<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Зважування — Адмін</title>

  <link rel="stylesheet" href="assets/css/main.css">

  <style>
    body{background:#020617}
    .card{background:#0f172a;border:1px solid #334155;border-radius:16px;padding:14px;margin-top:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row > *{flex:1 1 auto}
    select, input{
      width:100%;
      background:#020617;color:#fff;border:1px solid #475569;border-radius:10px;
      padding:10px 12px;
    }
    .btnWide{min-width:160px}
    .muted{opacity:.85}
    .ok{color:#22c55e}
    .err{color:#ef4444}
    .zoneTitle{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .zoneTitle h3{margin:0;font-weight:900}
    .badge{border:1px solid #334155;border-radius:999px;padding:4px 10px;font-size:.85rem;opacity:.9}

    .tblWrap{overflow:auto;border:1px solid #334155;border-radius:14px}
    table{width:100%;border-collapse:collapse;min-width:860px}
    th,td{border-bottom:1px solid #334155;padding:10px 10px;text-align:left;vertical-align:top}
    th{background:#020617;position:sticky;top:0;z-index:2}
    td.num, th.num{text-align:center}

    .fishList{display:flex;gap:8px;flex-wrap:wrap}
    .fishInput{
      width:90px !important;
      text-align:center;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #475569;
      background:#020617;
      color:#fff;
    }
    .btnPlus{
      background:linear-gradient(90deg,#facc15,#fb7185);
      color:#0b1220;border:none;border-radius:10px;
      padding:8px 12px;font-weight:900;cursor:pointer
    }
    .btnSaveRow{
      background:#16a34a;color:#04110a;border:none;border-radius:10px;
      padding:9px 12px;font-weight:900;cursor:pointer
    }
    .btnClearRow{
      background:#334155;color:#fff;border:none;border-radius:10px;
      padding:9px 12px;font-weight:700;cursor:pointer
    }
    .sumBox{font-weight:900}
    .small{font-size:.88rem;opacity:.85}
    .hr{height:1px;background:#334155;opacity:.7;margin:12px 0}
  </style>
</head>

<body>

<header class="header">
  <div class="container header__row">
    <div class="logo"><span class="logo__mark">SC</span> STOLAR CARP</div>
  </div>
</header>

<main class="container">

  <div class="card">
    <h2 style="margin:0 0 6px 0;">⚖️ Зважування (адмін)</h2>
    <div class="muted small">
      1) Обери змагання/етап → 2) Обери номер зважування (W1..W4) → 3) По командах натискай <b>+</b> і вводь рибу → <b>Зберегти</b>.<br>
      Дані пишуться в <b>stageResults</b>, тому <b>LIVE</b> має їх бачити одразу.
    </div>

    <div class="hr"></div>

    <div class="row">
      <div style="flex:2 1 260px">
        <div class="muted small" style="margin-bottom:6px">Змагання / етап</div>
        <select id="stageSelect">
          <option value="">— Завантаження… —</option>
        </select>
      </div>

      <div style="flex:1 1 160px">
        <div class="muted small" style="margin-bottom:6px">Номер зважування</div>
        <select id="wSelect">
          <option value="W1">W1</option>
          <option value="W2">W2</option>
          <option value="W3">W3</option>
          <option value="W4">W4</option>
        </select>
      </div>

      <div style="flex:0 0 auto;display:flex;gap:10px;align-items:end">
        <button id="btnRefresh" class="btn btn--ghost btnWide" type="button">Оновити список</button>
        <button id="btnLoad" class="btn btn--accent btnWide" type="button">Завантажити таблиці</button>
      </div>
    </div>

    <div id="msg" class="muted" style="margin-top:10px;"></div>
    <div id="debug" class="muted small" style="margin-top:6px;white-space:pre-wrap;"></div>
  </div>

  <div id="zonesWrap"></div>

</main>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="assets/js/firebase-init.js"></script>

<script>
(function(){
  "use strict";

  const auth = window.scAuth;
  const db   = window.scDb;
  const ff   = window.firebase?.firestore?.FieldValue;

  const $ = (id)=>document.getElementById(id);

  const stageSelect = $("stageSelect");
  const wSelect     = $("wSelect");
  const btnLoad     = $("btnLoad");
  const btnRefresh  = $("btnRefresh");

  const msgEl   = $("msg");
  const dbgEl   = $("debug");
  const zonesWrap = $("zonesWrap");

  const esc = (s)=>String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  const norm = (v)=>String(v??"").trim();

  function setMsg(t, ok=true){
    msgEl.textContent = t || "";
    msgEl.className = "muted " + (t ? (ok ? "ok" : "err") : "");
  }
  function setDbg(t){ dbgEl.textContent = t || ""; }

  function parseStageValue(v){
    // value = compId||stageKey
    const [compId, stageKey] = String(v||"").split("||");
    return { compId: norm(compId), stageKey: norm(stageKey) };
  }

  async function requireAdmin(user){
    const snap = await db.collection("users").doc(user.uid).get();
    const role = (snap.exists ? (snap.data()||{}).role : "") || "";
    return role === "admin";
  }

  // ---------------------------
  // 1) Список змагань/етапів
  // ---------------------------
  async function loadStagesToSelect(){
    stageSelect.innerHTML = `<option value="">Завантаження…</option>`;
    const items = [];

    const snap = await db.collection("competitions").get();
    snap.forEach(docSnap=>{
      const c = docSnap.data()||{};
      const compId = docSnap.id;

      const brand = c.brand || "STOLAR CARP";
      const year  = c.year || c.seasonYear || "";
      const compTitle = c.name || c.title || (year ? `Season ${year}` : compId);

      const eventsArr = Array.isArray(c.events) ? c.events : null;

      if (eventsArr && eventsArr.length){
        eventsArr.forEach((ev, idx)=>{
          const key = String(ev.key || ev.stageId || ev.id || `stage-${idx+1}`);
          const stageTitle = ev.title || ev.name || ev.label || `Етап ${idx+1}`;
          const label = `${brand} · ${compTitle} — ${stageTitle}`;
          items.push({ value:`${compId}||${key}`, label, compId, stageKey:key });
        });
      } else {
        items.push({ value:`${compId}||stage-1`, label:`${brand} · ${compTitle} — Етап 1`, compId, stageKey:"stage-1" });
      }
    });

    items.sort((a,b)=>a.label.localeCompare(b.label,"uk"));

    stageSelect.innerHTML =
      `<option value="">— Обери етап —</option>` +
      items.map(x=>`<option value="${esc(x.value)}">${esc(x.label)}</option>`).join("");
  }

  // -------------------------------------------------------
  // 2) StageResults DocId (СТАБІЛЬНО ДЛЯ LIVE)
  // -------------------------------------------------------
  function stageDocId(compId, stageKey){
    // як у тебе на скріні: oneoff-2026-...__stage-1
    return `${compId}__${stageKey}`;
  }

  // -------------------------------------------------------
  // 3) Команди беремо з registrations (де є drawZone/drawSector)
  // -------------------------------------------------------
  async function loadTeamsFromRegistrations(compId, stageKey){
    // В registrations на скрінах є поля:
    // drawZone ("A"/"B"/"C"), drawSector (number), teamId, teamName, stageId
    // Тому тут читаємо confirmed для цього compId + stageKey.
    const q = await db.collection("registrations")
      .where("competitionId","==",compId)
      .where("stageId","==",stageKey)
      .where("status","==","confirmed")
      .get();

    const teams = [];
    q.forEach(d=>{
      const r = d.data()||{};
      const teamId = r.teamId || "";
      const teamName = r.teamName || r.team || r.name || "Команда";
      const zone = (r.drawZone || r.zone || "").toString().toUpperCase();
      const sector = r.drawSector ?? r.sector ?? "";
      if(!zone) return; // без зони не беремо
      teams.push({
        teamId,
        teamName,
        zone,
        sector: sector==="" ? "" : String(sector),
        regId: d.id
      });
    });

    // сортування по сектору
    teams.sort((a,b)=>{
      const za = a.zone.localeCompare(b.zone);
      if(za!==0) return za;
      const sa = Number(a.sector||0), sb = Number(b.sector||0);
      return sa - sb;
    });

    return teams;
  }

  // -------------------------------------------------------
  // 4) Створити/оновити stageResults (teamsMap + teams масив)
  // -------------------------------------------------------
  function emptyWeighings(){
    return {
      W1: { total:0, count:0 },
      W2: { total:0, count:0 },
      W3: { total:0, count:0 },
      W4: { total:0, count:0 }
    };
  }

  function computeTotalWeight(weighings){
    return (weighings?.W1?.total||0) + (weighings?.W2?.total||0) + (weighings?.W3?.total||0) + (weighings?.W4?.total||0);
  }

  function mapToArray(teamsMap){
    const arr = Object.values(teamsMap || {});
    // сортування A/B/C + сектор
    arr.sort((a,b)=>{
      const za = String(a.zone||"").localeCompare(String(b.zone||""));
      if(za!==0) return za;
      return Number(a.sector||0) - Number(b.sector||0);
    });
    return arr;
  }

  async function ensureStageResults(compId, stageKey, stageNameLabel){
    const id = stageDocId(compId, stageKey);
    const ref = db.collection("stageResults").doc(id);
    const snap = await ref.get();

    if(snap.exists){
      // оновимо stageName, але teams не чіпаємо
      await ref.set({
        compId, stageKey,
        stageName: stageNameLabel || snap.data().stageName || id,
        updatedAt: ff?.serverTimestamp?.() || new Date()
      }, { merge:true });
      return { id, ref, data: snap.data() };
    }

    // якщо нема — будуємо з registrations
    const teams = await loadTeamsFromRegistrations(compId, stageKey);
    const teamsMap = {};

    teams.forEach(t=>{
      const w = emptyWeighings();
      teamsMap[t.teamId] = {
        teamId: t.teamId,
        teamName: t.teamName,
        zone: t.zone,
        sector: t.sector,
        weighings: w,
        totalWeight: 0,
        bigFish: 0,
        updatedAt: ff?.serverTimestamp?.() || new Date()
      };
    });

    await ref.set({
      compId,
      stageKey,
      stageName: stageNameLabel || id,
      createdAt: ff?.serverTimestamp?.() || new Date(),
      updatedAt: ff?.serverTimestamp?.() || new Date(),
      teamsMap: teamsMap,
      teams: mapToArray(teamsMap) // для LIVE
    }, { merge:true });

    const created = await ref.get();
    return { id, ref, data: created.data() };
  }

  // -------------------------------------------------------
  // 5) UI: таблиці зон
  // -------------------------------------------------------
  function zoneBlock(zone, rows){
    const count = rows.length;
    const head = `
      <div class="card">
        <div class="zoneTitle">
          <h3>Зона ${zone}</h3>
          <span class="badge">${count ? ("команд: " + count) : "немає даних"}</span>
        </div>
        ${count ? `
          <div class="tblWrap">
            <table>
              <thead>
                <tr>
                  <th class="num">Сектор</th>
                  <th>Команда</th>
                  <th class="num">Риба (кг) — натискай “+”</th>
                  <th class="num">Сума (W)</th>
                  <th class="num">Дії</th>
                </tr>
              </thead>
              <tbody>
                ${rows.map(r=>rowHtml(r)).join("")}
              </tbody>
            </table>
          </div>
        ` : `<div class="muted">Результати для цієї зони ще не заповнені.</div>`}
      </div>
    `;
    return head;
  }

  function rowHtml(t){
    const sector = esc(t.sector || "—");
    const teamName = esc(t.teamName || "Команда");
    const teamId = esc(t.teamId || "");
    return `
      <tr data-team="${teamId}">
        <td class="num"><b>${sector}</b></td>
        <td>
          <div style="font-weight:900">${teamName}</div>
          <div class="small muted">${teamId}</div>
        </td>
        <td class="num">
          <div class="fishList" data-fishlist></div>
          <div style="margin-top:8px;display:flex;gap:8px;justify-content:center">
            <button class="btnPlus" type="button" data-plus>+</button>
            <button class="btnClearRow" type="button" data-clear>Очистити</button>
          </div>
        </td>
        <td class="num">
          <div class="sumBox" data-sum>0.000</div>
          <div class="small muted">кількість: <span data-count>0</span></div>
        </td>
        <td class="num">
          <button class="btnSaveRow" type="button" data-save>Зберегти</button>
          <div class="small muted" style="margin-top:6px" data-status></div>
        </td>
      </tr>
    `;
  }

  function addFishInput(fishListEl, value=""){
    const inp = document.createElement("input");
    inp.type = "number";
    inp.step = "0.001";
    inp.placeholder = "0.000";
    inp.className = "fishInput";
    inp.value = value;
    fishListEl.appendChild(inp);
    return inp;
  }

  function getFishValues(fishListEl){
    const arr = [];
    fishListEl.querySelectorAll("input").forEach(inp=>{
      const v = Number(String(inp.value||"").replace(",","."));
      if(v>0) arr.push(v);
    });
    return arr;
  }

  function calc(arr){
    const total = arr.reduce((s,v)=>s+Number(v||0),0);
    const count = arr.length;
    const big = count ? Math.max(...arr) : 0;
    return { total, count, big };
  }

  // -------------------------------------------------------
  // 6) Save: stageResults агрегати + teams масив (для LIVE) + weighingsLog (по рибі)
  // -------------------------------------------------------
  async function saveTeamWeighing(stageRef, stageId, wKey, teamId, zone, fishArr){
    const pack = calc(fishArr);

    await db.runTransaction(async tx=>{
      const snap = await tx.get(stageRef);
      if(!snap.exists) throw new Error("stageResults не знайдено");

      const data = snap.data()||{};
      const teamsMap = data.teamsMap || {};
      const t = teamsMap[teamId];
      if(!t) throw new Error("Команда не знайдена в teamsMap");

      const weighings = t.weighings || emptyWeighings();
      const prev = weighings[wKey] || { total:0, count:0 };

      // додаємо до існуючого (щоб можна було зберігати частинами)
      const newTotal = Number(prev.total||0) + Number(pack.total||0);
      const newCount = Number(prev.count||0) + Number(pack.count||0);

      weighings[wKey] = { total: newTotal, count: newCount };

      // totalWeight по всіх W
      const newTW = computeTotalWeight(weighings);

      // bigFish беремо максимальний з (старий, новий)
      const oldBig = Number(t.bigFish||0);
      const newBig = Math.max(oldBig, Number(pack.big||0));

      const updatedTeam = Object.assign({}, t, {
        weighings,
        totalWeight: newTW,
        bigFish: newBig,
        updatedAt: ff?.serverTimestamp?.() || new Date()
      });

      // оновлюємо teamsMap.{teamId}
      tx.update(stageRef, {
        [`teamsMap.${teamId}`]: updatedTeam,
        updatedAt: ff?.serverTimestamp?.() || new Date()
      });

      // оновлюємо teams (масив) для LIVE сумісності
      const teamsArr = mapToArray(Object.assign({}, teamsMap, { [teamId]: updatedTeam }));
      tx.update(stageRef, { teams: teamsArr });
    });

    // журнал кожної риби (ОКРЕМО, без nested arrays)
    // якщо не хочеш лог — можеш потім прибрати цей блок
    const logCol = db.collection("weighingsLog");
    const batch = db.batch();
    fishArr.forEach(w=>{
      const doc = logCol.doc();
      batch.set(doc, {
        stageId: stageId,
        teamId: teamId,
        zone: zone,
        wKey: wKey,
        weight: Number(w),
        createdAt: ff?.serverTimestamp?.() || new Date()
      });
    });
    await batch.commit();

    return pack;
  }

  // -------------------------------------------------------
  // 7) Завантажити таблиці (з stageResults)
  // -------------------------------------------------------
  async function loadAndRender(){
    const v = stageSelect.value;
    const { compId, stageKey } = parseStageValue(v);
    const wKey = wSelect.value;

    if(!compId || !stageKey){
      setMsg("Обери етап.", false);
      return;
    }

    const stageLabel = stageSelect.options[stageSelect.selectedIndex]?.textContent || `${compId} — ${stageKey}`;
    setMsg("Готую stageResults і таблиці…", true);
    setDbg("");

    const ensured = await ensureStageResults(compId, stageKey, stageLabel);
    const stageId = ensured.id;
    const stageRef = ensured.ref;

    // перечитати актуальні дані
    const snap = await stageRef.get();
    const data = snap.data()||{};
    const teamsMap = data.teamsMap || {};
    const teamsArr = mapToArray(teamsMap);

    // розклад по зонах
    const zones = { A:[], B:[], C:[] };
    teamsArr.forEach(t=>{
      const z = String(t.zone||"").toUpperCase();
      if(zones[z]) zones[z].push(t);
    });

    zonesWrap.innerHTML =
      zoneBlock("A", zones.A) +
      zoneBlock("B", zones.B) +
      zoneBlock("C", zones.C);

    // навісити логіку + / очистити / зберегти
    zonesWrap.querySelectorAll("tr[data-team]").forEach(tr=>{
      const teamId = tr.getAttribute("data-team");
      const team = teamsMap[teamId];
      const zone = String(team?.zone||"").toUpperCase();

      const fishListEl = tr.querySelector("[data-fishlist]");
      const sumEl = tr.querySelector("[data-sum]");
      const countEl = tr.querySelector("[data-count]");
      const stEl = tr.querySelector("[data-status]");
      const btnPlus = tr.querySelector("[data-plus]");
      const btnClear = tr.querySelector("[data-clear]");
      const btnSave = tr.querySelector("[data-save]");

      function refresh(){
        const fishArr = getFishValues(fishListEl);
        const pack = calc(fishArr);
        sumEl.textContent = pack.total.toFixed(3);
        countEl.textContent = String(pack.count);
      }

      // старт: 1 поле
      addFishInput(fishListEl, "");
      fishListEl.addEventListener("input", refresh);

      btnPlus.onclick = ()=>{
        addFishInput(fishListEl, "");
      };

      btnClear.onclick = ()=>{
        fishListEl.innerHTML = "";
        addFishInput(fishListEl, "");
        refresh();
        stEl.textContent = "Очищено.";
        stEl.className = "small muted";
      };

      btnSave.onclick = async ()=>{
        try{
          const fishArr = getFishValues(fishListEl);
          if(!fishArr.length){
            stEl.textContent = "Нема введеної риби.";
            stEl.className = "small err";
            return;
          }

          stEl.textContent = "Зберігаю…";
          stEl.className = "small muted";

          const pack = await saveTeamWeighing(stageRef, stageId, wKey, teamId, zone, fishArr);

          // після збереження — очищаємо поля (щоб не дублювати)
          fishListEl.innerHTML = "";
          addFishInput(fishListEl, "");
          refresh();

          stEl.textContent = `✅ Додано: ${pack.total.toFixed(3)} кг (${pack.count} шт.)`;
          stEl.className = "small ok";

          setMsg("✅ Збережено. LIVE має бачити оновлення.", true);

        }catch(e){
          stEl.textContent = "❌ Помилка збереження";
          stEl.className = "small err";
          setMsg("❌ Помилка збереження", false);
          setDbg((dbgEl.textContent||"") + "\n\nSAVE ERROR:\n" + (e?.message||String(e)));
        }
      };

      refresh();
    });

    setMsg(`✅ Таблиці готові. Етап: ${stageLabel} · режим: ${wKey}`, true);
    setDbg(`stageResults doc: stageResults/${stageDocId(compId, stageKey)}\nДжерело команд: registrations (confirmed + drawZone/drawSector)`);
  }

  // ---------------------------
  // INIT
  // ---------------------------
  async function init(){
    if(!auth || !db){
      setMsg("Firebase не ініціалізований (scAuth/scDb).", false);
      return;
    }

    auth.onAuthStateChanged(async (user)=>{
      if(!user){
        setMsg("Увійди як адмін.", false);
        return;
      }
      const ok = await requireAdmin(user);
      if(!ok){
        setMsg("Цей акаунт не адмін.", false);
        return;
      }

      await loadStagesToSelect();
      setMsg("Обери етап і W → натисни “Завантажити таблиці”.", true);

      btnLoad.onclick = loadAndRender;
      btnRefresh.onclick = async ()=>{
        setMsg("Оновлюю список…", true);
        await loadStagesToSelect();
        setMsg("Оновлено ✅", true);
      };
    });
  }

  init();

})();
</script>

</body>
</html>
