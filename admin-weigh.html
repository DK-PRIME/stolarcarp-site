<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Зважування — Адмін</title>

  <link rel="stylesheet" href="assets/css/main.css" />

  <style>
    body{background:#020617}
    .card{background:#0f172a;border:1px solid #334155;border-radius:16px;padding:14px;margin:14px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row > *{flex:1}
    .row .btn{flex:0 0 auto}
    .muted{color:#94a3b8}
    .ok{color:#22c55e}
    .err{color:#ef4444}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid #334155;border-radius:999px;padding:6px 10px;background:#0b1224;color:#e5e7eb;font-size:.9rem}
    .hr{height:1px;background:#334155;margin:12px 0;opacity:.7}

    .zoneTitle{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .zoneTitle h3{margin:0;font-size:1.1rem}
    .badge{border:1px solid #334155;border-radius:999px;padding:6px 10px;background:#0b1224;color:#e5e7eb;font-size:.85rem}

    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px;overflow:hidden;border-radius:14px;border:1px solid #334155}
    th,td{border-bottom:1px solid #334155;padding:10px 8px;text-align:left;vertical-align:top}
    th{background:#020617;color:#e5e7eb;font-weight:800;font-size:.9rem}
    tr:last-child td{border-bottom:none}
    td:nth-child(1){width:72px}
    td:nth-child(2){min-width:180px}
    td:nth-child(3){width:380px}
    td:nth-child(4){width:110px;text-align:right}
    td:nth-child(5){width:130px;text-align:right}

    .teamName{font-weight:800;color:#e5e7eb}
    .teamMeta{margin-top:3px;color:#94a3b8;font-size:.85rem;word-break:break-word}

    .fishWrap{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .fishInput{
      width:92px; text-align:center;
      background:#020617;color:#fff;border:1px solid #475569;border-radius:10px;
      padding:8px 10px;
    }
    .fishInput::placeholder{color:#64748b}
    .btnPlus{
      background:linear-gradient(90deg,#facc15,#fb7185);
      color:#0b1224;border:none;border-radius:12px;padding:8px 12px;font-weight:900;
      cursor:pointer
    }
    .btnSaveMini{
      background:#111827;border:1px solid #334155;color:#e5e7eb;border-radius:12px;padding:8px 10px;font-weight:800;cursor:pointer
    }
    .btnSaveMini:hover{border-color:#64748b}

    .sumBox{font-weight:900;color:#e5e7eb}
    .small{font-size:.85rem;color:#94a3b8;margin-top:4px}

    select, input[type="text"]{
      background:#0b1224;color:#e5e7eb;border:1px solid #334155;border-radius:14px;
      padding:12px 12px;outline:none;min-width:240px
    }
    .topHelp{line-height:1.5}
  </style>
</head>

<body>

<header class="header">
  <div class="container header__row">
    <div class="logo"><span class="logo__mark">SC</span> STOLAR CARP</div>
  </div>
</header>

<main class="container">

    <div class="hr"></div>

    <div class="row">
        <div class="muted" style="margin-bottom:6px;">Змагання / етап</div>
        <select id="stageSelect">
          <option value="">— Завантаження… —</option>
        </select>
      </div>

      <div style="flex:0 0 200px;">
        <div class="muted" style="margin-bottom:6px;">Номер зважування</div>
        <select id="wSelect">
          <option value="W1">W1</option>
          <option value="W2">W2</option>
          <option value="W3">W3</option>
          <option value="W4">W4</option>
        </select>
      </div>

      <button id="btnReloadStages" class="btn btn--primary" type="button">Оновити список</button>
      <button id="btnLoadTables" class="btn btn--accent" type="button">Завантажити таблиці</button>
    </div>

    <div id="msg" class="muted" style="margin-top:10px;"></div>
    <div id="debug" class="muted" style="margin-top:6px;white-space:pre-wrap;"></div>
  </div>

  <div id="zonesWrap"></div>

</main>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="assets/js/firebase-init.js"></script>

<script>
(function(){
  "use strict";

  const auth = window.scAuth;
  const db   = window.scDb;
  const fb   = window.firebase;

  const $ = (id)=>document.getElementById(id);

  const stageSelect = $("stageSelect");
  const wSelect     = $("wSelect");
  const msgEl       = $("msg");
  const dbgEl       = $("debug");
  const zonesWrap   = $("zonesWrap");

  function esc(s){ return String(s ?? "").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
  function norm(s){ return String(s ?? "").trim(); }

  function setMsg(t, ok=true){
    msgEl.textContent = t || "";
    msgEl.className = "muted " + (t ? (ok ? "ok" : "err") : "");
  }
  function setDbg(t){
    dbgEl.textContent = t || "";
  }

  async function requireAdmin(user){
    const snap = await db.collection("users").doc(user.uid).get();
    const role = (snap.exists ? (snap.data()||{}).role : "") || "";
    return role === "admin";
  }

  // value: compId||stageKey
  function parseStageValue(v){
    const [compId, stageKey] = String(v||"").split("||");
    return { compId: norm(compId), stageKey: norm(stageKey) };
  }

  // stageResults doc id: compId__stageKey
  function stageResultsId(compId, stageKey){
    return `${compId}__${stageKey}`;
  }

  // ====== 1) Завантаження етапів зі competitions ======
  async function loadStages(){
    stageSelect.innerHTML = `<option value="">— Завантаження… —</option>`;
    const items = [];
    const seen = new Set();

    const snap = await db.collection("competitions").get();
    snap.forEach(docSnap=>{
      const c = docSnap.data()||{};
      const compId = docSnap.id;

      const brand = c.brand || "STOLAR CARP";
      const year  = c.year || c.seasonYear || "";
      const compTitle = c.name || c.title || (year ? `Season ${year}` : compId);

      const events = Array.isArray(c.events) ? c.events : [];
      events.forEach((ev, idx)=>{
        const key = String(ev.key || ev.stageId || ev.id || `stage-${idx+1}`);
        const stageTitle = ev.name || ev.title || ev.label || `Етап ${idx+1}`;
        const label = `${brand} · ${compTitle} — ${stageTitle}`;
        const value = `${compId}||${key}`;

        if(!seen.has(value)){
          seen.add(value);
          items.push({value, label});
        }
      });
    });

    items.sort((a,b)=>a.label.localeCompare(b.label,"uk"));
    stageSelect.innerHTML =
      `<option value="">— Обери етап —</option>` +
      items.map(x=>`<option value="${esc(x.value)}">${esc(x.label)}</option>`).join("");
  }

  // ====== 2) Тягнемо команди з registrations (confirmed + drawZone/drawSector) ======
  async function loadTeamsFromRegistrations(compId, stageKey){
    const q = await db.collection("registrations")
      .where("competitionId","==",compId)
      .where("stageId","==",stageKey)
      .where("status","==","confirmed")
      .get();

    const teams = [];
    q.forEach(d=>{
      const r = d.data()||{};
      const zone = String(r.drawZone || r.zone || "").toUpperCase();
      const sector = r.drawSector ?? r.sector ?? r.place ?? "";
      const teamId = r.teamId || r.uid || d.id;
      const teamName = r.teamName || r.team || r.name || "Команда";

      if(!zone) return;
      teams.push({
        regId: d.id,
        teamId: String(teamId),
        team: String(teamName),
        zone,
        sector: sector,
      });
    });

    const zoneOrder = {A:1,B:2,C:3};
    teams.sort((a,b)=>{
      const za = zoneOrder[a.zone] || 9;
      const zb = zoneOrder[b.zone] || 9;
      if(za !== zb) return za - zb;

      const na = Number(String(a.sector).replace(/[^\d.]/g,""));
      const nb = Number(String(b.sector).replace(/[^\d.]/g,""));
      if(Number.isFinite(na) && Number.isFinite(nb) && na !== nb) return na - nb;

      return String(a.sector).localeCompare(String(b.sector),"uk");
    });

    return teams;
  }

  // ====== 3) Читаємо вже збережені зважування з stageResults/{doc}/teams/{teamId} ======
  async function loadSavedTeamWeighings(stageDocId){
    const map = new Map();
    const snap = await db.collection("stageResults").doc(stageDocId).collection("teams").get();
    snap.forEach(d=>{
      map.set(d.id, d.data()||{});
    });
    return map;
  }

  // ====== 4) Рендер таблиць по зонах ======
  function zoneBlock(zone, rowsHtml, count){
    return `
      <div class="card">
        <div class="zoneTitle">
          <h3>Зона ${esc(zone)}</h3>
          <span class="badge">команд: ${count}</span>
        </div>
        ${rowsHtml}
      </div>
    `;
  }

  function buildTable(zone, teams, wKey, savedMap){
    if(!teams.length){
      return `<div class="muted">Немає команд у зоні ${esc(zone)}.</div>`;
    }

    const head = `
      <table>
        <thead>
          <tr>
            <th>Сектор</th>
            <th>Команда</th>
            <th>Риба (${esc(wKey)})</th>
            <th>Сума ${esc(wKey)}</th>
            <th>Дія</th>
          </tr>
        </thead>
        <tbody>
    `;

    const body = teams.map(t=>{
      const saved = savedMap.get(t.teamId) || {};
      const weighings = saved.weighings || {};
      const slot = weighings[wKey] || {};
      const fish = Array.isArray(slot.fish) ? slot.fish : [];

      const inputs = fish.map(v=>{
        const val = (Number(v)||0) ? Number(v).toFixed(3) : "";
        return `<input class="fishInput" inputmode="decimal" placeholder="0.000" value="${esc(val)}" data-fish />`;
      }).join("");

      const sum = fish.reduce((s,v)=>s + (Number(v)||0), 0);

      return `
        <tr data-team="${esc(t.teamId)}" data-zone="${esc(t.zone)}">
          <td><div class="pill">${esc(t.sector || "—")}</div></td>
          <td>
            <div class="teamName">${esc(t.team)}</div>
            <div class="teamMeta">${esc(t.teamId)}</div>
          </td>
          <td>
            <div class="fishWrap">
              ${inputs || `<span class="muted">Немає внесеної риби</span>`}
              <button class="btnPlus" type="button" data-plus>+</button>
            </div>
            <div class="small">Вписуй вагу кожної риби окремо (наприклад 4.560)</div>
          </td>
          <td style="text-align:right;">
            <div class="sumBox" data-sum>${sum.toFixed(3)}</div>
          </td>
          <td style="text-align:right;">
            <button class="btnSaveMini" type="button" data-save>Зберегти</button>
            <div class="small" data-status></div>
          </td>
        </tr>
      `;
    }).join("");

    const tail = `</tbody></table>`;
    return head + body + tail;
  }

  function recalcRowSum(tr){
    const inputs = tr.querySelectorAll("input[data-fish]");
    let sum = 0;
    inputs.forEach(inp=>{
      const v = Number(String(inp.value||"").replace(",","."));
      if(Number.isFinite(v) && v > 0) sum += v;
    });
    const sumEl = tr.querySelector("[data-sum]");
    if(sumEl) sumEl.textContent = sum.toFixed(3);
  }

  function collectFish(tr){
    const arr = [];
    tr.querySelectorAll("input[data-fish]").forEach(inp=>{
      const v = Number(String(inp.value||"").replace(",","."));
      if(Number.isFinite(v) && v > 0) arr.push(v);
    });
    return arr;
  }

  // ====== 5) Запис + оновлення stageResults для LIVE ======
  async function saveTeam(stageDocId, compId, stageKey, wKey, team, fish){
    const teamRef = db.collection("stageResults").doc(stageDocId).collection("teams").doc(team.teamId);

    const oldSnap = await teamRef.get();
    const old = oldSnap.exists ? (oldSnap.data()||{}) : {};

    const weighings = old.weighings || {};
    weighings[wKey] = {
      fish: fish,
      total: fish.reduce((s,v)=>s+(Number(v)||0),0),
      count: fish.length,
      big: fish.reduce((m,v)=>Math.max(m,Number(v)||0),0)
    };

    const W = ["W1","W2","W3","W4"];
    let totalWeight = 0;
    let bigFish = 0;
    const sums = {};
    W.forEach(k=>{
      const slot = weighings[k] || {};
      const s = Number(slot.total || 0) || 0;
      sums[k] = s;
      totalWeight += s;
      bigFish = Math.max(bigFish, Number(slot.big||0)||0);
    });

    await teamRef.set({
      compId,
      stageId: stageKey,
      teamId: team.teamId,
      team: team.team,
      zone: team.zone,
      sector: team.sector,
      weighings,
      sums,
      totalWeight,
      bigFish,
      updatedAt: fb.firestore.FieldValue.serverTimestamp()
    }, { merge:true });

    const stageRef = db.collection("stageResults").doc(stageDocId);
    const stageSnap = await stageRef.get();
    const stageData = stageSnap.exists ? (stageSnap.data()||{}) : {};

    const teamsArr = Array.isArray(stageData.teams) ? stageData.teams.slice() : [];

    const idx = teamsArr.findIndex(x => (x && (x.teamId === team.teamId)));
    const rowObj = {
      teamId: team.teamId,
      team: team.team,
      zone: team.zone,
      sector: team.sector,
      W1: sums.W1 || 0,
      W2: sums.W2 || 0,
      W3: sums.W3 || 0,
      W4: sums.W4 || 0,
      totalWeight: totalWeight,
      bigFish: bigFish
    };

    if(idx >= 0) teamsArr[idx] = rowObj; else teamsArr.push(rowObj);

    const zoneOrder = {A:1,B:2,C:3};
    teamsArr.sort((a,b)=>{
      const za = zoneOrder[a.zone] || 9;
      const zb = zoneOrder[b.zone] || 9;
      if(za !== zb) return za - zb;
      const na = Number(String(a.sector).replace(/[^\d.]/g,""));
      const nb = Number(String(b.sector).replace(/[^\d.]/g,""));
      if(Number.isFinite(na) && Number.isFinite(nb) && na !== nb) return na - nb;
      return String(a.sector).localeCompare(String(b.sector),"uk");
    });

    await stageRef.set({
      compId,
      stageId: stageKey,
      stageName: stageData.stageName || stageData.name || stageDocId,
      teams: teamsArr,
      updatedAt: fb.firestore.FieldValue.serverTimestamp()
    }, { merge:true });

    return { sums, totalWeight, bigFish };
  }

  // ====== 6) Завантаження таблиць ======
  async function loadTables(){
    const { compId, stageKey } = parseStageValue(stageSelect.value);
    const wKey = wSelect.value;

    if(!compId || !stageKey){
      setMsg("Обери етап зі списку.", false);
      return;
    }

    setMsg("Завантажую команди…", true);
    setDbg("");

    const stageDocId = stageResultsId(compId, stageKey);
    let teams = [];

    try{
      teams = await loadTeamsFromRegistrations(compId, stageKey);
    }catch(e){
      setMsg("Помилка читання registrations.", false);
      setDbg(String(e && e.message ? e.message : e));
      return;
    }

    if(!teams.length){
      setMsg("Не знайдено підтверджених команд у registrations (status=confirmed).", false);
      setDbg("Перевір: competitionId, stageId, status у registrations.");
      zonesWrap.innerHTML = "";
      return;
    }

    setMsg(`✅ Команди підтягнуті: ${teams.length}. Читаю збережені ваги…`, true);

    let savedMap = new Map();
    try{
      savedMap = await loadSavedTeamWeighings(stageDocId);
    }catch(e){
      savedMap = new Map();
    }

    const zones = {A:[],B:[],C:[]};
    teams.forEach(t=>{
      if(zones[t.zone]) zones[t.zone].push(t);
    });

    zonesWrap.innerHTML =
      zoneBlock("A", buildTable("A", zones.A, wKey, savedMap), zones.A.length) +
      zoneBlock("B", buildTable("B", zones.B, wKey, savedMap), zones.B.length) +
      zoneBlock("C", buildTable("C", zones.C, wKey, savedMap), zones.C.length);

    zonesWrap.querySelectorAll("tr[data-team]").forEach(tr=>{
      tr.addEventListener("input", (ev)=>{
        if(ev.target && ev.target.matches("input[data-fish]")){
          recalcRowSum(tr);
        }
      });
    });

    zonesWrap.addEventListener("click", async (ev)=>{
      const btnPlus = ev.target.closest("[data-plus]");
      const btnSave = ev.target.closest("[data-save]");
      const tr = ev.target.closest("tr[data-team]");
      if(!tr) return;

      const { compId, stageKey } = parseStageValue(stageSelect.value);
      const stageDocId = stageResultsId(compId, stageKey);
      const wKey = wSelect.value;

      if(btnPlus){
        const wrap = tr.querySelector(".fishWrap");
        const inp = document.createElement("input");
        inp.className = "fishInput";
        inp.setAttribute("inputmode","decimal");
        inp.setAttribute("placeholder","0.000");
        inp.setAttribute("data-fish","");
        wrap.insertBefore(inp, wrap.querySelector("[data-plus]"));
        inp.focus();
        return;
      }

      if(btnSave){
        const statusEl = tr.querySelector("[data-status]");
        statusEl.textContent = "Зберігаю…";

        const teamId = tr.getAttribute("data-team");
        const teamObj = teams.find(x => x.teamId === teamId);
        if(!teamObj){
          statusEl.textContent = "❌ Нема teamObj";
          return;
        }

        const fish = collectFish(tr);

        try{
          await saveTeam(stageDocId, compId, stageKey, wKey, teamObj, fish);
          statusEl.innerHTML = "<span class='ok'>✅ Збережено</span>";
          recalcRowSum(tr);
          setMsg("✅ Збережено. LIVE має підтягнути оновлення.", true);
          setDbg(`stageResults doc: stageResults/${stageDocId}\nджерело команд: registrations (confirmed + drawZone/drawSector)\nрежим: ${wKey}`);
        }catch(e){
          statusEl.innerHTML = "<span class='err'>❌ Помилка</span>";
          setMsg("Помилка збереження.", false);
          setDbg(String(e && e.message ? e.message : e));
        }
      }
    });

    setMsg(`✅ Таблиці готові. Етап: ${stageDocId} · режим: ${wKey}`, true);
    setDbg(`stageResults doc: stageResults/${stageDocId}\nджерело команд: registrations (confirmed + drawZone/drawSector)`);
  }

  // ====== INIT ======
  async function init(){
    if(!auth || !db || !fb){
      setMsg("Firebase не ініціалізувався (scAuth/scDb).", false);
      return;
    }

    auth.onAuthStateChanged(async (user)=>{
      if(!user){
        setMsg("Увійди як адмін.", false);
        return;
      }
      const ok = await requireAdmin(user);
      if(!ok){
        setMsg("Цей акаунт не адмін.", false);
        return;
      }

      await loadStages();
      setMsg("Обери етап та W → натисни “Завантажити таблиці”.", true);

      $("btnReloadStages").onclick = async ()=>{
        setMsg("Оновлюю список етапів…", true);
        await loadStages();
        setMsg("✅ Список оновлено.", true);
      };

      $("btnLoadTables").onclick = loadTables;
    });
  }

  init();
})();
</script>

</body>
</html>
