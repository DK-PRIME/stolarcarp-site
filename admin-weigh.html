<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>STOLAR CARP • Зважування (адмін)</title>

  <link rel="stylesheet" href="assets/css/main.css">

  <style>
    body{ background: radial-gradient(circle at top,#111827 0,#020617 55%); }

    .wrap{ max-width:1100px; margin:0 auto; padding:18px 0 70px; }
    .card{
      margin-top:14px; padding:16px; border-radius:18px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.35);
      box-shadow:0 18px 40px rgba(0,0,0,.6);
    }
    .muted{ color:#9ca3af; }
    .ok{ color:#22c55e; }
    .err{ color:#ef4444; }
    .hidden{ display:none !important; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row > *{ flex: 1 1 auto; }

    select, input{
      width:100%;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.35);
      background:rgba(2,6,23,.55);
      color:#e5e7eb;
      outline:none;
    }

    .btnline{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .btnline .btn{ border-radius:14px; padding:12px 14px; }

    .zoneTitle{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom:10px;
      font-weight:900; font-size:1.15rem;
    }
    .badge{
      font-size:.72rem;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.25);
      background:rgba(2,6,23,.45);
      color:#e5e7eb;
      white-space:nowrap;
    }

    /* tables */
    .tableWrap{ overflow:auto; border-radius:14px; border:1px solid rgba(148,163,184,.25); }
    table{ width:100%; border-collapse:collapse; min-width:780px; }
    th, td{
      border-bottom:1px solid rgba(148,163,184,.18);
      padding:10px 10px;
      text-align:left;
      vertical-align:top;
      color:#e5e7eb;
    }
    th{
      position:sticky; top:0;
      background:rgba(2,6,23,.92);
      z-index:2;
      font-size:.85rem;
      letter-spacing:.04em;
      text-transform:uppercase;
    }
    td small{ color:#94a3b8; display:block; margin-top:3px; }

    .sector{ width:84px; }
    .teamcol{ min-width:220px; }
    .fishcol{ min-width:360px; }
    .sumcol{ width:120px; text-align:right; }
    .actcol{ width:140px; }

    .fishList{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .fishInput{
      width:110px;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,.35);
      background:rgba(2,6,23,.55);
      color:#e5e7eb;
    }
    .miniBtn{
      display:inline-flex; align-items:center; justify-content:center;
      width:42px; height:42px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,.35);
      background:linear-gradient(135deg,var(--accent),var(--accent-2));
      color:#000;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .miniBtn--ghost{
      background:rgba(2,6,23,.55);
      color:#e5e7eb;
    }
    .right{ text-align:right; }
    .hr{ height:1px; background:rgba(148,163,184,.18); margin:12px 0; border-radius:99px; }

    .hint{ font-size:.9rem; line-height:1.35; color:#9ca3af; }
    .hint b{ color:#e5e7eb; }

    .topTitle{
      font-size:1.4rem;
      font-weight:900;
      letter-spacing:.04em;
      margin:0 0 4px;
    }
  </style>
</head>

<body>

<header class="header">
  <div class="container header__row">
    <a class="logo" href="index.html">
      <span class="logo__mark">SC</span>
      <span class="logo__text">STOLAR CARP</span>
    </a>
    <nav class="nav">
      <a href="/live.html" class="nav__link">Live</a>
      <a href="/rating.html" class="nav__link">Рейтинг</a>
      <a href="/auth.html" class="nav__link">Акаунт</a>
    </nav>
  </div>
</header>

<main class="main">
  <section class="section container wrap">

    <div class="card">
      <div class="topTitle">⚖️ Зважування (адмін)</div>
      <div class="hint">
        1) Обери <b>етап</b> → 2) Обери <b>номер зважування</b> → 3) По командах натискай <b>+</b> і вводь рибу → <b>Зберегти</b>.
        <br>Дані пишуться в <b>stageResults</b>, тому <b>LIVE</b> має їх бачити.
      </div>

      <div class="hr"></div>

      <div class="row">
        <div style="flex:2 1 320px">
          <div class="muted" style="margin-bottom:6px;">Етап (stageResults)</div>
          <select id="stageSelect"></select>
        </div>

        <div style="flex:1 1 200px">
          <div class="muted" style="margin-bottom:6px;">Номер зважування</div>
          <select id="weighNo">
            <option value="0">W1</option>
            <option value="1">W2</option>
            <option value="2">W3</option>
            <option value="3" selected>W4</option>
            <option value="4">W5</option>
            <option value="5">W6</option>
            <option value="6">W7</option>
            <option value="7">W8</option>
            <option value="8">W9</option>
          </select>
        </div>
      </div>

      <div class="btnline">
        <button class="btn btn--accent" id="btnLoad">Завантажити таблиці</button>
        <button class="btn btn--primary" id="btnReload">Оновити список етапів</button>
      </div>

      <div id="msg" class="muted" style="margin-top:10px;"></div>
      <div id="dbg" class="muted" style="margin-top:6px; white-space:pre-wrap;"></div>
    </div>

    <div id="zonesWrap"></div>

  </section>
</main>

<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<!-- init -->
<script src="assets/js/firebase-init.js"></script>

<script>
(function(){
  "use strict";

  const $ = (id)=>document.getElementById(id);
  const msgEl = $("msg");
  const dbgEl = $("dbg");

  const stageSelect = $("stageSelect");
  const weighNoSel  = $("weighNo");
  const zonesWrap   = $("zonesWrap");

  function esc(s){ return String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
  function setMsg(t, ok=true){
    msgEl.textContent = t || "";
    msgEl.className = "muted " + (t ? (ok ? "ok" : "err") : "");
  }
  function setDbg(t){ dbgEl.textContent = t || ""; }

  function toNum(x){
    const v = Number(String(x||"").replace(",", "."));
    return Number.isFinite(v) ? v : 0;
  }

  async function waitFirebase(maxMs=12000){
    const t0 = Date.now();
    while(Date.now()-t0 < maxMs){
      if(window.scAuth && window.scDb && window.firebase) return;
      await new Promise(r=>setTimeout(r,100));
    }
    throw new Error("Firebase not ready (scAuth/scDb).");
  }

  // доступ: admin або judge (під себе можеш лишити тільки admin)
  async function requireRole(user){
    const db = window.scDb;
    const snap = await db.collection("users").doc(user.uid).get();
    const role = (snap.exists ? (snap.data()||{}).role : "") || "";
    return (role === "admin" || role === "judge");
  }

  // ---------- Stage list ----------
  async function loadStageResultsList(){
    const db = window.scDb;
    stageSelect.innerHTML = `<option value="">Завантаження…</option>`;

    const snap = await db.collection("stageResults").get();
    const items = snap.docs.map(d=>{
      const x = d.data() || {};
      return {
        id: d.id,
        name: x.stageName || x.name || x.title || d.id,
        compId: x.compId || "",
        stageKey: x.stageKey || x.stageId || ""
      };
    });

    items.sort((a,b)=> (a.name||"").localeCompare(b.name||"","uk"));

    stageSelect.innerHTML =
      `<option value="">— Обери етап —</option>` +
      items.map(it=>{
        const label = it.name;
        return `<option value="${esc(it.id)}">${esc(label)}</option>`;
      }).join("");
  }

  // ---------- Rendering ----------
  function splitZones(teams){
    const zones = { A:[], B:[], C:[] };
    (teams||[]).forEach(t=>{
      const z = String(t.zone || "").toUpperCase();
      if(zones[z]) zones[z].push(t);
    });
    // сортуємо по сектору (якщо A4/B5 — то по числу)
    ["A","B","C"].forEach(z=>{
      zones[z].sort((x,y)=>{
        const sx = String(x.sector||"");
        const sy = String(y.sector||"");
        // витягаємо число
        const nx = Number((sx.match(/\d+/)||["0"])[0]);
        const ny = Number((sy.match(/\d+/)||["0"])[0]);
        return nx-ny || sx.localeCompare(sy,"uk");
      });
    });
    return zones;
  }

  function ensureFishStruct(team){
    // fish = [ [..], [..], ... ] (до 9)
    if(!Array.isArray(team.fish)) team.fish = [];
    for(let i=0;i<9;i++){
      if(!Array.isArray(team.fish[i])) team.fish[i] = [];
    }
    // weights = [sumW1..] (до 9)
    if(!Array.isArray(team.weights)) team.weights = [];
    for(let i=0;i<9;i++){
      if(typeof team.weights[i] !== "number") team.weights[i] = 0;
    }
  }

  function calcSums(team){
    ensureFishStruct(team);
    for(let i=0;i<9;i++){
      team.weights[i] = (team.fish[i] || []).reduce((s,v)=>s + toNum(v), 0);
    }
    team.totalWeight = team.weights.reduce((s,v)=>s + toNum(v), 0);
  }

  function renderZoneTable(zone, teams, wIndex, stageId){
    const countBadge = teams.length ? `команд: ${teams.length}` : `нема даних`;

    const rows = teams.map(t=>{
      const teamId = t.teamId || t.id || "";
      const sector = t.sector || "";
      const name   = t.team || t.teamName || t.name || "Команда";

      ensureFishStruct(t);
      calcSums(t);

      const fishArr = t.fish[wIndex] || [];
      const sumW = t.weights[wIndex] || 0;

      return `
        <tr data-team="${esc(teamId)}" data-zone="${esc(zone)}">
          <td class="sector"><b>${esc(sector)}</b><small>${esc(zone)}</small></td>
          <td class="teamcol"><b>${esc(name)}</b><small>${esc(teamId)}</small></td>

          <td class="fishcol">
            <div class="fishList" data-fishlist>
              ${fishArr.map((v,idx)=>`
                <input class="fishInput" inputmode="decimal" placeholder="0.000"
                  value="${esc((Number(v)||0).toFixed(3))}"
                  data-fish="${idx}" />
              `).join("")}
              <span class="miniBtn" data-add title="Додати рибу">+</span>
              <span class="miniBtn miniBtn--ghost" data-clear title="Очистити W">⟲</span>
            </div>
            <small class="muted">Вводиш вагу → Enter / вихід з поля → Зберегти</small>
          </td>

          <td class="sumcol right">
            <b data-sum>${sumW.toFixed(3)}</b>
            <small>W${wIndex+1}</small>
            <div class="muted" style="margin-top:4px;">Загалом: <b>${(t.totalWeight||0).toFixed(3)}</b></div>
          </td>

          <td class="actcol">
            <button class="btn btn--accent" type="button" data-save>Зберегти</button>
            <div class="muted" data-status style="margin-top:6px;"></div>
          </td>
        </tr>
      `;
    }).join("");

    return `
      <div class="card">
        <div class="zoneTitle">
          <div>Зона ${esc(zone)} — W${wIndex+1}</div>
          <div class="badge">${esc(countBadge)}</div>
        </div>

        ${teams.length ? `
          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th class="sector">Сектор</th>
                  <th class="teamcol">Команда</th>
                  <th class="fishcol">Риба (натискай “+”)</th>
                  <th class="sumcol right">Сума</th>
                  <th class="actcol">Дія</th>
                </tr>
              </thead>
              <tbody>
                ${rows}
              </tbody>
            </table>
          </div>
        ` : `
          <div class="muted">Результати для цієї зони ще не заповнені.</div>
        `}
      </div>
    `;
  }

  async function renderAll(stageDocId, stageData){
    const wIndex = Number(weighNoSel.value || 0);

    const teams = Array.isArray(stageData.teams) ? stageData.teams : [];
    if(!teams.length){
      zonesWrap.innerHTML = `<div class="card"><div class="err">Нема команд у stageResults/${esc(stageDocId)} (поле teams[] пусте).</div></div>`;
      return;
    }

    // ensure structure
    teams.forEach(t=>{ ensureFishStruct(t); calcSums(t); });

    const zones = splitZones(teams);

    zonesWrap.innerHTML =
      renderZoneTable("A", zones.A, wIndex, stageDocId) +
      renderZoneTable("B", zones.B, wIndex, stageDocId) +
      renderZoneTable("C", zones.C, wIndex, stageDocId);

    // навішуємо дії на таблиці
    zonesWrap.querySelectorAll("tr[data-team]").forEach(tr=>{
      const teamId = tr.getAttribute("data-team") || "";
      const zone   = tr.getAttribute("data-zone") || "";
      const stEl   = tr.querySelector("[data-status]");
      const sumEl  = tr.querySelector("[data-sum]");
      const fishWrap = tr.querySelector("[data-fishlist]");
      const btnAdd  = tr.querySelector("[data-add]");
      const btnClear= tr.querySelector("[data-clear]");
      const btnSave = tr.querySelector("[data-save]");

      // знаходимо team у локальних teams[]
      const teamObj = teams.find(x => (x.teamId||x.id||"") === teamId);
      if(!teamObj) return;

      function refreshRow(){
        calcSums(teamObj);
        if(sumEl) sumEl.textContent = (teamObj.weights[wIndex]||0).toFixed(3);

        // перечитати inputs → fish
        const inputs = [...fishWrap.querySelectorAll("input[data-fish]")];
        const arr = inputs.map(i => toNum(i.value)).filter(v=>v>0);
        teamObj.fish[wIndex] = arr;
        calcSums(teamObj);
        if(sumEl) sumEl.textContent = (teamObj.weights[wIndex]||0).toFixed(3);
      }

      // add new fish input
      btnAdd.onclick = ()=>{
        const idx = fishWrap.querySelectorAll("input[data-fish]").length;
        const inp = document.createElement("input");
        inp.className = "fishInput";
        inp.setAttribute("inputmode","decimal");
        inp.setAttribute("placeholder","0.000");
        inp.setAttribute("data-fish", String(idx));
        inp.value = "";
        fishWrap.insertBefore(inp, btnAdd);

        inp.addEventListener("change", ()=>{ refreshRow(); });
        inp.addEventListener("blur", ()=>{ refreshRow(); });
        inp.addEventListener("keydown", (e)=>{
          if(e.key === "Enter"){ e.preventDefault(); inp.blur(); }
        });

        inp.focus();
      };

      // clear W
      btnClear.onclick = ()=>{
        teamObj.fish[wIndex] = [];
        calcSums(teamObj);

        // видалити всі inputs і лишити 0
        fishWrap.querySelectorAll("input[data-fish]").forEach(x=>x.remove());
        if(sumEl) sumEl.textContent = "0.000";
        if(stEl){ stEl.textContent = "Очищено локально"; stEl.className="muted"; }
      };

      // on change existing inputs
      fishWrap.querySelectorAll("input[data-fish]").forEach(inp=>{
        inp.addEventListener("change", ()=>{ refreshRow(); });
        inp.addEventListener("blur", ()=>{ refreshRow(); });
        inp.addEventListener("keydown", (e)=>{
          if(e.key === "Enter"){ e.preventDefault(); inp.blur(); }
        });
      });

      // save to Firestore
      btnSave.onclick = async ()=>{
        try{
          if(stEl){ stEl.textContent="Збереження…"; stEl.className="muted"; }

          refreshRow();

          // оновлюємо teams[] і пишемо в stageResults
          const db = window.scDb;
          const ref = db.collection("stageResults").doc(stageDocId);

          // ВАЖЛИВО: пишемо всю команду назад у teams[] (з оновленими fish/weights/totalWeight)
          await ref.update({ teams });

          if(stEl){ stEl.textContent="✅ Збережено (LIVE має бачити)"; stEl.className="muted ok"; }
          setMsg("✅ Збережено у stageResults (LIVE має підтягнути).", true);
        }catch(e){
          if(stEl){ stEl.textContent="❌ Помилка збереження"; stEl.className="muted err"; }
          setMsg("❌ Помилка. Дивись Debug.", false);
          setDbg("SAVE ERROR:\n" + (e?.message || String(e)));
        }
      };
    });
  }

  // ---------- Load stage doc ----------
  async function loadAndBuild(){
    const stageId = String(stageSelect.value||"").trim();
    if(!stageId) return setMsg("Обери етап.", false);

    try{
      setMsg("Завантажую stageResults…", true);
      setDbg("");

      const db = window.scDb;
      const doc = await db.collection("stageResults").doc(stageId).get();
      if(!doc.exists){
        setMsg("Нема stageResults/" + stageId, false);
        return;
      }

      const data = doc.data() || {};
      await renderAll(stageId, data);

      setMsg("✅ Таблиці готові. Працюй з рибою через “+” і Зберегти.", true);
    }catch(e){
      setMsg("❌ Помилка завантаження. Дивись Debug.", false);
      setDbg("LOAD ERROR:\n" + (e?.message || String(e)));
    }
  }

  // ---------- INIT ----------
  async function init(){
    try{
      await waitFirebase();

      const auth = window.scAuth;
      auth.onAuthStateChanged(async (user)=>{
        if(!user){
          setMsg("Увійди як адмін/суддя.", false);
          return;
        }

        const ok = await requireRole(user);
        if(!ok){
          setMsg("Доступ заборонено ❌ (нема ролі admin/judge).", false);
          return;
        }

        await loadStageResultsList();
        setMsg("Обери етап та W → натисни “Завантажити таблиці”.", true);
      });

      $("btnLoad").onclick = loadAndBuild;
      $("btnReload").onclick = async ()=>{
        setMsg("Оновлюю список…", true);
        await loadStageResultsList();
        setMsg("✅ Оновлено список етапів.", true);
      };

      // якщо змінили W — перерендер з поточного doc (не ліземо в Firestore, якщо ще не завантажено)
      weighNoSel.onchange = ()=>{
        // просто підказка, щоб ти натиснув завантажити заново
        setMsg("Змінився номер W. Натисни “Завантажити таблиці”.", true);
      };

    }catch(e){
      setMsg("Firebase не піднявся ❌", false);
      setDbg(e?.message || String(e));
    }
  }

  window.addEventListener("error", (e)=>{
    setMsg("JS помилка ❌", false);
    setDbg(e?.message || "error");
  });
  window.addEventListener("unhandledrejection", (e)=>{
    setMsg("Promise помилка ❌", false);
    setDbg(e?.reason?.message || String(e?.reason || "promise"));
  });

  init();
})();
</script>

</body>
</html>
