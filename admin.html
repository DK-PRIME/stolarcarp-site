<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>STOLAR CARP • Адмінка</title>

  <link rel="stylesheet" href="assets/css/main.css">

  <style>
    body{ background: radial-gradient(circle at top,#111827 0,#020617 55%); }
    .admin-wrap{ max-width:980px; margin:0 auto; padding:22px 0 70px; }

    .admin-top{
      padding:14px 16px; border-radius:18px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.35);
      box-shadow:0 18px 40px rgba(0,0,0,.6);
    }
    .muted{ color:#9ca3af; }
    .admin-hidden{ display:none; }

    .admin-card{
      margin-top:14px;
      padding:16px;
      border-radius:18px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.35);
      box-shadow:0 18px 40px rgba(0,0,0,.6);
    }

    .stack{ display:flex; flex-direction:column; gap:10px; }
    .stack .btn{
      width:100%;
      justify-content:center;
      padding:12px 14px;
      border-radius:14px;
    }

    .mini-form{
      margin-top:12px;
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    .mini-form input, .mini-form select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,.35);
      background:rgba(2,6,23,.55);
      color:#e5e7eb;
      outline:none;
    }
    .mini-form input::placeholder{ color:#6b7280; }

    .hr{ height:1px; background:rgba(148,163,184,.18); margin:12px 0; border-radius:99px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(148,163,184,.35);
      background:rgba(2,6,23,.4);
      color:#e5e7eb;
      font-size:.85rem;
    }
    .pill strong{ color:#facc15; font-weight:700; }
  </style>
</head>

<body>

<header class="header">
  <div class="container header__row">
    <a class="logo" href="index.html">
      <span class="logo__mark">SC</span>
      <span class="logo__text">STOLAR CARP</span>
    </a>
    <nav class="nav">
      <a href="/index.html" class="nav__link">Головна</a>
      <a href="/live.html" class="nav__link">Live</a>
      <a href="/rating.html" class="nav__link">Рейтинг</a>
      <a href="/cabinet.html" class="nav__link">Мій кабінет</a>
    </nav>
  </div>
</header>

<main class="main">
  <section class="section container admin-wrap">

    <div class="admin-top">
      <div class="title-gradient" style="font-size:1.2rem; font-weight:800;">Адмінка STOLAR CARP</div>
      <div class="muted" id="adminStatus">Запуск…</div>
      <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
        <div class="pill"><strong>Реєстрація</strong> працює через competitions</div>
        <div class="pill"><strong>Час</strong> відкриття/закриття = 12:00 (Київ)</div>
      </div>
    </div>

    <!-- LOGIN -->
    <div id="adminLogin" class="admin-card admin-hidden">
      <h2 class="section-title" style="margin:0 0 10px;">Вхід адміністратора</h2>
      <div class="muted">Увійди email/паролем адмін-акаунта. Реєстрації тут немає.</div>

      <div class="row" style="margin-top:12px;">
        <input id="admEmail" type="email" placeholder="Email"
          style="flex:1; min-width:220px; padding:10px 12px; border-radius:12px; border:1px solid rgba(148,163,184,.35); background:rgba(2,6,23,.55); color:#e5e7eb;">
        <input id="admPass" type="password" placeholder="Пароль"
          style="flex:1; min-width:220px; padding:10px 12px; border-radius:12px; border:1px solid rgba(148,163,184,.35); background:rgba(2,6,23,.55); color:#e5e7eb;">
        <button class="btn btn--accent" id="btnAdminLogin">Увійти</button>
      </div>

      <div class="muted" id="adminLoginMsg" style="margin-top:10px;"></div>
    </div>

    <!-- APP -->
    <div id="adminApp" class="admin-hidden">

      <!-- ПАНЕЛЬ -->
      <div class="admin-card">
        <h2 class="section-title" style="margin:0 0 8px;">Панель</h2>
        <div class="muted">Тут: створення змагання (сезон або одноразове) + керування реєстрацією.</div>

        <div class="hr"></div>

        <div class="stack">
          <button class="btn btn--primary" id="btnOpenCreate">1) Створити змагання</button>
          <button class="btn btn--accent"  id="btnOpenReg">2) Відкрити / закрити реєстрацію</button>

          <a class="btn btn--primary" href="admin-registrations.html">3) Реєстрація команд</a>
          <a class="btn btn--accent"  href="admin-draw.html">4) Жеребкування</a>
          <a class="btn btn--danger"  href="admin-weigh.html">5) Зважування (судді/адмін)</a>
        </div>

        <div class="muted" style="margin-top:10px;">
          AUTO — працює по датах (12:00). MANUAL — відкриття/закриття вручну.
        </div>
      </div>

      <!-- 1) CREATE -->
      <div class="admin-card admin-hidden" id="modCreate">
        <h2 class="section-title" style="margin:0 0 8px;">Створити змагання</h2>
        <div class="muted">Пише в <b>competitions</b> і може зробити змагання активним у <b>settings/app</b>.</div>

        <div class="mini-form">
          <select id="inpType">
            <option value="season">Тип: СЕЗОН (з етапами + фінал опційно)</option>
            <option value="single">Тип: ОДНОРАЗОВЕ змагання</option>
          </select>

          <input id="inpYear" type="number" min="2025" step="1" placeholder="Рік (наприклад: 2026)" />

          <input id="inpName" placeholder="Бренд/серія (наприклад: STOLAR CARP)" />
          <input id="inpTitle" placeholder="Назва змагання (наприклад: Season 2026 / Осінній короп / Stalker)" />

          <select id="inpStagesCount">
            <option value="2">К-сть етапів у сезоні: 2</option>
            <option value="3" selected>К-сть етапів у сезоні: 3</option>
            <option value="4">К-сть етапів у сезоні: 4</option>
            <option value="5">К-сть етапів у сезоні: 5</option>
            <option value="6">К-сть етапів у сезоні: 6</option>
            <option value="7">К-сть етапів у сезоні: 7</option>
            <option value="8">К-сть етапів у сезоні: 8</option>
          </select>

          <select id="inpHasFinal">
            <option value="yes" selected>Фінал: ТАК</option>
            <option value="no">Фінал: НІ</option>
          </select>

          <div class="muted" style="margin-top:6px;">
            Реєстрація (дата, час автоматично = <b>12:00</b> Київ)
          </div>
          <input id="inpRegOpenDate" type="date" />
          <input id="inpRegCloseDate" type="date" />

          <select id="inpRegMode">
            <option value="auto">Режим реєстрації: AUTO (по даті)</option>
            <option value="manual">Режим реєстрації: MANUAL (вручну)</option>
          </select>
        </div>

        <div class="stack" style="margin-top:12px;">
          <button class="btn btn--accent" id="btnDoCreate">Зберегти змагання</button>
          <button class="btn btn--primary" id="btnSetActive">Зробити активним</button>
        </div>

        <div class="muted" id="createMsg" style="margin-top:10px;"></div>
      </div>

      <!-- 2) REG -->
      <div class="admin-card admin-hidden" id="modReg">
        <h2 class="section-title" style="margin:0 0 8px;">Реєстрація: відкрити / закрити</h2>
        <div class="muted">Вибери змагання зі списку → AUTO/Manual статус + ручне відкриття/закриття.</div>

        <div class="mini-form">
          <select id="selComp"></select>
          <div class="muted" id="regInfo">Завантаження…</div>

          <div class="stack">
            <button class="btn btn--accent" id="btnManualOpen">ВІДКРИТИ вручну</button>
            <button class="btn btn--danger" id="btnManualClose">ЗАКРИТИ вручну</button>
            <button class="btn btn--primary" id="btnSyncActive">Зробити вибране активним</button>
          </div>
        </div>

        <div class="muted" id="regMsg" style="margin-top:10px;"></div>
      </div>

    </div>
  </section>
</main>

<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<!-- Єдиний init -->
<script src="assets/js/firebase-init.js"></script>

<script>
  const ADMIN_UID = "5Dt6fN64c3aWACYV1WacxV2BHDl2";

  const $ = (id)=>document.getElementById(id);
  const show = (el)=>el && el.classList.remove("admin-hidden");
  const hide = (el)=>el && el.classList.add("admin-hidden");
  const setStatus = (t)=>{ const e=$("adminStatus"); if(e) e.textContent=t; };

  const modCreate = $("modCreate");
  const modReg    = $("modReg");

  function openModule(name){
    hide(modCreate); hide(modReg);
    if(name==="create") show(modCreate);
    if(name==="reg") show(modReg);
  }

  async function waitForFirebase(){
    for(let i=0;i<120;i++){
      if(window.scAuth && window.scDb && window.firebase) return;
      await new Promise(r=>setTimeout(r,100));
    }
    throw new Error("Firebase НЕ ініціалізований (scAuth / scDb)");
  }

  function noonKyivFromDateInput(dateStr){
    // Працює як "локальний час браузера". Для України = Київ.
    // Рівно 12:00 за вибраною датою.
    if(!dateStr) return null;
    return new Date(dateStr + "T12:00:00");
  }
  function toTS(d){
    return d ? window.firebase.firestore.Timestamp.fromDate(d) : null;
  }
  function esc(s){
    return String(s||"").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }

  async function init(){
    await waitForFirebase();
    const auth = window.scAuth;
    const db   = window.scDb;

    const loginBox = $("adminLogin");
    const appBox   = $("adminApp");
    const btnLogin = $("btnAdminLogin");
    const msg      = $("adminLoginMsg");

    function showLogin(text){
      hide(appBox);
      show(loginBox);
      if(msg) msg.textContent = text || "";
    }
    function showApp(){
      hide(loginBox);
      show(appBox);
    }

    $("btnOpenCreate").onclick = ()=>openModule("create");
    $("btnOpenReg").onclick    = async ()=>{ openModule("reg"); await loadCompetitions(); };

    // toggle season-only fields
    const inpType = $("inpType");
    const inpStagesCount = $("inpStagesCount");
    const inpHasFinal = $("inpHasFinal");
    function applyTypeUI(){
      const t = inpType.value;
      const isSeason = (t === "season");
      inpStagesCount.style.display = isSeason ? "" : "none";
      inpHasFinal.style.display    = isSeason ? "" : "none";
    }
    inpType.onchange = applyTypeUI;
    applyTypeUI();

    if(btnLogin){
      btnLogin.onclick = async () => {
        const email = $("admEmail").value.trim();
        const pass  = $("admPass").value.trim();
        if(!email || !pass){ msg.textContent = "Введи email і пароль"; return; }
        msg.textContent = "Вхід…";
        try{ await auth.signInWithEmailAndPassword(email, pass); }
        catch(e){ msg.textContent = e?.message || "Помилка входу"; }
      };
    }

    auth.onAuthStateChanged(async (user) => {
      if(!user){
        setStatus("Потрібен вхід (адмін)");
        showLogin("Увійди як адміністратор");
        return;
      }

      if(user.uid !== ADMIN_UID){
        setStatus("Доступ заборонено ❌");
        showLogin("Цей акаунт не має доступу");
        return;
      }

      setStatus("Адмін-доступ дозволено ✅");
      showApp();
      openModule("create");
      await loadCompetitions();
    });

    // CREATE COMPETITION
    $("btnDoCreate").onclick = async ()=>{
      const type  = $("inpType").value; // season | single
      const year  = Number(($("inpYear").value || "").trim());
      const name  = ($("inpName").value || "").trim();
      const title = ($("inpTitle").value || "").trim();

      const stagesCount = Number($("inpStagesCount").value || "0");
      const hasFinal = ($("inpHasFinal").value === "yes");

      const regMode = $("inpRegMode").value; // auto | manual
      const openD = noonKyivFromDateInput(($("inpRegOpenDate").value || "").trim());
      const closeD = noonKyivFromDateInput(($("inpRegCloseDate").value || "").trim());

      const out = $("createMsg");
      out.textContent = "";

      if(!year || year < 2025){
        out.textContent = "Вкажи коректний рік (наприклад 2026).";
        return;
      }
      if(!name){
        out.textContent = "Вкажи бренд/серію (наприклад STOLAR CARP).";
        return;
      }
      if(!title){
        out.textContent = "Вкажи назву змагання (наприклад Season 2026 / Осінній короп / Stalker).";
        return;
      }
      if(type === "season" && (!stagesCount || stagesCount < 2 || stagesCount > 8)){
        out.textContent = "Для сезону вибери к-сть етапів (2–8).";
        return;
      }
      if(!openD || !closeD){
        out.textContent = "Вкажи дати відкриття та закриття реєстрації.";
        return;
      }
      if(closeD.getTime() <= openD.getTime()){
        out.textContent = "Дата закриття має бути пізніше дати відкриття.";
        return;
      }

      out.textContent = "Збереження…";

      try{
        // зрозумілий ID (щоб потім легко читати)
        // season: season-2026, single: single-2026-osinniy-korop
        const slug = title
          .toLowerCase()
          .replace(/['"`]/g,"")
          .replace(/[^a-z0-9\u0400-\u04FF]+/g,"-")
          .replace(/^-+|-+$/g,"")
          .slice(0,60);

        const compId = (type === "season")
          ? `season-${year}`
          : `single-${year}-${slug || "event"}`;

        const payload = {
          type,
          year,
          name,
          title,

          stagesCount: (type === "season") ? stagesCount : 0,
          hasFinal: (type === "season") ? !!hasFinal : false,

          regMode,
          manualOpen: false,
          regOpenAt: toTS(openD),
          regCloseAt: toTS(closeD),

          updatedAt: window.firebase.firestore.FieldValue.serverTimestamp(),
          createdAt: window.firebase.firestore.FieldValue.serverTimestamp()
        };

        await db.collection("competitions").doc(compId).set(payload, { merge:true });

        out.textContent = `✅ Збережено: ${compId}. (Відкриття/закриття = 12:00)`;
        await loadCompetitions(true);

      }catch(e){
        console.error(e);
        out.textContent = "❌ Помилка: " + (e.message || e);
      }
    };

    // SET ACTIVE
    $("btnSetActive").onclick = async ()=>{
      const type  = $("inpType").value;
      const year  = Number(($("inpYear").value || "").trim());
      const title = ($("inpTitle").value || "").trim();

      const out = $("createMsg");
      if(!year || !title){
        out.textContent = "Спочатку заповни рік і назву (або збережи змагання).";
        return;
      }

      const slug = title
        .toLowerCase()
        .replace(/['"`]/g,"")
        .replace(/[^a-z0-9\u0400-\u04FF]+/g,"-")
        .replace(/^-+|-+$/g,"")
        .slice(0,60);

      const compId = (type === "season")
        ? `season-${year}`
        : `single-${year}-${slug || "event"}`;

      out.textContent = "Оновлення settings/app…";

      try{
        await db.collection("settings").doc("app").set({
          activeCompetitionId: compId,
          updatedAt: window.firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });

        out.textContent = "✅ Активне змагання встановлено: " + compId;
        await loadCompetitions(true);
      }catch(e){
        console.error(e);
        out.textContent = "❌ Помилка: " + (e.message || e);
      }
    };

    // MANUAL TOGGLE
    $("btnManualOpen").onclick  = async ()=>manualToggle(true);
    $("btnManualClose").onclick = async ()=>manualToggle(false);
    $("btnSyncActive").onclick  = async ()=>{
      const sel = $("selComp");
      const compId = (sel && sel.value) ? sel.value : "";
      const out = $("regMsg");
      if(!compId){ out.textContent = "Нема вибраного змагання."; return; }
      out.textContent = "Оновлення settings/app…";
      try{
        await db.collection("settings").doc("app").set({
          activeCompetitionId: compId,
          updatedAt: window.firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
        out.textContent = "✅ Активне змагання: " + compId;
        await loadCompetitions(true);
      }catch(e){
        console.error(e);
        out.textContent = "❌ Помилка: " + (e.message || e);
      }
    };

    async function manualToggle(open){
      const sel = $("selComp");
      const compId = (sel && sel.value) ? sel.value : "";
      const out = $("regMsg");
      if(!compId){ out.textContent = "Нема вибраного змагання."; return; }

      out.textContent = open ? "Відкриваю…" : "Закриваю…";

      try{
        await db.collection("competitions").doc(compId).set({
          regMode: "manual",
          manualOpen: !!open,
          updatedAt: window.firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });

        // (опційно) дублюємо в settings для швидкого читання
        await db.collection("settings").doc("app").set({
          activeCompetitionId: compId,
          regMode: "manual",
          manualOpen: !!open,
          registrationOpen: !!open,
          updatedAt: window.firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });

        out.textContent = "✅ " + (open ? "Реєстрація ВІДКРИТА (MANUAL)" : "Реєстрація ЗАКРИТА (MANUAL)");
        await loadCompetitions(true);
      }catch(e){
        console.error(e);
        out.textContent = "❌ Помилка: " + (e.message || e);
      }
    }

    // LOAD competitions
    async function loadCompetitions(keepSelected){
      const sel = $("selComp");
      const info = $("regInfo");
      const out = $("regMsg");
      if(!sel) return;

      sel.innerHTML = `<option value="">Завантаження…</option>`;
      info.textContent = "Завантаження…";
      out.textContent = "";

      let activeId = null;
      try{
        const s = await db.collection("settings").doc("app").get();
        if(s.exists){
          const d = s.data() || {};
          activeId = d.activeCompetitionId || null;
        }
      }catch(_){}

      const prev = keepSelected ? sel.value : "";

      const snap = await db.collection("competitions").get();
      const list = [];
      snap.forEach(doc => {
        const d = doc.data() || {};
        list.push({
          id: doc.id,
          type: d.type || "single",
          year: d.year || 0,
          name: d.name || "",
          title: d.title || doc.id,
          stagesCount: d.stagesCount || 0,
          hasFinal: !!d.hasFinal,
          regMode: d.regMode || "auto",
          manualOpen: !!d.manualOpen,
          openAt: d.regOpenAt ? d.regOpenAt.toDate() : null,
          closeAt: d.regCloseAt ? d.regCloseAt.toDate() : null
        });
      });

      if(!list.length){
        sel.innerHTML = `<option value="">Нема змагань. Спочатку створи.</option>`;
        info.textContent = "Нема даних";
        return;
      }

      list.sort((a,b)=>{
        // новіші роки першими, потім сезон перед single, потім назва
        if(b.year !== a.year) return b.year - a.year;
        if(a.type !== b.type) return (a.type === "season") ? -1 : 1;
        return (a.title || "").localeCompare(b.title || "", "uk");
      });

      sel.innerHTML = list.map(o=>{
        const isActive = (o.id === activeId);
        const labelCore = `${o.year} · ${o.name} · ${o.title}`;
        const extra = (o.type === "season")
          ? ` · етапів: ${o.stagesCount}${o.hasFinal ? " + фінал" : ""}`
          : "";
        return `<option value="${esc(o.id)}" ${isActive ? "selected":""}>${isActive ? "✅ " : ""}${esc(labelCore + extra)}</option>`;
      }).join("");

      // restore selection
      if(prev && list.some(x=>x.id===prev)) sel.value = prev;

      function renderInfo(){
        const compId = sel.value || list[0].id;
        const o = list.find(x=>x.id===compId) || list[0];
        const now = new Date();

        let autoState = "AUTO: —";
        if(o.openAt && o.closeAt){
          autoState = (now >= o.openAt && now <= o.closeAt) ? "AUTO: відкрита" : "AUTO: закрита";
        }

        const parts = [];
        parts.push(`Тип: ${o.type === "season" ? "СЕЗОН" : "ОДНОРАЗОВЕ"}`);
        parts.push(`Режим: ${String(o.regMode||"").toUpperCase()}`);
        if(o.regMode === "manual") parts.push(`MANUAL: ${o.manualOpen ? "відкрита" : "закрита"}`);
        if(o.openAt)  parts.push(`Відкриття: ${o.openAt.toLocaleString("uk-UA")}`);
        if(o.closeAt) parts.push(`Закриття: ${o.closeAt.toLocaleString("uk-UA")}`);
        parts.push(autoState);

        info.textContent = parts.join(" · ");
      }

      sel.onchange = renderInfo;
      renderInfo();
    }
  }

  init().catch(err=>{
    console.error(err);
    setStatus("Помилка: " + err.message);
  });
</script>

</body>
</html>
