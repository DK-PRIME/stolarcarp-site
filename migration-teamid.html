async function fixAllTeamIds() {
  const db = firebase.firestore();

  console.log("ðŸš€ ÐŸÐ¾Ñ‡Ð¸Ð½Ð°ÑŽ Ð¿Ð¾Ð²Ð½Ñƒ Ð¼Ñ–Ð³Ñ€Ð°Ñ†Ñ–ÑŽ teamIdâ€¦");

  // ========== 1. Ð—Ð‘Ð˜Ð ÐÐ„ÐœÐž Ð’Ð¡Ð† ÐšÐžÐœÐÐÐ”Ð˜ ==========
  const teamsSnap = await db.collection("teams").get();
  const teamsByOwner = new Map();   // ownerUid -> {teamId, name, joinCode}
  const teamsByName = new Map();    // normalized name -> teamId
  const teamsById = new Map();      // teamId -> team data
  const teamsByNameStrict = new Map(); // Ð¾Ñ€Ð¸Ð³Ñ–Ð½Ð°Ð»ÑŒÐ½Ð° Ð½Ð°Ð·Ð²Ð° -> teamId (Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ¸)

  teamsSnap.forEach(doc => {
    const data = doc.data();
    const teamId = doc.id;

    teamsById.set(teamId, { ...data, teamId });

    if (data.ownerUid) {
      teamsByOwner.set(data.ownerUid, { teamId, name: data.name, joinCode: data.joinCode });
    }
    
    if (data.name) {
      const originalName = data.name.trim();
      const normalizedName = originalName.toLowerCase();
      const noSpaces = normalizedName.replace(/\s+/g, '');
      const noDashes = normalizedName.replace(/-/g, ' ');
      
      teamsByNameStrict.set(originalName.toLowerCase(), teamId);
      teamsByName.set(normalizedName, teamId);
      teamsByName.set(noSpaces, teamId);
      teamsByName.set(noDashes, teamId);
    }
    
    if (data.joinCode) {
      teamsByName.set(data.joinCode.toLowerCase(), teamId);
    }
  });

  console.log(`ðŸ“Œ Ð—Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ ÐºÐ¾Ð¼Ð°Ð½Ð´: ${teamsByOwner.size}`);
  console.log(`ðŸ“Œ Ð£Ð½Ñ–ÐºÐ°Ð»ÑŒÐ½Ð¸Ñ… Ð½Ð°Ð·Ð² (Ð½Ð¾Ñ€Ð¼Ð°Ð»Ñ–Ð·Ð¾Ð²Ð°Ð½Ð¸Ñ…): ${teamsByName.size}`);

  let updateCount = 0;
  let consistencyWarnings = 0;
  const errors = [];
  const warnings = [];

  // ========== 2. Ð’Ð˜ÐŸÐ ÐÐ’Ð›Ð¯Ð„ÐœÐž USERS ==========
  console.log("\nðŸ‘¥ ÐžÐ±Ñ€Ð¾Ð±Ð»ÑÑŽ usersâ€¦");
  const usersSnap = await db.collection("users").get();
  
  for (const userDoc of usersSnap.docs) {
    try {
      const userId = userDoc.id;
      const data = userDoc.data();
      let correctedTeamId = null;
      let correctionReason = "";
      let consistencyCheck = null;

      // Ð¡Ñ‚Ñ€Ð°Ñ‚ÐµÐ³Ñ–Ñ 1: ÐšÐ°Ð¿Ñ–Ñ‚Ð°Ð½ â†’ Ð¿Ð¾ ownerUid
      if (data.role === "captain") {
        if (teamsByOwner.has(userId)) {
          correctedTeamId = teamsByOwner.get(userId).teamId;
          correctionReason = "ownerUid match";
          
          // ðŸ”¥ ÐŸÐ•Ð Ð•Ð’Ð†Ð ÐšÐ: Ñ‡Ð¸ ÑÐ¿Ñ–Ð²Ð¿Ð°Ð´Ð°Ñ” teamName ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ð° Ð· Ð½Ð°Ð·Ð²Ð¾ÑŽ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð¸
          const teamInfo = teamsByOwner.get(userId);
          if (data.teamName && data.teamName.trim().toLowerCase() !== teamInfo.name.toLowerCase()) {
            consistencyCheck = {
              type: "teamName_mismatch",
              userTeamName: data.teamName,
              actualTeamName: teamInfo.name,
              suggestion: `ÐžÐ½Ð¾Ð²Ð¸Ñ‚Ð¸ teamName Ð½Ð° "${teamInfo.name}"`
            };
            warnings.push({
              user: userId,
              name: data.fullName,
              issue: `teamName "${data.teamName}" â‰  ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ– "${teamInfo.name}"`
            });
          }
        }
      }
      
      // Ð¡Ñ‚Ñ€Ð°Ñ‚ÐµÐ³Ñ–Ñ 2: Ð£Ñ‡Ð°ÑÐ½Ð¸Ðº â†’ Ð¿Ð¾ teamName
      if (!correctedTeamId && data.teamName) {
        const key = data.teamName.trim().toLowerCase();
        const keyNoSpaces = key.replace(/\s+/g, '');
        const keyNoDashes = key.replace(/-/g, ' ');
        
        correctedTeamId = teamsByName.get(key) || 
                         teamsByName.get(keyNoSpaces) || 
                         teamsByName.get(keyNoDashes);
        
        if (correctedTeamId) correctionReason = "teamName match";
      }

      // Ð¡Ñ‚Ñ€Ð°Ñ‚ÐµÐ³Ñ–Ñ 3: ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ñ‡Ð¸ Ð¿Ð¾Ñ‚Ð¾Ñ‡Ð½Ð¸Ð¹ teamId Ð²Ð°Ð»Ñ–Ð´Ð½Ð¸Ð¹
      if (!correctedTeamId && data.teamId) {
        if (teamsById.has(data.teamId)) {
          correctedTeamId = data.teamId;
          correctionReason = "existing valid teamId";
          
          // ðŸ”¥ ÐŸÐ•Ð Ð•Ð’Ð†Ð ÐšÐ: Ñ‡Ð¸ teamName Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ñ” Ñ†Ñ–Ð¹ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ–
          if (data.teamName) {
            const actualTeam = teamsById.get(data.teamId);
            const userTeamKey = data.teamName.trim().toLowerCase();
            const actualTeamKey = actualTeam.name.trim().toLowerCase();
            
            if (userTeamKey !== actualTeamKey && 
                userTeamKey.replace(/\s+/g, '') !== actualTeamKey.replace(/\s+/g, '')) {
              consistencyCheck = {
                type: "teamName_teamId_mismatch",
                userTeamName: data.teamName,
                actualTeamName: actualTeam.name,
                teamId: data.teamId
              };
              warnings.push({
                user: userId,
                name: data.fullName,
                issue: `teamName "${data.teamName}" Ð½Ðµ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ñ” ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ– ${data.teamId} ("${actualTeam.name}")`
              });
            }
          }
        }
        else if (teamsByOwner.has(data.teamId)) {
          correctedTeamId = teamsByOwner.get(data.teamId).teamId;
          correctionReason = "teamId was ownerUid";
        }
      }

      // Ð¡Ñ‚Ñ€Ð°Ñ‚ÐµÐ³Ñ–Ñ 4: Email prefix (ÐºÑ€Ð°Ð¹Ð½Ñ–Ð¹ Ð²Ð¸Ð¿Ð°Ð´Ð¾Ðº)
      if (!correctedTeamId && data.email) {
        const emailPrefix = data.email.split('@')[0].toLowerCase();
        if (teamsByName.has(emailPrefix)) {
          correctedTeamId = teamsByName.get(emailPrefix);
          correctionReason = "email prefix match";
        }
      }

      // Ð›Ð¾Ð³ÑƒÑ”Ð¼Ð¾ Ð½ÐµÐ²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð½Ð¾ÑÑ‚Ñ–
      if (consistencyCheck) {
        console.warn(`âš ï¸ ÐÐµÐ²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð½Ñ–ÑÑ‚ÑŒ Ð´Ð»Ñ ${data.fullName || userId}:`, consistencyCheck);
        consistencyWarnings++;
      }

      // Ð¯ÐºÑ‰Ð¾ Ð½Ðµ Ð·Ð½Ð°Ð¹ÑˆÐ»Ð¸ â€” Ð»Ð¾Ð³ÑƒÑ”Ð¼Ð¾ Ñ– Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°Ñ”Ð¼Ð¾
      if (!correctedTeamId) {
        console.warn(`âš ï¸ ÐÐµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ Ð´Ð»Ñ user ${userId}:`, {
          name: data.fullName,
          role: data.role,
          teamName: data.teamName,
          currentTeamId: data.teamId
        });
        continue;
      }

      // ÐžÐ½Ð¾Ð²Ð»ÑŽÑ”Ð¼Ð¾ ÑÐºÑ‰Ð¾ Ð¿Ð¾Ñ‚Ñ€Ñ–Ð±Ð½Ð¾
      if (data.teamId !== correctedTeamId) {
        console.log(`ðŸ”§ user ${data.fullName || userId}: ${data.teamId} â†’ ${correctedTeamId} (${correctionReason})`);
        
        const updateData = {
          teamId: correctedTeamId,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        // ðŸ”¥ Ð¯ÐºÑ‰Ð¾ Ð·Ð½Ð°Ð¹ÑˆÐ»Ð¸ Ð¿Ð¾ teamName â€” Ñ‚Ð°ÐºÐ¾Ð¶ Ð¾Ð½Ð¾Ð²Ð¸Ð¼Ð¾ teamName Ð´Ð¾ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð³Ð¾ (Ð· teams)
        if (correctionReason === "teamName match" && data.teamName) {
          const matchedTeam = teamsById.get(correctedTeamId);
          if (matchedTeam && matchedTeam.name !== data.teamName) {
            updateData.teamName = matchedTeam.name;
            console.log(`  ðŸ“ ÐžÐ½Ð¾Ð²Ð»ÑŽÑŽ teamName: "${data.teamName}" â†’ "${matchedTeam.name}"`);
          }
        }
        
        await db.collection("users").doc(userId).update(updateData);
        updateCount++;
      }

    } catch (err) {
      errors.push({ collection: "users", id: userDoc.id, error: err.message });
    }
  }

  // ========== 3. Ð’Ð˜ÐŸÐ ÐÐ’Ð›Ð¯Ð„ÐœÐž PUBLIC_PARTICIPANTS ==========
  console.log("\nðŸ“‹ ÐžÐ±Ñ€Ð¾Ð±Ð»ÑÑŽ public_participantsâ€¦");
  const ppSnap = await db.collection("public_participants").get();
  
  for (const doc of ppSnap.docs) {
    try {
      const data = doc.data();
      
      if (data.teamId && teamsById.has(data.teamId)) continue;

      let correctedTeamId = null;
      const teamName = (data.teamName || "").trim();

      if (teamName) {
        const key = teamName.toLowerCase();
        const keyNoSpaces = key.replace(/\s+/g, '');
        const keyNoDashes = key.replace(/-/g, ' ');
        
        correctedTeamId = teamsByName.get(key) || 
                         teamsByName.get(keyNoSpaces) || 
                         teamsByName.get(keyNoDashes);
      }

      // ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ð¿Ð¾ userId
      if (!correctedTeamId && data.userId) {
        const userSnap = await db.collection("users").doc(data.userId).get();
        if (userSnap.exists) {
          const userTeamId = userSnap.data().teamId;
          if (userTeamId && teamsById.has(userTeamId)) {
            correctedTeamId = userTeamId;
          }
        }
      }

      if (correctedTeamId && data.teamId !== correctedTeamId) {
        const matchedTeam = teamsById.get(correctedTeamId);
        console.log(`ðŸ› ï¸ public_participants ${doc.id}: ${data.teamId} â†’ ${correctedTeamId}`);
        
        const updateData = {
          teamId: correctedTeamId,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // ðŸ”¥ Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ñ–Ð·ÑƒÑ”Ð¼Ð¾ teamName Ð· teams
        if (matchedTeam && matchedTeam.name !== data.teamName) {
          updateData.teamName = matchedTeam.name;
        }
        
        await db.collection("public_participants").doc(doc.id).update(updateData);
        updateCount++;
      } else if (!correctedTeamId && teamName) {
        console.warn(`âš ï¸ ÐÐµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ Ð´Ð»Ñ public_participants ${doc.id}:`, teamName);
      }

    } catch (err) {
      errors.push({ collection: "public_participants", id: doc.id, error: err.message });
    }
  }

  // ========== 4. Ð’Ð˜ÐŸÐ ÐÐ’Ð›Ð¯Ð„ÐœÐž REGISTRATIONS ==========
  console.log("\nðŸ“ ÐžÐ±Ñ€Ð¾Ð±Ð»ÑÑŽ registrationsâ€¦");
  const regSnap = await db.collection("registrations").get();
  
  for (const doc of regSnap.docs) {
    try {
      const data = doc.data();
      
      if (data.teamId && teamsById.has(data.teamId)) continue;

      let correctedTeamId = null;
      const teamName = (data.teamName || "").trim();

      if (teamName) {
        const key = teamName.toLowerCase();
        const keyNoSpaces = key.replace(/\s+/g, '');
        const keyNoDashes = key.replace(/-/g, ' ');
        
        correctedTeamId = teamsByName.get(key) || 
                         teamsByName.get(keyNoSpaces) || 
                         teamsByName.get(keyNoDashes);
      }

      // ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ð¿Ð¾ userId
      if (!correctedTeamId && data.userId) {
        const userSnap = await db.collection("users").doc(data.userId).get();
        if (userSnap.exists) {
          const userTeamId = userSnap.data().teamId;
          if (userTeamId && teamsById.has(userTeamId)) {
            correctedTeamId = userTeamId;
          }
        }
      }

      // ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ð¿Ð¾ captainUid
      if (!correctedTeamId && data.captainUid && teamsByOwner.has(data.captainUid)) {
        correctedTeamId = teamsByOwner.get(data.captainUid).teamId;
      }

      if (correctedTeamId && data.teamId !== correctedTeamId) {
        const matchedTeam = teamsById.get(correctedTeamId);
        console.log(`ðŸ› ï¸ registrations ${doc.id}: ${data.teamId} â†’ ${correctedTeamId}`);
        
        const updateData = {
          teamId: correctedTeamId,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // ðŸ”¥ Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ñ–Ð·ÑƒÑ”Ð¼Ð¾ teamName Ð· teams
        if (matchedTeam && matchedTeam.name !== data.teamName) {
          updateData.teamName = matchedTeam.name;
        }
        
        await db.collection("registrations").doc(doc.id).update(updateData);
        updateCount++;
      } else if (!correctedTeamId && teamName) {
        console.warn(`âš ï¸ ÐÐµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ Ð´Ð»Ñ registrations ${doc.id}:`, teamName);
      }

    } catch (err) {
      errors.push({ collection: "registrations", id: doc.id, error: err.message });
    }
  }

  // ========== 5. ÐŸÐ†Ð”Ð¡Ð£ÐœÐžÐš ==========
  console.log("\n" + "=".repeat(60));
  console.log("âœ… ÐœÐ†Ð“Ð ÐÐ¦Ð†Ð¯ Ð—ÐÐ’Ð•Ð Ð¨Ð•ÐÐ!");
  console.log(`ðŸ“Š Ð’ÑÑŒÐ¾Ð³Ð¾ Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾ Ð·Ð°Ð¿Ð¸ÑÑ–Ð²: ${updateCount}`);
  console.log(`âš ï¸ ÐÐµÐ²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð½Ð¾ÑÑ‚ÐµÐ¹ teamName: ${consistencyWarnings}`);
  
  if (warnings.length > 0) {
    console.log("\nðŸ“‹ Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð½ÐµÐ²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð½Ð¾ÑÑ‚ÐµÐ¹ (Ð¿Ð¾Ñ‚Ñ€ÐµÐ±ÑƒÑŽÑ‚ÑŒ Ñ€ÑƒÑ‡Ð½Ð¾Ñ— Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ¸):");
    warnings.forEach((w, i) => console.log(`  ${i + 1}. ${w.name} (${w.user}): ${w.issue}`));
  }
  
  if (errors.length > 0) {
    console.error(`\nâŒ ÐŸÐ¾Ð¼Ð¸Ð»Ð¾Ðº: ${errors.length}`);
    errors.forEach(e => console.error(`  - ${e.collection}/${e.id}: ${e.error}`));
  } else {
    console.log("ðŸŽ‰ Ð‘ÐµÐ· ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ð¸Ñ… Ð¿Ð¾Ð¼Ð¸Ð»Ð¾Ðº!");
  }
  
  console.log("=".repeat(60));

  return {
    teamsFound: teamsByOwner.size,
    updatesMade: updateCount,
    consistencyWarnings: consistencyWarnings,
    warnings: warnings,
    errors: errors
  };
}

// Ð—Ð°Ð¿ÑƒÑÐº Ð· Ð¿Ñ–Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¶ÐµÐ½Ð½ÑÐ¼
if (confirm("ðŸš¨ Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ð¸ Ð¼Ñ–Ð³Ñ€Ð°Ñ†Ñ–ÑŽ teamId?\n\nÐ¦Ðµ Ð·Ð¼Ñ–Ð½Ð¸Ñ‚ÑŒ Ð´Ð°Ð½Ñ– Ñƒ Firestore Ñ– ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ñ–Ð·ÑƒÑ”:\nâ€¢ users\nâ€¢ public_participants  \nâ€¢ registrations\n\nÐŸÑ€Ð¾Ð´Ð¾Ð²Ð¶Ð¸Ñ‚Ð¸?")) {
  fixAllTeamIds().then(result => {
    console.log("ðŸ“ˆ Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð¼Ñ–Ð³Ñ€Ð°Ñ†Ñ–Ñ—:", result);
  }).catch(err => {
    console.error("ðŸ’¥ ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ð° Ð¿Ð¾Ð¼Ð¸Ð»ÐºÐ°:", err);
  });
}
