// assets/js/register_firebase.js
// STOLAR CARP ‚Ä¢ Registration
// competitions + events[] ‚Üí cards with lamp status (red/yellow/green)
// Shows: title + start/finish dates. NO "closed/active" text. NO reg open/close dates.

(function () {
  const auth = window.scAuth;
  const db   = window.scDb;

  const form           = document.getElementById("regForm");
  const eventOptionsEl = document.getElementById("eventOptions");
  const msgEl          = document.getElementById("msg");
  const submitBtn      = document.getElementById("submitBtn");
  const spinnerEl      = document.getElementById("spinner");
  const hpInput        = document.getElementById("hp");
  const foodQtyField   = document.getElementById("foodQtyField");
  const foodQtyInput   = document.getElementById("food_qty");
  const profileSummary = document.getElementById("profileSummary");
  const copyCardBtn    = document.getElementById("copyCard");
  const cardNumEl      = document.getElementById("cardNum");
  const rulesChk       = document.getElementById("rules");

  if (!auth || !db || !window.firebase) {
    if (eventOptionsEl) {
      eventOptionsEl.innerHTML =
        '<p class="form__hint" style="color:#ff6c6c;">Firebase init –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–≤—Å—è.</p>';
    }
    if (submitBtn) submitBtn.disabled = true;
    return;
  }

  let currentUser = null;
  let profile = null;

  let lastItems = [];
  let nearestUpcomingValue = null; // `${compId}||${stageKey||""}`

  function escapeHtml(s) {
    return String(s ?? "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;");
  }

  function setMsg(text, ok = true) {
    if (!msgEl) return;
    msgEl.textContent = text || "";
    msgEl.classList.remove("ok", "err");
    if (text) msgEl.classList.add(ok ? "ok" : "err");
  }

  function setLoading(v) {
    if (spinnerEl) spinnerEl.classList.toggle("spinner--on", !!v);
    if (submitBtn) submitBtn.disabled = !!v || submitBtn.disabled;
  }

  function nowKyiv() {
    return new Date();
  }

  function toDateMaybe(x) {
    if (!x) return null;
    try {
      if (x instanceof Date) return x;
      if (typeof x === "string") {
        const d = new Date(x);
        return isFinite(d.getTime()) ? d : null;
      }
      if (x && typeof x.toDate === "function") return x.toDate(); // Firestore Timestamp
    } catch {}
    return null;
  }

  function fmtDate(d) {
    if (!d) return "‚Äî";
    return d.toLocaleDateString("uk-UA", { day: "2-digit", month: "2-digit", year: "numeric" });
  }

  function getRegDatesFromEvent(ev) {
    const regOpen  = ev.regOpenAt  || ev.regOpenDate  || ev.regOpen || null;
    const regClose = ev.regCloseAt || ev.regCloseDate || ev.regClose || null;
    return { regOpenAt: regOpen, regCloseAt: regClose };
  }

  function getRunDatesFromEvent(ev) {
    const start  = ev.startAt  || ev.startDate  || null;
    const finish = ev.finishAt || ev.finishDate || ev.endAt || ev.endDate || null;
    return { startAt: start, endAt: finish };
  }

  function isOpenWindow(item) {
    const mode = String(item.regMode || "auto").toLowerCase();
    if (mode === "manual") return !!item.manualOpen;

    const openAt  = toDateMaybe(item.regOpenAt);
    const closeAt = toDateMaybe(item.regCloseAt);
    if (!openAt || !closeAt) return false;

    const n = nowKyiv();
    return n >= openAt && n <= closeAt;
  }

  function isUpcoming(item) {
    const mode = String(item.regMode || "auto").toLowerCase();
    if (mode === "manual") return false;

    const openAt = toDateMaybe(item.regOpenAt);
    if (!openAt) return false;

    return openAt > nowKyiv();
  }

  function isStalkerComp(c) {
    const t = `${c.title || ""} ${c.name || ""}`.toLowerCase();
    const type = String(c.type || "").toLowerCase();
    const fmt  = String(c.format || "").toLowerCase();
    return t.includes("stalker") || type === "stalker" || fmt === "solo";
  }

  // copy card
  if (copyCardBtn && cardNumEl) {
    copyCardBtn.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(cardNumEl.textContent.trim());
        copyCardBtn.textContent = "–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ ‚úî";
        setTimeout(() => (copyCardBtn.textContent = "–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç–∫–∏"), 1200);
      } catch {
        alert("–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –Ω–æ–º–µ—Ä. –°–∫–æ–ø—ñ—é–π—Ç–µ –≤—Ä—É—á–Ω—É.");
      }
    });
  }

  function initFoodLogic() {
    const radios = document.querySelectorAll('input[name="food"]');
    if (!radios.length || !foodQtyField || !foodQtyInput) return;

    function update() {
      const selected = document.querySelector('input[name="food"]:checked');
      const need = selected && selected.value === "–¢–∞–∫";
      foodQtyField.classList.toggle("field--disabled", !need);
      foodQtyInput.disabled = !need;
      if (!need) foodQtyInput.value = "";
    }

    radios.forEach(r => r.addEventListener("change", update));
    update();
  }

  async function loadProfile(user) {
    const uSnap = await db.collection("users").doc(user.uid).get();
    if (!uSnap.exists) throw new Error("–ù–µ–º–∞ –ø—Ä–æ—Ñ—ñ–ª—é. –ó–∞–π–¥—ñ—Ç—å –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É ¬´–ê–∫–∞—É–Ω—Ç¬ª —ñ —Å—Ç–≤–æ—Ä—ñ—Ç—å –ø—Ä–æ—Ñ—ñ–ª—å.");

    const u = uSnap.data() || {};
    const teamId = u.teamId || null;

    let teamName = "";
    if (teamId) {
      const tSnap = await db.collection("teams").doc(teamId).get();
      if (tSnap.exists) teamName = (tSnap.data() || {}).name || "";
    }

    profile = {
      uid: user.uid,
      email: user.email || "",
      teamId,
      teamName: teamName || "–ë–µ–∑ –Ω–∞–∑–≤–∏",
      captain: u.fullName || user.email || "",
      phone: u.phone || ""
    };

    if (profileSummary) {
      profileSummary.innerHTML =
        `–ö–æ–º–∞–Ω–¥–∞: <b>${escapeHtml(profile.teamName)}</b><br>` +
        `–ö–∞–ø—ñ—Ç–∞–Ω: <b>${escapeHtml(profile.captain)}</b><br>` +
        `–¢–µ–ª–µ—Ñ–æ–Ω: <b>${escapeHtml(profile.phone || "–Ω–µ –≤–∫–∞–∑–∞–Ω–æ")}</b>`;
    }
  }

  function computeNearestUpcomingValue(items) {
    // closest future regOpenAt (auto-mode)
    const future = items
      .filter(isUpcoming)
      .map(it => ({ it, openAt: toDateMaybe(it.regOpenAt) }))
      .filter(x => x.openAt)
      .sort((a, b) => a.openAt - b.openAt);

    if (!future.length) return null;
    const it = future[0].it;
    return `${it.compId}||${it.stageKey || ""}`;
  }

  function getLampClass(it, value) {
    if (isOpenWindow(it)) return "lamp-green";
    if (nearestUpcomingValue && value === nearestUpcomingValue) return "lamp-yellow";
    return "lamp-red";
  }

  function getLampTitle(it, value) {
    const cls = getLampClass(it, value);
    if (cls === "lamp-green") return "–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –≤—ñ–¥–∫—Ä–∏—Ç–∞";
    if (cls === "lamp-yellow") return "–ù–∞–π–±–ª–∏–∂—á–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è (—Å–∫–æ—Ä–æ –≤—ñ–¥–∫—Ä–∏—î—Ç—å—Å—è)";
    return "–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —â–µ –Ω–µ –≤—ñ–¥–∫—Ä–∏—Ç–∞ –∞–±–æ –≤–∂–µ –∑–∞–∫—Ä–∏—Ç–∞";
  }

  function refreshSubmitState() {
    if (!submitBtn) return;
    const loading = spinnerEl && spinnerEl.classList.contains("spinner--on");
    if (loading) { submitBtn.disabled = true; return; }

    const picked = document.querySelector('input[name="stagePick"]:checked');
    const rulesOk = rulesChk ? !!rulesChk.checked : true;
    submitBtn.disabled = !(picked && rulesOk);
  }

  document.addEventListener("change", (e) => {
    if (!e.target) return;
    if (e.target.name === "stagePick" || e.target.id === "rules") refreshSubmitState();
  });

  async function loadCompetitions() {
    if (!eventOptionsEl) return;
    eventOptionsEl.innerHTML = `<p class="form__hint">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É...</p>`;

    try {
      const snap = await db.collection("competitions").get();
      const items = [];

      snap.forEach(docSnap => {
        const c = docSnap.data() || {};
        const compId = docSnap.id;

        const brand = c.brand || "STOLAR CARP";
        const year  = c.year || c.seasonYear || "";
        const compTitle = c.name || c.title || (year ? `Season ${year}` : compId);

        const type = String(c.type || "").toLowerCase();
        const stalker = isStalkerComp(c);

        const eventsArr = Array.isArray(c.events) ? c.events : null;

        if (eventsArr && eventsArr.length) {
          eventsArr.forEach((ev, idx) => {
            const key = ev.key || ev.stageId || ev.id || `stage-${idx+1}`;
            const isFinal = String(key).toLowerCase().includes("final") || !!ev.isFinal;

            const { startAt, endAt } = getRunDatesFromEvent(ev);
            const { regOpenAt, regCloseAt } = getRegDatesFromEvent(ev);

            const stageTitle =
              ev.title || ev.name || ev.label ||
              (isFinal ? "–§—ñ–Ω–∞–ª" : `–ï—Ç–∞–ø ${idx + 1}`);

            items.push({
              kind: "stage",
              compId,
              compTitle,
              brand,
              year,
              stalker,
              type: type || "season",
              stageKey: key,
              stageTitle,
              isFinal,

              startAt: toDateMaybe(startAt),
              endAt: toDateMaybe(endAt),

              regMode: ev.regMode || c.regMode || "auto",
              manualOpen: !!(ev.manualOpen ?? c.manualOpen),
              regOpenAt,
              regCloseAt
            });
          });
        } else {
          const startAt = toDateMaybe(c.startAt || c.startDate);
          const endAt   = toDateMaybe(c.endAt || c.endDate || c.finishAt || c.finishDate);

          items.push({
            kind: "oneoff",
            compId,
            compTitle,
            brand,
            year,
            stalker,
            type: stalker ? "stalker" : (type || "competition"),
            stageKey: null,
            stageTitle: null,
            isFinal: false,

            startAt,
            endAt,

            regMode: c.regMode || "auto",
            manualOpen: !!c.manualOpen,
            regOpenAt: c.regOpenAt || c.regOpenDate || null,
            regCloseAt: c.regCloseAt || c.regCloseDate || null
          });
        }
      });

      // nice order by start date (participants —á–∏—Ç–∞—é—Ç—å)
      items.sort((a, b) => {
        const ad = a.startAt ? a.startAt.getTime() : 9999999999999;
        const bd = b.startAt ? b.startAt.getTime() : 9999999999999;
        return ad - bd;
      });

      lastItems = items;
      nearestUpcomingValue = computeNearestUpcomingValue(items);

      renderItems(items);
      refreshSubmitState();
    } catch (e) {
      console.error("loadCompetitions error:", e);
      eventOptionsEl.innerHTML =
        '<p class="form__hint" style="color:#ff6c6c;">–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–º–∞–≥–∞–Ω–Ω—è (Rules/–¥–æ—Å—Ç—É–ø).</p>';
    }
  }

  function renderItems(items) {
    if (!eventOptionsEl) return;
    eventOptionsEl.innerHTML = "";

    if (!items.length) {
      eventOptionsEl.innerHTML = `<p class="form__hint">–ù–µ–º–∞ —Å—Ç–≤–æ—Ä–µ–Ω–∏—Ö –∑–º–∞–≥–∞–Ω—å. –î–æ–¥–∞–π —ó—Ö –≤ –∞–¥–º—ñ–Ω—Ü—ñ.</p>`;
      if (submitBtn) submitBtn.disabled = true;
      return;
    }

    items.forEach(it => {
      const open = isOpenWindow(it);
      const value = `${it.compId}||${it.stageKey || ""}`;

      // TITLE: —â–æ–± –±—É–ª–æ —á–∏—Ç–∞–±–µ–ª—å–Ω–æ ‚Äî ‚Äú–°–µ–∑–æ–Ω ‚Ä¶ ‚Äî –ï—Ç–∞–ø ‚Ä¶‚Äù
      const titleText =
        `${it.brand ? it.brand + " ¬∑ " : ""}${it.compTitle}` +
        (it.stageTitle ? ` ‚Äî ${it.stageTitle}` : "");

      const dateLine = `${fmtDate(it.startAt)} ‚Äî ${fmtDate(it.endAt)}`;

      const lampCls = getLampClass(it, value);
      const lampTitle = getLampTitle(it, value);

      const card = document.createElement("div");
      card.className = "stage-card";
      card.setAttribute("role", "button");
      card.tabIndex = 0;

      // —Ä–∞–¥—ñ–æ, –∞–ª–µ —Ö–æ–≤–∞—î–º–æ ‚Äî –∫–ª—ñ–∫–∞—î–º–æ –ø–æ –∫–∞—Ä—Ç—Ü—ñ
      const radio = document.createElement("input");
      radio.type = "radio";
      radio.name = "stagePick";
      radio.value = value;
      radio.style.position = "absolute";
      radio.style.opacity = "0";
      radio.style.pointerEvents = "none";
      radio.disabled = !open;

      card.appendChild(radio);

      card.innerHTML += `
        <div class="stage-head">
          <span class="lamp ${lampCls}" title="${escapeHtml(lampTitle)}" aria-hidden="true"></span>
          <div class="stage-info">
            <div class="stage-title">${escapeHtml(titleText)}</div>
            <div class="stage-dates">
              <span>üìÖ</span>
              <span>${escapeHtml(dateLine)}</span>
            </div>
          </div>
        </div>
      `;

      // click selects ONLY if open (green)
      function selectIfOpen() {
        if (!open) {
          setMsg("–¶—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –∑–∞—Ä–∞–∑ –∑–∞–∫—Ä–∏—Ç–∞. –û–±–µ—Ä—ñ—Ç—å –∑–µ–ª–µ–Ω—É –ª–∞–º–ø–æ—á–∫—É.", false);
          return;
        }
        setMsg("");
        // –∑–Ω—ñ–º–∞—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ
        document.querySelectorAll('input[name="stagePick"]').forEach(r => (r.checked = false));
        radio.checked = true;
        refreshSubmitState();
      }

      card.addEventListener("click", selectIfOpen);
      card.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          selectIfOpen();
        }
      });

      eventOptionsEl.appendChild(card);
    });
  }

  auth.onAuthStateChanged(async (user) => {
    currentUser = user || null;
    setMsg("");

    if (!user) {
      if (submitBtn) submitBtn.disabled = true;
      if (profileSummary) profileSummary.textContent = "–í–∏ –Ω–µ –∑–∞–ª–æ–≥—ñ–Ω–µ–Ω—ñ. –ó–∞–π–¥—ñ—Ç—å —É ¬´–ê–∫–∞—É–Ω—Ç¬ª —ñ –ø–æ–≤–µ—Ä–Ω—ñ—Ç—å—Å—è —Å—é–¥–∏.";
      if (eventOptionsEl) eventOptionsEl.innerHTML =
        '<p class="form__hint" style="color:#ff6c6c;">–°–ø–∏—Å–æ–∫ –∑–º–∞–≥–∞–Ω—å –¥–æ—Å—Ç—É–ø–Ω–∏–π –ø—ñ—Å–ª—è –≤—Ö–æ–¥—É –≤ –∞–∫–∞—É–Ω—Ç.</p>';
      setMsg("–£–≤—ñ–π–¥—ñ—Ç—å —É –∞–∫–∞—É–Ω—Ç, —â–æ–± –±–∞—á–∏—Ç–∏ –∑–º–∞–≥–∞–Ω–Ω—è —Ç–∞ –ø–æ–¥–∞—Ç–∏ –∑–∞—è–≤–∫—É.", false);
      return;
    }

    try {
      await loadProfile(user);
      initFoodLogic();
      await loadCompetitions();
      refreshSubmitState();
    } catch (e) {
      console.error(e);
      if (submitBtn) submitBtn.disabled = true;
      setMsg(e.message || "–ü–æ–º–∏–ª–∫–∞ –ø—Ä–æ—Ñ—ñ–ª—é.", false);
    }
  });

  if (form) {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (hpInput && hpInput.value) {
        setMsg("–ü—ñ–¥–æ–∑—Ä–∞ –Ω–∞ –±–æ—Ç–∞. –ó–∞—è–≤–∫–∞ –Ω–µ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∞.", false);
        return;
      }

      if (!currentUser || !profile) {
        setMsg("–£–≤—ñ–π–¥—ñ—Ç—å —É –∞–∫–∞—É–Ω—Ç.", false);
        return;
      }

      if (rulesChk && !rulesChk.checked) {
        setMsg("–ü–æ—Ç—Ä—ñ–±–Ω–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –æ–∑–Ω–∞–π–æ–º–ª–µ–Ω–Ω—è –∑ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç–æ–º.", false);
        return;
      }

      const picked = document.querySelector('input[name="stagePick"]:checked');
      if (!picked) {
        setMsg("–û–±–µ—Ä—ñ—Ç—å –≤—ñ–¥–∫—Ä–∏—Ç–µ (–∑–µ–ª–µ–Ω–µ) –∑–º–∞–≥–∞–Ω–Ω—è/–µ—Ç–∞–ø.", false);
        return;
      }

      const pickedValue = String(picked.value);
      const it = (lastItems || []).find(x => `${x.compId}||${x.stageKey || ""}` === pickedValue);
      if (!it || !isOpenWindow(it)) {
        setMsg("–¶—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –∑–∞—Ä–∞–∑ –∑–∞–∫—Ä–∏—Ç–∞. –û–±–µ—Ä—ñ—Ç—å –∑–µ–ª–µ–Ω—É –ª–∞–º–ø–æ—á–∫—É.", false);
        return;
      }

      const food = document.querySelector('input[name="food"]:checked')?.value;
      if (!food) {
        setMsg("–û–±–µ—Ä—ñ—Ç—å —Ö–∞—Ä—á—É–≤–∞–Ω–Ω—è.", false);
        return;
      }

      let foodQty = null;
      if (food === "–¢–∞–∫") {
        const q = Number(foodQtyInput?.value || "0");
        if (!q || q < 1 || q > 6) {
          setMsg("–í–∫–∞–∂—ñ—Ç—å –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ö–∞—Ä—á—É—é—á–∏—Ö 1‚Äì6.", false);
          return;
        }
        foodQty = q;
      }

      const [competitionId, stageKeyRaw] = pickedValue.split("||");
      const stageId = (stageKeyRaw || "").trim() || null;

      try {
        setLoading(true);
        setMsg("");
        refreshSubmitState();

        await db.collection("registrations").add({
          uid: profile.uid,

          competitionId,
          stageId,

          teamId: profile.teamId,
          teamName: profile.teamName,
          captain: profile.captain,
          phone: profile.phone,

          food,
          foodQty: foodQty ?? null,

          status: "pending_payment",
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        setMsg("–ó–∞—è–≤–∫–∞ –ø–æ–¥–∞–Ω–∞ ‚úî –ü—ñ—Å–ª—è –æ–ø–ª–∞—Ç–∏ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂—É –≤ –∞–¥–º—ñ–Ω—Ü—ñ.", true);
        form.reset();
        initFoodLogic();
        refreshSubmitState();
      } catch (err) {
        console.error("submit error:", err);
        setMsg("–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏ (Rules/–¥–æ—Å—Ç—É–ø).", false);
      } finally {
        setLoading(false);
        refreshSubmitState();
      }
    });
  }
})();
