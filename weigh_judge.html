<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>STOLAR CARP ‚Ä¢ –°—É–¥–¥—è ‚Ä¢ –ó–≤–∞–∂—É–≤–∞–Ω–Ω—è</title>

  <link rel="stylesheet" href="assets/css/main.css" />

  <style>
    body{ background:#020617; }
    .wrap{ max-width:980px; margin:0 auto; padding:20px 0 80px; }
    .card{
      background:rgba(15,23,42,.92);
      border:1px solid rgba(148,163,184,.30);
      border-radius:16px;
      padding:16px;
      margin-bottom:12px;
    }
    .muted{ color:#9ca3af; }
    .ok{ color:#8fe39a; }
    .err{ color:#ff6c6c; }
    .big{ font-size:1.35rem; font-weight:900; }
    .kv{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:.9rem; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(148,163,184,.25);
      background:rgba(2,6,23,.35);
      color:#e5e7eb; font-size:.82rem; white-space:nowrap;
    }

    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .rowTop{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap:wrap; }

    .wbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
      margin-top:12px;
      padding:10px;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(2,6,23,.25);
      border-radius:14px;
    }
    .wBtns{ display:flex; gap:8px; flex-wrap:wrap; }
    .wbtn{
      border:1px solid rgba(148,163,184,.25);
      background:rgba(2,6,23,.25);
      color:#e5e7eb;
      border-radius:999px;
      padding:8px 12px;
      font-weight:900;
      font-size:.9rem;
      cursor:pointer;
      user-select:none;
    }
    .wbtn.isActive{
      border-color: rgba(246,195,76,.55);
      box-shadow: 0 0 0 3px rgba(246,195,76,.14);
      background: rgba(246,195,76,.10);
      color:#fff;
    }
    .wbtn:disabled{
      opacity:.45;
      cursor:not-allowed;
    }
    .wstat{ text-align:right; }
    .wstat .big2{ font-size:1.1rem; font-weight:900; }

    .teams{
      display:grid;
      gap:10px;
      margin-top:10px;
    }
    .teamRow{
      border:1px solid rgba(148,163,184,.22);
      background:rgba(2,6,23,.22);
      border-radius:14px;
      padding:12px;
    }
    .teamHead{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .teamTitle{
      font-weight:900;
      font-size:1.05rem;
      line-height:1.2;
    }
    .teamMeta{ color:#9ca3af; font-size:.9rem; }

    .inp{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(2,6,23,.55);
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,.28);
      outline:none;
      font-weight:800;
    }
    .inp:focus{
      border-color:var(--accent);
      box-shadow:0 0 10px rgba(246,195,76,.25);
    }

    .teamBtns{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
      justify-content:flex-end;
    }

    .miniBadge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border-radius:999px;
      padding:6px 10px;
      border:1px solid rgba(148,163,184,.20);
      background:rgba(2,6,23,.20);
      color:#e5e7eb;
      font-size:.82rem;
      white-space:nowrap;
    }
    .dot{
      width:8px;height:8px;border-radius:999px;
      background:rgba(34,197,94,.95);
      box-shadow:0 0 0 3px rgba(34,197,94,.12);
      display:inline-block;
    }

    /* ==== Fish tiles (–≤–Ω–µ—Å–µ–Ω–Ω—è –∫–æ–∂–Ω–æ—ó —Ä–∏–±–∏ –æ–∫—Ä–µ–º–æ) ==== */
    .fishGrid{
      display:grid;
      grid-template-columns: 1fr 1fr auto;
      gap:10px;
      align-items:center;
    }
    @media (max-width:720px){
      .fishGrid{ grid-template-columns: 1fr auto; }
    }
    .fishTile{ position:relative; }
    .fishInp{ padding-right:44px; }
    .fishDel{
      position:absolute;
      right:10px;
      top:50%;
      transform:translateY(-50%);
      width:30px;height:30px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.25);
      background:rgba(2,6,23,.35);
      color:#e5e7eb;
      font-weight:900;
      cursor:pointer;
    }
    .fishDel:disabled{ opacity:.45; cursor:not-allowed; }
    .fishAdd{
      width:44px;height:44px;
      border-radius:14px;
      border:1px solid rgba(246,195,76,.35);
      background:rgba(246,195,76,.18);
      color:#fff;
      font-weight:900;
      font-size:20px;
      cursor:pointer;
    }
    .fishAdd:disabled{ opacity:.45; cursor:not-allowed; }

    .sumRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-top:10px;
      padding-top:10px;
      border-top:1px dashed rgba(148,163,184,.22);
    }
    .sumRow b{ color:#e5e7eb; }
  </style>
</head>

<body>
<header class="header">
  <div class="container header__row">
    <a class="logo" href="index.html">
      <span class="logo__mark">SC</span>
      <span class="logo__text">STOLAR CARP</span>
    </a>
    <div class="pill" id="authPill">auth: ‚Ä¶</div>
  </div>
</header>

<main class="main">
  <section class="section container wrap">

    <div class="card">
      <div class="rowTop">
        <div>
          <div class="big" id="zoneTitle">–ó–æ–Ω–∞ ‚Äî</div>
          <div class="muted" id="status">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</div>
        </div>
        <div class="miniBadge" id="netBadge" style="display:none;"><span class="dot"></span> realtime</div>
      </div>

      <div class="muted" style="margin-top:10px;">
        <div><b>–ü—Ä–∏–≤‚Äô—è–∑–∫–∞ –ø—Ä–∏—Å—Ç—Ä–æ—é:</b></div>
        <div class="kv" id="bindInfo">‚Äî</div>
      </div>

      <div class="btnRow">
        <button class="btn btn--primary" id="btnOpen">–í—ñ–¥–∫—Ä–∏—Ç–∏ –º–æ—é –∑–æ–Ω—É</button>
        <button class="btn btn--ghost" id="btnSaveHint">–Ø–∫ –∑–±–µ—Ä–µ–≥—Ç–∏ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω</button>
        <button class="btn btn--danger" id="btnReset">–°–∫–∏–Ω—É—Ç–∏ –ø—Ä–∏–≤‚Äô—è–∑–∫—É</button>
      </div>

      <div class="muted" id="msg" style="margin-top:10px;"></div>
    </div>

    <div class="card" id="weighCard" style="display:none;">
      <div class="rowTop">
        <div>
          <div style="font-weight:900;font-size:1.1rem;">–ó–≤–∞–∂—É–≤–∞–Ω–Ω—è</div>
          <div class="muted" id="wHelp">–ü–æ—Ç–æ—á–Ω–µ W –ø–µ—Ä–µ–º–∏–∫–∞—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ, –∫–æ–ª–∏ –≤—Å—ñ –∫–æ–º–∞–Ω–¥–∏ —Ç–≤–æ—î—ó –∑–æ–Ω–∏ –∑–¥–∞–Ω—ñ.</div>
        </div>
        <div class="muted" id="teamsCount">‚Äî</div>
      </div>

      <div class="wbar">
        <div class="wBtns">
          <button class="wbtn" id="w1">W1</button>
          <button class="wbtn" id="w2">W2</button>
          <button class="wbtn" id="w3">W3</button>
          <button class="wbtn" id="w4">W4</button>
        </div>
        <div class="wstat">
          <div class="muted">–ü–æ—Ç–æ—á–Ω–µ</div>
          <div class="big2" id="curW">W‚Äî</div>
        </div>
      </div>

      <div class="muted" id="wMsg" style="margin-top:10px;"></div>

      <div style="margin-top:14px; font-weight:900;">–ö–æ–º–∞–Ω–¥–∏ –º–æ—î—ó –∑–æ–Ω–∏</div>
      <div class="muted" id="teamsHint" style="margin-top:6px;">–°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è: —Å–µ–∫—Ç–æ—Ä ‚Üí –Ω–∞–∑–≤–∞.</div>

      <div class="teams" id="teamsBox"></div>
    </div>

  </section>
</main>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="assets/js/firebase-init.js"></script>

<script>
(function(){
  "use strict";

  const LS_KEY = "sc_judge_bind_v1";
  const ADMIN_UID = "5Dt6fN64c3aWACYV1WacxV2BHDl2";
  const DEFAULT_MAX_W = 4;

  const zoneTitle = document.getElementById("zoneTitle");
  const statusEl  = document.getElementById("status");
  const bindInfo  = document.getElementById("bindInfo");
  const msgEl     = document.getElementById("msg");
  const authPill  = document.getElementById("authPill");

  const btnOpen   = document.getElementById("btnOpen");
  const btnReset  = document.getElementById("btnReset");
  const btnSaveHint = document.getElementById("btnSaveHint");

  const weighCard = document.getElementById("weighCard");
  const wMsgEl = document.getElementById("wMsg");
  const curWEl = document.getElementById("curW");
  const teamsCountEl = document.getElementById("teamsCount");
  const teamsBox = document.getElementById("teamsBox");
  const netBadge = document.getElementById("netBadge");

  const wBtns = [
    { n:1, el: document.getElementById("w1") },
    { n:2, el: document.getElementById("w2") },
    { n:3, el: document.getElementById("w3") },
    { n:4, el: document.getElementById("w4") },
  ];

  let db = null;
  let me = null;

  let stageId  = "";
  let compId   = "";
  let zone     = "";
  let token    = "";

  let activeKey = "";
  let maxW = DEFAULT_MAX_W;
  let currentW = 1;
  let viewW = 1;

  // –∫–µ—à: { [teamId]: { [wNo]: weighingData|null } }
  const weighCache = Object.create(null);

  function setMsg(t, ok=true){
    msgEl.textContent = t || "";
    msgEl.className = "muted " + (t ? (ok ? "ok":"err") : "");
  }
  function setWMsg(t, ok=true){
    wMsgEl.textContent = t || "";
    wMsgEl.className = "muted " + (t ? (ok ? "ok":"err") : "");
  }
  function norm(v){ return String(v ?? "").trim(); }
  function esc(s){ return String(s ?? "").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

  async function waitFirebase(){
    for(let i=0;i<140;i++){
      if(window.scDb && window.scAuth && window.firebase) return;
      await new Promise(r=>setTimeout(r,100));
    }
    throw new Error("Firebase init –Ω–µ –ø—ñ–¥–Ω—è–≤ scAuth/scDb.");
  }

  async function requireJudgeOrAdmin(user){
    if(!user) return false;
    if(user.uid === ADMIN_UID) return true;
    const snap = await db.collection("users").doc(user.uid).get();
    const role = (snap.exists ? (snap.data()||{}).role : "") || "";
    return role === "judge" || role === "admin";
  }

  function readBind(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      return raw ? JSON.parse(raw) : null;
    }catch{ return null; }
  }
  function writeBind(data){
    try{ localStorage.setItem(LS_KEY, JSON.stringify(data)); return true; }
    catch{ return false; }
  }
  function clearBind(){
    try{ localStorage.removeItem(LS_KEY); }catch{}
  }

  function currentParams(){
    const p = new URLSearchParams(location.search);
    const z   = norm((p.get("zone")||"").toUpperCase());
    const cId = norm(p.get("compId")||"");
    const sId = norm(p.get("stageId")||""); // –º–æ–∂–µ –±—É—Ç–∏ –ø—É—Å—Ç–∏–π => main
    const t   = norm(p.get("t")||"");
    return { zone:z, compId:cId, stageId:sId, token:t };
  }

  function makeActiveKey(compId, stageId){
    return `${String(compId||"").trim()}||${String(stageId||"").trim() || "main"}`;
  }

  function renderBindState(){
    const bind = readBind();
    if (!bind){
      zoneTitle.textContent = "–ó–æ–Ω–∞ ‚Äî";
      statusEl.textContent = "‚ùó –ù–µ–º–∞ –ø—Ä–∏–≤‚Äô—è–∑–∫–∏. –í—ñ–¥–∫—Ä–∏–π QR/–ª—ñ–Ω–∫ –≤—ñ–¥ –∞–¥–º—ñ–Ω–∞ –æ–¥–∏–Ω —Ä–∞–∑ ‚Äî —ñ –∑–æ–Ω–∞ –∑–±–µ—Ä–µ–∂–µ—Ç—å—Å—è.";
      bindInfo.textContent = "‚Äî";
      return;
    }
    const ak = makeActiveKey(bind.compId, bind.stageId);
    zoneTitle.textContent = `–ó–æ–Ω–∞ ${bind.zone}`;
    statusEl.textContent = "‚úÖ –ü—Ä–∏–≤‚Äô—è–∑–∫–∞ –∑–æ–Ω–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–∞ –Ω–∞ —Ü—å–æ–º—É —Ç–µ–ª–µ—Ñ–æ–Ω—ñ.";
    bindInfo.textContent = `zone=${bind.zone} | compId=${bind.compId} | stageId=${bind.stageId || "main"} | activeKey=${ak}`;
  }

  function settingsDocIdByActiveKey(activeKey){
    return `weighing_${activeKey}`;
  }

  async function getOrCreateWeighingSettings(){
    const ref = db.collection("settings").doc(settingsDocIdByActiveKey(activeKey));
    const snap = await ref.get();
    if(snap.exists) return { ref, data:(snap.data()||{}) };

    const init = {
      activeKey,
      compId,
      stageId: stageId || "main",
      maxW: DEFAULT_MAX_W,
      current: { A:1, B:1, C:1 },
      updatedAt: window.firebase.firestore.FieldValue.serverTimestamp()
    };
    await ref.set(init, { merge:true });
    return { ref, data:init };
  }

  function getCurrentWForZone(settingsData){
    const cur = settingsData.current || {};
    const w = Number(cur[zone] || 1);
    return Math.min(Math.max(w,1), Number(settingsData.maxW || DEFAULT_MAX_W));
  }

  async function setCurrentWForZone(nextW){
    const ref = db.collection("settings").doc(settingsDocIdByActiveKey(activeKey));
    await db.runTransaction(async (tx)=>{
      const snap = await tx.get(ref);
      const d = snap.data() || {};
      const mW = Number(d.maxW || DEFAULT_MAX_W);
      const cur = Object.assign({A:1,B:1,C:1}, d.current || {});
      const safe = Math.min(Math.max(Number(nextW||1),1), mW);
      cur[zone] = safe;
      tx.set(ref, {
        current: cur,
        updatedAt: window.firebase.firestore.FieldValue.serverTimestamp()
      }, { merge:true });
    });
  }

  function updateWButtons(){
    curWEl.textContent = `W${currentW}`;
    wBtns.forEach(b=>{
      b.el.classList.toggle("isActive", b.n === viewW);
      b.el.disabled = (b.n > currentW);
    });
  }

  async function loadTeamsForZone(){
    const srSnap = await db.collection("stageResults").doc(activeKey).get();
    const sr = srSnap.exists ? (srSnap.data()||{}) : {};
    const teams = Array.isArray(sr.teams) ? sr.teams : [];

    const arr = teams
      .filter(t => String(t.drawZone||"").toUpperCase() === String(zone||"").toUpperCase())
      .map(t => ({
        teamId: String(t.regId || t.teamId || ""),
        teamName: String(t.teamName || ""),
        sector: Number(t.drawSector || 0)
      }))
      .filter(x => x.teamId);

    arr.sort((a,b)=> (a.sector||0)-(b.sector||0) || (a.teamName||"").localeCompare(b.teamName||"", "uk"));
    return arr;
  }

  function weighingDocId(teamId, wNo){
    return `${activeKey}_${zone}_${teamId}_W${wNo}`;
  }

  async function loadWeighing(teamId, wNo){
    const id = weighingDocId(teamId, wNo);
    const snap = await db.collection("weighings").doc(id).get();
    return snap.exists ? (snap.data()||null) : null;
  }

  function toNum(val){
    const s = String(val ?? "").trim().replace(",", ".");
    if(!s) return NaN;
    return Number(s);
  }

  function clampWeight(x){
    // –º–∞–∫—Å–∏–º—É–º –ø–æ —Ü–∏—Ñ—Ä–∞—Ö: 000.00 -> 999.99
    if(!Number.isFinite(x)) return NaN;
    x = Math.max(0, Math.min(x, 999.99));
    return Math.round(x * 100) / 100;
  }

  function computeFromFishWeights(fishWeights){
    const arr = (Array.isArray(fishWeights) ? fishWeights : [])
      .map(toNum)
      .map(clampWeight)
      .filter(n => Number.isFinite(n) && n > 0);

    const fishCount = arr.length;
    const totalWeightKg = Math.round(arr.reduce((a,b)=>a+b,0) * 100) / 100;
    const bigFishKg = fishCount ? Math.max(...arr) : 0;
    return { fishWeights: arr, fishCount, totalWeightKg, bigFishKg };
  }

  async function saveWeighing(team, wNo, fishWeights){
    const id = weighingDocId(team.teamId, wNo);
    const ts = window.firebase.firestore.FieldValue.serverTimestamp();

    const calc = computeFromFishWeights(fishWeights);

    await db.collection("weighings").doc(id).set({
      activeKey,
      compId,
      stageId: stageId || "main",

      zone,
      sector: Number(team.sector || 0),

      wNo: Number(wNo),
      teamId: team.teamId,
      teamName: team.teamName || "",

      fishWeights: calc.fishWeights,
      fishCount: calc.fishCount,
      totalWeightKg: calc.totalWeightKg,
      bigFishKg: calc.bigFishKg,

      status: "submitted",

      judgeUid: me.uid,
      judgeEmail: me.email || "",

      updatedAt: ts,
      createdAt: ts
    }, { merge: true });

    // –∫–µ—à –æ–Ω–æ–≤–ª—é—î–º–æ –æ–¥—Ä–∞–∑—É
    weighCache[team.teamId] = weighCache[team.teamId] || {};
    weighCache[team.teamId][wNo] = Object.assign({}, calc, { status:"submitted" });
  }

  async function maybeAdvanceAuto(teams){
    if(currentW >= maxW) return false;
    if(!teams.length) return false;

    const wsnap = await db.collection("weighings")
      .where("activeKey","==",activeKey)
      .where("zone","==",zone)
      .where("wNo","==",Number(currentW))
      .where("status","==","submitted")
      .get();

    const got = new Set();
    wsnap.forEach(doc=>{
      const d = doc.data() || {};
      if(d.teamId) got.add(String(d.teamId));
    });

    for(const t of teams){
      if(!got.has(String(t.teamId))) return false;
    }

    await setCurrentWForZone(currentW + 1);
    return true;
  }

  function fmtW(count, kg){
    // —Ñ–æ—Ä–º–∞—Ç –¥–ª—è live: 4/24.79
    const c = Number.isFinite(count) ? count : 0;
    const w = Number.isFinite(kg) ? kg : 0;
    return `${c}/${w.toFixed(2)}`;
  }

  function renderTeamRow(team, wNo, weighing){
    const fishWeights = (weighing && Array.isArray(weighing.fishWeights)) ? weighing.fishWeights : [];
    const calc = computeFromFishWeights(fishWeights);

    const safeWeights = (calc.fishWeights.length ? calc.fishWeights : ["" ]) // –º—ñ–Ω 1 –ø–æ–ª–µ
      .map(v => (v === "" ? "" : String(v.toFixed ? v.toFixed(2) : v)));

    const status = (weighing && weighing.status === "submitted") ? "‚úÖ –∑–¥–∞–Ω–æ" : "‚Äî –Ω–µ –∑–¥–∞–Ω–æ";
    const sum = fmtW(calc.fishCount, calc.totalWeightKg);

    return `
      <div class="teamRow" data-team="${esc(team.teamId)}">
        <div class="teamHead">
          <div>
            <div class="teamTitle">${esc(team.teamName)}</div>
            <div class="teamMeta">–°–µ–∫—Ç–æ—Ä: <b>${esc(team.sector)}</b> ‚Ä¢ W${wNo} ‚Ä¢ <span class="muted">${status}</span></div>
          </div>
          <div class="pill">–†–∞–∑–æ–º: <b>${esc(sum)}</b> ‚Ä¢ Big: <b>${esc((calc.bigFishKg||0).toFixed(2))}</b></div>
        </div>

        <div class="fishGrid">
          <div class="fishTile">
            ${safeWeights.map((v,idx)=>`
              <div class="fishTile" style="margin-bottom:8px;">
                <input class="inp fishInp" inputmode="decimal" placeholder="–í–∞–≥–∞ —Ä–∏–±–∏ (–∫–≥), –Ω–∞–ø—Ä. 12.34"
                  value="${esc(v)}" data-fish="${idx}">
                <button class="fishDel" type="button" data-del="${idx}" ${safeWeights.length<=1 ? "disabled":""}>√ó</button>
              </div>
            `).join("")}
          </div>

          <div class="muted">
            <div>–ü–æ—Ä–∞–¥–∞: –º–æ–∂–Ω–∞ –ø–∏—Å–∞—Ç–∏ <b>12.34</b> –∞–±–æ <b>12,34</b></div>
            <div>–ú–∞–∫—Å —Ü–∏—Ñ—Ä–∏: <b>999.99</b></div>
          </div>

          <button class="fishAdd" type="button" title="–î–æ–¥–∞—Ç–∏ —Ä–∏–±—É" data-add>+</button>
        </div>

        <div class="sumRow">
          <div class="muted">–ê–≤—Ç–æ: üêü <b>${esc(String(calc.fishCount))}</b> ‚Ä¢ –∫–≥ <b>${esc(calc.totalWeightKg.toFixed(2))}</b> ‚Ä¢ Big <b>${esc((calc.bigFishKg||0).toFixed(2))}</b></div>
          <div class="teamBtns">
            <button class="btn btn--ghost" type="button" data-reload>–û–Ω–æ–≤–∏—Ç–∏</button>
            <button class="btn btn--primary" type="button" data-save>–ó–±–µ—Ä–µ–≥—Ç–∏ W${wNo}</button>
          </div>
        </div>

        <div class="muted" data-hint style="margin-top:8px;"></div>
      </div>
    `;
  }

  async function ensureWeighingCached(teamId, wNo){
    weighCache[teamId] = weighCache[teamId] || {};
    if(weighCache[teamId].hasOwnProperty(wNo)) return weighCache[teamId][wNo];
    const d = await loadWeighing(teamId, wNo);
    weighCache[teamId][wNo] = d;
    return d;
  }

  async function renderTeams(teams){
    teamsCountEl.textContent = `–ö–æ–º–∞–Ω–¥ —É –∑–æ–Ω—ñ: ${teams.length}`;
    if(!teams.length){
      teamsBox.innerHTML = `<div class="muted">–ù–µ–º–∞ –∫–æ–º–∞–Ω–¥ —É –∑–æ–Ω—ñ ${esc(zone)}. –ü–µ—Ä–µ–≤—ñ—Ä drawZone —É stageResults.</div>`;
      return;
    }

    // –ø—ñ–¥–≤–∞–Ω—Ç–∞–∂–∏–º–æ weighings –¥–ª—è viewW
    const rows = [];
    for(const t of teams){
      const w = await ensureWeighingCached(t.teamId, viewW);
      rows.push(renderTeamRow(t, viewW, w));
    }
    teamsBox.innerHTML = rows.join("");

    // –Ω–∞–≤—ñ—à–∞—î–º–æ –¥—ñ—ó
    teamsBox.querySelectorAll(".teamRow").forEach(row=>{
      const teamId = row.getAttribute("data-team");
      const hintEl = row.querySelector('[data-hint]');

      function readFishInputs(){
        const vals = [];
        row.querySelectorAll("input[data-fish]").forEach(inp=>{
          vals.push(inp.value);
        });
        return vals;
      }

      row.querySelector("[data-add]")?.addEventListener("click", ()=>{
        const tile = row.querySelector(".fishGrid .fishTile");
        const curInputs = tile.querySelectorAll("input[data-fish]").length;
        const wrap = document.createElement("div");
        wrap.className = "fishTile";
        wrap.style.marginBottom = "8px";
        wrap.innerHTML = `
          <input class="inp fishInp" inputmode="decimal" placeholder="–í–∞–≥–∞ —Ä–∏–±–∏ (–∫–≥), –Ω–∞–ø—Ä. 12.34"
            value="" data-fish="${curInputs}">
          <button class="fishDel" type="button" data-del="${curInputs}">√ó</button>
        `;
        tile.appendChild(wrap);
        reindexFish(row);
        hintEl.textContent = "";
      });

      row.addEventListener("click", (e)=>{
        const del = e.target?.getAttribute && e.target.getAttribute("data-del");
        if(del !== null && del !== undefined){
          const idx = Number(del);
          const blocks = row.querySelectorAll(".fishGrid .fishTile .fishTile");
          // –±–ª–æ–∫–∏ –≤–∫–ª–∞–¥–µ–Ω—ñ ‚Äî –±–µ—Ä–µ–º–æ –Ω–∞–π–±–ª–∏–∂—á–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
          const btn = e.target;
          const container = btn.closest(".fishTile");
          if(container){
            container.remove();
            reindexFish(row);
            hintEl.textContent = "";
          }
        }
      });

      row.querySelector("[data-reload]")?.addEventListener("click", async ()=>{
        try{
          weighCache[teamId][viewW] = await loadWeighing(teamId, viewW);
          // –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏–º–æ –≤—Å–µ (–ø—Ä–æ—Å—Ç–∏–π —Å—Ç–∞–±—ñ–ª—å–Ω–∏–π —Å–ø–æ—Å—ñ–±)
          const teams = await loadTeamsForZone();
          await renderTeams(teams);
        }catch(err){
          hintEl.textContent = "–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: " + (err?.message || err);
          hintEl.className = "muted err";
        }
      });

      row.querySelector("[data-save]")?.addEventListener("click", async ()=>{
        try{
          hintEl.textContent = "–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è‚Ä¶";
          hintEl.className = "muted";

          // –±–µ—Ä–µ–º–æ –∫–æ–º–∞–Ω–¥—É –∑ –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Å–ø–∏—Å–∫—É
          const teams = await loadTeamsForZone();
          const team = teams.find(x => String(x.teamId) === String(teamId));
          if(!team) throw new Error("–ù–µ –∑–Ω–∞–π—à–æ–≤ teamId —É stageResults (–ø–µ—Ä–µ–≤—ñ—Ä regId/teamId).");

          const raw = readFishInputs();
          const calc = computeFromFishWeights(raw);

          await saveWeighing(team, viewW, raw);

          hintEl.textContent = `‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–æ: ${fmtW(calc.fishCount, calc.totalWeightKg)} ‚Ä¢ Big ${calc.bigFishKg.toFixed(2)}`;
          hintEl.className = "muted ok";

          // –∞–≤—Ç–æ-–ø—Ä–æ–≥—Ä–µ—Å W (—è–∫—â–æ –≤—Å–µ –∑–¥–∞–Ω–æ)
          const advanced = await maybeAdvanceAuto(teams);
          if(advanced){
            const s = await getOrCreateWeighingSettings();
            maxW = Number(s.data.maxW || DEFAULT_MAX_W);
            currentW = getCurrentWForZone(s.data);
            if(viewW > currentW) viewW = currentW;
            updateWButtons();
            setWMsg(`–ê–≤—Ç–æ: –≤—Å—ñ –∫–æ–º–∞–Ω–¥–∏ –∑–¥–∞–Ω—ñ ‚Üí –ø–µ—Ä–µ–∫–ª—é—á–∏–≤ –Ω–∞ W${currentW}`, true);
          }

          // –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä —â–æ–± —Å—Ç–∞—Ç—É—Å "‚úÖ –∑–¥–∞–Ω–æ" –±—É–≤ –æ–¥—Ä–∞–∑—É
          await renderTeams(teams);
        }catch(err){
          hintEl.textContent = "‚ùå –ü–æ–º–∏–ª–∫–∞: " + (err?.message || err);
          hintEl.className = "muted err";
        }
      });
    });
  }

  function reindexFish(row){
    const blocks = row.querySelectorAll(".fishGrid .fishTile .fishTile");
    blocks.forEach((b,i)=>{
      const inp = b.querySelector("input[data-fish]");
      const del = b.querySelector("button[data-del]");
      if(inp) inp.setAttribute("data-fish", String(i));
      if(del) del.setAttribute("data-del", String(i));
    });

    // –∑–∞–±–ª–æ–∫—É—î–º–æ delete —è–∫—â–æ 1 –ø–æ–ª–µ
    const dels = row.querySelectorAll("button.fishDel");
    if(dels.length === 1){
      dels[0].disabled = true;
    }else{
      dels.forEach(x => x.disabled = false);
    }
  }

  async function openZoneFlow(){
    const p = currentParams();
    let bind = readBind();

    // —è–∫—â–æ –≤ URL —î –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ ‚Äî –≤–æ–Ω–∏ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–Ω—ñ, —ñ –º–∏ —ó—Ö –∑–±–µ—Ä—ñ–≥–∞—î–º–æ
    if(p.zone && p.compId){
      bind = { zone:p.zone, compId:p.compId, stageId:p.stageId || "", token:p.token || "" };
      writeBind(bind);
    }

    if(!bind || !bind.zone || !bind.compId){
      setMsg("–ù–µ–º–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤. –í—ñ–¥–∫—Ä–∏–π –ª—ñ–Ω–∫/QR –∑ zone —ñ compId –æ–¥–∏–Ω —Ä–∞–∑.", false);
      return;
    }

    zone = String(bind.zone).toUpperCase();
    compId = String(bind.compId);
    stageId = String(bind.stageId || "");
    token = String(bind.token || "");

    activeKey = makeActiveKey(compId, stageId);

    zoneTitle.textContent = `–ó–æ–Ω–∞ ${zone}`;
    statusEl.textContent = "üîÑ –í—ñ–¥–∫—Ä–∏–≤–∞—é –∑–æ–Ω—É‚Ä¶";
    bindInfo.textContent = `zone=${zone} | compId=${compId} | stageId=${stageId || "main"} | activeKey=${activeKey}`;

    // –ø—ñ–¥—Ç—è–≥—É—î–º–æ settings
    const s = await getOrCreateWeighingSettings();
    maxW = Number(s.data.maxW || DEFAULT_MAX_W);
    currentW = getCurrentWForZone(s.data);
    viewW = Math.min(viewW, currentW);

    updateWButtons();

    // –ø—ñ–¥—Ç—è–≥—É—î–º–æ –∫–æ–º–∞–Ω–¥–∏
    const teams = await loadTeamsForZone();
    statusEl.textContent = teams.length ? "‚úÖ –ó–æ–Ω–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∞." : "‚ö†Ô∏è –ó–æ–Ω–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∞, –∞–ª–µ –∫–æ–º–∞–Ω–¥ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ —É stageResults.";
    weighCard.style.display = "block";

    await renderTeams(teams);
    setWMsg(`–ü–µ—Ä–µ–≥–ª—è–¥: W${viewW}. –ü–æ—Ç–æ—á–Ω–µ: W${currentW}.`, true);
  }

  // ===== INIT =====
  (async function init(){
    try{
      renderBindState();
      await waitFirebase();

      db = window.scDb;
      const auth = window.scAuth;

      auth.onAuthStateChanged(async (user)=>{
        if(!user){
          authPill.textContent = "auth: ‚ùå —É–≤—ñ–π–¥–∏ (—Å—É–¥–¥—è)";
          statusEl.textContent = "–ü–æ—Ç—Ä—ñ–±–µ–Ω –≤—Ö—ñ–¥ —Å—É–¥–¥—ñ/–∞–¥–º—ñ–Ω–∞.";
          weighCard.style.display = "none";
          return;
        }

        me = user;
        authPill.textContent = "auth: ‚úÖ " + (user.email || user.uid);

        const ok = await requireJudgeOrAdmin(user);
        if(!ok){
          statusEl.textContent = "‚õî –ù–µ–º–∞ –¥–æ—Å—Ç—É–ø—É. –ü–æ—Ç—Ä—ñ–±–Ω–∞ —Ä–æ–ª—å judge/admin —É users/{uid}.";
          weighCard.style.display = "none";
          return;
        }

        statusEl.textContent = "‚úÖ –î–æ—Å—Ç—É–ø —Å—É–¥–¥—ñ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ.";
        setMsg("–ì–æ—Ç–æ–≤–æ. –ù–∞—Ç–∏—Å–Ω–∏ ¬´–í—ñ–¥–∫—Ä–∏—Ç–∏ –º–æ—é –∑–æ–Ω—É¬ª –∞–±–æ –∑–∞–π–¥–∏ —á–µ—Ä–µ–∑ QR.", true);
      });

      btnOpen.addEventListener("click", async ()=>{
        try{
          setMsg("–í—ñ–¥–∫—Ä–∏–≤–∞—é‚Ä¶", true);
          await openZoneFlow();
          renderBindState();
          setMsg("–ó–æ–Ω–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∞.", true);
        }catch(err){
          setMsg("–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è: " + (err?.message || err), false);
        }
      });

      btnReset.addEventListener("click", ()=>{
        clearBind();
        renderBindState();
        weighCard.style.display = "none";
        setMsg("–ü—Ä–∏–≤‚Äô—è–∑–∫—É —Å–∫–∏–Ω—É—Ç–æ.", true);
      });

      btnSaveHint.addEventListener("click", ()=>{
        alert("–ù–∞ Android/Chrome: –º–µ–Ω—é ‚ãÆ ‚Üí ¬´–î–æ–¥–∞—Ç–∏ –Ω–∞ –≥–æ–ª–æ–≤–Ω–∏–π –µ–∫—Ä–∞–Ω¬ª. –ù–∞ iPhone/Safari: Share ‚Üí Add to Home Screen.");
      });

      // –∫–Ω–æ–ø–∫–∏ W
      wBtns.forEach(b=>{
        b.el.addEventListener("click", async ()=>{
          if(b.n > currentW) return;
          viewW = b.n;
          updateWButtons();
          try{
            const teams = await loadTeamsForZone();
            await renderTeams(teams);
            setWMsg(`–ü–µ—Ä–µ–≥–ª—è–¥: W${viewW}`, true);
          }catch(err){
            setWMsg("–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è: " + (err?.message || err), false);
          }
        });
      });

    }catch(err){
      statusEl.textContent = "‚ùå –ü–æ–º–∏–ª–∫–∞ init: " + (err?.message || err);
    }
  })();

})();
</script>

</body>
</html>
