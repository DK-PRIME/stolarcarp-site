<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>STOLAR CARP • Адмінка</title>

  <link rel="stylesheet" href="assets/css/main.css">

  <style>
    body{ background: radial-gradient(circle at top,#111827 0,#020617 55%); }
    .admin-wrap{ max-width:980px; margin:0 auto; padding:22px 0 70px; }

    .admin-top{
      padding:14px 16px; border-radius:18px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.35);
      box-shadow:0 18px 40px rgba(0,0,0,.6);
    }
    .muted{ color:#9ca3af; }
    .admin-hidden{ display:none; }

    .admin-card{
      margin-top:14px;
      padding:16px;
      border-radius:18px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.35);
      box-shadow:0 18px 40px rgba(0,0,0,.6);
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }

    .stack{ display:flex; flex-direction:column; gap:10px; }
    .stack .btn{
      width:100%;
      justify-content:center;
      padding:12px 14px;
      border-radius:14px;
    }

    .mini-form{
      margin-top:12px;
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    .mini-form input, .mini-form select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,.35);
      background:rgba(2,6,23,.55);
      color:#e5e7eb;
      outline:none;
    }
    .mini-form input::placeholder{ color:#6b7280; }

    .hr{ height:1px; background:rgba(148,163,184,.18); margin:12px 0; border-radius:99px; }

    .grid2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media (max-width:640px){
      .grid2{ grid-template-columns:1fr; }
    }

    .stage-box{
      border:1px solid rgba(148,163,184,.20);
      border-radius:14px;
      padding:12px;
      background:rgba(2,6,23,.35);
    }
    .stage-title{
      font-weight:800;
      letter-spacing:.06em;
      text-transform:uppercase;
      margin:0 0 8px;
      font-size:.92rem;
    }
    .hint{
      font-size:.82rem;
      color:#9ca3af;
      margin-top:-2px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.35);
      background:rgba(2,6,23,.35);
      font-size:.85rem;
      color:#e5e7eb;
    }
  </style>
</head>

<body>

<header class="header">
  <div class="container header__row">
    <a class="logo" href="index.html">
      <span class="logo__mark">SC</span>
      <span class="logo__text">STOLAR CARP</span>
    </a>
    <nav class="nav">
      <a href="/index.html" class="nav__link">Головна</a>
      <a href="/live.html" class="nav__link">Live</a>
      <a href="/rating.html" class="nav__link">Рейтинг</a>
      <a href="/cabinet.html" class="nav__link">Мій кабінет</a>
    </nav>
  </div>
</header>

<main class="main">
  <section class="section container admin-wrap">

    <div class="admin-top">
      <div class="title-gradient" style="font-size:1.2rem; font-weight:800;">Адмінка STOLAR CARP</div>
      <div class="muted" id="adminStatus">Запуск…</div>
    </div>

    <!-- LOGIN (тільки якщо немає сесії) -->
    <div id="adminLogin" class="admin-card admin-hidden">
      <h2 class="section-title" style="margin:0 0 10px;">Вхід адміністратора</h2>
      <div class="muted">Увійди email/паролем адмін-акаунта. Реєстрації тут немає.</div>

      <div class="row" style="margin-top:12px;">
        <input id="admEmail" type="email" placeholder="Email"
          style="flex:1; min-width:220px; padding:10px 12px; border-radius:12px; border:1px solid rgba(148,163,184,.35); background:rgba(2,6,23,.55); color:#e5e7eb;">
        <input id="admPass" type="password" placeholder="Пароль"
          style="flex:1; min-width:220px; padding:10px 12px; border-radius:12px; border:1px solid rgba(148,163,184,.35); background:rgba(2,6,23,.55); color:#e5e7eb;">
        <button class="btn btn--accent" id="btnAdminLogin">Увійти</button>
      </div>

      <div class="muted" id="adminLoginMsg" style="margin-top:10px;"></div>
    </div>

    <!-- APP -->
    <div id="adminApp" class="admin-hidden">

      <div class="admin-card">
        <h2 class="section-title" style="margin:0 0 8px;">Створити змагання (нова логіка)</h2>
        <div class="muted">
          Пише в <b>competitions/{competitionId}</b> і може зробити активним у <b>settings/app</b>.
          <div class="hint">Для кожного етапу — тільки дати відкриття/закриття. Час автоматично = <b>12:00 (Київ)</b>.</div>
        </div>

        <div class="hr"></div>

        <div class="mini-form">
          <select id="inpType">
            <option value="season">Тип: СЕЗОН (з етапами + фінал опційно)</option>
            <option value="single">Тип: ОДНОРАЗОВЕ змагання</option>
          </select>

          <!-- SEASON YEAR -->
          <input id="inpYear" placeholder="Рік сезону (наприклад: 2026)" inputmode="numeric">

          <!-- BRAND (AUTO) -->
          <input id="inpBrand" value="STOLAR CARP" readonly>

          <!-- TITLE -->
          <input id="inpTitle" placeholder="Назва (авто для сезону: Season STOLAR CARP 2026)">

          <div id="seasonOnlyBlock">
            <select id="inpStagesCount">
              <option value="2">К-сть етапів у сезоні: 2</option>
              <option value="3" selected>К-сть етапів у сезоні: 3</option>
              <option value="4">К-сть етапів у сезоні: 4</option>
              <option value="5">К-сть етапів у сезоні: 5</option>
              <option value="6">К-сть етапів у сезоні: 6</option>
              <option value="7">К-сть етапів у сезоні: 7</option>
              <option value="8">К-сть етапів у сезоні: 8</option>
            </select>

            <select id="inpHasFinal">
              <option value="yes" selected>Фінал: ТАК</option>
              <option value="no">Фінал: НІ</option>
            </select>
          </div>

          <div class="pill">
            <span>Режим реєстрації:</span>
            <b>AUTO (по даті)</b>
            <span class="muted">· ручний режим прибрали</span>
          </div>

          <div class="hr"></div>

          <div id="stageDatesWrap"></div>

          <div class="stack" style="margin-top:10px;">
            <button class="btn btn--accent" id="btnSaveCompetition">Зберегти змагання</button>
            <button class="btn btn--primary" id="btnMakeActive">Зробити активним</button>
          </div>

          <div class="muted" id="saveMsg" style="margin-top:10px;"></div>
        </div>
      </div>

      <!-- (Опційно) список існуючих для швидкого зробити активним -->
      <div class="admin-card">
        <h2 class="section-title" style="margin:0 0 8px;">Швидко: зробити активним існуюче</h2>
        <div class="mini-form">
          <select id="selExisting"></select>
          <button class="btn btn--accent" id="btnMakeActiveExisting">Зробити активним вибране</button>
        </div>
        <div class="muted" id="existingMsg" style="margin-top:10px;"></div>
      </div>

    </div>
  </section>
</main>

<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<!-- Єдиний init -->
<script src="assets/js/firebase-init.js"></script>

<script>
  const ADMIN_UID = "5Dt6fN64c3aWACYV1WacxV2BHDl2";

  const $ = (id)=>document.getElementById(id);
  const show = (el)=>el && el.classList.remove("admin-hidden");
  const hide = (el)=>el && el.classList.add("admin-hidden");
  const setStatus = (t)=>{ const e=$("adminStatus"); if(e) e.textContent=t; };

  function escapeHTML(s){
    return String(s ?? "")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
  }

  function slugify(s){
    return String(s||"")
      .trim()
      .toLowerCase()
      .replace(/['"]/g,"")
      .replace(/[^a-z0-9\u0400-\u04FF]+/g,"-")
      .replace(/-+/g,"-")
      .replace(/^-|-$/g,"");
  }

  // Date helper: expects YYYY-MM-DD, time fixed at 12:00 local (Kyiv device = OK)
  function dateAtNoon(dateStr){
    const v = (dateStr||"").trim();
    if(!v) return null;
    const m = v.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(!m) return null;
    const Y = Number(m[1]), Mo = Number(m[2]), D = Number(m[3]);
    return new Date(Y, Mo-1, D, 12, 0, 0, 0);
  }
  function toTS(d){
    return d ? window.firebase.firestore.Timestamp.fromDate(d) : null;
  }

  async function waitForFirebase(){
    for(let i=0;i<120;i++){
      if(window.scAuth && window.scDb) return;
      await new Promise(r=>setTimeout(r,100));
    }
    throw new Error("Firebase НЕ ініціалізований (scAuth / scDb)");
  }

  function buildStageDatesUI(){
    const type = $("inpType").value;
    const wrap = $("stageDatesWrap");
    const seasonOnly = $("seasonOnlyBlock");
    if(!wrap) return;

    wrap.innerHTML = "";

    if(type === "single"){
      // hide season-only controls
      if(seasonOnly) seasonOnly.style.display = "none";
      // single: one registration window
      wrap.innerHTML = `
        <div class="stage-box">
          <div class="stage-title">Реєстрація на змагання</div>
          <div class="hint">Вкажи дати (час буде 12:00 Київ)</div>
          <div class="grid2" style="margin-top:10px;">
            <input type="date" id="regOpen_single" />
            <input type="date" id="regClose_single" />
          </div>
          <div class="hint" style="margin-top:8px;">Ліворуч — відкриття, праворуч — закриття</div>
        </div>
      `;
      return;
    }

    if(seasonOnly) seasonOnly.style.display = "";

    const n = Number($("inpStagesCount").value || "3");
    const hasFinal = ($("inpHasFinal").value === "yes");

    for(let i=1;i<=n;i++){
      wrap.insertAdjacentHTML("beforeend", `
        <div class="stage-box">
          <div class="stage-title">Етап ${i}</div>
          <div class="hint">Дати реєстрації (час автоматично 12:00 Київ)</div>
          <div class="grid2" style="margin-top:10px;">
            <input type="date" id="regOpen_stage_${i}" />
            <input type="date" id="regClose_stage_${i}" />
          </div>
          <div class="hint" style="margin-top:8px;">Відкриття / Закриття</div>
        </div>
      `);
    }

    if(hasFinal){
      wrap.insertAdjacentHTML("beforeend", `
        <div class="stage-box">
          <div class="stage-title">Фінал</div>
          <div class="hint">Дати реєстрації на фінал (час автоматично 12:00 Київ)</div>
          <div class="grid2" style="margin-top:10px;">
            <input type="date" id="regOpen_final" />
            <input type="date" id="regClose_final" />
          </div>
        </div>
      `);
    }
  }

  function autoFillTitle(){
    const type = $("inpType").value;
    const brand = "STOLAR CARP";
    $("inpBrand").value = brand;

    if(type === "season"){
      const y = ($("inpYear").value || "").trim();
      if(y && !$("inpTitle").dataset.touched){
        $("inpTitle").value = `Season ${brand} ${y}`;
      }
    }else{
      // single: leave as-is
      if(!$("inpTitle").dataset.touched && !$("inpTitle").value.trim()){
        $("inpTitle").value = "";
      }
    }
  }

  async function loadExistingCompetitions(){
    const sel = $("selExisting");
    const msg = $("existingMsg");
    if(!sel) return;
    sel.innerHTML = `<option value="">Завантаження…</option>`;
    if(msg) msg.textContent = "";

    const db = window.scDb;
    const snap = await db.collection("competitions").orderBy("createdAt","desc").limit(50).get();

    if(snap.empty){
      sel.innerHTML = `<option value="">Нема створених змагань</option>`;
      return;
    }

    const opts = [];
    snap.forEach(doc=>{
      const d = doc.data() || {};
      const title = d.title || doc.id;
      const type = d.type || "";
      const badge = type === "season" ? "Сезон" : "Разове";
      opts.push({
        id: doc.id,
        label: `${badge} · ${title} (${doc.id})`
      });
    });

    sel.innerHTML = opts.map(o=>`<option value="${escapeHTML(o.id)}">${escapeHTML(o.label)}</option>`).join("");
  }

  async function init(){
    await waitForFirebase();
    const auth = window.scAuth;
    const db   = window.scDb;

    const loginBox = $("adminLogin");
    const appBox   = $("adminApp");
    const btnLogin = $("btnAdminLogin");
    const msg      = $("adminLoginMsg");

    function showLogin(text){
      hide(appBox);
      show(loginBox);
      if(msg) msg.textContent = text || "";
    }
    function showApp(){
      hide(loginBox);
      show(appBox);
    }

    // events
    $("inpTitle").addEventListener("input", ()=>{ $("inpTitle").dataset.touched = "1"; });
    $("inpType").addEventListener("change", ()=>{ autoFillTitle(); buildStageDatesUI(); });
    $("inpYear").addEventListener("input", ()=>{ autoFillTitle(); });
    $("inpStagesCount").addEventListener("change", buildStageDatesUI);
    $("inpHasFinal").addEventListener("change", buildStageDatesUI);

    if(btnLogin){
      btnLogin.onclick = async () => {
        const email = $("admEmail").value.trim();
        const pass  = $("admPass").value.trim();
        if(!email || !pass){ msg.textContent = "Введи email і пароль"; return; }
        msg.textContent = "Вхід…";
        try{ await auth.signInWithEmailAndPassword(email, pass); }
        catch(e){ msg.textContent = e?.message || "Помилка входу"; }
      };
    }

    auth.onAuthStateChanged(async (user) => {
      if(!user){
        setStatus("Потрібен вхід (адмін)");
        showLogin("Увійди як адміністратор");
        return;
      }
      if(user.uid !== ADMIN_UID){
        setStatus("Доступ заборонено ❌");
        showLogin("Цей акаунт не має доступу");
        return;
      }

      setStatus("Адмін-доступ дозволено ✅");
      showApp();

      // init form
      autoFillTitle();
      buildStageDatesUI();
      await loadExistingCompetitions();
    });

    function collectPayload(){
      const type = $("inpType").value; // season | single
      const brand = "STOLAR CARP";
      const title = $("inpTitle").value.trim();

      if(type === "season"){
        const yearStr = ($("inpYear").value || "").trim();
        const year = Number(yearStr);
        if(!Number.isFinite(year) || year < 2020 || year > 2100){
          throw new Error("Вкажи коректний рік сезону (наприклад 2026).");
        }

        const stagesCount = Number($("inpStagesCount").value || "3");
        const hasFinal = ($("inpHasFinal").value === "yes");

        if(!title){
          throw new Error("Назва порожня. Має бути хоча б 'Season STOLAR CARP 2026'.");
        }

        const stages = [];
        for(let i=1;i<=stagesCount;i++){
          const openV = $("regOpen_stage_"+i)?.value || "";
          const closeV = $("regClose_stage_"+i)?.value || "";
          const openD = dateAtNoon(openV);
          const closeD = dateAtNoon(closeV);

          if(!openD || !closeD){
            throw new Error(`Заповни дати реєстрації для Етапу ${i}.`);
          }
          if(closeD < openD){
            throw new Error(`Етап ${i}: дата закриття не може бути раніше відкриття.`);
          }

          stages.push({
            id: "stage-" + i,
            name: "Етап " + i,
            regOpenDate: openV,   // для зручності читання
            regCloseDate: closeV, // для зручності читання
            regOpenAt: toTS(openD),
            regCloseAt: toTS(closeD)
          });
        }

        let finalObj = null;
        if(hasFinal){
          const openV = $("regOpen_final")?.value || "";
          const closeV = $("regClose_final")?.value || "";
          const openD = dateAtNoon(openV);
          const closeD = dateAtNoon(closeV);
          if(!openD || !closeD) throw new Error("Заповни дати реєстрації для Фіналу.");
          if(closeD < openD) throw new Error("Фінал: дата закриття не може бути раніше відкриття.");

          finalObj = {
            id: "final",
            name: "Фінал",
            regOpenDate: openV,
            regCloseDate: closeV,
            regOpenAt: toTS(openD),
            regCloseAt: toTS(closeD)
          };
        }

        const competitionId = `season-${year}`;

        return {
          competitionId,
          doc: {
            type: "season",
            brand,
            year,
            title,
            stagesCount,
            hasFinal: !!hasFinal,
            stages,
            final: finalObj,

            // реєстрація на сайті AUTO по датах (ручного не робимо)
            regMode: "auto",

            updatedAt: window.firebase.firestore.FieldValue.serverTimestamp(),
            createdAt: window.firebase.firestore.FieldValue.serverTimestamp()
          }
        };
      }

      // SINGLE
      if(!title){
        throw new Error("Вкажи назву одноразового змагання (наприклад: Осінній Короп).");
      }

      const openV = $("regOpen_single")?.value || "";
      const closeV = $("regClose_single")?.value || "";
      const openD = dateAtNoon(openV);
      const closeD = dateAtNoon(closeV);

      if(!openD || !closeD){
        throw new Error("Заповни дати реєстрації для змагання.");
      }
      if(closeD < openD){
        throw new Error("Дата закриття не може бути раніше відкриття.");
      }

      const competitionId = `single-${slugify(title) || ("comp-" + Date.now())}`;

      return {
        competitionId,
        doc: {
          type: "single",
          brand,
          title,
          regMode: "auto",
          regOpenDate: openV,
          regCloseDate: closeV,
          regOpenAt: toTS(openD),
          regCloseAt: toTS(closeD),

          updatedAt: window.firebase.firestore.FieldValue.serverTimestamp(),
          createdAt: window.firebase.firestore.FieldValue.serverTimestamp()
        }
      };
    }

    $("btnSaveCompetition").onclick = async ()=>{
      const out = $("saveMsg");
      out.textContent = "Збереження…";
      try{
        const payload = collectPayload();
        const ref = db.collection("competitions").doc(payload.competitionId);

        await ref.set(payload.doc, { merge:true });

        out.textContent = `✅ Збережено: competitions/${payload.competitionId}`;
        await loadExistingCompetitions();
      }catch(e){
        console.error(e);
        out.textContent = "❌ " + (e?.message || e);
      }
    };

    $("btnMakeActive").onclick = async ()=>{
      const out = $("saveMsg");
      out.textContent = "Роблю активним…";
      try{
        const payload = collectPayload();
        await db.collection("competitions").doc(payload.competitionId).set(payload.doc, { merge:true });

        await db.collection("settings").doc("app").set({
          activeCompetitionId: payload.competitionId,
          updatedAt: window.firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });

        out.textContent = `✅ Активне: ${payload.competitionId} (settings/app)`;
        await loadExistingCompetitions();
      }catch(e){
        console.error(e);
        out.textContent = "❌ " + (e?.message || e);
      }
    };

    $("btnMakeActiveExisting").onclick = async ()=>{
      const id = ($("selExisting").value || "").trim();
      const out = $("existingMsg");
      if(!id){ out.textContent = "Вибери змагання зі списку."; return; }
      out.textContent = "Роблю активним…";
      try{
        await db.collection("settings").doc("app").set({
          activeCompetitionId: id,
          updatedAt: window.firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
        out.textContent = `✅ Активне: ${id}`;
      }catch(e){
        console.error(e);
        out.textContent = "❌ " + (e?.message || e);
      }
    };
  }

  init().catch(err=>{
    console.error(err);
    setStat
