<script>
(function(){
  "use strict";

  // ---------- helpers: анти-білий екран ----------
  function ensureEl(id, parent, className, styleText){
    let el = document.getElementById(id);
    if(el) return el;
    el = document.createElement("div");
    el.id = id;
    if(className) el.className = className;
    if(styleText) el.style.cssText = styleText;
    (parent || document.body).appendChild(el);
    return el;
  }

  const $ = (id)=>document.getElementById(id);

  const safeRoot =
    document.querySelector(".section.container") ||
    document.querySelector(".section") ||
    document.querySelector("main") ||
    document.body;

  // гарантовано маємо місця для повідомлень/таблиць
  const msgEl  = ensureEl("weighMsg",  safeRoot, "muted", "margin-top:10px;");
  const dbgEl  = ensureEl("weighDebug",safeRoot, "muted", "margin-top:6px; white-space:pre-wrap;");
  const wrapEl = ensureEl("tablesWrap",safeRoot, "",      "margin-top:12px;");

  const esc = (s)=>String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  const norm = (v)=>String(v??"").trim();

  function setMsg(t, ok=true){
    msgEl.textContent = t || "";
    msgEl.className = "muted " + (t ? (ok ? "ok" : "err") : "");
  }
  function setDbg(t){
    dbgEl.textContent = t || "";
  }

  // показуємо помилки на екрані
  window.addEventListener("error", (e)=>{
    setMsg("JS помилка ❌", false);
    setDbg(e?.message || "error");
  });
  window.addEventListener("unhandledrejection", (e)=>{
    setMsg("Promise помилка ❌", false);
    setDbg(e?.reason?.message || String(e?.reason || "promise error"));
  });

  // ---------- Firebase ----------
  const auth = window.scAuth;
  const db   = window.scDb;
  const fb   = window.firebase;

  if(!auth || !db || !fb){
    setMsg("Firebase init не завантажився (scAuth/scDb).", false);
    setDbg("Перевір підключення compat SDK та assets/js/firebase-init.js");
    return;
  }

  // ---------- DOM: селект/кнопки (робастно) ----------
  const stageSelect =
    $("stageSelect") ||
    $("stage") ||
    document.querySelector("select#stageSelect") ||
    document.querySelector("select");

  if(!stageSelect){
    setMsg("Не знайдено select для етапу ❌", false);
    setDbg("Додай <select id='stageSelect'></select> у верхню картку.");
    return;
  }

  function findButtonByText(re){
    return Array.from(document.querySelectorAll("button, a.btn"))
      .find(b => re.test((b.textContent||"").trim()));
  }

  const btnLoad =
    $("btnLoad") || $("btnLoadData") || document.querySelector("[data-load]") ||
    findButtonByText(/завантаж/i);

  const btnRefresh =
    $("btnRefresh") || $("btnReload") || $("btnReloadList") || $("btnRefreshList") ||
    findButtonByText(/оновит/i);

  if(!btnLoad){
    setMsg("Не знайдено кнопку “Завантажити дані” ❌", false);
    setDbg("Дай кнопці id='btnLoadData' або переконайся, що в тексті кнопки є слово “Завантажити”.");
    return;
  }

  // ---------- auth/roles ----------
  async function requireAdmin(user){
    const snap = await db.collection("users").doc(user.uid).get();
    const role = (snap.exists ? (snap.data()||{}).role : "") || "";
    return role === "admin";
  }

  // value: compId||stageKey
  function parseStageValue(v){
    const [compId, stageIdRaw] = String(v||"").split("||");
    return { compId: norm(compId), stageId: norm(stageIdRaw) || "" };
  }

  async function loadStagesToSelect(){
    stageSelect.innerHTML = `<option value="">Завантаження…</option>`;

    const items = [];
    const snap = await db.collection("competitions").get();

    snap.forEach(docSnap=>{
      const c = docSnap.data()||{};
      const compId = docSnap.id;

      const brand = c.brand || "STOLAR CARP";
      const year  = c.year || c.seasonYear || "";
      const compTitle = c.name || c.title || (year ? `Season ${year}` : compId);

      const eventsArr = Array.isArray(c.events) ? c.events : null;

      if(eventsArr && eventsArr.length){
        eventsArr.forEach((ev, idx)=>{
          const key = String(ev.key || ev.stageId || ev.id || `stage-${idx+1}`);
          const stageTitle = ev.title || ev.name || ev.label || `Етап ${idx+1}`;
          items.push({ value:`${compId}||${key}`, label:`${brand} · ${compTitle} — ${stageTitle}` });
        });
      }else{
        items.push({ value:`${compId}||`, label:`${brand} · ${compTitle}` });
      }
    });

    items.sort((a,b)=>a.label.localeCompare(b.label,"uk"));

    stageSelect.innerHTML =
      `<option value="">— Оберіть —</option>` +
      items.map(x=>`<option value="${esc(x.value)}">${esc(x.label)}</option>`).join("");
  }

  // ---------- ГОЛОВНЕ: знайти жеребкування ----------
  async function findDrawDoc(compId, stageId){
    // якщо stageId пустий — теж пробуємо по compId
    const sid = stageId || "stage-1";

    const candidates = [
      { col:"draws", doc:`${compId}_${sid}` },
      { col:"draws", doc:`${compId}__${sid}` },
      { col:"draws", doc:`${compId}||${sid}` },
      { col:"draws", doc:`${compId}-${sid}` },
      { col:"draws", doc:`${compId}` },

      { col:"draw", doc:`${compId}_${sid}` },
      { col:"drawings", doc:`${compId}_${sid}` },
    ];

    // 1) competitions/{compId}/draws/{stageId}
    try{
      const s = await db.collection("competitions").doc(compId).collection("draws").doc(sid).get();
      if(s.exists) return { ref:s.ref, data:s.data()||{}, where:`competitions/${compId}/draws/${sid}` };
    }catch(_){}

    // 2) прямі docs
    for(const c of candidates){
      try{
        const s = await db.collection(c.col).doc(c.doc).get();
        if(s.exists) return { ref:s.ref, data:s.data()||{}, where:`${c.col}/${c.doc}` };
      }catch(_){}
    }

    // 3) query (якщо збережено як документи з полями compId/stageId)
    try{
      const q = await db.collection("draws")
        .where("compId","==",compId)
        .where("stageId","==",sid)
        .limit(1)
        .get();
      if(!q.empty){
        const d = q.docs[0];
        return { ref:d.ref, data:d.data()||{}, where:`draws(query)->${d.id}` };
      }
    }catch(_){}

    return null;
  }

  function extractZones(drawData){
    let A = drawData.A || drawData.zoneA || drawData.a || null;
    let B = drawData.B || drawData.zoneB || drawData.b || null;
    let C = drawData.C || drawData.zoneC || drawData.c || null;

    if(!A && !B && !C && drawData.zones){
      const z = drawData.zones;
      if(Array.isArray(z)){
        for(const item of z){
          const zn = String(item.zone || item.key || "").toUpperCase();
          const teams = item.teams || item.items || item.list || [];
          if(zn==="A") A = teams;
          if(zn==="B") B = teams;
          if(zn==="C") C = teams;
        }
      }else if(typeof z === "object"){
        A = z.A || z.zoneA || null;
        B = z.B || z.zoneB || null;
        C = z.C || z.zoneC || null;
      }
    }

    return {
      A: Array.isArray(A) ? A : [],
      B: Array.isArray(B) ? B : [],
      C: Array.isArray(C) ? C : [],
    };
  }

  // ---------- UI таблиць ----------
  function teamLabel(t, idx){
    const sector = t.sector || t.place || t.slot || t.position || (idx+1);
    const name   = t.teamName || t.name || t.team || t.title || "Команда";
    const teamId = t.teamId || t.id || "";
    return { sector, name, teamId };
  }

  function renderZoneTable(zone, teams){
    const rows = teams.map((t, idx)=>{
      const x = teamLabel(t, idx);
      return `
        <div class="win-card" data-zone="${zone}" data-team="${esc(x.teamId)}" style="margin-top:10px;">
          <div class="win-title">
            <span>Сектор ${esc(x.sector)} — ${esc(x.name)}</span>
            <span class="badge">${zone}</span>
          </div>

          <div class="grid2" style="grid-template-columns: 1fr auto; gap:10px;">
            <input type="number" step="0.001" placeholder="Вага (наприклад 4.560)" data-weight />
            <button class="btn btn--accent" type="button" data-add>+</button>
          </div>

          <div class="muted" style="margin-top:8px;">Внесені ваги:</div>
          <div class="muted" data-list style="margin-top:6px;">—</div>

          <div class="hr"></div>

          <div class="grid2">
            <button class="btn btn--primary" type="button" data-save>Зберегти</button>
            <button class="btn btn--ghost" type="button" data-clear>Очистити локально</button>
          </div>

          <div class="muted" data-status style="margin-top:8px;"></div>
        </div>
      `;
    }).join("");

    return `
      <div class="admin-card">
        <div style="font-weight:900; margin-bottom:6px;">Зона ${zone}</div>
        ${teams.length ? rows : `<div class="muted">Нема команд у зоні ${zone}.</div>`}
      </div>
    `;
  }

  function renderAllTables(zones){
    wrapEl.innerHTML =
      renderZoneTable("A", zones.A) +
      renderZoneTable("B", zones.B) +
      renderZoneTable("C", zones.C);
  }

  // ---------- local storage ----------
  function keyLocal(compId, stageId, zone, teamId){
    return `sc_weights_${compId}_${stageId}_${zone}_${teamId||"noid"}`;
  }
  function loadLocal(compId, stageId, zone, teamId){
    try{ return JSON.parse(localStorage.getItem(keyLocal(compId, stageId, zone, teamId)) || "[]"); }
    catch{ return []; }
  }
  function saveLocal(compId, stageId, zone, teamId, arr){
    try{ localStorage.setItem(keyLocal(compId, stageId, zone, teamId), JSON.stringify(arr||[])); }
    catch{}
  }
  function refreshCardList(card, arr){
    const list = card.querySelector("[data-list]");
    if(!list) return;
    if(!arr.length){ list.textContent = "—"; return; }
    list.textContent = arr.map(x=>Number(x).toFixed(3)).join(" | ");
  }

  // ---------- Firestore save (тимчасово в weighings) ----------
  async function saveWeighing(compId, stageId, zone, teamId, weights){
    const sid = stageId || "stage-1";
    const id = `${compId}_${sid}_${zone}_${(teamId||"noid")}`;
    await db.collection("weighings").doc(id).set({
      compId,
      stageId: sid,
      zone,
      teamId: teamId || "",
      weights: weights || [],
      totalWeight: (weights||[]).reduce((s,v)=>s+Number(v||0),0),
      updatedAt: fb.firestore.FieldValue.serverTimestamp()
    }, { merge:true });
  }

  // ---------- main: load & build ----------
  async function loadAndBuild(){
    const { compId, stageId } = parseStageValue(stageSelect.value);
    if(!compId) return setMsg("Обери змагання/етап.", false);

    setMsg("Шукаю жеребкування…", true);
    setDbg("");

    const found = await findDrawDoc(compId, stageId);
    if(!found){
      setMsg("❌ Жеребкування не знайдено шляхом, який читає адмінка.", false);
      setDbg(
        "Пробував:\n" +
        "- competitions/{compId}/draws/{stageId}\n" +
        "- draws/{compId}_{stageId}\n" +
        "- draws/{compId}\n" +
        "- draws query where compId+stageId\n\n" +
        "Покажи 1 скрін Firestore: де лежить жеребкування і які поля (A/B/C або zones)."
      );
      wrapEl.innerHTML = "";
      return;
    }

    setDbg("✅ Знайдено жеребкування:\n" + found.where);

    const zones = extractZones(found.data);
    renderAllTables(zones);

    // events for cards
    wrapEl.querySelectorAll(".win-card[data-zone]").forEach(card=>{
      const zone = card.getAttribute("data-zone");
      const teamId = card.getAttribute("data-team") || "";
      const inp = card.querySelector("[data-weight]");
      const btnAdd = card.querySelector("[data-add]");
      const btnSave = card.querySelector("[data-save]");
      const btnClear = card.querySelector("[data-clear]");
      const st = card.querySelector("[data-status]");

      const sid = stageId || "stage-1";
      let arr = loadLocal(compId, sid, zone, teamId);
      refreshCardList(card, arr);

      btnAdd.onclick = ()=>{
        const raw = String(inp.value||"").replace(",",".");
        const v = Number(raw);
        if(!v || v<=0){
          st.textContent = "Введи вагу (наприклад 4.560)";
          st.className="muted err";
          return;
        }
        arr.push(v);
        saveLocal(compId, sid, zone, teamId, arr);
        refreshCardList(card, arr);
        inp.value = "";
        st.textContent = "Додано ✅";
        st.className="muted ok";
      };

      btnClear.onclick = ()=>{
        arr = [];
        saveLocal(compId, sid, zone, teamId, arr);
        refreshCardList(card, arr);
        st.textContent = "Очищено локально";
        st.className="muted";
      };

      btnSave.onclick = async ()=>{
        st.textContent = "Зберігаю…";
        st.className="muted";
        try{
          await saveWeighing(compId, sid, zone, teamId, arr);
          st.textContent = "Збережено у Firestore ✅";
          st.className="muted ok";
        }catch(e){
          st.textContent = "Помилка збереження ❌";
          st.className="muted err";
          setDbg((dbgEl.textContent||"") + "\n\nSAVE ERROR:\n" + (e?.message||String(e)));
        }
      };
    });

    setMsg("✅ Таблиці згенеровані (A/B/C).", true);
  }

  // ---------- init ----------
  async function init(){
    auth.onAuthStateChanged(async (user)=>{
      if(!user){
        setMsg("Увійди як адмін.", false);
        return;
      }
      try{
        const ok = await requireAdmin(user);
        if(!ok){
          setMsg("Цей акаунт не адмін.", false);
          return;
        }

        await loadStagesToSelect();
        setMsg("Обери етап → натисни “Завантажити дані”.", true);

        btnLoad.onclick = loadAndBuild;

        if(btnRefresh){
          btnRefresh.onclick = async ()=>{
            setMsg("Оновлюю список…", true);
            await loadStagesToSelect();
            setMsg("Оновлено ✅", true);
          };
        }
      }catch(e){
        setMsg("Помилка ініціалізації ❌", false);
        setDbg(e?.message || String(e));
      }
    });
  }

  init();

})();
</script>
