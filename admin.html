<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>STOLAR CARP • Адмінка</title>

  <link rel="stylesheet" href="assets/css/main.css">

  <style>
    body{ background: radial-gradient(circle at top,#111827 0,#020617 55%); }
    .admin-wrap{ max-width:980px; margin:0 auto; padding:22px 0 70px; }

    .admin-top{
      padding:14px 16px; border-radius:18px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.35);
      box-shadow:0 18px 40px rgba(0,0,0,.6);
    }
    .muted{ color:#9ca3af; }
    .admin-hidden{ display:none; }

    .admin-card{
      margin-top:14px;
      padding:16px;
      border-radius:18px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.35);
      box-shadow:0 18px 40px rgba(0,0,0,.6);
    }

    .stack{ display:flex; flex-direction:column; gap:10px; }
    .stack .btn{
      width:100%;
      justify-content:center;
      padding:12px 14px;
      border-radius:14px;
    }

    .mini-form{
      margin-top:12px;
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    .mini-form input, .mini-form select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,.35);
      background:rgba(2,6,23,.55);
      color:#e5e7eb;
      outline:none;
    }
    .mini-form input::placeholder{ color:#6b7280; }

    .hr{ height:1px; background:rgba(148,163,184,.18); margin:12px 0; border-radius:99px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.25);
      background:rgba(2,6,23,.35);
      color:#e5e7eb;
      font-size:.9rem;
    }
    .pill input{ width:auto; }
  </style>
</head>

<body>

<header class="header">
  <div class="container header__row">
    <a class="logo" href="index.html">
      <span class="logo__mark">SC</span>
      <span class="logo__text">STOLAR CARP</span>
    </a>
    <nav class="nav">
      <a href="/index.html" class="nav__link">Головна</a>
      <a href="/live.html" class="nav__link">Live</a>
      <a href="/rating.html" class="nav__link">Рейтинг</a>
      <a href="/cabinet.html" class="nav__link">Мій кабінет</a>
    </nav>
  </div>
</header>

<main class="main">
  <section class="section container admin-wrap">

    <div class="admin-top">
      <div class="title-gradient" style="font-size:1.2rem; font-weight:800;">Адмінка STOLAR CARP</div>
      <div class="muted" id="adminStatus">Запуск…</div>
    </div>

    <!-- LOGIN -->
    <div id="adminLogin" class="admin-card admin-hidden">
      <h2 class="section-title" style="margin:0 0 10px;">Вхід адміністратора</h2>
      <div class="muted">Увійди email/паролем адмін-акаунта. Реєстрації тут немає.</div>

      <div class="row" style="margin-top:12px;">
        <input id="admEmail" type="email" placeholder="Email"
          style="flex:1; min-width:220px; padding:10px 12px; border-radius:12px; border:1px solid rgba(148,163,184,.35); background:rgba(2,6,23,.55); color:#e5e7eb;">
        <input id="admPass" type="password" placeholder="Пароль"
          style="flex:1; min-width:220px; padding:10px 12px; border-radius:12px; border:1px solid rgba(148,163,184,.35); background:rgba(2,6,23,.55); color:#e5e7eb;">
        <button class="btn btn--accent" id="btnAdminLogin">Увійти</button>
      </div>

      <div class="muted" id="adminLoginMsg" style="margin-top:10px;"></div>
    </div>

    <!-- APP -->
    <div id="adminApp" class="admin-hidden">

      <div class="admin-card">
        <h2 class="section-title" style="margin:0 0 8px;">Послідовність</h2>
        <div class="muted">Тут: створення змагання і керування реєстрацією. Жереб/зважування — окремі сторінки.</div>

        <div class="hr"></div>

        <div class="stack">
          <button class="btn btn--primary" id="btnOpenCreate">1) Створити змагання / сезон</button>
          <button class="btn btn--accent"  id="btnOpenReg">2) Реєстрація: AUTO / MANUAL</button>

          <a class="btn btn--primary" href="admin-registrations.html">3) Реєстрація команд</a>
          <a class="btn btn--accent"  href="admin-draw.html">4) Жеребкування</a>
          <a class="btn btn--danger"  href="admin-weigh.html">5) Зважування (судді/адмін)</a>
        </div>
      </div>

      <!-- 1) CREATE EVENT -->
      <div class="admin-card admin-hidden" id="modCreate">
        <h2 class="section-title" style="margin:0 0 8px;">Створити змагання</h2>
        <div class="muted">
          Пише в <b>events/{eventId}</b> і може зробити змагання активним через <b>settings/app</b>.
        </div>

        <div class="mini-form">
          <input id="inpEventId" placeholder="eventId (латиниця) напр.: sc-2026 або stalker-2026" />
          <input id="inpTitle" placeholder="Назва (напр.: STOLAR CARP Season 2026 / Осінній короп)" />

          <select id="inpType">
            <option value="season">Тип: СЕЗОН (кілька етапів + можливий фінал)</option>
            <option value="single">Тип: ОДНОРАЗОВЕ змагання</option>
          </select>

          <input id="inpBrand" placeholder="Бренд/серія (напр.: STOLAR CARP)" value="STOLAR CARP" />

          <input id="inpStagesCount" type="number" min="1" step="1" placeholder="Кількість етапів (для сезону, напр.: 3)" />
          <label class="pill">
            <input id="inpHasFinal" type="checkbox" checked>
            <span>Є фінал (для сезону)</span>
          </label>

          <div class="muted" style="margin-top:6px;">
            Реєстрація по даті (час автоматично 12:00):
          </div>
          <input id="inpRegOpenDate" type="date" />
          <input id="inpRegCloseDate" type="date" />

          <select id="inpRegMode">
            <option value="auto">Режим реєстрації: AUTO (по датах)</option>
            <option value="manual">Режим реєстрації: MANUAL (вручну)</option>
          </select>

          <label class="pill">
            <input id="inpArchived" type="checkbox">
            <span>Архівне (прибрати з основного списку, але зберегти)</span>
          </label>
        </div>

        <div class="stack" style="margin-top:12px;">
          <button class="btn btn--accent" id="btnDoCreate">Зберегти змагання</button>
          <button class="btn btn--primary" id="btnSetActive">Зробити активним</button>
        </div>

        <div class="muted" id="createMsg" style="margin-top:10px;"></div>
      </div>

      <!-- 2) REGISTRATION CONTROL -->
      <div class="admin-card admin-hidden" id="modReg">
        <h2 class="section-title" style="margin:0 0 8px;">Реєстрація: AUTO / MANUAL</h2>
        <div class="muted">
          Вибери змагання → подивись стан → (за потреби) відкрий/закрий вручну.
        </div>

        <div class="mini-form">
          <select id="selEvent"></select>
          <div class="muted" id="regInfo">Завантаження…</div>

          <div class="stack">
            <button class="btn btn--accent" id="btnManualOpen">ВІДКРИТИ вручну</button>
            <button class="btn btn--danger" id="btnManualClose">ЗАКРИТИ вручну</button>
            <button class="btn btn--primary" id="btnSyncToActive">Зробити вибране активним</button>
          </div>
        </div>

        <div class="muted" id="regMsg" style="margin-top:10px;"></div>
      </div>

    </div>
  </section>
</main>

<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<!-- Єдиний init -->
<script src="assets/js/firebase-init.js"></script>

<script>
  const ADMIN_UID = "5Dt6fN64c3aWACYV1WacxV2BHDl2";

  const $ = (id)=>document.getElementById(id);
  const show = (el)=>el && el.classList.remove("admin-hidden");
  const hide = (el)=>el && el.classList.add("admin-hidden");
  const setStatus = (t)=>{ const e=$("adminStatus"); if(e) e.textContent=t; };

  const modCreate = $("modCreate");
  const modReg    = $("modReg");

  function openModule(name){
    hide(modCreate); hide(modReg);
    if(name==="create") show(modCreate);
    if(name==="reg") show(modReg);
  }

  function dateAtNoon(dateStr){
    // dateStr: YYYY-MM-DD
    const s = (dateStr || "").trim();
    if(!s) return null;
    const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(!m) return null;
    const Y = Number(m[1]), Mo = Number(m[2]), D = Number(m[3]);
    return new Date(Y, Mo-1, D, 12, 0, 0, 0);
  }
  function toTS(d){ return d ? window.firebase.firestore.Timestamp.fromDate(d) : null; }

  async function waitForFirebase(){
    for(let i=0;i<120;i++){
      if(window.scAuth && window.scDb) return;
      await new Promise(r=>setTimeout(r,100));
    }
    throw new Error("Firebase НЕ ініціалізований (scAuth / scDb)");
  }

  async function init(){
    await waitForFirebase();
    const auth = window.scAuth;
    const db   = window.scDb;

    const loginBox = $("adminLogin");
    const appBox   = $("adminApp");
    const btnLogin = $("btnAdminLogin");
    const msg      = $("adminLoginMsg");

    function showLogin(text){
      hide(appBox);
      show(loginBox);
      if(msg) msg.textContent = text || "";
    }
    function showApp(){
      hide(loginBox);
      show(appBox);
    }

    $("btnOpenCreate").onclick = ()=>openModule("create");
    $("btnOpenReg").onclick    = async ()=>{ openModule("reg"); await loadEvents(); };

    if(btnLogin){
      btnLogin.onclick = async () => {
        const email = $("admEmail").value.trim();
        const pass  = $("admPass").value.trim();
        if(!email || !pass){ msg.textContent = "Введи email і пароль"; return; }
        msg.textContent = "Вхід…";
        try{ await auth.signInWithEmailAndPassword(email, pass); }
        catch(e){ msg.textContent = e?.message || "Помилка входу"; }
      };
    }

    auth.onAuthStateChanged(async (user) => {
      if(!user){
        setStatus("Потрібен вхід (адмін)");
        showLogin("Увійди як адміністратор");
        return;
      }
      if(user.uid !== ADMIN_UID){
        setStatus("Доступ заборонено ❌");
        showLogin("Цей акаунт не має доступу");
        return;
      }

      setStatus("Адмін-доступ дозволено ✅");
      showApp();
      openModule("create");
      await loadEvents();
    });

    // ===== CREATE / UPDATE EVENT =====
    $("btnDoCreate").onclick = async ()=>{
      const eventId = ($("inpEventId").value || "").trim();
      const title   = ($("inpTitle").value || "").trim();
      const type    = $("inpType").value;               // season | single
      const brand   = ($("inpBrand").value || "").trim();

      const stagesCountRaw = ($("inpStagesCount").value || "").trim();
      const stagesCount = stagesCountRaw ? Math.max(1, parseInt(stagesCountRaw,10) || 1) : null;
      const hasFinal = !!$("inpHasFinal").checked;

      const regMode = $("inpRegMode").value;            // auto | manual
      const regOpenAt  = dateAtNoon($("inpRegOpenDate").value);
      const regCloseAt = dateAtNoon($("inpRegCloseDate").value);

      const archived = !!$("inpArchived").checked;

      if(!eventId || !title){
        $("createMsg").textContent = "Заповни мінімум: eventId та Назва.";
        return;
      }

      if(type === "season" && !stagesCount){
        $("createMsg").textContent = "Для сезону вкажи кількість етапів (наприклад: 3).";
        return;
      }

      $("createMsg").textContent = "Збереження…";

      try{
        const ref = db.collection("events").doc(eventId);

        const payload = {
          eventId,
          title,
          type,            // season/single
          brand: brand || "STOLAR CARP",
          stagesCount: type === "season" ? stagesCount : 1,
          hasFinal: type === "season" ? !!hasFinal : false,

          regMode,
          regOpenAt:  toTS(regOpenAt),
          regCloseAt: toTS(regCloseAt),

          manualOpen: false, // MANUAL state (коли натиснеш кнопки у модулі 2)
          archived: !!archived,

          updatedAt: window.firebase.firestore.FieldValue.serverTimestamp(),
          createdAt: window.firebase.firestore.FieldValue.serverTimestamp()
        };

        await ref.set(payload, { merge:true });

        $("createMsg").textContent = "✅ Збережено. Тепер можеш зробити активним або керувати реєстрацією у модулі 2.";
        await loadEvents(true);
      }catch(e){
        console.error(e);
        $("createMsg").textContent = "❌ Помилка: " + (e.message || e);
      }
    };

    $("btnSetActive").onclick = async ()=>{
      const eventId = ($("inpEventId").value || "").trim();
      if(!eventId){
        $("createMsg").textContent = "Вкажи eventId.";
        return;
      }
      $("createMsg").textContent = "Оновлення settings/app…";
      try{
        await db.collection("settings").doc("app").set({
          activeEventId: eventId,
          updatedAt: window.firebase.firestore.FieldValue.serverTimestamp()
        }, {merge:true});
        $("createMsg").textContent = "✅ Активне змагання встановлено (settings/app).";
        await loadEvents(true);
      }catch(e){
        console.error(e);
        $("createMsg").textContent = "❌ Помилка: " + (e.message || e);
      }
    };

    // ===== REG TOGGLE =====
    $("btnManualOpen").onclick = async ()=>manualToggle(true);
    $("btnManualClose").onclick= async ()=>manualToggle(false);

    $("btnSyncToActive").onclick= async ()=>{
      const v = $("selEvent").value || "";
      if(!v){ $("regMsg").textContent = "Нема вибраного змагання."; return; }
      $("regMsg").textContent = "Оновлення settings/app…";
      try{
        await db.collection("settings").doc("app").set({
          activeEventId: v,
          updatedAt: window.firebase.firestore.FieldValue.serverTimestamp()
        }, {merge:true});
        $("regMsg").textContent = "✅ Активне змагання змінено.";
        await loadEvents(true);
      }catch(e){
        console.error(e);
        $("regMsg").textContent = "❌ Помилка: " + (e.message || e);
      }
    };

    async function manualToggle(open){
      const eventId = $("selEvent").value || "";
      if(!eventId){ $("regMsg").textContent = "Нема вибраного змагання."; return; }
      $("regMsg").textContent = open ? "Відкриваю…" : "Закриваю…";

      try{
        await db.collection("events").doc(eventId).set({
          regMode: "manual",
          manualOpen: !!open,
          updatedAt: window.firebase.firestore.FieldValue.serverTimestamp()
        }, {merge:true});

        await db.collection("settings").doc("app").set({
          activeEventId: eventId,
          registrationOpen: !!open,
          regMode: "manual",
          manualOpen: !!open,
          updatedAt: window.firebase.firestore.FieldValue.serverTimestamp()
        }, {merge:true});

        $("regMsg").textContent = "✅ " + (open ? "Реєстрація ВІДКРИТА" : "Реєстрація ЗАКРИТА");
        await loadEvents(true);
      }catch(e){
        console.error(e);
        $("regMsg").textContent = "❌ Помилка: " + (e.message || e);
      }
    }

    // ===== LOAD EVENTS =====
    async function loadEvents(){
      const sel = $("selEvent");
      if(!sel) return;

      sel.innerHTML = `<option value="">Завантаження…</option>`;
      $("regInfo").textContent = "Завантаження…";
      $("regMsg").textContent = "";

      let activeEventId = null;
      try{
        const s = await db.collection("settings").doc("app").get();
        if(s.exists){
          const d = s.data() || {};
          activeEventId = d.activeEventId || null;
        }
      }catch(_){}

      const snap = await db.collection("events").get();
      const options = [];
      snap.forEach(doc=>{
        const d = doc.data() || {};
        options.push({
          id: doc.id,
          title: d.title || doc.id,
          type: d.type || "single",
          brand: d.brand || "STOLAR CARP",
          stagesCount: d.stagesCount || 1,
          hasFinal: !!d.hasFinal,
          regMode: d.regMode || "auto",
          manualOpen: !!d.manualOpen,
          openAt: d.regOpenAt ? d.regOpenAt.toDate() : null,
          closeAt: d.regCloseAt ? d.regCloseAt.toDate() : null,
          archived: !!d.archived
        });
      });

      if(!options.length){
        sel.innerHTML = `<option value="">Нема змагань. Спочатку створи змагання.</option>`;
        $("regInfo").textContent = "Нема даних";
        return;
      }

      // сортуємо: спочатку неархівні, потім архівні, всередині — по назві
      options.sort((a,b)=>{
        if(a.archived !== b.archived) return a.archived ? 1 : -1;
        return (a.title||"").localeCompare((b.title||""),"uk");
      });

      sel.innerHTML = options.map(o=>{
        const isActive = o.id === activeEventId;
        const tagType = o.type === "season" ? "СЕЗОН" : "ONE";
        const arch = o.archived ? " [архів]" : "";
        const label = `${o.title} (${tagType}${o.type==="season" ? ` • етапів: ${o.stagesCount}${o.hasFinal ? " • фінал" : ""}` : ""})${arch}`;
        return `<option value="${o.id}" ${isActive ? "selected":""}>${isActive ? "✅ " : ""}${label}</option>`;
      }).join("");

      function renderInfo(){
        const v = sel.value || "";
        const o = options.find(x=>x.id===v) || options[0];
        const now = new Date();

        let autoState = "AUTO: —";
        if(o.openAt && o.closeAt){
          autoState = (now >= o.openAt && now <= o.closeAt) ? "AUTO: відкрита" : "AUTO: закрита";
        }

        const parts = [];
        parts.push(`Тип: ${o.type === "season" ? "СЕЗОН" : "ОДНОРАЗОВЕ"}`);
        parts.push(`Режим: ${String(o.regMode || "auto").toUpperCase()}`);
        if(o.regMode==="manual") parts.push(`MANUAL: ${o.manualOpen ? "відкрита" : "закрита"}`);
        if(o.openAt)  parts.push(`Відкриття: ${o.openAt.toLocaleString("uk-UA")}`);
        if(o.closeAt) parts.push(`Закриття: ${o.closeAt.toLocaleString("uk-UA")}`);
        parts.push(autoState);

        $("regInfo").textContent = parts.join(" · ");
      }

      sel.onchange = renderInfo;
      renderInfo();
    }
  }

  init().catch(err=>{
    console.error(err);
    setStatus("Помилка: " + err.message);
  });
</script>

</body>
</html>
