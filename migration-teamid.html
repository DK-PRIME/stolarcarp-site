<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <title>TeamId Migration ¬∑ Enterprise</title>
  <style>
    * { box-sizing: border-box; }
    body {
      background: #020617;
      color: #e5e7eb;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
      max-width: 1200px;
      margin: 0 auto;
    }
    h2 { color: #facc15; margin-bottom: 10px; }
    h3 { color: #94a3b8; margin-top: 30px; }
    
    .controls {
      background: #0f172a;
      border: 1px solid #1f2937;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }
    
    .option {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 12px 0;
      padding: 10px;
      background: rgba(250, 204, 21, 0.05);
      border-radius: 8px;
    }
    
    .option input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: #facc15;
    }
    
    .option label {
      cursor: pointer;
      flex: 1;
    }
    
    .option .desc {
      font-size: 13px;
      color: #64748b;
      margin-top: 4px;
    }
    
    button {
      background: #facc15;
      color: #000;
      border: none;
      padding: 14px 32px;
      border-radius: 10px;
      font-weight: 800;
      cursor: pointer;
      font-size: 16px;
      margin-right: 12px;
      transition: all 0.2s;
    }
    
    button:hover:not(:disabled) {
      background: #eab308;
      transform: translateY(-1px);
    }
    
    button.secondary {
      background: #334155;
      color: #e5e7eb;
    }
    
    button.secondary:hover:not(:disabled) {
      background: #475569;
    }
    
    button:disabled {
      background: #475569;
      color: #94a3b8;
      cursor: not-allowed;
      opacity: 0.7;
    }
    
    .progress-container {
      background: #0f172a;
      border: 1px solid #1f2937;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      display: none;
    }
    
    .progress-bar {
      width: 100%;
      height: 24px;
      background: #1e293b;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #facc15 0%, #eab308 100%);
      width: 0%;
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 12px;
      color: #000;
    }
    
    .progress-text {
      text-align: center;
      margin-top: 10px;
      color: #94a3b8;
      font-size: 14px;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .stat-box {
      background: #0f172a;
      border: 1px solid #1f2937;
      border-radius: 10px;
      padding: 15px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: 800;
      color: #facc15;
    }
    
    .stat-label {
      font-size: 12px;
      color: #64748b;
      margin-top: 4px;
    }
    
    .log-container {
      background: #0f172a;
      border: 1px solid #1f2937;
      border-radius: 12px;
      padding: 15px;
      margin: 20px 0;
      max-height: 500px;
      overflow-y: auto;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 13px;
      display: none;
    }
    
    .log-line {
      margin: 3px 0;
      padding: 4px 8px;
      border-radius: 4px;
      animation: fadeIn 0.2s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    .log-error { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
    .log-success { background: rgba(34, 197, 94, 0.1); color: #22c55e; }
    .log-warning { background: rgba(249, 115, 22, 0.1); color: #f97316; }
    .log-info { color: #60a5fa; }
    .log-dryrun { background: rgba(168, 85, 247, 0.1); color: #a855f7; }
    
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
    }
    
    .badge-dryrun { background: #a855f7; color: #fff; }
    .badge-live { background: #22c55e; color: #fff; }
    
    .summary {
      background: #0f172a;
      border: 1px solid #1f2937;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      display: none;
    }
    
    .error-list, .warning-list {
      margin: 10px 0;
      padding-left: 20px;
    }
    
    .error-list li { color: #ef4444; }
    .warning-list li { color: #f97316; }
    
    code {
      background: #1e293b;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
    }
  </style>
</head>

<body>
  <h2>üîß STOLAR CARP ¬∑ TeamId Migration <span class="badge badge-dryrun" id="modeBadge">DRY RUN</span></h2>
  
  <div class="controls">
    <h3>‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h3>
    
    <div class="option">
      <input type="checkbox" id="dryRun" checked onchange="updateMode()">
      <label>
        <strong>üîç Dry Run —Ä–µ–∂–∏–º</strong>
        <div class="desc">–¢—ñ–ª—å–∫–∏ –∞–Ω–∞–ª—ñ–∑—É—î –¥–∞–Ω—ñ –±–µ–∑ –∑–º—ñ–Ω. –ü–æ–∫–∞–∂–µ, —â–æ –±—É–¥–µ –æ–Ω–æ–≤–ª–µ–Ω–æ, –∞–ª–µ –Ω–µ –∑–º—ñ–Ω–∏—Ç—å –Ω—ñ—á–æ–≥–æ —É Firestore.</div>
      </label>
    </div>
    
    <div class="option">
      <input type="checkbox" id="createBackup" checked>
      <label>
        <strong>üíæ –°—Ç–≤–æ—Ä–∏—Ç–∏ backup</strong>
        <div class="desc">–ó–±–µ—Ä–µ–∂–µ JSON –∑ —É—Å—ñ–º–∞ —Å—Ç–∞—Ä–∏–º–∏ –¥–∞–Ω–∏–º–∏ —É Firebase Storage –ø–µ—Ä–µ–¥ –º—ñ–≥—Ä–∞—Ü—ñ—î—é (—Ç—ñ–ª—å–∫–∏ –≤ Live —Ä–µ–∂–∏–º—ñ).</div>
      </label>
    </div>
    
    <div class="option">
      <input type="checkbox" id="throttle" checked>
      <label>
        <strong>‚è±Ô∏è –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ –ª—ñ–º—ñ—Ç—ñ–≤</strong>
        <div class="desc">Batch-–æ–ø–µ—Ä–∞—Ü—ñ—ó + –ø–∞—É–∑–∏ –º—ñ–∂ –∑–∞–ø–∏—Ç–∞–º–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ –¥–ª—è 100+ –∑–∞–ø–∏—Å—ñ–≤).</div>
      </label>
    </div>
    
    <div style="margin-top: 20px;">
      <button id="startBtn" onclick="runMigration()">‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –∞–Ω–∞–ª—ñ–∑</button>
      <button class="secondary" onclick="clearLog()">üóë –û—á–∏—Å—Ç–∏—Ç–∏ –ª–æ–≥</button>
      <button class="secondary" onclick="downloadLog()">üíæ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ª–æ–≥</button>
    </div>
  </div>

  <div class="progress-container" id="progressContainer">
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill">0%</div>
    </div>
    <div class="progress-text" id="progressText">–ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞...</div>
  </div>

  <div class="stats" id="statsContainer" style="display:none;">
    <div class="stat-box">
      <div class="stat-value" id="statTeams">0</div>
      <div class="stat-label">–ö–æ–º–∞–Ω–¥ –∑–Ω–∞–π–¥–µ–Ω–æ</div>
    </div>
    <div class="stat-box">
      <div class="stat-value" id="statUpdates">0</div>
      <div class="stat-label">–ë—É–¥–µ –æ–Ω–æ–≤–ª–µ–Ω–æ</div>
    </div>
    <div class="stat-box">
      <div class="stat-value" id="statWarnings">0</div>
      <div class="stat-label">–ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω—å</div>
    </div>
    <div class="stat-box">
      <div class="stat-value" id="statErrors">0</div>
      <div class="stat-label">–ü–æ–º–∏–ª–æ–∫</div>
    </div>
  </div>

  <div class="log-container" id="logContainer">
    <div style="color:#64748b; margin-bottom:10px; border-bottom:1px solid #1f2937; padding-bottom:10px;">
      üìã –õ–æ–≥ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
    </div>
    <div id="log"></div>
  </div>

  <div class="summary" id="summary">
    <h3>üìä –ü—ñ–¥—Å—É–º–æ–∫</h3>
    <div id="summaryContent"></div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

  <script src="assets/js/firebase-init.js"></script>

  <script>
    // ==================== –£–¢–ò–õ–Ü–¢–ò ====================
    const $ = id => document.getElementById(id);
    let logEntries = [];
    
    function log(msg, type = 'info') {
      const time = new Date().toLocaleTimeString();
      const entry = { time, msg, type };
      logEntries.push(entry);
      
      const line = document.createElement('div');
      line.className = `log-line log-${type}`;
      line.textContent = `[${time}] ${msg}`;
      $('log').appendChild(line);
      $('logContainer').style.display = 'block';
      $('logContainer').scrollTop = $('logContainer').scrollHeight;
      
      const colors = {
        error: '#ef4444',
        success: '#22c55e',
        warning: '#f97316',
        info: '#60a5fa',
        dryrun: '#a855f7'
      };
      console.log(`%c[${type.toUpperCase()}] ${msg}`, `color: ${colors[type] || '#fff'}`);
    }
    
    function updateProgress(current, total, text) {
      const percent = Math.round((current / total) * 100);
      $('progressFill').style.width = percent + '%';
      $('progressFill').textContent = percent + '%';
      $('progressText').textContent = text || `${current} / ${total}`;
    }
    
    function updateMode() {
      const isDry = $('dryRun').checked;
      $('modeBadge').textContent = isDry ? 'DRY RUN' : 'LIVE';
      $('modeBadge').className = 'badge ' + (isDry ? 'badge-dryrun' : 'badge-live');
      $('startBtn').textContent = isDry ? '‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –∞–Ω–∞–ª—ñ–∑' : '‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –º—ñ–≥—Ä–∞—Ü—ñ—é';
    }
    
    function clearLog() {
      $('log').innerHTML = '';
      logEntries = [];
      $('summary').style.display = 'none';
      $('statsContainer').style.display = 'none';
    }
    
    function downloadLog() {
      const blob = new Blob([JSON.stringify(logEntries, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `migration-log-${new Date().toISOString().slice(0,19)}.json`;
      a.click();
    }
    
    async function waitFirebase(maxMs = 15000) {
      const t0 = Date.now();
      while (Date.now() - t0 < maxMs) {
        if (window.scDb && window.scStorage) return;
        await new Promise(r => setTimeout(r, 100));
      }
      throw new Error('Firebase –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ');
    }
    
    // ==================== BATCH & THROTTLE ====================
    class BatchProcessor {
      constructor(db, batchSize = 450, delayMs = 1000) {
        this.db = db;
        this.batchSize = batchSize;
        this.delayMs = delayMs;
        this.currentBatch = db.batch();
        this.count = 0;
        this.totalOps = 0;
      }
      
      async add(ref, data) {
        this.currentBatch.update(ref, data);
        this.count++;
        this.totalOps++;
        
        if (this.count >= this.batchSize) {
          await this.commit();
        }
      }
      
      async commit() {
        if (this.count === 0) return;
        
        log(`üíæ Commit batch: ${this.count} –æ–ø–µ—Ä–∞—Ü—ñ–π...`, 'info');
        await this.currentBatch.commit();
        
        if (this.delayMs > 0) {
          await new Promise(r => setTimeout(r, this.delayMs));
        }
        
        this.currentBatch = this.db.batch();
        this.count = 0;
      }
      
      async finish() {
        await this.commit();
        return this.totalOps;
      }
    }
    
    // ==================== BACKUP ====================
    async function createBackup(db, storage) {
      log('üíæ –°—Ç–≤–æ—Ä—é—é backup...', 'info');
      
      const timestamp = new Date().toISOString().slice(0,19).replace(/:/g, '-');
      const backupData = {
        timestamp: new Date().toISOString(),
        collections: {}
      };
      
      const usersSnap = await db.collection('users').get();
      backupData.collections.users = usersSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      
      const ppSnap = await db.collection('public_participants').get();
      backupData.collections.public_participants = ppSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      
      const regSnap = await db.collection('registrations').get();
      backupData.collections.registrations = regSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      
      const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
      const ref = storage.ref().child(`backups/teamid-migration-${timestamp}.json`);
      await ref.put(blob);
      
      const downloadUrl = await ref.getDownloadURL();
      
      log(`‚úÖ Backup –∑–±–µ—Ä–µ–∂–µ–Ω–æ: ${backupData.collections.users.length} users, ${backupData.collections.public_participants.length} pp, ${backupData.collections.registrations.length} reg`, 'success');
      log(`üîó URL: ${downloadUrl}`, 'info');
      
      return downloadUrl;
    }
    
    // ==================== –ú–Ü–ì–†–ê–¶–Ü–Ø ====================
    async function fixAllTeamIds(isDryRun, useThrottle) {
      const db = window.scDb;
      const stats = { teams: 0, updates: 0, warnings: 0, errors: 0, skipped: 0 };
      const warnings = [];
      const errors = [];
      
      const batch = useThrottle && !isDryRun ? new BatchProcessor(db) : null;
      
      log(`${isDryRun ? 'üîç DRY RUN:' : 'üöÄ LIVE:'} –ü–æ—á–∏–Ω–∞—é –º—ñ–≥—Ä–∞—Ü—ñ—é...`, isDryRun ? 'dryrun' : 'info');
      $('progressContainer').style.display = 'block';
      
      // 1. –ó–ë–ò–†–ê–Ñ–ú–û –ö–û–ú–ê–ù–î–ò
      updateProgress(0, 100, '–ó–±—ñ—Ä –∫–æ–º–∞–Ω–¥...');
      const teamsSnap = await db.collection('teams').get();
      const teamsByOwner = new Map();
      const teamsByName = new Map();
      const teamsById = new Map();
      
      teamsSnap.forEach(doc => {
        const data = doc.data();
        const teamId = doc.id;
        
        teamsById.set(teamId, { ...data, teamId });
        
        if (data.ownerUid) {
          teamsByOwner.set(data.ownerUid, { teamId, name: data.name, joinCode: data.joinCode });
        }
        
        if (data.name) {
          const normalized = data.name.trim().toLowerCase();
          teamsByName.set(normalized, teamId);
          teamsByName.set(normalized.replace(/\s+/g, ''), teamId);
          teamsByName.set(normalized.replace(/-/g, ''), teamId);
          teamsByName.set(normalized.replace(/[^a-z–∞-—è—ñ—ó—î“ë0-9]/g, ''), teamId); // ‚úÖ –ü–æ–≤–Ω–∞ —É–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –∞–±–µ—Ç–∫–∞
        }
        
        if (data.joinCode) {
          teamsByName.set(data.joinCode.toLowerCase(), teamId);
        }
      });
      
      stats.teams = teamsByOwner.size;
      log(`–ó–Ω–∞–π–¥–µ–Ω–æ –∫–æ–º–∞–Ω–¥: ${stats.teams}`, 'success');
      
      const usersSnap = await db.collection('users').get();
      const ppSnap = await db.collection('public_participants').get();
      const regSnap = await db.collection('registrations').get();
      const totalDocs = usersSnap.size + ppSnap.size + regSnap.size;
      let processed = 0;
      
      // 2. USERS
      log('–û–±—Ä–æ–±–ª—è—é users...', 'info');
      
      for (const userDoc of usersSnap.docs) {
        processed++;
        updateProgress(processed, totalDocs, `Users: ${userDoc.id.slice(0,8)}...`);
        
        try {
          const userId = userDoc.id;
          const data = userDoc.data();
          let correctedTeamId = null;
          let correctionReason = '';
          let needsTeamNameUpdate = false;
          let correctTeamName = null;
          
          if (data.role === 'captain' && teamsByOwner.has(userId)) {
            const teamInfo = teamsByOwner.get(userId);
            correctedTeamId = teamInfo.teamId;
            correctionReason = 'ownerUid';
            correctTeamName = teamInfo.name;
            
            if (data.teamName && data.teamName.trim().toLowerCase() !== teamInfo.name.toLowerCase()) {
              needsTeamNameUpdate = true;
              warnings.push(`${data.fullName || userId}: teamName "${data.teamName}" ‚â† "${teamInfo.name}"`);
              stats.warnings++;
            }
          }
          
          if (!correctedTeamId && data.teamName) {
            const key = data.teamName.trim().toLowerCase();
            const variations = [
              key,
              key.replace(/\s+/g, ''),
              key.replace(/-/g, ''),
              key.replace(/[^a-z–∞-—è—ñ—ó—î“ë0-9]/g, '') // ‚úÖ –ü–æ–≤–Ω–∞ —É–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –∞–±–µ—Ç–∫–∞
            ];
            
            for (const variant of variations) {
              if (teamsByName.has(variant)) {
                correctedTeamId = teamsByName.get(variant);
                correctionReason = 'teamName';
                correctTeamName = teamsById.get(correctedTeamId)?.name;
                break;
              }
            }
          }
          
          if (!correctedTeamId && data.teamId) {
            if (teamsById.has(data.teamId)) {
              correctedTeamId = data.teamId;
              correctionReason = 'valid existing';
            } else if (teamsByOwner.has(data.teamId)) {
              correctedTeamId = teamsByOwner.get(data.teamId).teamId;
              correctionReason = 'ownerUid lookup';
            }
          }
          
          if (!correctedTeamId) {
            log(`‚ö†Ô∏è –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∫–æ–º–∞–Ω–¥—É: ${data.fullName || userId}`, 'warning');
            stats.skipped++;
            continue;
          }
          
          if (data.teamId !== correctedTeamId) {
            log(`${isDryRun ? '[DRY] ' : ''}${data.fullName || userId}: ${data.teamId} ‚Üí ${correctedTeamId} (${correctionReason})`, isDryRun ? 'dryrun' : 'success');
            
            if (!isDryRun) {
              const updateData = {
                teamId: correctedTeamId,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
              };
              
              if (needsTeamNameUpdate && correctTeamName) {
                updateData.teamName = correctTeamName;
                log(`  ‚îî‚îÄ teamName: "${data.teamName}" ‚Üí "${correctTeamName}"`, 'info');
              }
              
              if (batch) {
                await batch.add(db.collection('users').doc(userId), updateData);
              } else {
                await db.collection('users').doc(userId).update(updateData);
              }
            }
            stats.updates++;
          }
          
        } catch (err) {
          errors.push({ col: 'users', id: userDoc.id, err: err.message });
          log(`‚ùå –ü–æ–º–∏–ª–∫–∞ users/${userDoc.id}: ${err.message}`, 'error');
          stats.errors++;
        }
      }
      
      if (batch) await batch.commit();
      
      // 3. PUBLIC_PARTICIPANTS
      log('–û–±—Ä–æ–±–ª—è—é public_participants...', 'info');
      
      for (const doc of ppSnap.docs) {
        processed++;
        updateProgress(processed, totalDocs, `PP: ${doc.id.slice(0,8)}...`);
        
        try {
          const data = doc.data();
          if (data.teamId && teamsById.has(data.teamId)) continue;
          
          let correctedTeamId = null;
          const teamName = (data.teamName || '').trim();
          
          if (teamName) {
            const key = teamName.toLowerCase();
            const variations = [
              key,
              key.replace(/\s+/g, ''),
              key.replace(/-/g, ''),
              key.replace(/[^a-z–∞-—è—ñ—ó—î“ë0-9]/g, '') // ‚úÖ –ü–æ–≤–Ω–∞ —É–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –∞–±–µ—Ç–∫–∞
            ];
            
            for (const variant of variations) {
              if (teamsByName.has(variant)) {
                correctedTeamId = teamsByName.get(variant);
                break;
              }
            }
          }
          
          if (!correctedTeamId && data.userId) {
            const userSnap = await db.collection('users').doc(data.userId).get();
            if (userSnap.exists) {
              const userTeamId = userSnap.data().teamId;
              if (userTeamId && teamsById.has(userTeamId)) {
                correctedTeamId = userTeamId;
              }
            }
          }
          
          if (correctedTeamId && data.teamId !== correctedTeamId) {
            const matchedTeam = teamsById.get(correctedTeamId);
            log(`${isDryRun ? '[DRY] ' : ''}pp/${doc.id}: ${data.teamId} ‚Üí ${correctedTeamId}`, isDryRun ? 'dryrun' : 'success');
            
            if (!isDryRun) {
              const updateData = {
                teamId: correctedTeamId,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
              };
              if (matchedTeam && matchedTeam.name !== data.teamName) {
                updateData.teamName = matchedTeam.name;
              }
              
              if (batch) {
                await batch.add(db.collection('public_participants').doc(doc.id), updateData);
              } else {
                await db.collection('public_participants').doc(doc.id).update(updateData);
              }
            }
            stats.updates++;
          }
          
        } catch (err) {
          errors.push({ col: 'public_participants', id: doc.id, err: err.message });
          log(`‚ùå –ü–æ–º–∏–ª–∫–∞ pp/${doc.id}: ${err.message}`, 'error');
          stats.errors++;
        }
      }
      
      if (batch) await batch.commit();
      
      // 4. REGISTRATIONS
      log('–û–±—Ä–æ–±–ª—è—é registrations...', 'info');
      
      for (const doc of regSnap.docs) {
        processed++;
        updateProgress(processed, totalDocs, `Reg: ${doc.id.slice(0,8)}...`);
        
        try {
          const data = doc.data();
          if (data.teamId && teamsById.has(data.teamId)) continue;
          
          let correctedTeamId = null;
          const teamName = (data.teamName || '').trim();
          
          if (teamName) {
            const key = teamName.toLowerCase();
            const variations = [
              key,
              key.replace(/\s+/g, ''),
              key.replace(/-/g, ''),
              key.replace(/[^a-z–∞-—è—ñ—ó—î“ë0-9]/g, '') // ‚úÖ –ü–æ–≤–Ω–∞ —É–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –∞–±–µ—Ç–∫–∞
            ];
            
            for (const variant of variations) {
              if (teamsByName.has(variant)) {
                correctedTeamId = teamsByName.get(variant);
                break;
              }
            }
          }
          
          if (!correctedTeamId && data.userId) {
            const userSnap = await db.collection('users').doc(data.userId).get();
            if (userSnap.exists) {
              const userTeamId = userSnap.data().teamId;
              if (userTeamId && teamsById.has(userTeamId)) {
                correctedTeamId = userTeamId;
              }
            }
          }
          
          if (!correctedTeamId && data.captainUid && teamsByOwner.has(data.captainUid)) {
            correctedTeamId = teamsByOwner.get(data.captainUid).teamId;
          }
          
          if (correctedTeamId && data.teamId !== correctedTeamId) {
            const matchedTeam = teamsById.get(correctedTeamId);
            log(`${isDryRun ? '[DRY] ' : ''}reg/${doc.id}: ${data.teamId} ‚Üí ${correctedTeamId}`, isDryRun ? 'dryrun' : 'success');
            
            if (!isDryRun) {
              const updateData = {
                teamId: correctedTeamId,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
              };
              if (matchedTeam && matchedTeam.name !== data.teamName) {
                updateData.teamName = matchedTeam.name;
              }
              
              if (batch) {
                await batch.add(db.collection('registrations').doc(doc.id), updateData);
              } else {
                await db.collection('registrations').doc(doc.id).update(updateData);
              }
            }
            stats.updates++;
          }
          
        } catch (err) {
          errors.push({ col: 'registrations', id: doc.id, err: err.message });
          log(`‚ùå –ü–æ–º–∏–ª–∫–∞ reg/${doc.id}: ${err.message}`, 'error');
          stats.errors++;
        }
      }
      
      if (batch) {
        const totalOps = await batch.finish();
        log(`–í—Å—å–æ–≥–æ batch-–æ–ø–µ—Ä–∞—Ü—ñ–π: ${totalOps}`, 'info');
      }
      
      updateProgress(100, 100, '–ó–∞–≤–µ—Ä—à–µ–Ω–æ!');
      return { stats, warnings, errors };
    }
    
    // ==================== –ó–ê–ü–£–°–ö ====================
async function runMigration() {
  const isDryRun = $('dryRun').checked;
  const doBackup = $('createBackup').checked && !isDryRun;  // ‚úÖ –í–ò–ü–†–ê–í–õ–ï–ù–û
  const useThrottle = $('throttle').checked && !isDryRun;
  
  $('startBtn').disabled = true;
  $('progressContainer').style.display = 'block';
  $('statsContainer').style.display = 'grid';
  $('summary').style.display = 'none';
  
  try {
    await waitFirebase();
    log('Firebase –≥–æ—Ç–æ–≤–∏–π', 'success');
    
    if (doBackup) {  // ‚úÖ –í–ò–ü–†–ê–í–õ–ï–ù–û
      await createBackup(window.scDb, window.scStorage);
    }
    
    const result = await fixAllTeamIds(isDryRun, useThrottle);
    
    $('statTeams').textContent = result.stats.teams;
    $('statUpdates').textContent = result.stats.updates;
    $('statWarnings').textContent = result.stats.warnings;
    $('statErrors').textContent = result.stats.errors;
    
    $('summary').style.display = 'block';
    let summaryHtml = `
      <p><strong>–†–µ–∂–∏–º:</strong> ${isDryRun ? 'Dry Run (–±–µ–∑ –∑–º—ñ–Ω)' : 'LIVE (–¥–∞–Ω—ñ –∑–º—ñ–Ω–µ–Ω–æ)'}</p>
      <p><strong>–í—Å—å–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–æ:</strong> ${result.stats.updates}</p>
      <p><strong>–ü—Ä–æ–ø—É—â–µ–Ω–æ:</strong> ${result.stats.skipped}</p>
    `;
    
    if (result.warnings.length) {
      summaryHtml += `<h4>‚ö†Ô∏è –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è (${result.warnings.length}):</h4><ul class="warning-list">`;
      result.warnings.forEach(w => summaryHtml += `<li>${w}</li>`);
      summaryHtml += '</ul>';
    }
    
    if (result.errors.length) {
      summaryHtml += `<h4>‚ùå –ü–æ–º–∏–ª–∫–∏ (${result.errors.length}):</h4><ul class="error-list">`;
      result.errors.forEach(e => summaryHtml += `<li>${e.col}/${e.id}: ${e.err}</li>`);
      summaryHtml += '</ul>';
    }
    
    if (!isDryRun && result.stats.updates > 0) {
      summaryHtml += `<p style="color:#22c55e; font-weight:800; margin-top:20px;">‚úÖ –ú—ñ–≥—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞! Popup —Å–∫–ª–∞–¥—É –∫–æ–º–∞–Ω–¥–∏ —Ç–µ–ø–µ—Ä –ø—Ä–∞—Ü—é—î.</p>`;
    }
    
    $('summaryContent').innerHTML = summaryHtml;
    
    if (isDryRun && result.stats.updates > 0) {
      log(`\nüîç Dry Run –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –ó–Ω–∞–π–¥–µ–Ω–æ ${result.stats.updates} –∑–∞–ø–∏—Å—ñ–≤ –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è.`, 'dryrun');
      log('–ó–Ω—ñ–º–∏ –≥–∞–ª–æ—á–∫—É "Dry Run" —ñ –∑–∞–ø—É—Å—Ç–∏ –∑–Ω–æ–≤—É –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ—ó –º—ñ–≥—Ä–∞—Ü—ñ—ó.', 'info');
    }
    
  } catch (err) {
    log(`–ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞: ${err.message}`, 'error');
    console.error(err);
  } finally {
    $('startBtn').disabled = false;
  }
}
    
    updateMode();
  </script>
</body>
</html>
