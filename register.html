function doPost(e) {
  try {
    const SHEET_ID   = '1v5owevBkZuiRGioOjujOMXvvH4w7zbt5UWDCE8ND2Vo'; // <-- ТВОЯ таблиця
    const SHEET_NAME = 'Реєстрації';                                    // <-- аркуш
    const CAPACITY   = 24; // null якщо не обмежувати

    const ss = SpreadsheetApp.openById(SHEET_ID);
    const sh = ss.getSheetByName(SHEET_NAME);
    const p = e.parameter || {};

    // honeypot
    if ((p.hp || '').trim() !== '') return fail('Помилка відправки.', 'SPAM');

    // fingerprint
    const fp = (p.fp || '').trim();
    if (!fp) return fail('Не вдалось ідентифікувати пристрій.', 'NO_FP');

    // Нормалізація
    const team    = norm(p.team_name);
    const members = Number(p.members_count || 0);
    const captain = norm(p.captain);
    const phone   = (p.phone || '').replace(/[^\d+]/g,'');
    const food    = (p.food === 'Так') ? 'Так' : 'Ні';
    const foodQty = (food === 'Так') ? Number(p.food_qty || 0) : '';

    // Валідація
    if (!team || team.length < 2)               return fail('Невірна назва команди.', 'BAD_TEAM');
    if (!captain || captain.length < 2)         return fail('Вкажіть капітана.', 'BAD_CAPTAIN');
    if (!(phone && /^\+380\d{9}$/.test(phone))) return fail('Невірний телефон (+380XXXXXXXXX).', 'BAD_PHONE');
    if (!(members >= 1 && members <= 4))        return fail('Кількість учасників: від 1 до 4.', 'BAD_MEMBERS');
    if (food === 'Так' && !(foodQty >= 1 && foodQty <= 20)) return fail('Кількість порцій 1–20.', 'BAD_FOOD_QTY');

    // Читаємо існуючі рядки
    const last = sh.getLastRow();
    const data = last > 1 ? sh.getRange(2, 1, last-1, sh.getLastColumn()).getValues() : [];

    // Припускаємо колонковий порядок (якщо інший — підешлю під тебе)
    // A: Назва команди | B: К-ть | C: Капітан | D: Телефон | E: Харчування | F: Порції | G: timestamp | H: fp
    const existingTeams  = data.map(r => norm(String(r[0]||'')));
    const existingPhones = data.map(r => String(r[3]||'').replace(/[^\d+]/g,''));
    const existingFPs    = data.map(r => String(r[7]||'').trim());

    // Ліміт
    const count = existingTeams.filter(Boolean).length;
    if (CAPACITY && count >= CAPACITY) return fail('Ліміт місць вичерпано.', 'LIMIT');

    // Дублі
    const teamSlug = team.toLowerCase();
    if (existingTeams.some(t => t.toLowerCase() === teamSlug)) return fail('Команда з такою назвою вже зареєстрована.', 'DUPLICATE_TEAM');
    if (existingPhones.some(ph => ph === phone)) return fail('З цього номера вже подано заявку.', 'DUPLICATE_PHONE');
    if (existingFPs.some(x => x && x === fp)) return fail('З цього пристрою вже подано заявку.', 'DUPLICATE_DEVICE');

    // Запис
    sh.appendRow([ team, members, captain, phone, food, (food === 'Так' ? foodQty : ''), new Date(), fp ]);

    return ok({ ok:true, message:'Заявку збережено.' });
  } catch (err) {
    return fail('Серверна помилка: ' + err.message, 'SERVER');
  }

  function norm(s){ return String(s||'').replace(/\s+/g,' ').trim(); }
  function ok(obj){ return ContentService.createTextOutput(JSON.stringify(obj)).setMimeType(ContentService.MimeType.JSON); }
  function fail(error, code){ return ContentService.createTextOutput(JSON.stringify({ ok:false, error, code })).setMimeType(ContentService.MimeType.JSON); }
}
