<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>STOLAR CARP ‚Ä¢ –°—É–¥–¥—è ‚Ä¢ –ó–≤–∞–∂—É–≤–∞–Ω–Ω—è</title>

  <link rel="stylesheet" href="assets/css/main.css" />

  <style>
    body{ background:#020617; }
    .wrap{ max-width:980px; margin:0 auto; padding:20px 0 80px; }
    .card{
      background:rgba(15,23,42,.92);
      border:1px solid rgba(148,163,184,.30);
      border-radius:16px;
      padding:16px;
      margin-bottom:12px;
    }
    .muted{ color:#9ca3af; }
    .ok{ color:#8fe39a; }
    .err{ color:#ff6c6c; }
    .big{ font-size:1.35rem; font-weight:900; }
    .kv{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:.9rem; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(148,163,184,.25);
      background:rgba(2,6,23,.35);
      color:#e5e7eb; font-size:.82rem; white-space:nowrap;
    }

    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .rowTop{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap:wrap; }

    .wbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
      margin-top:12px;
      padding:10px;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(2,6,23,.25);
      border-radius:14px;
    }
    .wBtns{ display:flex; gap:8px; flex-wrap:wrap; }
    .wbtn{
      border:1px solid rgba(148,163,184,.25);
      background:rgba(2,6,23,.25);
      color:#e5e7eb;
      border-radius:999px;
      padding:8px 12px;
      font-weight:900;
      font-size:.9rem;
      cursor:pointer;
      user-select:none;
    }
    .wbtn.isActive{
      border-color: rgba(246,195,76,.55);
      box-shadow: 0 0 0 3px rgba(246,195,76,.14);
      background: rgba(246,195,76,.10);
      color:#fff;
    }
    .wbtn:disabled{
      opacity:.45;
      cursor:not-allowed;
    }
    .wstat{ text-align:right; }
    .wstat .big2{ font-size:1.1rem; font-weight:900; }

    .callItem{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(2,6,23,.22);
      border-radius:12px;
      padding:10px;
      margin-top:8px;
    }
    .callLine{ font-size:1.0rem; }
    .callActions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }

    .teams{
      display:grid;
      gap:10px;
      margin-top:10px;
    }
    .teamRow{
      border:1px solid rgba(148,163,184,.22);
      background:rgba(2,6,23,.22);
      border-radius:14px;
      padding:12px;
    }
    .teamHead{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .teamTitle{
      font-weight:900;
      font-size:1.05rem;
      line-height:1.2;
    }
    .teamMeta{ color:#9ca3af; font-size:.9rem; }

    .inp{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(2,6,23,.55);
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,.28);
      outline:none;
      font-weight:800;
    }
    .inp:focus{
      border-color:var(--accent);
      box-shadow:0 0 10px rgba(246,195,76,.25);
    }

    .teamBtns{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
      justify-content:flex-end;
    }

    .miniBadge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border-radius:999px;
      padding:6px 10px;
      border:1px solid rgba(148,163,184,.20);
      background:rgba(2,6,23,.20);
      color:#e5e7eb;
      font-size:.82rem;
      white-space:nowrap;
    }
    .dot{
      width:8px;height:8px;border-radius:999px;
      background:rgba(34,197,94,.95);
      box-shadow:0 0 0 3px rgba(34,197,94,.12);
      display:inline-block;
    }

    /* ==== Fish tiles ==== */
    .fishGrid{
      display:grid;
      grid-template-columns: 1fr 1fr auto;
      gap:10px;
      align-items:center;
    }
    @media (max-width:720px){
      .fishGrid{ grid-template-columns: 1fr auto; }
    }
    .fishTile{ position:relative; }
    .fishInp{ padding-right:44px; }
    .fishDel{
      position:absolute;
      right:10px;
      top:50%;
      transform:translateY(-50%);
      width:30px;height:30px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.25);
      background:rgba(2,6,23,.35);
      color:#e5e7eb;
      font-weight:900;
      cursor:pointer;
    }
    .fishDel:disabled{ opacity:.45; cursor:not-allowed; }
    .fishAdd{
      width:44px;height:44px;
      border-radius:14px;
      border:1px solid rgba(246,195,76,.35);
      background:rgba(246,195,76,.18);
      color:#fff;
      font-weight:900;
      font-size:20px;
      cursor:pointer;
    }
    .fishAdd:disabled{ opacity:.45; cursor:not-allowed; }
  </style>
</head>

<body>
<header class="header">
  <div class="container header__row">
    <a class="logo" href="index.html">
      <span class="logo__mark">SC</span>
      <span class="logo__text">STOLAR CARP</span>
    </a>
    <div class="pill" id="authPill">auth: ‚Ä¶</div>
  </div>
</header>

<main class="main">
  <section class="section container wrap">

    <div class="card">
      <div class="rowTop">
        <div>
          <div class="big" id="zoneTitle">–ó–æ–Ω–∞ ‚Äî</div>
          <div class="muted" id="status">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</div>
        </div>
        <div class="miniBadge" id="netBadge" style="display:none;"><span class="dot"></span> realtime</div>
      </div>

      <div class="muted" style="margin-top:10px;">
        <div><b>–ü—Ä–∏–≤‚Äô—è–∑–∫–∞ –ø—Ä–∏—Å—Ç—Ä–æ—é:</b></div>
        <div class="kv" id="bindInfo">‚Äî</div>
      </div>

      <div class="btnRow">
        <button class="btn btn--primary" id="btnOpen" type="button">–í—ñ–¥–∫—Ä–∏—Ç–∏ –º–æ—é –∑–æ–Ω—É</button>
        <button class="btn btn--ghost" id="btnSaveHint" type="button">–Ø–∫ –∑–±–µ—Ä–µ–≥—Ç–∏ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω</button>
        <button class="btn btn--danger" id="btnReset" type="button">–°–∫–∏–Ω—É—Ç–∏ –ø—Ä–∏–≤‚Äô—è–∑–∫—É</button>
      </div>

      <div class="muted" id="msg" style="margin-top:10px;"></div>
    </div>

    <div class="card" id="weighCard" style="display:none;">
      <div class="rowTop">
        <div>
          <div style="font-weight:900;font-size:1.1rem;">–ó–≤–∞–∂—É–≤–∞–Ω–Ω—è</div>
          <div class="muted" id="wHelp">–ü–æ—Ç–æ—á–Ω–µ W –ø–µ—Ä–µ–º–∏–∫–∞—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ, –∫–æ–ª–∏ –≤—Å—ñ –∫–æ–º–∞–Ω–¥–∏ —Ç–≤–æ—î—ó –∑–æ–Ω–∏ –∑–¥–∞–Ω—ñ.</div>
        </div>
        <div class="muted" id="teamsCount">‚Äî</div>
      </div>

      <div class="wbar">
        <div class="wBtns">
          <button class="wbtn" id="w1" type="button">W1</button>
          <button class="wbtn" id="w2" type="button">W2</button>
          <button class="wbtn" id="w3" type="button">W3</button>
          <button class="wbtn" id="w4" type="button">W4</button>
        </div>
        <div class="wstat">
          <div class="muted">–ü–æ—Ç–æ—á–Ω–µ</div>
          <div class="big2" id="curW">W‚Äî</div>
        </div>
      </div>

      <div class="muted" id="wMsg" style="margin-top:10px;"></div>

      <div style="margin-top:14px; font-weight:900;">–ö–æ–º–∞–Ω–¥–∏ –º–æ—î—ó –∑–æ–Ω–∏</div>
      <div class="muted" id="teamsHint" style="margin-top:6px;">–°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è: —Å–µ–∫—Ç–æ—Ä ‚Üí –Ω–∞–∑–≤–∞.</div>
      <div class="teams" id="teamsBox"></div>
    </div>

  </section>
</main>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="assets/js/firebase-init.js"></script>

<script>
(function(){
  "use strict";

  const LS_KEY = "sc_judge_bind_v1";
  const ADMIN_UID = "5Dt6fN64c3aWACYV1WacxV2BHDl2";
  const DEFAULT_MAX_W = 4;

  const zoneTitle = document.getElementById("zoneTitle");
  const statusEl  = document.getElementById("status");
  const bindInfo  = document.getElementById("bindInfo");
  const msgEl     = document.getElementById("msg");
  const authPill  = document.getElementById("authPill");

  const btnOpen   = document.getElementById("btnOpen");
  const btnReset  = document.getElementById("btnReset");
  const btnSaveHint = document.getElementById("btnSaveHint");

  const weighCard = document.getElementById("weighCard");
  const wMsgEl = document.getElementById("wMsg");
  const curWEl = document.getElementById("curW");
  const teamsCountEl = document.getElementById("teamsCount");
  const teamsBox = document.getElementById("teamsBox");

  const netBadge = document.getElementById("netBadge");

  const wBtns = [
    { n:1, el: document.getElementById("w1") },
    { n:2, el: document.getElementById("w2") },
    { n:3, el: document.getElementById("w3") },
    { n:4, el: document.getElementById("w4") },
  ];

  let auth = null;
  let db = null;
  let me = null;

  let stageId  = "";
  let compId   = "";
  let zone     = "";
  let token    = "";

  let activeKey = "";

  let maxW = DEFAULT_MAX_W;
  let currentW = 1;
  let viewW = 1;

  function setMsg(t, ok=true){
    msgEl.textContent = t || "";
    msgEl.className = "muted " + (t ? (ok ? "ok":"err") : "");
  }
  function setWMsg(t, ok=true){
    wMsgEl.textContent = t || "";
    wMsgEl.className = "muted " + (t ? (ok ? "ok":"err") : "");
  }

  function norm(v){ return String(v ?? "").trim(); }
  function esc(s){ return String(s ?? "").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

  function parseKg(v){
    v = String(v ?? "").trim().replace(",", ".");
    if(!v) return null;
    const n = Number(v);
    if(!Number.isFinite(n)) return null;
    const clamped = Math.min(Math.max(n, 0), 999.99); // 000.00..999.99
    return Math.round(clamped * 100) / 100;
  }

  function calcFromFishWeights(fishWeights){
    const arr = (fishWeights || [])
      .map(parseKg)
      .filter(v => v !== null && v > 0);

    const fishCount = arr.length;
    const totalWeightKg = Math.round(arr.reduce((s,x)=>s+x,0) * 100) / 100;
    const bigFishKg = fishCount ? Math.max(...arr) : 0;

    return { fishWeights: arr, fishCount, totalWeightKg, bigFishKg };
  }

  async function waitFirebase(){
    for(let i=0;i<140;i++){
      if(window.scAuth && window.scDb && window.firebase) return;
      await new Promise(r=>setTimeout(r,100));
    }
    throw new Error("Firebase init –Ω–µ –ø—ñ–¥–Ω—è–≤ scAuth/scDb.");
  }

  async function requireJudgeOrAdmin(user){
    if(!user) return false;
    if(user.uid === ADMIN_UID) return true;
    const snap = await db.collection("users").doc(user.uid).get();
    const role = (snap.exists ? (snap.data()||{}).role : "") || "";
    return role === "judge" || role === "admin";
  }

  function readBind(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      return raw ? JSON.parse(raw) : null;
    }catch{ return null; }
  }
  function writeBind(data){
    try{ localStorage.setItem(LS_KEY, JSON.stringify(data)); return true; }
    catch{ return false; }
  }
  function clearBind(){
    try{ localStorage.removeItem(LS_KEY); }catch{}
  }

  function currentParams(){
    const p = new URLSearchParams(location.search);
    const z   = norm((p.get("zone")||"").toUpperCase());
    const cId = norm(p.get("compId")||"");
    const sId = norm(p.get("stageId")||""); // –º–æ–∂–µ –±—É—Ç–∏ –ø—É—Å—Ç–∏–π => main
    const t   = norm(p.get("t")||"");
    return { zone:z, compId:cId, stageId:sId, token:t };
  }

  function makeActiveKey(compId, stageId){
    return `${String(compId||"").trim()}||${String(stageId||"").trim() || "main"}`;
  }
  function settingsDocIdByActiveKey(activeKey){
    return `weighing_${activeKey}`;
  }

  function renderBindState(){
    const bind = readBind();
    if (!bind){
      zoneTitle.textContent = "–ó–æ–Ω–∞ ‚Äî";
      statusEl.textContent = "‚ùó –ù–µ–º–∞ –ø—Ä–∏–≤‚Äô—è–∑–∫–∏. –í—ñ–¥–∫—Ä–∏–π QR/–ª—ñ–Ω–∫ –≤—ñ–¥ –∞–¥–º—ñ–Ω–∞ –æ–¥–∏–Ω —Ä–∞–∑ ‚Äî —ñ –∑–æ–Ω–∞ –∑–±–µ—Ä–µ–∂–µ—Ç—å—Å—è.";
      bindInfo.textContent = "‚Äî";
      return;
    }
    const ak = makeActiveKey(bind.compId, bind.stageId);
    zoneTitle.textContent = `–ó–æ–Ω–∞ ${bind.zone}`;
    statusEl.textContent = "‚úÖ –ü—Ä–∏–≤‚Äô—è–∑–∫–∞ –∑–æ–Ω–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–∞ –Ω–∞ —Ü—å–æ–º—É —Ç–µ–ª–µ—Ñ–æ–Ω—ñ.";
    bindInfo.textContent = `zone=${bind.zone} | compId=${bind.compId} | stageId=${bind.stageId || "main"} | activeKey=${ak}`;
  }

  async function getOrCreateWeighingSettings(){
    const ref = db.collection("settings").doc(settingsDocIdByActiveKey(activeKey));
    const snap = await ref.get();
    if(snap.exists) return { ref, data:(snap.data()||{}) };

    const init = {
      activeKey,
      compId,
      stageId: stageId || "main",
      maxW: DEFAULT_MAX_W,
      current: { A:1, B:1, C:1 },
      updatedAt: window.firebase.firestore.FieldValue.serverTimestamp()
    };
    await ref.set(init, { merge:true });
    return { ref, data:init };
  }

  function getCurrentWForZone(settingsData){
    const cur = settingsData.current || {};
    const w = Number(cur[zone] || 1);
    return Math.min(Math.max(w,1), Number(settingsData.maxW || DEFAULT_MAX_W));
  }

  async function setCurrentWForZone(nextW){
    const ref = db.collection("settings").doc(settingsDocIdByActiveKey(activeKey));
    await db.runTransaction(async (tx)=>{
      const snap = await tx.get(ref);
      const d = snap.data() || {};
      const mW = Number(d.maxW || DEFAULT_MAX_W);
      const cur = Object.assign({A:1,B:1,C:1}, d.current || {});
      const safe = Math.min(Math.max(Number(nextW||1),1), mW);
      cur[zone] = safe;
      tx.set(ref, {
        current: cur,
        updatedAt: window.firebase.firestore.FieldValue.serverTimestamp()
      }, { merge:true });
    });
  }

  function updateWButtons(){
    curWEl.textContent = `W${currentW}`;
    wBtns.forEach(b=>{
      b.el.classList.toggle("isActive", b.n === viewW);
      b.el.disabled = (b.n > currentW);
    });
  }

  async function loadTeamsForZone(){
    const srSnap = await db.collection("stageResults").doc(activeKey).get();
    const sr = srSnap.exists ? (srSnap.data()||{}) : {};
    const teams = Array.isArray(sr.teams) ? sr.teams : [];

    const arr = teams
      .filter(t => String(t.drawZone||"").toUpperCase() === String(zone||"").toUpperCase())
      .map(t => ({
        teamId: String(t.regId || t.teamId || ""),
        teamName: String(t.teamName || ""),
        sector: Number(t.drawSector || 0)
      }))
      .filter(x => x.teamId);

    arr.sort((a,b)=> (a.sector||0)-(b.sector||0) || (a.teamName||"").localeCompare(b.teamName||"", "uk"));
    return arr;
  }

  function weighingDocId(teamId, wNo){
    return `${activeKey}_${zone}_${teamId}_W${wNo}`;
  }

  async function loadWeighing(teamId, wNo){
    const id = weighingDocId(teamId, wNo);
    const snap = await db.collection("weighings").doc(id).get();
    return snap.exists ? (snap.data()||null) : null;
  }

  async function saveWeighing(team, wNo, values){
    const id = weighingDocId(team.teamId, wNo);
    const ts = window.firebase.firestore.FieldValue.serverTimestamp();

    await db.collection("weighings").doc(id).set({
      activeKey,
      compId,
      stageId: stageId || "main",

      zone,
      sector: Number(team.sector || 0),

      wNo: Number(wNo),
      teamId: team.teamId,
      teamName: team.teamName || "",

      fishWeights: Array.isArray(values.fishWeights) ? values.fishWeights : [],
      fishCount: Number(values.fishCount || 0),
      totalWeightKg: Number(values.totalWeightKg || 0),
      bigFishKg: Number(values.bigFishKg || 0),

      status: "submitted",

      judgeUid: me.uid,
      judgeEmail: me.email || "",

      updatedAt: ts,
      createdAt: ts
    }, { merge: true });
  }

  async function maybeAdvanceAuto(teams){
    if(currentW >= maxW) return false;
    if(!teams.length) return false;

    const wsnap = await db.collection("weighings")
      .where("activeKey","==",activeKey)
      .where("zone","==",zone)
      .where("wNo","==",Number(currentW))
      .where("status","==","submitted")
      .get();

    const got = new Set();
    wsnap.forEach(doc=>{
      const d = doc.data() || {};
      if(d.teamId) got.add(String(d.teamId));
    });

    for(const t of teams){
      if(!got.has(String(t.teamId))) return false;
    }

    await setCurrentWForZone(currentW + 1);
    return true;
  }

  function fishTileHtml(i, val){
    const v = (val ?? "") === 0 ? "" : (val ?? "");
    return `
      <div class="fishTile">
        <input class="inp fishInp"
               inputmode="decimal"
               placeholder="0.00"
               data-fish="${i}"
               value="${esc(v)}" />
        <button class="fishDel" type="button" data-del="${i}">√ó</button>
      </div>
    `;
  }

  function renderFishGrid(rootEl, fishWeights){
    const arr = Array.isArray(fishWeights) ? fishWeights.slice() : [];
    if(arr.length === 0) arr.push("");

    rootEl.innerHTML = `
      <div class="fishGrid">
        ${arr.map((v,i)=>fishTileHtml(i, v)).join("")}
        <button class="fishAdd" type="button" data-add>+</button>
      </div>
      <div class="muted" style="margin-top:8px;">
        –í–∞–≥–∞ 0.00‚Äì999.99 (–ø–æ—Ä–æ–∂–Ω—å–æ = –Ω–µ–º–∞ —Ä–∏–±–∏). –ù—É–ª—å –æ–∑–Ω–∞—á–∞—î –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å —É–ª–æ–≤—É.
      </div>
    `;
  }

  function teamRowHtml(t){
    return `
      <div class="teamRow" data-team="${esc(t.teamId)}">
        <div class="teamHead">
          <div>
            <div class="teamTitle">${esc(t.teamName || "‚Äî")}</div>
            <div class="teamMeta">–°–µ–∫—Ç–æ—Ä: <b>${esc(t.sector)}</b> ‚Ä¢ –ó–æ–Ω–∞: <b>${esc(zone)}</b></div>
          </div>
          <div class="pill" data-state>W${viewW}: ‚Äî</div>
        </div>

        <div data-fishgrid></div>

        <div class="teamBtns">
          <button class="btn btn--ghost" type="button" data-load>–û–Ω–æ–≤–∏—Ç–∏</button>
          <button class="btn btn--primary" type="button" data-save>–ó–¥–∞—Ç–∏ W${viewW}</button>
        </div>

        <div class="muted" style="margin-top:8px;" data-sum>‚Äî</div>
      </div>
    `;
  }

  function getRowEl(teamId){
    // CSS.escape –Ω–µ –≤—Å—é–¥–∏ —î –Ω–∞ —Å—Ç–∞—Ä–∏—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö, –∞–ª–µ –Ω–∞ Android Chrome ‚Äî —î.
    return teamsBox.querySelector(`[data-team="${CSS.escape(teamId)}"]`);
  }

  function summarizeToText(st){
    const big = st.bigFishKg ? st.bigFishKg.toFixed(2) : "‚Äî";
    return `–ü—ñ–¥—Å—É–º–æ–∫: üêü ${st.fishCount} ‚Ä¢ –í–∞–≥–∞ ${st.totalWeightKg.toFixed(2)} –∫–≥ ‚Ä¢ Big ${big}`;
  }

  async function fillTeamWeighingRow(rowEl, team){
    const fishBox = rowEl.querySelector("[data-fishgrid]");
    const stateEl = rowEl.querySelector("[data-state]");
    const sumEl   = rowEl.querySelector("[data-sum]");

    const existing = await loadWeighing(team.teamId, viewW);
    const fishWeights = existing?.fishWeights || [];

    renderFishGrid(fishBox, fishWeights);

    const stats = calcFromFishWeights(fishWeights);
    sumEl.textContent = summarizeToText(stats);

    if(existing?.status === "submitted"){
      stateEl.textContent = `W${viewW}: ‚úÖ –∑–¥–∞–Ω–æ`;
    }else{
      stateEl.textContent = `W${viewW}: ‚è≥ –Ω–µ–º–∞`;
    }

    // live –ø–µ—Ä–µ—Ä–∞—Ö—É–Ω–æ–∫
    fishBox.addEventListener("input", ()=>{
      const vals = [...fishBox.querySelectorAll("input[data-fish]")].map(i=>i.value);
      const st = calcFromFishWeights(vals);
      sumEl.textContent = summarizeToText(st);
    });

    // add/del
    fishBox.addEventListener("click", (e)=>{
      const add = e.target?.closest?.("[data-add]");
      const del = e.target?.closest?.("[data-del]");
      if(add){
        const inputs = [...fishBox.querySelectorAll("input[data-fish]")];
        const vals = inputs.map(i=>i.value);
        vals.push("");
        renderFishGrid(fishBox, vals);
        const st = calcFromFishWeights(vals);
        sumEl.textContent = summarizeToText(st);
      }
      if(del){
        const idx = Number(del.getAttribute("data-del"));
        const inputs = [...fishBox.querySelectorAll("input[data-fish]")];
        const vals = inputs.map(i=>i.value);
        vals.splice(idx,1);
        const next = vals.length ? vals : [""];
        renderFishGrid(fishBox, next);
        const st = calcFromFishWeights(next);
        sumEl.textContent = summarizeToText(st);
      }
    });
  }

  async function submitTeamWeighing(rowEl, team){
    const fishBox = rowEl.querySelector("[data-fishgrid]");
    const stateEl = rowEl.querySelector("[data-state]");
    const sumEl   = rowEl.querySelector("[data-sum]");

    const vals = [...fishBox.querySelectorAll("input[data-fish]")].map(i=>i.value);
    const st = calcFromFishWeights(vals);

    await saveWeighing(team, viewW, st);

    stateEl.textContent = `W${viewW}: ‚úÖ –∑–¥–∞–Ω–æ`;
    sumEl.textContent = summarizeToText(st);
  }

  async function renderTeams(){
    const teams = await loadTeamsForZone();
    teamsCountEl.textContent = `–ö–æ–º–∞–Ω–¥ —É –∑–æ–Ω—ñ: ${teams.length}`;
    teamsBox.innerHTML = teams.map(teamRowHtml).join("");

    for(const t of teams){
      const rowEl = getRowEl(t.teamId);
      if(!rowEl) continue;

      await fillTeamWeighingRow(rowEl, t);

      rowEl.addEventListener("click", async (e)=>{
        if(e.target.closest("[data-load]")){
          await fillTeamWeighingRow(rowEl, t);
        }
        if(e.target.closest("[data-save]")){
          await submitTeamWeighing(rowEl, t);

          // –∞–≤—Ç–æ–ø–µ—Ä–µ—Ö—ñ–¥
          try{
            const advanced = await maybeAdvanceAuto(teams);
            if(advanced){
              setWMsg(`‚úÖ –í—Å—ñ –∑–¥–∞–Ω—ñ ‚Äî –ø–µ—Ä–µ—Ö—ñ–¥ –Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω–µ W`, true);
            }
          }catch{}
        }
      });
    }

    return teams;
  }

  function applyBind(bind){
    zone = String(bind.zone||"").toUpperCase();
    compId = String(bind.compId||"");
    stageId = String(bind.stageId||"");
    token = String(bind.token||"");
    activeKey = makeActiveKey(compId, stageId);
  }

  async function boot(){
    try{
      await waitFirebase();
      auth = window.scAuth;
      db   = window.scDb;

      renderBindState();

      auth.onAuthStateChanged(async (user)=>{
        me = user || null;
        authPill.textContent = me ? `auth: ${me.email || me.uid}` : "auth: (–Ω–µ–º–∞ –≤—Ö–æ–¥—É)";

        if(!me){
          setMsg("‚ùó –£–≤—ñ–π–¥–∏ –≤ –∞–∫–∞—É–Ω—Ç —Å—É–¥–¥—ñ/–∞–¥–º—ñ–Ω–∞ (cabinet.html) —ñ –ø–æ–≤–µ—Ä–Ω–∏—Å—å —Å—é–¥–∏.", false);
          return;
        }

        const ok = await requireJudgeOrAdmin(me);
        if(!ok){
          setMsg("‚ùó –ù–µ–º–∞ –ø—Ä–∞–≤ —Å—É–¥–¥—ñ. –ü–æ—Ç—Ä—ñ–±–Ω–æ role=judge –∞–±–æ –∞–¥–º—ñ–Ω.", false);
          return;
        }

        setMsg("‚úÖ –î–æ—Å—Ç—É–ø —Å—É–¥–¥—ñ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ.", true);

        // —è–∫—â–æ –ø—Ä–∏–π—à–ª–∏ –∑ QR ‚Äî –∑–±–µ—Ä–µ–∂–µ–º–æ –ø—Ä–∏–≤‚Äô—è–∑–∫—É
        const p = currentParams();
        if(p.zone && p.compId && p.token){
          const bind = { zone:p.zone, compId:p.compId, stageId:p.stageId || "", token:p.token };
          writeBind(bind);
        }

        const bind = readBind();
        if(!bind){
          renderBindState();
          return;
        }

        applyBind(bind);
        renderBindState();

        const { data } = await getOrCreateWeighingSettings();
        maxW = Number(data.maxW || DEFAULT_MAX_W);
        currentW = getCurrentWForZone(data);
        viewW = currentW;

        weighCard.style.display = "block";
        netBadge.style.display = "inline-flex";

        updateWButtons();

        const teams = await renderTeams();

        // –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è W (–¥–∏–≤–∏—Ç–∏—Å—å –º–æ–∂–Ω–∞ —Ç—ñ–ª—å–∫–∏ <= currentW)
        wBtns.forEach(b=>{
          b.el.addEventListener("click", async ()=>{
            viewW = b.n;
            updateWButtons();
            await renderTeams();
          });
        });

        setWMsg("–ì–æ—Ç–æ–≤–æ. –í–Ω–æ—Å—å —Ä–∏–±—É –ø–æ –∫–æ–∂–Ω—ñ–π –∫–æ–º–∞–Ω–¥—ñ –π —Ç–∏—Å–Ω–∏ ‚Äú–ó–¥–∞—Ç–∏‚Äù.", true);
      });

      // UI-–∫–Ω–æ–ø–∫–∏
      btnReset.addEventListener("click", ()=>{
        clearBind();
        setMsg("‚úÖ –ü—Ä–∏–≤‚Äô—è–∑–∫—É —Å–∫–∏–Ω—É—Ç–æ. –í—ñ–¥–∫—Ä–∏–π QR/–ª—ñ–Ω–∫ –∑–∞–Ω–æ–≤–æ.", true);
        weighCard.style.display = "none";
        renderBindState();
      });

      btnSaveHint.addEventListener("click", ()=>{
        alert("–ü–æ—Ä–∞–¥–∞: –≤—ñ–¥–∫—Ä–∏–π —Å—Ç–æ—Ä—ñ–Ω–∫—É –≤ Chrome ‚Üí –º–µ–Ω—é ‚ãÆ ‚Üí ‚Äú–î–æ–¥–∞—Ç–∏ –Ω–∞ –≥–æ–ª–æ–≤–Ω–∏–π –µ–∫—Ä–∞–Ω‚Äù. –¢–æ–¥—ñ –ø—Ä–∞—Ü—é—î —è–∫ –¥–æ–¥–∞—Ç–æ–∫.");
      });

      btnOpen.addEventListener("click", ()=>{
        const bind = readBind();
        if(!bind){ alert("–ù–µ–º–∞ –ø—Ä–∏–≤‚Äô—è–∑–∫–∏. –í—ñ–¥–∫—Ä–∏–π QR/–ª—ñ–Ω–∫ –≤—ñ–¥ –∞–¥–º—ñ–Ω–∞."); return; }
        alert("–ó–æ–Ω–∞ –≤–∂–µ –ø—Ä–∏–≤‚Äô—è–∑–∞–Ω–∞. –ú–æ–∂–µ—à –ø—Ä–∞—Ü—é–≤–∞—Ç–∏.");
      });

    }catch(e){
      console.error(e);
      setMsg("–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó: " + (e?.message || e), false);
    }
  }

  boot();
})();
</script>
</body>
</html>
