<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Реєстрація — STOLAR CARP</title>
  <link rel="stylesheet" href="assets/css/main.css">
  <script defer src="assets/js/config.js"></script>
</head>

<body class="register-page">
<header class="header">
  <div class="container header__row">
    <a class="logo" href="index.html"><span class="logo__mark">SC</span><span class="logo__text">STOLAR CARP</span></a>
    <nav class="nav" id="nav">
      <a href="index.html" class="nav__link">Головна</a>
      <a href="rules.html" class="nav__link">Регламент</a>
      <a href="register.html" class="nav__link nav__link--active">Реєстрація</a>
      <a href="live.html" class="nav__link">Live</a>
      <a href="rating.html" class="nav__link">Рейтинг</a>
      <a href="lakes.html" class="nav__link">Водойми</a>
      <a href="sponsors.html" class="nav__link">Спонсори</a>
      <a href="events/turnir-2026.html" class="nav__link">Турнір 2026</a>
    </nav>
    <button class="burger" id="burger"><span></span><span></span><span></span></button>
  </div>
</header>

<main class="main">
  <section class="container section section--narrow">
    <h1 class="page-title title-gradient">Реєстрація команд</h1>
    <p class="lead">Заповніть форму нижче для участі у змаганнях.</p>

    <form id="regForm" class="form-card" novalidate>
      <input type="text" name="hp" autocomplete="off" style="position:absolute;left:-9999px;opacity:0">
      <input type="hidden" name="fp" id="fp">

      <div class="field">
        <label for="team_name">Назва команди *</label>
        <input id="team_name" name="team_name" type="text" required minlength="2" maxlength="60" placeholder="DK Два Кума">
      </div>

      <div class="field">
        <label for="members_count">Кількість учасників *</label>
        <input id="members_count" name="members_count" type="number" required min="1" max="4" inputmode="numeric" placeholder="1–4">
      </div>

      <div class="field">
        <label for="captain">Капітан команди *</label>
        <input id="captain" name="captain" type="text" required minlength="2" maxlength="60" placeholder="Ім’я та прізвище">
      </div>

      <div class="field">
        <label for="phone_rest">Номер телефону *</label>
        <div class="phone-wrap">
          <span class="phone-prefix">+380</span>
          <input
            id="phone_rest"
            type="text"
            inputmode="numeric"
            pattern="\d{9}"
            maxlength="9"
            required
            placeholder="XXXXXXXXX"
            aria-label="9 цифр після +380"
          />
        </div>
        <!-- приховане поле, що відправиться у форму -->
        <input type="hidden" id="phone" name="phone" />
        <small class="hint">Введіть 9 цифр після +380 (разом буде +380XXXXXXXXX)</small>
      </div>

      <fieldset class="field">
        <legend>Харчування *</legend>
        <label class="radio"><input type="radio" name="food" value="Ні" required> Ні</label>
        <label class="radio"><input type="radio" name="food" value="Так" required> Так</label>
      </fieldset>

      <div class="field" id="foodQtyField">
        <label for="food_qty">Кількість порцій</label>
        <input id="food_qty" name="food_qty" type="number" min="1" max="20" inputmode="numeric" placeholder="скільки порцій?">
      </div>

      <div class="field checkbox">
        <label><input id="agree" name="agree" type="checkbox" required> Погоджуюсь з <a href="rules.html" target="_blank" rel="noopener">регламентом</a> *</label>
      </div>

      <div class="form-actions">
        <button id="submitBtn" type="submit" class="btn btn--primary">Надіслати заявку</button>
        <span id="spinner" class="spinner" aria-hidden="true"></span>
      </div>

      <div id="msg" class="form-msg" role="status" aria-live="polite"></div>
    </form>
  </section>
</main>

<footer class="footer">
  <div class="container footer__row">
    <div>© 2025 STOLAR CARP · Львів</div>
    <div class="footer__links">
      <a href="https://invite.viber.com/?g=8R04gUEhdVSnX6sr_DxGGGqAXTus0Ygh">Viber</a>
      <a href="https://youtube.com/@dk-stolarcarp">YouTube</a>
    </div>
  </div>
</footer>

<script>
  /* ===== Антиспам/таймер ===== */
  const MIN_TIME_ON_PAGE_MS = 4000;
  const LOCAL_COOLDOWN_MIN  = 24 * 60;
  const COOLDOWN_KEY        = 'sc_reg_cooldown_until';
  const DONE_FP_KEY         = 'sc_reg_done_fp';
  const PAGE_LOADED_AT      = Date.now();

  /* ===== FP (відбиток пристрою) ===== */
  (function setFP(){
    const src = [
      navigator.userAgent,
      navigator.language,
      screen.width+'x'+screen.height,
      screen.colorDepth,
      Intl.DateTimeFormat().resolvedOptions().timeZone
    ].join('|');
    let h = 2166136261;
    for (let i=0;i<src.length;i++){ h ^= src.charCodeAt(i); h = (h*16777619)>>>0; }
    document.getElementById('fp').value = 'fp_'+h.toString(16);
  })();

  /* ===== Телефон: +380 + 9 цифр (видиме поле -> приховане) ===== */
  const phoneHidden = document.getElementById('phone');
  const phoneRest   = document.getElementById('phone_rest');
  function syncPhone(){
    const digits = (phoneRest.value || '').replace(/\D+/g,'').slice(0,9);
    phoneRest.value = digits;
    phoneHidden.value = digits.length === 9 ? '+380' + digits : '';
  }
  phoneRest.addEventListener('input', syncPhone);
  syncPhone();

  /* ===== Логіка харчування ===== */
  const form = document.getElementById('regForm');
  const foodRadios = [...form.querySelectorAll('input[name="food"]')];
  const qtyInput   = document.getElementById('food_qty');
  const qtyField   = document.getElementById('foodQtyField');
  function updateQtyState(){
    const need = (foodRadios.find(r=>r.checked)?.value === 'Так');
    qtyInput.disabled = !need;
    qtyInput.required = need;
    if (!need) qtyInput.value = '';
    qtyField.classList.toggle('field--disabled', !need);
  }
  foodRadios.forEach(r => r.addEventListener('change', updateQtyState));
  updateQtyState();

  /* ===== Надсилання ===== */
  const ENDPOINT = "https://script.google.com/macros/s/AKfycbwfc8-XTU7hXh9ermqg_zxpnqVivWTuTDW_12guSuzU0R-bC4-3R6xp29W12ZOai8B3yg/exec";
  const btn = document.getElementById('submitBtn');
  const msg = document.getElementById('msg');
  const spinner = document.getElementById('spinner');

  function setBusy(b){ btn.disabled = b; spinner.classList.toggle('spinner--on', b); }
  function flash(type, text){ msg.className = 'form-msg ' + type; msg.textContent = text; }

  function minsLeft(ts){ const ms = (+ts) - Date.now(); return Math.max(0, Math.ceil(ms/60000)); }
  function cooldownActive(){ const until = localStorage.getItem(COOLDOWN_KEY); return until && Date.now() < +until; }

  const ERROR_MAP = {
    LIMIT:'Ліміт місць вичерпано.',
    DUPLICATE_TEAM:'Команда з такою назвою вже зареєстрована.',
    DUPLICATE_PHONE:'З цього номера вже подано заявку.',
    DUPLICATE_DEVICE:'З цього пристрою вже подано заявку.',
    BAD_TEAM:'Невірна назва команди.',
    BAD_CAPTAIN:'Вкажіть капітана.',
    BAD_PHONE:'Невірний телефон. Формат: +380XXXXXXXXX.',
    BAD_MEMBERS:'Кількість учасників: від 1 до 4.',
    BAD_FOOD_QTY:'Вкажіть кількість порцій 1–20.'
  };

  let inFlight = false;

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    flash('', '');

    if (inFlight) return;

    if (Date.now() - PAGE_LOADED_AT < MIN_TIME_ON_PAGE_MS){
      flash('err','Будь ласка, заповніть форму уважно і повторіть через кілька секунд.');
      return;
    }

    if (cooldownActive()){
      const left = minsLeft(localStorage.getItem(COOLDOWN_KEY));
      flash('err',`Заявка вже була надіслана. Спробуйте пізніше (прибл. ${left} хв).`);
      return;
    }

    const fp = document.getElementById('fp').value;
    if (localStorage.getItem(DONE_FP_KEY) === fp){
      flash('err','З цього пристрою вже подано заявку.');
      return;
    }

    if (!form.checkValidity()){
      flash('err','Перевірте обов’язкові поля форми.');
      form.reportValidity?.();
      return;
    }

    // телефон з префіксом
    syncPhone();
    if (!/^\+380\d{9}$/.test(phoneHidden.value)){
      flash('err','Введіть 9 цифр після +380 (разом буде +380XXXXXXXXX)');
      return;
    }

    if (form.food.value === 'Так' && !form.food_qty.value){
      flash('err','Вкажіть кількість порцій.');
      return;
    }

    form.hp.value = '';
    const fd = new FormData(form);
    fd.append('ts', Date.now().toString());
    fd.append('ua', navigator.userAgent.slice(0,200));

    inFlight = true; setBusy(true);
    try{
      const res  = await fetch(ENDPOINT, { method:'POST', body: fd });
      const data = await res.json();

      if (data.ok){
        flash('ok','Дякуємо! Заявку надіслано та збережено.');
        const until = Date.now() + LOCAL_COOLDOWN_MIN*60000;
        localStorage.setItem(COOLDOWN_KEY, until.toString());
        localStorage.setItem(DONE_FP_KEY, fp);
        form.reset(); updateQtyState();
      }else{
        const nice = ERROR_MAP[data.code] || data.error || 'Сталася помилка при надсиланні.';
        flash('err', nice);
      }
    }catch(err){
      flash('err','Не вдалося надіслати форму: ' + err.message);
    }finally{
      setBusy(false); inFlight = false;
    }
  });
</script>
</body>
</html>
