<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>STOLAR CARP ‚Ä¢ –ê–¥–º—ñ–Ω–∫–∞</title>

  <link rel="stylesheet" href="assets/css/main.css">

  <style>
    body{ background: radial-gradient(circle at top,#111827 0,#020617 55%); }
    .admin-wrap{ max-width:980px; margin:0 auto; padding:26px 0 70px; }
    .admin-card{
      margin-top:14px; padding:16px;
      border-radius:18px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.35);
      box-shadow:0 18px 40px rgba(0,0,0,.6);
    }
    .muted{ color:#9ca3af; }
    .admin-hidden{ display:none; }

    .admin-top{
      display:flex; flex-direction:column; gap:6px;
      padding:14px 16px; border-radius:18px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.35);
      box-shadow:0 18px 40px rgba(0,0,0,.6);
    }
    .admin-title{ font-size:1.25rem; font-weight:900; }
    .admin-sub{ font-size:.95rem; }

    .col{ display:flex; flex-direction:column; gap:10px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .btn-col{ display:flex; flex-direction:column; gap:10px; }
    .btn-full{ width:100%; justify-content:center; padding:12px 14px; border-radius:14px; }

    .field{ display:flex; flex-direction:column; gap:6px; }
    input, select{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,.35);
      background:rgba(2,6,23,.55);
      color:#e5e7eb;
      outline:none;
    }
    input::placeholder{ color:#6b7280; }

    .hr{ height:1px; background:rgba(148,163,184,.18); margin:8px 0; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      font-size:.82rem;
      border:1px solid rgba(148,163,184,.35);
      background:rgba(0,0,0,.25);
      color:#e5e7eb;
      width:max-content;
    }
    .pill.ok{ border-color:rgba(34,197,94,.6); }
    .pill.warn{ border-color:rgba(250,204,21,.65); }
    .pill.bad{ border-color:rgba(239,68,68,.65); }
  </style>
</head>

<body>

<header class="header">
  <div class="container header__row">
    <a class="logo" href="index.html">
      <span class="logo__mark">SC</span>
      <span class="logo__text">STOLAR CARP</span>
    </a>
    <nav class="nav" id="nav">
      <a href="index.html" class="nav__link">–ì–æ–ª–æ–≤–Ω–∞</a>
      <a href="live.html" class="nav__link">Live</a>
      <a href="rating.html" class="nav__link">–†–µ–π—Ç–∏–Ω–≥</a>
      <a href="cabinet.html" class="nav__link">–ú—ñ–π –∫–∞–±—ñ–Ω–µ—Ç</a>
    </nav>
    <button class="burger" id="burger"><span></span><span></span><span></span></button>
  </div>
</header>

<main class="main">
  <section class="section container admin-wrap">

    <!-- TOP STATUS -->
    <div class="admin-top">
      <div class="admin-title">–ê–¥–º—ñ–Ω–∫–∞ STOLAR CARP</div>
      <div class="muted admin-sub" id="adminStatus">–ó–∞–ø—É—Å–∫‚Ä¶</div>
      <div class="row" id="adminPills"></div>
    </div>

    <!-- LOGIN -->
    <div id="adminLogin" class="admin-card admin-hidden">
      <h2 class="section-title" style="margin:0 0 8px;">–í—Ö—ñ–¥ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
      <div class="muted">–£–≤—ñ–π–¥–∏ email/–ø–∞—Ä–æ–ª–µ–º –∞–¥–º—ñ–Ω-–∞–∫–∞—É–Ω—Ç–∞. –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó —Ç—É—Ç –Ω–µ–º–∞—î.</div>

      <div class="row" style="margin-top:12px;">
        <input id="admEmail" type="email" placeholder="Email" style="flex:1; min-width:220px;">
        <input id="admPass"  type="password" placeholder="–ü–∞—Ä–æ–ª—å" style="flex:1; min-width:220px;">
        <button class="btn btn--accent" id="btnAdminLogin">–£–≤—ñ–π—Ç–∏</button>
      </div>

      <div class="muted" id="adminLoginMsg" style="margin-top:10px;"></div>
    </div>

    <!-- APP -->
    <div id="adminApp" class="admin-hidden">

      <!-- 1) CREATE STAGE -->
      <div class="admin-card">
        <h2 class="section-title" style="margin:0 0 8px;">1) –°—Ç–≤–æ—Ä–∏—Ç–∏ –µ—Ç–∞–ø / –∑–º–∞–≥–∞–Ω–Ω—è</h2>
        <div class="muted">
          –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤ –∫–æ–ª–µ–∫—Ü—ñ—é <b>stages</b>. –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –±—É–¥–µ <b>–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ –¥–∞—Ç—ñ</b>, –∞ —Ç–∞–∫–æ–∂ —î <b>—Ä—É—á–Ω–µ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è/–∑–∞–∫—Ä–∏—Ç—Ç—è</b>.
        </div>

        <div class="hr"></div>

        <div class="col">
          <div class="field">
            <label class="muted">Season ID (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: season-2026)</label>
            <input id="inpSeasonId" placeholder="season-2026" value="season-2026">
          </div>

          <div class="field">
            <label class="muted">Stage ID (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: stage-1)</label>
            <input id="inpStageId" placeholder="stage-1">
          </div>

          <div class="field">
            <label class="muted">–ù–∞–∑–≤–∞ –µ—Ç–∞–ø—É</label>
            <input id="inpStageName" placeholder="–ï—Ç–∞–ø 1 ‚Ä¢ –û—Å—ñ–Ω–Ω—ñ–π –∫–æ—Ä–æ–ø STOLAR CARP">
          </div>

          <div class="field">
            <label class="muted">–°—Ç–∞—Ä—Ç –∑–º–∞–≥–∞–Ω–Ω—è (–¥–∞—Ç–∞ + —á–∞—Å)</label>
            <input id="inpStartAt" type="datetime-local">
          </div>

          <div class="field">
            <label class="muted">–ñ–µ—Ä–µ–±–∫—É–≤–∞–Ω–Ω—è (–¥–∞—Ç–∞ + —á–∞—Å)</label>
            <input id="inpDrawAt" type="datetime-local">
          </div>

          <div class="field">
            <label class="muted">–í—ñ–¥–∫—Ä–∏—Ç—Ç—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó (–∞–≤—Ç–æ)</label>
            <input id="inpRegOpenAt" type="datetime-local">
          </div>

          <div class="field">
            <label class="muted">–ó–∞–∫—Ä–∏—Ç—Ç—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó (–∞–≤—Ç–æ)</label>
            <input id="inpRegCloseAt" type="datetime-local">
          </div>

          <button class="btn btn--primary btn-full" id="btnSaveStage">–ó–±–µ—Ä–µ–≥—Ç–∏ –µ—Ç–∞–ø</button>
          <div class="muted" id="createMsg"></div>
        </div>
      </div>

      <!-- 2) SELECT + TOGGLE REG -->
      <div class="admin-card">
        <h2 class="section-title" style="margin:0 0 8px;">2) –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è (–∞–≤—Ç–æ –ø–æ –¥–∞—Ç—ñ + —Ä—É—á–Ω–µ –∫–µ—Ä—É–≤–∞–Ω–Ω—è)</h2>
        <div class="muted">
          –û–±–µ—Ä–∏ –µ—Ç–∞–ø –∑—ñ —Å–ø–∏—Å–∫—É ‚Üí –ø–æ–±–∞—á–∏—à —Å—Ç–∞—Ç—É—Å ‚Üí –º–æ–∂–µ—à <b>–≤—ñ–¥–∫—Ä–∏—Ç–∏/–∑–∞–∫—Ä–∏—Ç–∏ –≤—Ä—É—á–Ω—É</b>.
        </div>

        <div class="hr"></div>

        <div class="col">
          <div class="field">
            <label class="muted">–í–∏–±—ñ—Ä –µ—Ç–∞–ø—É</label>
            <select id="selStage"></select>
          </div>

          <div class="row">
            <button class="btn btn--accent" id="btnForceOpen">–í—ñ–¥–∫—Ä–∏—Ç–∏ –≤—Ä—É—á–Ω—É</button>
            <button class="btn btn--danger" id="btnForceClose">–ó–∞–∫—Ä–∏—Ç–∏ –≤—Ä—É—á–Ω—É</button>
            <button class="btn btn--primary" id="btnForceAuto">–ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –ê–í–¢–û (–ø–æ –¥–∞—Ç—ñ)</button>
          </div>

          <div class="muted" id="stageInfo"></div>
        </div>
      </div>

      <!-- 3) NEXT PAGES -->
      <div class="admin-card">
        <h2 class="section-title" style="margin:0 0 8px;">3) –î–∞–ª—ñ –ø–æ –º–æ–¥—É–ª—è—Ö</h2>
        <div class="muted">–¶—ñ –∫–Ω–æ–ø–∫–∏ –≤–µ–¥—É—Ç—å –Ω–∞ –æ–∫—Ä–µ–º—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ (—â–æ–± –≥–æ–ª–æ–≤–Ω—É –Ω–µ –≥—Ä—É–∑–∏—Ç–∏).</div>

        <div class="hr"></div>

        <div class="btn-col">
          <a class="btn btn--primary btn-full" id="goRegs" href="admin-registrations.html">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –∫–æ–º–∞–Ω–¥</a>
          <a class="btn btn--accent  btn-full" id="goDraw" href="admin-draw.html">–ñ–µ—Ä–µ–±–∫—É–≤–∞–Ω–Ω—è</a>
          <a class="btn btn--danger  btn-full" id="goWeigh" href="judge-weighings.html">–ó–≤–∞–∂—É–≤–∞–Ω–Ω—è (—Å—É–¥–¥—ñ)</a>
          <a class="btn btn--primary btn-full" id="goUsers" href="admin-users.html">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ —Å–∞–π—Ç—É</a>
        </div>

        <div class="muted" style="margin-top:10px;">
          * –ö–Ω–æ–ø–∫–∏ ‚Äú–í–∏–π—Ç–∏‚Äù –Ω–µ–º–∞—î ‚Äî —Å–µ—Å—ñ—è Firebase —Ç—Ä–∏–º–∞—î—Ç—å—Å—è, —è–∫ —Ç–∏ —ñ —Ö–æ—Ç—ñ–≤.
        </div>
      </div>

    </div><!-- /adminApp -->

  </section>
</main>

<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<!-- –¢–≤—ñ–π init: –º–∞—î —Å—Ç–≤–æ—Ä–∏—Ç–∏ window.scAuth / window.scDb -->
<script src="assets/js/firebase-init.js"></script>

<script>
  const ADMIN_UID = "5Dt6fN64c3aWACYV1WacxV2BHDl2";

  const $ = (id) => document.getElementById(id);
  const show = (el) => el && el.classList.remove("admin-hidden");
  const hide = (el) => el && el.classList.add("admin-hidden");

  function setStatus(text){ const e=$("adminStatus"); if(e) e.textContent=text; }
  function pill(text, cls){
    const el = document.createElement("div");
    el.className = "pill " + (cls||"");
    el.textContent = text;
    return el;
  }

  function dtToTs(localValue){
    // datetime-local -> Firestore Timestamp —á–µ—Ä–µ–∑ Date
    if(!localValue) return null;
    const d = new Date(localValue);
    return window.firebase.firestore.Timestamp.fromDate(d);
  }
  function tsToText(ts){
    if(!ts) return "‚Äî";
    const d = ts.toDate ? ts.toDate() : new Date(ts);
    return d.toLocaleString("uk-UA");
  }

  async function waitForFirebase(){
    for(let i=0;i<120;i++){
      if(window.scAuth && window.scDb) return;
      await new Promise(r=>setTimeout(r,100));
    }
    throw new Error("Firebase –ù–ï —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π (scAuth / scDb)");
  }

  async function init(){
    await waitForFirebase();
    const auth = window.scAuth;
    const db   = window.scDb;

    const loginBox = $("adminLogin");
    const appBox   = $("adminApp");
    const msg      = $("adminLoginMsg");

    function showLogin(text){
      hide(appBox); show(loginBox);
      if(msg) msg.textContent = text || "";
    }
    function showApp(){
      hide(loginBox); show(appBox);
    }

    // login button
    $("btnAdminLogin").onclick = async () => {
      const email = $("admEmail").value.trim();
      const pass  = $("admPass").value.trim();
      if(!email || !pass){ msg.textContent="–í–≤–µ–¥–∏ email —ñ –ø–∞—Ä–æ–ª—å"; return; }
      msg.textContent="–í—Ö—ñ–¥‚Ä¶";
      try { await auth.signInWithEmailAndPassword(email, pass); }
      catch(e){ msg.textContent="–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É"; }
    };

    // Auth gate
    auth.onAuthStateChanged(async (user) => {
      const pills = $("adminPills");
      pills.innerHTML = "";

      if(!user){
        setStatus("–ü–æ—Ç—Ä—ñ–±–µ–Ω –≤—Ö—ñ–¥");
        pills.appendChild(pill("üîí –Ω–µ –∑–∞–ª–æ–≥—ñ–Ω–µ–Ω–∏–π", "bad"));
        showLogin("–£–≤—ñ–π–¥–∏ —è–∫ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä");
        return;
      }
      if(user.uid !== ADMIN_UID){
        setStatus("–î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ");
        pills.appendChild(pill("‚õî –Ω–µ –∞–¥–º—ñ–Ω", "bad"));
        showLogin("–¶–µ–π –∞–∫–∞—É–Ω—Ç –Ω–µ –º–∞—î –¥–æ—Å—Ç—É–ø—É");
        return;
      }

      setStatus("–ê–¥–º—ñ–Ω-–¥–æ—Å—Ç—É–ø –¥–æ–∑–≤–æ–ª–µ–Ω–æ");
      pills.appendChild(pill("‚úÖ admin", "ok"));
      pills.appendChild(pill("UID: " + user.uid.slice(0,8) + "‚Ä¶", ""));
      showApp();

      // load stages
      await loadStages();
    });

    async function loadStages(){
      const sel = $("selStage");
      sel.innerHTML = `<option value="">‚Äî –Ω–µ–º–∞—î –µ—Ç–∞–ø—ñ–≤ ‚Äî</option>`;

      const snap = await db.collection("stages").orderBy("startAt", "desc").limit(50).get();
      if(snap.empty) return;

      sel.innerHTML = "";
      snap.forEach(doc => {
        const s = doc.data() || {};
        const opt = document.createElement("option");
        opt.value = doc.id;
        opt.textContent = `${s.stageName || doc.id} (${s.seasonId || "‚Äî"})`;
        sel.appendChild(opt);
      });

      // restore last selected
      const saved = localStorage.getItem("sc_admin_stage") || "";
      if(saved && [...sel.options].some(o=>o.value===saved)) sel.value = saved;

      await renderStageInfo();
      sel.onchange = async () => {
        localStorage.setItem("sc_admin_stage", sel.value || "");
        await renderStageInfo();
        syncLinks();
      };
      syncLinks();
    }

    function syncLinks(){
      const stageId = $("selStage").value || "";
      const q = stageId ? `?stage=${encodeURIComponent(stageId)}` : "";
      $("goRegs").href  = "admin-registrations.html" + q;
      $("goDraw").href  = "admin-draw.html" + q;
      $("goWeigh").href = "judge-weighings.html" + q;
      $("goUsers").href = "admin-users.html" + q;
    }

    async function renderStageInfo(){
      const stageId = $("selStage").value;
      const box = $("stageInfo");
      if(!stageId){ box.textContent = "–û–±–µ—Ä–∏ –µ—Ç–∞–ø, —â–æ–± –±–∞—á–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å."; return; }

      const doc = await db.collection("stages").doc(stageId).get();
      if(!doc.exists){ box.textContent = "–ï—Ç–∞–ø –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∏–π."; return; }
      const s = doc.data();

      const now = new Date();
      const regOpenAt  = s.regOpenAt?.toDate?.() || null;
      const regCloseAt = s.regCloseAt?.toDate?.() || null;

      let autoOpen = false;
      if(regOpenAt && regCloseAt){
        autoOpen = (now >= regOpenAt && now <= regCloseAt);
      }

      // manualOpen: true / false / null (auto)
      const manual = (typeof s.manualOpen === "boolean") ? s.manualOpen : null;
      const effectiveOpen = (manual === true) ? true : (manual === false) ? false : autoOpen;

      const mode = (manual === true) ? "–†–£–ß–ù–ò–ô: –í–Ü–î–ö–†–ò–¢–û"
                : (manual === false) ? "–†–£–ß–ù–ò–ô: –ó–ê–ö–†–ò–¢–û"
                : "–ê–í–¢–û (–ø–æ –¥–∞—Ç—ñ)";

      box.innerHTML =
        `–ï—Ç–∞–ø: <b>${(s.stageName||stageId)}</b><br>` +
        `–°—Ç–∞—Ä—Ç: <b>${tsToText(s.startAt)}</b><br>` +
        `–ñ–µ—Ä–µ–±: <b>${tsToText(s.drawAt)}</b><br>` +
        `–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è (–∞–≤—Ç–æ): <b>${tsToText(s.regOpenAt)}</b> ‚Üí <b>${tsToText(s.regCloseAt)}</b><br>` +
        `–†–µ–∂–∏–º: <b>${mode}</b><br>` +
        `–§–∞–∫—Ç–∏—á–Ω–æ –∑–∞—Ä–∞–∑: <b>${effectiveOpen ? "–í–Ü–î–ö–†–ò–¢–û" : "–ó–ê–ö–†–ò–¢–û"}</b>`;
    }

    // CREATE/SAVE STAGE
    $("btnSaveStage").onclick = async () => {
      const seasonId  = $("inpSeasonId").value.trim();
      const stageIdIn = $("inpStageId").value.trim();
      const stageName = $("inpStageName").value.trim();

      const startAt   = dtToTs($("inpStartAt").value);
      const drawAt    = dtToTs($("inpDrawAt").value);
      const regOpenAt = dtToTs($("inpRegOpenAt").value);
      const regCloseAt= dtToTs($("inpRegCloseAt").value);

      const out = $("createMsg");
      if(!seasonId || !stageIdIn || !stageName){
        out.textContent = "–ó–∞–ø–æ–≤–Ω–∏ –º—ñ–Ω—ñ–º—É–º: seasonId, stageId, –Ω–∞–∑–≤–∞.";
        return;
      }

      const docId = `${seasonId}__${stageIdIn}`; // —Å—Ç–∞–±—ñ–ª—å–Ω–∏–π –∫–ª—é—á
      out.textContent = "–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è‚Ä¶";

      try{
        await db.collection("stages").doc(docId).set({
          seasonId,
          stageId: stageIdIn,
          stageName,
          startAt: startAt || null,
          drawAt: drawAt || null,
          regOpenAt: regOpenAt || null,
          regCloseAt: regCloseAt || null,
          manualOpen: null, // null = –∞–≤—Ç–æ
          updatedAt: window.firebase.firestore.FieldValue.serverTimestamp(),
          createdAt: window.firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });

        out.textContent = "‚úÖ –ï—Ç–∞–ø –∑–±–µ—Ä–µ–∂–µ–Ω–æ: " + docId;
        await loadStages();
        $("selStage").value = docId;
        localStorage.setItem("sc_admin_stage", docId);
        await renderStageInfo();
        syncLinks();
      }catch(e){
        console.error(e);
        out.textContent = "‚ùå –ü–æ–º–∏–ª–∫–∞: " + (e.message || e);
      }
    };

    // FORCE OPEN/CLOSE/AUTO
    $("btnForceOpen").onclick = async () => setManual(true);
    $("btnForceClose").onclick = async () => setManual(false);
    $("btnForceAuto").onclick = async () => setManual(null);

    async function setManual(val){
      const stageId = $("selStage").value;
      if(!stageId) return alert("–°–ø–æ—á–∞—Ç–∫—É –≤–∏–±–µ—Ä–∏ –µ—Ç–∞–ø");
      try{
        await db.collection("stages").doc(stageId).set({ manualOpen: val }, { merge:true });
        await renderStageInfo();
      }catch(e){
        alert("–ü–æ–º–∏–ª–∫–∞: " + e.message);
      }
    }
  }

  init().catch(err=>{
    console.error(err);
    setStatus("–ü–æ–º–∏–ª–∫–∞: " + err.message);
  });
</script>

</body>
</html>
