<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>STOLAR CARP ‚Ä¢ –ê–¥–º—ñ–Ω–∫–∞</title>

  <link rel="stylesheet" href="assets/css/main.css">

  <style>
    body{ background: radial-gradient(circle at top,#111827 0,#020617 55%); }
    .admin-wrap{ max-width:980px; margin:0 auto; padding:22px 0 70px; }

    .admin-top{
      padding:14px 16px; border-radius:18px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.35);
      box-shadow:0 18px 40px rgba(0,0,0,.6);
    }
    .muted{ color:#9ca3af; }
    .admin-hidden{ display:none; }

    .admin-card{
      margin-top:14px;
      padding:16px;
      border-radius:18px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.35);
      box-shadow:0 18px 40px rgba(0,0,0,.6);
    }

    .stack{ display:flex; flex-direction:column; gap:10px; }
    .stack .btn{
      width:100%;
      justify-content:center;
      padding:12px 14px;
      border-radius:14px;
    }

    .mini-form{
      margin-top:12px;
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    .mini-form input, .mini-form select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,.35);
      background:rgba(2,6,23,.55);
      color:#e5e7eb;
      outline:none;
    }
    .mini-form input::placeholder{ color:#6b7280; }

    .hr{ height:1px; background:rgba(148,163,184,.18); margin:12px 0; border-radius:99px; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .row > * { flex:1; min-width:180px; }

    .stage-box{
      border:1px solid rgba(148,163,184,.22);
      border-radius:14px;
      padding:12px;
      background:rgba(2,6,23,.35);
    }
    .stage-title{
      font-weight:800;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size:.85rem;
      margin:0 0 10px;
      color:#e5e7eb;
    }
    .stage-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media (max-width:640px){
      .stage-grid{ grid-template-columns:1fr; }
    }

    .hint{
      font-size:.85rem;
      color:#9ca3af;
      margin-top:6px;
      line-height:1.35;
    }

    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.25);
      background:rgba(2,6,23,.35);
      color:#e5e7eb;
      font-size:.85rem;
    }
  </style>
</head>

<body>

<header class="header">
  <div class="container header__row">
    <a class="logo" href="index.html">
      <span class="logo__mark">SC</span>
      <span class="logo__text">STOLAR CARP</span>
    </a>
    <nav class="nav">
      <a href="/index.html" class="nav__link">–ì–æ–ª–æ–≤–Ω–∞</a>
      <a href="/live.html" class="nav__link">Live</a>
      <a href="/rating.html" class="nav__link">–†–µ–π—Ç–∏–Ω–≥</a>
      <a href="/cabinet.html" class="nav__link">–ú—ñ–π –∫–∞–±—ñ–Ω–µ—Ç</a>
    </nav>
  </div>
</header>

<main class="main">
  <section class="section container admin-wrap">

    <div class="admin-top">
      <div class="title-gradient" style="font-size:1.2rem; font-weight:800;">–ê–¥–º—ñ–Ω–∫–∞ STOLAR CARP</div>
      <div class="muted" id="adminStatus">–ó–∞–ø—É—Å–∫‚Ä¶</div>
    </div>

    <!-- LOGIN (—Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –Ω–µ–º–∞—î —Å–µ—Å—ñ—ó) -->
    <div id="adminLogin" class="admin-card admin-hidden">
      <h2 class="section-title" style="margin:0 0 10px;">–í—Ö—ñ–¥ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
      <div class="muted">–£–≤—ñ–π–¥–∏ email/–ø–∞—Ä–æ–ª–µ–º –∞–¥–º—ñ–Ω-–∞–∫–∞—É–Ω—Ç–∞. –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó —Ç—É—Ç –Ω–µ–º–∞—î.</div>

      <div class="row" style="margin-top:12px;">
        <input id="admEmail" type="email" placeholder="Email">
        <input id="admPass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
        <button class="btn btn--accent" id="btnAdminLogin" style="flex:0 0 auto; min-width:140px;">–£–≤—ñ–π—Ç–∏</button>
      </div>

      <div class="muted" id="adminLoginMsg" style="margin-top:10px;"></div>
    </div>

    <!-- APP -->
    <div id="adminApp" class="admin-hidden">

      <!-- –ü–µ—Ä–µ—Ö–æ–¥–∏ (–ù–ï –±–ª–æ–∫—É—î–º–æ –Ω—ñ—á–æ–≥–æ) -->
      <div class="admin-card">
        <h2 class="section-title" style="margin:0 0 8px;">–ü–∞–Ω–µ–ª—å</h2>
        <div class="muted">
          –¢—É—Ç: —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–º–∞–≥–∞–Ω—å/—Å–µ–∑–æ–Ω—ñ–≤ —ñ –∫–µ—Ä—É–≤–∞–Ω–Ω—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—î—é. <br>
          <span class="pill" style="margin-top:10px;">‚ö†Ô∏è –ñ–µ—Ä–µ–±–∫—É–≤–∞–Ω–Ω—è/–∑–≤–∞–∂—É–≤–∞–Ω–Ω—è –ù–ï –±–ª–æ–∫—É—î–º–æ ‚Äî –≤–æ–Ω–∏ –¥–æ—Å—Ç—É–ø–Ω—ñ –∑–∞–≤–∂–¥–∏ –∞–¥–º—ñ–Ω–∞–º/—Å—É–¥–¥—è–º.</span>
        </div>

        <div class="hr"></div>

        <div class="stack">
          <button class="btn btn--primary" id="btnOpenCreate">1) –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–º–∞–≥–∞–Ω–Ω—è</button>
          <button class="btn btn--accent"  id="btnOpenReg">2) –í—ñ–¥–∫—Ä–∏—Ç–∏ / –∑–∞–∫—Ä–∏—Ç–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é</button>

          <a class="btn btn--primary" href="admin-registrations.html">3) –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –∫–æ–º–∞–Ω–¥ (–ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –æ–ø–ª–∞—Ç)</a>
          <a class="btn btn--accent"  href="admin-draw.html">4) –ñ–µ—Ä–µ–±–∫—É–≤–∞–Ω–Ω—è</a>
          <a class="btn btn--danger"  href="admin-weigh.html">5) –ó–≤–∞–∂—É–≤–∞–Ω–Ω—è (—Å—É–¥–¥—ñ/–∞–¥–º—ñ–Ω)</a>
        </div>

        <div class="muted" style="margin-top:10px;">
          AUTO ‚Äî –ø—Ä–∞—Ü—é—î –ø–æ –¥–∞—Ç–∞—Ö (12:00). MANUAL ‚Äî –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è/–∑–∞–∫—Ä–∏—Ç—Ç—è –≤—Ä—É—á–Ω—É.
        </div>
      </div>

      <!-- 1) –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–º–∞–≥–∞–Ω–Ω—è -->
      <div class="admin-card admin-hidden" id="modCreate">
        <h2 class="section-title" style="margin:0 0 8px;">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–º–∞–≥–∞–Ω–Ω—è</h2>
        <div class="muted">
          –ü–∏—à–µ –≤ <b>competitions/{competitionId}</b> —Ç–∞ –µ—Ç–∞–ø–∏ –≤ <b>competitions/{competitionId}/stages/{stageId}</b>.
        </div>

        <div class="mini-form">
          <select id="inpType">
            <option value="season">–¢–∏–ø: –°–ï–ó–û–ù (2‚Äì8 –µ—Ç–∞–ø—ñ–≤ + —Ñ—ñ–Ω–∞–ª –æ–ø—Ü—ñ–π–Ω–æ)</option>
            <option value="single">–¢–∏–ø: –û–î–ù–û–†–ê–ó–û–í–ï –∑–º–∞–≥–∞–Ω–Ω—è</option>
          </select>

          <input id="inpYear" inputmode="numeric" placeholder="–†—ñ–∫ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: 2026)">
          <input id="inpTitle" placeholder="–ù–∞–∑–≤–∞ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: Season STOLAR CARP 2026 / –û—Å—ñ–Ω–Ω—ñ–π –ö–æ—Ä–æ–ø / –°—Ç–∞–ª–∫–µ—Ä)">

          <select id="inpStagesCount">
            <option value="2">–ö-—Å—Ç—å –µ—Ç–∞–ø—ñ–≤ —É —Å–µ–∑–æ–Ω—ñ: 2</option>
            <option value="3" selected>–ö-—Å—Ç—å –µ—Ç–∞–ø—ñ–≤ —É —Å–µ–∑–æ–Ω—ñ: 3</option>
            <option value="4">–ö-—Å—Ç—å –µ—Ç–∞–ø—ñ–≤ —É —Å–µ–∑–æ–Ω—ñ: 4</option>
            <option value="5">–ö-—Å—Ç—å –µ—Ç–∞–ø—ñ–≤ —É —Å–µ–∑–æ–Ω—ñ: 5</option>
            <option value="6">–ö-—Å—Ç—å –µ—Ç–∞–ø—ñ–≤ —É —Å–µ–∑–æ–Ω—ñ: 6</option>
            <option value="7">–ö-—Å—Ç—å –µ—Ç–∞–ø—ñ–≤ —É —Å–µ–∑–æ–Ω—ñ: 7</option>
            <option value="8">–ö-—Å—Ç—å –µ—Ç–∞–ø—ñ–≤ —É —Å–µ–∑–æ–Ω—ñ: 8</option>
          </select>

          <select id="inpHasFinal">
            <option value="yes" selected>–§—ñ–Ω–∞–ª: –¢–ê–ö</option>
            <option value="no">–§—ñ–Ω–∞–ª: –ù–Ü</option>
          </select>

          <select id="inpRegMode">
            <option value="auto" selected>–†–µ–∂–∏–º —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó: AUTO (–ø–æ –¥–∞—Ç—ñ)</option>
            <option value="manual">–†–µ–∂–∏–º —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó: MANUAL (–≤—Ä—É—á–Ω—É)</option>
          </select>
        </div>

        <div class="hint">
          üóìÔ∏è –î–∞–ª—ñ –≤–∏–±–µ—Ä–∏ <b>–¥–∞—Ç–∏</b> –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è/–∑–∞–∫—Ä–∏—Ç—Ç—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –µ—Ç–∞–ø—É.
          –ß–∞—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ = <b>12:00 (–ö–∏—ó–≤)</b>.
        </div>

        <div id="stagesDatesWrap" style="margin-top:12px;"></div>

        <div class="stack" style="margin-top:12px;">
          <button class="btn btn--accent" id="btnDoCreate">–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º–∞–≥–∞–Ω–Ω—è</button>
          <button class="btn btn--primary" id="btnSetActive">–ó—Ä–æ–±–∏—Ç–∏ –∞–∫—Ç–∏–≤–Ω–∏–º</button>
        </div>

        <div class="muted" id="createMsg" style="margin-top:10px;"></div>
      </div>

      <!-- 2) –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è: —Ä—É—á–Ω–µ –∫–µ—Ä—É–≤–∞–Ω–Ω—è -->
      <div class="admin-card admin-hidden" id="modReg">
        <h2 class="section-title" style="margin:0 0 8px;">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è: –≤—ñ–¥–∫—Ä–∏—Ç–∏ / –∑–∞–∫—Ä–∏—Ç–∏</h2>
        <div class="muted">–í–∏–±–µ—Ä–∏ –µ—Ç–∞–ø ‚Üí –≤—ñ–¥–∫—Ä–∏–π/–∑–∞–∫—Ä–∏–π –≤—Ä—É—á–Ω—É. AUTO —Ä–µ–∂–∏–º ‚Äî –æ—Ä—ñ—î–Ω—Ç—É—î—Ç—å—Å—è –Ω–∞ –¥–∞—Ç–∏ (12:00).</div>

        <div class="mini-form">
          <select id="selStage"></select>
          <div class="muted" id="regInfo">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</div>

          <div class="stack">
            <button class="btn btn--accent" id="btnManualOpen">–í–Ü–î–ö–†–ò–¢–ò –≤—Ä—É—á–Ω—É</button>
            <button class="btn btn--danger" id="btnManualClose">–ó–ê–ö–†–ò–¢–ò –≤—Ä—É—á–Ω—É</button>
            <button class="btn btn--primary" id="btnSyncToActive">–ó—Ä–æ–±–∏—Ç–∏ –≤–∏–±—Ä–∞–Ω–∏–π –µ—Ç–∞–ø –∞–∫—Ç–∏–≤–Ω–∏–º</button>
          </div>
        </div>

        <div class="muted" id="regMsg" style="margin-top:10px;"></div>
      </div>

    </div>
  </section>
</main>

<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<!-- –Ñ–¥–∏–Ω–∏–π init -->
<script src="assets/js/firebase-init.js"></script>

<script>
  const ADMIN_UID = "5Dt6fN64c3aWACYV1WacxV2BHDl2";
  const BRAND_DEFAULT = "STOLAR CARP";

  const $ = (id)=>document.getElementById(id);
  const show = (el)=>el && el.classList.remove("admin-hidden");
  const hide = (el)=>el && el.classList.add("admin-hidden");
  const setStatus = (t)=>{ const e=$("adminStatus"); if(e) e.textContent=t; };

  const modCreate = $("modCreate");
  const modReg    = $("modReg");
  function openModule(name){
    hide(modCreate); hide(modReg);
    if(name==="create") show(modCreate);
    if(name==="reg") show(modReg);
  }

  function pad2(n){ return String(n).padStart(2,"0"); }

  // dateStr: "YYYY-MM-DD" -> Date at 12:00 local (Kyiv, —è–∫—â–æ —Ç–µ–ª–µ—Ñ–æ–Ω –≤ UA)
  function dateAtNoon(dateStr){
    const v = (dateStr||"").trim();
    if(!v) return null;
    const m = v.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(!m) return null;
    const Y = Number(m[1]), Mo = Number(m[2])-1, D = Number(m[3]);
    return new Date(Y, Mo, D, 12, 0, 0, 0);
  }
  function toTS(d){ return d ? window.firebase.firestore.Timestamp.fromDate(d) : null; }

  function slugify(s){
    return String(s||"")
      .toLowerCase()
      .trim()
      .replace(/['"]/g,"")
      .replace(/[^a-z0-9–∞-—è—ñ—ó—î“ë]+/gi,"-")
      .replace(/^-+|-+$/g,"")
      .slice(0,60) || "competition";
  }

  async function waitForFirebase(){
    for(let i=0;i<120;i++){
      if(window.scAuth && window.scDb) return;
      await new Promise(r=>setTimeout(r,100));
    }
    throw new Error("Firebase –ù–ï —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π (scAuth / scDb)");
  }

  let lastCreatedCompetitionId = null;

  function renderStagesDateInputs(){
    const type = $("inpType").value;
    const count = Number($("inpStagesCount").value || "3");
    const hasFinal = $("inpHasFinal").value === "yes";

    const wrap = $("stagesDatesWrap");
    if(!wrap) return;

    // –¥–ª—è –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–≥–æ ‚Äî 1 –±–ª–æ–∫
    if(type === "single"){
      wrap.innerHTML = `
        <div class="stage-box">
          <div class="stage-title">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –¥–ª—è –∑–º–∞–≥–∞–Ω–Ω—è</div>
          <div class="stage-grid">
            <input type="date" id="dateOpen_single"  placeholder="–í—ñ–¥–∫—Ä–∏—Ç—Ç—è (–¥–∞—Ç–∞)">
            <input type="date" id="dateClose_single" placeholder="–ó–∞–∫—Ä–∏—Ç—Ç—è (–¥–∞—Ç–∞)">
          </div>
          <div class="hint">–ß–∞—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –±—É–¥–µ 12:00 (–ö–∏—ó–≤).</div>
        </div>
      `;
      return;
    }

    // –¥–ª—è —Å–µ–∑–æ–Ω—É ‚Äî –µ—Ç–∞–ø–∏ + (–æ–ø—Ü—ñ–π–Ω–æ) —Ñ—ñ–Ω–∞–ª
    let html = "";
    for(let i=1;i<=count;i++){
      html += `
        <div class="stage-box" style="margin-bottom:10px;">
          <div class="stage-title">–ï—Ç–∞–ø ${i} ‚Äî —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</div>
          <div class="stage-grid">
            <input type="date" id="dateOpen_stage_${i}"  placeholder="–í—ñ–¥–∫—Ä–∏—Ç—Ç—è (–¥–∞—Ç–∞)">
            <input type="date" id="dateClose_stage_${i}" placeholder="–ó–∞–∫—Ä–∏—Ç—Ç—è (–¥–∞—Ç–∞)">
          </div>
          <div class="hint">–ß–∞—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ 12:00 (–ö–∏—ó–≤).</div>
        </div>
      `;
    }
    if(hasFinal){
      html += `
        <div class="stage-box">
          <div class="stage-title">–§—ñ–Ω–∞–ª ‚Äî —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</div>
          <div class="stage-grid">
            <input type="date" id="dateOpen_final"  placeholder="–í—ñ–¥–∫—Ä–∏—Ç—Ç—è (–¥–∞—Ç–∞)">
            <input type="date" id="dateClose_final" placeholder="–ó–∞–∫—Ä–∏—Ç—Ç—è (–¥–∞—Ç–∞)">
          </div>
          <div class="hint">–ß–∞—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ 12:00 (–ö–∏—ó–≤).</div>
        </div>
      `;
    }

    wrap.innerHTML = html;
  }

  async function init(){
    await waitForFirebase();
    const auth = window.scAuth;
    const db   = window.scDb;

    const loginBox = $("adminLogin");
    const appBox   = $("adminApp");
    const btnLogin = $("btnAdminLogin");
    const msg      = $("adminLoginMsg");

    function showLogin(text){
      hide(appBox);
      show(loginBox);
      if(msg) msg.textContent = text || "";
    }
    function showApp(){
      hide(loginBox);
      show(appBox);
    }

    $("btnOpenCreate").onclick = ()=>openModule("create");
    $("btnOpenReg").onclick    = async ()=>{ openModule("reg"); await loadStagesForReg(); };

    // –∑–º—ñ–Ω–∏ —Ñ–æ—Ä–º–∏ ‚Äî –ø–µ—Ä–µ–º–∞–ª—å–æ–≤—É—î–º–æ –µ—Ç–∞–ø–∏
    $("inpType").addEventListener("change", renderStagesDateInputs);
    $("inpStagesCount").addEventListener("change", renderStagesDateInputs);
    $("inpHasFinal").addEventListener("change", renderStagesDateInputs);

    renderStagesDateInputs();

    if(btnLogin){
      btnLogin.onclick = async () => {
        const email = $("admEmail").value.trim();
        const pass  = $("admPass").value.trim();
        if(!email || !pass){ msg.textContent = "–í–≤–µ–¥–∏ email —ñ –ø–∞—Ä–æ–ª—å"; return; }
        msg.textContent = "–í—Ö—ñ–¥‚Ä¶";
        try{ await auth.signInWithEmailAndPassword(email, pass); }
        catch(e){ msg.textContent = e?.message || "–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É"; }
      };
    }

    auth.onAuthStateChanged(async (user) => {
      if(!user){
        setStatus("–ü–æ—Ç—Ä—ñ–±–µ–Ω –≤—Ö—ñ–¥ (–∞–¥–º—ñ–Ω)");
        showLogin("–£–≤—ñ–π–¥–∏ —è–∫ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä");
        return;
      }
      if(user.uid !== ADMIN_UID){
        setStatus("–î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ ‚ùå");
        showLogin("–¶–µ–π –∞–∫–∞—É–Ω—Ç –Ω–µ –º–∞—î –¥–æ—Å—Ç—É–ø—É");
        return;
      }
      setStatus("–ê–¥–º—ñ–Ω-–¥–æ—Å—Ç—É–ø –¥–æ–∑–≤–æ–ª–µ–Ω–æ ‚úÖ");
      showApp();
      openModule("create");
      await loadStagesForReg();
    });

    // 1) CREATE
    $("btnDoCreate").onclick = async ()=>{
      const type = $("inpType").value; // season | single
      const year = $("inpYear").value.trim();
      const title = $("inpTitle").value.trim();
      const regMode = $("inpRegMode").value; // auto | manual

      const stagesCount = Number($("inpStagesCount").value || "3");
      const hasFinal = $("inpHasFinal").value === "yes";

      if(!year || !/^\d{4}$/.test(year)){
        $("createMsg").textContent = "–í–∫–∞–∂–∏ —Ä—ñ–∫ (4 —Ü–∏—Ñ—Ä–∏), –Ω–∞–ø—Ä–∏–∫–ª–∞–¥ 2026.";
        return;
      }
      if(!title){
        $("createMsg").textContent = "–í–∫–∞–∂–∏ –Ω–∞–∑–≤—É –∑–º–∞–≥–∞–Ω–Ω—è.";
        return;
      }

      // competitionId
      const baseId = type === "season"
        ? `season-${year}`
        : `${year}-${slugify(title)}`;

      const competitionId = baseId;

      $("createMsg").textContent = "–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è‚Ä¶";

      try{
        // competitions/{competitionId}
        await db.collection("competitions").doc(competitionId).set({
          competitionId,
          type,                 // season | single
          year: Number(year),
          brand: BRAND_DEFAULT, // –∞–≤—Ç–æ
          title,
          stagesCount: type === "season" ? stagesCount : 1,
          hasFinal: type === "season" ? !!hasFinal : false,
          regMode,
          updatedAt: window.firebase.firestore.FieldValue.serverTimestamp(),
          createdAt: window.firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });

        // stages
        const stagesCol = db.collection("competitions").doc(competitionId).collection("stages");

        if(type === "single"){
          const openD = dateAtNoon($("dateOpen_single")?.value);
          const closeD = dateAtNoon($("dateClose_single")?.value);

          await stagesCol.doc("main").set({
            stageId: "main",
            name: title,
            order: 1,
            regMode,
            regOpenAt: toTS(openD),
            regCloseAt: toTS(closeD),
            manualOpen: false,
            updatedAt: window.firebase.firestore.FieldValue.serverTimestamp(),
            createdAt: window.firebase.firestore.FieldValue.serverTimestamp()
          }, { merge:true });

        } else {
          for(let i=1;i<=stagesCount;i++){
            const openD = dateAtNoon($("dateOpen_stage_"+i)?.value);
            const closeD = dateAtNoon($("dateClose_stage_"+i)?.value);

            await stagesCol.doc(`stage-${i}`).set({
              stageId: `stage-${i}`,
              name: `–ï—Ç–∞–ø ${i}`,
              order: i,
              regMode,
              regOpenAt: toTS(openD),
              regCloseAt: toTS(closeD),
              manualOpen: false,
              updatedAt: window.firebase.firestore.FieldValue.serverTimestamp(),
              createdAt: window.firebase.firestore.FieldValue.serverTimestamp()
            }, { merge:true });
          }

          if(hasFinal){
            const openD = dateAtNoon($("dateOpen_final")?.value);
            const closeD = dateAtNoon($("dateClose_final")?.value);

            await stagesCol.doc("final").set({
              stageId: "final",
              name: "–§—ñ–Ω–∞–ª",
              order: 999,
              regMode,
              regOpenAt: toTS(openD),
              regCloseAt: toTS(closeD),
              manualOpen: false,
              updatedAt: window.firebase.firestore.FieldValue.serverTimestamp(),
              createdAt: window.firebase.firestore.FieldValue.serverTimestamp()
            }, { merge:true });
          }
        }

        lastCreatedCompetitionId = competitionId;
        $("createMsg").textContent = `‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–æ: ${competitionId}. –î–∞–ª—ñ –º–æ–∂–µ—à –∑—Ä–æ–±–∏—Ç–∏ –∞–∫—Ç–∏–≤–Ω–∏–º –∞–±–æ –∫–µ—Ä—É–≤–∞—Ç–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—î—é.`;
        await loadStagesForReg();

      }catch(e){
        console.error(e);
        $("createMsg").textContent = "‚ùå –ü–æ–º–∏–ª–∫–∞: " + (e.message || e);
      }
    };

    $("btnSetActive").onclick = async ()=>{
      const compId = lastCreatedCompetitionId;
      if(!compId){
        $("createMsg").textContent = "–°–ø–æ—á–∞—Ç–∫—É –∑–±–µ—Ä–µ–∂–∏ –∑–º–∞–≥–∞–Ω–Ω—è (–∫–Ω–æ–ø–∫–∞ ¬´–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º–∞–≥–∞–Ω–Ω—è¬ª).";
        return;
      }

      // –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –∞–∫—Ç–∏–≤–Ω–∏–π stage:
      // season -> stage-1, single -> main
      const type = $("inpType").value;
      const stageId = (type === "single") ? "main" : "stage-1";

      $("createMsg").textContent = "–û–Ω–æ–≤–ª–µ–Ω–Ω—è settings/app‚Ä¶";
      try{
        await db.collection("settings").doc("app").set({
          activeCompetitionId: compId,
          activeStageId: stageId,
          updatedAt: window.firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });

        $("createMsg").textContent = `‚úÖ –ê–∫—Ç–∏–≤–Ω–µ: ${compId} / ${stageId}`;
        await loadStagesForReg(true);
      }catch(e){
        console.error(e);
        $("createMsg").textContent = "‚ùå –ü–æ–º–∏–ª–∫–∞: " + (e.message || e);
      }
    };

    // 2) REG TOGGLE (MANUAL)
    $("btnManualOpen").onclick  = async ()=>manualToggle(true);
    $("btnManualClose").onclick = async ()=>manualToggle(false);

    $("btnSyncToActive").onclick = async ()=>{
      const v = $("selStage").value || "";
      if(!v){ $("regMsg").textContent = "–ù–µ–º–∞ –≤–∏–±—Ä–∞–Ω–æ–≥–æ –µ—Ç–∞–ø—É."; return; }
      const [compId, stageId] = v.split("|");

      $("regMsg").textContent = "–û–Ω–æ–≤–ª–µ–Ω–Ω—è settings/app‚Ä¶";
      try{
        await db.collection("settings").doc("app").set({
          activeCompetitionId: compId,
          activeStageId: stageId,
          updatedAt: window.firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });

        $("regMsg").textContent = "‚úÖ –ê–∫—Ç–∏–≤–Ω–∏–π –µ—Ç–∞–ø –∑–º—ñ–Ω–µ–Ω–æ.";
        await loadStagesForReg(true);
      }catch(e){
        console.error(e);
        $("regMsg").textContent = "‚ùå –ü–æ–º–∏–ª–∫–∞: " + (e.message || e);
      }
    };

    async function manualToggle(open){
      const v = $("selStage").value || "";
      if(!v){ $("regMsg").textContent = "–ù–µ–º–∞ –≤–∏–±—Ä–∞–Ω–æ–≥–æ –µ—Ç–∞–ø—É."; return; }
      const [compId, stageId] = v.split("|");

      $("regMsg").textContent = open ? "–í—ñ–¥–∫—Ä–∏–≤–∞—é‚Ä¶" : "–ó–∞–∫—Ä–∏–≤–∞—é‚Ä¶";

      try{
        await db.collection("competitions").doc(compId).collection("stages").d
