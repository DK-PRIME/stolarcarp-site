<script>
(function(){
  "use strict";

  const auth = window.scAuth;
  const db   = window.scDb;

  const $ = (id)=>document.getElementById(id);

  const stageSelect = $("stageSelect");
  const btnLoad     = $("btnLoad") || $("btnLoadData") || document.querySelector("[data-load]") || $("btnLoadData"); // якщо різні id
  const btnRefresh  = $("btnRefresh") || $("btnReload") || $("btnReloadList") || $("btnRefreshList");

  const msgEl   = $("weighMsg") || $("msg");
  const dbgEl   = $("weighDebug") || $("debug");
  const wrapEl  = $("tablesWrap") || $("tables") || $("wrap");

  const esc = (s)=>String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));

  const setMsg = (t, ok=true)=>{
    if(!msgEl) return;
    msgEl.textContent = t||"";
    msgEl.className = "muted " + (t ? (ok ? "ok" : "err") : "");
  };
  const setDbg = (t)=>{
    if(!dbgEl) return;
    dbgEl.textContent = t||"";
  };

  function norm(v){ return String(v??"").trim(); }

  function parseStageValue(v){
    // у тебе value типу: compId||stageKey
    const [compId, stageIdRaw] = String(v||"").split("||");
    return { compId: norm(compId), stageId: norm(stageIdRaw) || "" };
  }

  async function requireAdmin(user){
    const snap = await db.collection("users").doc(user.uid).get();
    const role = (snap.exists ? (snap.data()||{}).role : "") || "";
    return role === "admin";
  }

  async function loadStagesToSelect(){
    stageSelect.innerHTML = `<option value="">Завантаження…</option>`;

    const items = [];
    const snap = await db.collection("competitions").get();

    snap.forEach(docSnap=>{
      const c = docSnap.data()||{};
      const compId = docSnap.id;

      const brand = c.brand || "STOLAR CARP";
      const year  = c.year || c.seasonYear || "";
      const compTitle = c.name || c.title || (year ? `Season ${year}` : compId);

      const eventsArr = Array.isArray(c.events) ? c.events : null;

      if (eventsArr && eventsArr.length) {
        eventsArr.forEach((ev, idx)=>{
          const key = String(ev.key || ev.stageId || ev.id || `stage-${idx+1}`);
          const stageTitle = ev.title || ev.name || ev.label || `Етап ${idx+1}`;
          const label = `${brand} · ${compTitle} — ${stageTitle}`;
          items.push({ value:`${compId}||${key}`, label });
        });
      } else {
        items.push({ value:`${compId}||`, label:`${brand} · ${compTitle}` });
      }
    });

    items.sort((a,b)=>a.label.localeCompare(b.label,"uk"));

    stageSelect.innerHTML =
      `<option value="">— Оберіть —</option>` +
      items.map(x=>`<option value="${esc(x.value)}">${esc(x.label)}</option>`).join("");
  }

  // ---------- ГОЛОВНЕ: знайти жеребкування ----------
  async function findDrawDoc(compId, stageId){
    // 1) найчастіший варіант: draws/{compId}_{stageId}
    const candidates = [
      { col:"draws", doc:`${compId}_${stageId}` },
      { col:"draws", doc:`${compId}__${stageId}` },
      { col:"draws", doc:`${compId}||${stageId}` },
      { col:"draws", doc:`${compId}-${stageId}` },
      // 2) якщо збережено просто по compId (а stage в полі)
      { col:"draws", doc:`${compId}` },
      // 3) інші можливі назви колекцій
      { col:"draw", doc:`${compId}_${stageId}` },
      { col:"drawings", doc:`${compId}_${stageId}` }
    ];

    // 4) якщо в підколекції competitions/{compId}/draws/{stageId}
    const subPath = db.collection("competitions").doc(compId).collection("draws").doc(stageId);

    // пробуємо підколекцію першою (часто так роблять)
    try{
      const s = await subPath.get();
      if(s.exists) return { ref: s.ref, data: s.data()||{}, where: `competitions/${compId}/draws/${stageId}` };
    }catch(e){ /* ignore */ }

    // пробуємо candidates
    for(const c of candidates){
      try{
        const s = await db.collection(c.col).doc(c.doc).get();
        if(s.exists){
          return { ref: s.ref, data: s.data()||{}, where: `${c.col}/${c.doc}` };
        }
      }catch(e){ /* ignore */ }
    }

    // 5) fallback: query where compId/stageId збережені як поля
    // (це теж частий варіант)
    try{
      const q = await db.collection("draws")
        .where("compId","==",compId)
        .where("stageId","==",stageId)
        .limit(1)
        .get();
      if(!q.empty){
        const d = q.docs[0];
        return { ref: d.ref, data: d.data()||{}, where: `draws(query compId+stageId) -> ${d.id}` };
      }
    }catch(e){ /* ignore */ }

    return null;
  }

  function extractZones(drawData){
    // Підтримуємо всі формати:
    // A/B/C напряму
    // zones: {A:[],B:[],C:[]}
    // zones: [{zone:"A", teams:[...]}] тощо

    let A = drawData.A || drawData.zoneA || drawData.a || null;
    let B = drawData.B || drawData.zoneB || drawData.b || null;
    let C = drawData.C || drawData.zoneC || drawData.c || null;

    if(!A && !B && !C && drawData.zones){
      const z = drawData.zones;
      if(Array.isArray(z)){
        // [{zone:"A", teams:[...]}]
        for(const item of z){
          const zn = String(item.zone || item.key || "").toUpperCase();
          const teams = item.teams || item.items || item.list || [];
          if(zn==="A") A = teams;
          if(zn==="B") B = teams;
          if(zn==="C") C = teams;
        }
      }else if(typeof z === "object"){
        A = z.A || z.zoneA || null;
        B = z.B || z.zoneB || null;
        C = z.C || z.zoneC || null;
      }
    }

    // гарантуємо масиви
    A = Array.isArray(A) ? A : [];
    B = Array.isArray(B) ? B : [];
    C = Array.isArray(C) ? C : [];

    return { A, B, C };
  }

  // ---------- UI таблиць ----------
  function teamLabel(t){
    const sector = t.sector || t.place || t.slot || t.position || "";
    const name   = t.teamName || t.name || t.team || t.title || "Команда";
    return { sector: sector, name: name, teamId: t.teamId || t.id || "" };
  }

  function renderZoneTable(zone, teams){
    const rows = teams.map((t, idx)=>{
      const x = teamLabel(t);
      const sectorText = x.sector ? esc(x.sector) : esc(idx+1);
      return `
        <div class="win-card" data-zone="${zone}" data-team="${esc(x.teamId)}" style="margin-top:10px;">
          <div class="win-title">
            <span>Сектор ${sectorText} — ${esc(x.name)}</span>
            <span class="badge">${zone}</span>
          </div>

          <div class="grid2" style="grid-template-columns: 1fr auto; gap:10px;">
            <input type="number" step="0.001" placeholder="Вага (наприклад 4.560)" data-weight />
            <button class="btn btn--accent" type="button" data-add>+</button>
          </div>

          <div class="muted" style="margin-top:8px;">Внесені ваги:</div>
          <div class="muted" data-list style="margin-top:6px;"></div>

          <div class="hr"></div>

          <div class="grid2">
            <button class="btn btn--primary" type="button" data-save>Зберегти</button>
            <button class="btn btn--ghost" type="button" data-clear>Очистити локально</button>
          </div>

          <div class="muted" data-status style="margin-top:8px;"></div>
        </div>
      `;
    }).join("");

    return `
      <div class="admin-card">
        <div style="font-weight:900; margin-bottom:6px;">Зона ${zone}</div>
        ${teams.length ? rows : `<div class="muted">Нема команд у зоні ${zone}.</div>`}
      </div>
    `;
  }

  function renderAllTables(zones){
    if(!wrapEl) return;
    wrapEl.innerHTML =
      renderZoneTable("A", zones.A) +
      renderZoneTable("B", zones.B) +
      renderZoneTable("C", zones.C);
  }

  // ----- локальний список ваг для зручності -----
  function keyLocal(compId, stageId, zone, teamId){
    return `sc_weights_${compId}_${stageId}_${zone}_${teamId||"noid"}`;
  }
  function loadLocal(compId, stageId, zone, teamId){
    try{
      return JSON.parse(localStorage.getItem(keyLocal(compId, stageId, zone, teamId)) || "[]");
    }catch{ return []; }
  }
  function saveLocal(compId, stageId, zone, teamId, arr){
    try{ localStorage.setItem(keyLocal(compId, stageId, zone, teamId), JSON.stringify(arr||[])); }catch{}
  }

  function refreshCardList(card, arr){
    const list = card.querySelector("[data-list]");
    if(!list) return;
    if(!arr.length){ list.textContent = "—"; return; }
    list.textContent = arr.map(x=>Number(x).toFixed(3)).join(" | ");
  }

  // ---------- ТУТ тимчасово: просто зберігаємо у Firestore (weighings) ----------
  // (Потім ми підв’яжемо до weighings №1..№4, підтвердження командою і т.д.)
  async function saveWeighing(compId, stageId, zone, teamId, weights){
    const id = `${compId}_${stageId}_${zone}_${(teamId||"noid")}`;
    await db.collection("weighings").doc(id).set({
      compId, stageId, zone,
      teamId: teamId || "",
      weights: weights || [],
      totalWeight: (weights||[]).reduce((s,v)=>s+Number(v||0),0),
      updatedAt: window.firebase.firestore.FieldValue.serverTimestamp()
    }, { merge:true });
  }

  async function loadAndBuild(){
    const { compId, stageId } = parseStageValue(stageSelect.value);
    if(!compId) return setMsg("Обери змагання/етап.", false);

    setMsg("Шукаю жеребкування…", true);
    setDbg("");

    const found = await findDrawDoc(compId, stageId);
    if(!found){
      setMsg("❌ Жеребкування НЕ знайдено тим шляхом, який читає адмінка.", false);
      setDbg(
        "Я пробував:\n" +
        "- competitions/{compId}/draws/{stageId}\n" +
        "- draws/{compId}_{stageId}\n" +
        "- draws/{compId}\n" +
        "- draws query where compId+stageId\n\n" +
        "Висновок: твій draw збережений інакше. Дай 1 скрін Firestore або шматок saveDraw()."
      );
      return;
    }

    setDbg("✅ Знайдено жеребкування тут:\n" + found.where);

    const zones = extractZones(found.data);
    renderAllTables(zones);

    // навісити кнопки +/save
    wrapEl.querySelectorAll("[data-zone]").forEach(card=>{
      const zone = card.getAttribute("data-zone");
      const teamId = card.getAttribute("data-team") || "";
      const inp = card.querySelector("[data-weight]");
      const btnAdd = card.querySelector("[data-add]");
      const btnSave = card.querySelector("[data-save]");
      const btnClear = card.querySelector("[data-clear]");
      const st = card.querySelector("[data-status]");

      let arr = loadLocal(compId, stageId, zone, teamId);
      refreshCardList(card, arr);

      btnAdd.onclick = ()=>{
        const v = Number(String(inp.value||"").replace(",","."));
        if(!v || v<=0){ st.textContent = "Введи вагу (наприклад 4.560)"; st.className="muted err"; return; }
        arr.push(v);
        saveLocal(compId, stageId, zone, teamId, arr);
        refreshCardList(card, arr);
        inp.value = "";
        st.textContent = "Додано ✅";
        st.className="muted ok";
      };

      btnClear.onclick = ()=>{
        arr = [];
        saveLocal(compId, stageId, zone, teamId, arr);
        refreshCardList(card, arr);
        st.textContent = "Очищено локально";
        st.className="muted";
      };

      btnSave.onclick = async ()=>{
        st.textContent = "Зберігаю…";
        st.className="muted";
        try{
          await saveWeighing(compId, stageId, zone, teamId, arr);
          st.textContent = "Збережено у Firestore ✅";
          st.className="muted ok";
        }catch(e){
          st.textContent = "Помилка збереження ❌";
          st.className="muted err";
          setDbg((dbgEl?.textContent||"") + "\n\nSAVE ERROR:\n" + (e?.message||String(e)));
        }
      };
    });

    setMsg("✅ Таблиці згенеровані (A/B/C).", true);
  }

  async function init(){
    if(!auth || !db || !window.firebase){
      setMsg("Firebase init не завантажився.", false);
      return;
    }

    auth.onAuthStateChanged(async (user)=>{
      if(!user){
        setMsg("Увійди як адмін.", false);
        return;
      }
      const ok = await requireAdmin(user);
      if(!ok){
        setMsg("Цей акаунт не адмін.", false);
        return;
      }

      await loadStagesToSelect();
      setMsg("Обери етап → натисни “Завантажити дані”.", true);

      // якщо кнопки мають інші id — підстраховка:
      const loadBtn = btnLoad || document.querySelector("button.btn--accent");
      if(loadBtn) loadBtn.onclick = loadAndBuild;

      if(btnRefresh) btnRefresh.onclick = async ()=>{
        setMsg("Оновлюю список…", true);
        await loadStagesToSelect();
        setMsg("Оновлено ✅", true);
      };
    });
  }

  init();

})();
</script>
