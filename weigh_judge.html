<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>STOLAR CARP ‚Ä¢ –°—É–¥–¥—è</title>

  <link rel="stylesheet" href="assets/css/main.css" />

  <style>
    body{ background:#020617; }
    .wrap{ max-width:860px; margin:0 auto; padding:20px 0 80px; }
    .card{
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.3);
      border-radius:16px;
      padding:16px;
      margin-bottom:12px;
    }
    .muted{ color:#9ca3af; }
    .big{ font-size:1.35rem; font-weight:900; }
    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .ok{ color:#8fe39a; }
    .err{ color:#ff6c6c; }
    .kv{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:.9rem; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(148,163,184,.25);
      background:rgba(2,6,23,.35);
      color:#e5e7eb; font-size:.82rem; white-space:nowrap;
    }
  </style>
</head>

<body>
<header class="header">
  <div class="container header__row">
    <a class="logo" href="index.html">
      <span class="logo__mark">SC</span>
      <span class="logo__text">STOLAR CARP</span>
    </a>
    <div class="pill" id="authPill">auth: ‚Ä¶</div>
  </div>
</header>

<main class="main">
  <section class="section container wrap">

    <div class="card">
      <div class="big" id="zoneTitle">–ó–æ–Ω–∞ ‚Äî</div>
      <div class="muted" id="status">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</div>

      <div class="muted" style="margin-top:10px;">
        <div><b>–ü—Ä–∏–≤‚Äô—è–∑–∫–∞ –ø—Ä–∏—Å—Ç—Ä–æ—é:</b></div>
        <div class="kv" id="bindInfo">‚Äî</div>
      </div>

      <div class="btnRow">
        <button class="btn btn--primary" id="btnOpen">–í—ñ–¥–∫—Ä–∏—Ç–∏ –º–æ—é –∑–æ–Ω—É</button>
        <button class="btn btn--ghost" id="btnSaveHint">–Ø–∫ –∑–±–µ—Ä–µ–≥—Ç–∏ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω</button>
        <button class="btn btn--danger" id="btnReset">–°–∫–∏–Ω—É—Ç–∏ –ø—Ä–∏–≤‚Äô—è–∑–∫—É</button>
      </div>

      <div class="muted" id="msg" style="margin-top:10px;"></div>
    </div>

    <div class="card">
      <div style="font-weight:900;margin-bottom:8px;">–î–∞–ª—ñ —Ç—É—Ç –±—É–¥–µ ‚Äú–ó–≤–∞–∂—É–≤–∞–Ω–Ω—è‚Äù</div>
      <div class="muted">
        –¢—É—Ç –º–∏ –ø—ñ–¥–≤‚Äô—è–∂–µ–º–æ: —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ –ø–æ –∑–æ–Ω—ñ ‚Üí –≤–Ω–µ—Å–µ–Ω–Ω—è –≤–∞–≥ ‚Üí –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –∫–æ–º–∞–Ω–¥–æ—é ‚Üí ‚Äú–ó–∞–∫—Ä–∏—Ç–∏ –∑–≤–∞–∂—É–≤–∞–Ω–Ω—è ‚Ññ1‚Äù ‚Üí ‚Ññ2 ‚Üí ‚Ññ3 ‚Üí ‚Ññ4.
      </div>
    </div>

  </section>
</main>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="assets/js/firebase-init.js"></script>

<script>
(function(){
  "use strict";

  const LS_KEY = "sc_judge_bind_v1";
  const ADMIN_UID = "5Dt6fN64c3aWACYV1WacxV2BHDl2";

  const zoneTitle = document.getElementById("zoneTitle");
  const statusEl  = document.getElementById("status");
  const bindInfo  = document.getElementById("bindInfo");
  const msgEl     = document.getElementById("msg");
  const authPill  = document.getElementById("authPill");

  const btnOpen   = document.getElementById("btnOpen");
  const btnReset  = document.getElementById("btnReset");
  const btnSaveHint = document.getElementById("btnSaveHint");

  let auth = null;
  let db = null;

  function setMsg(t, ok=true){
    msgEl.textContent = t || "";
    msgEl.className = "muted " + (t ? (ok ? "ok":"err") : "");
  }

  function norm(v){ return String(v ?? "").trim(); }

  async function waitFirebase(){
    for(let i=0;i<140;i++){
      if(window.scAuth && window.scDb && window.firebase) return;
      await new Promise(r=>setTimeout(r,100));
    }
    throw new Error("Firebase init –Ω–µ –ø—ñ–¥–Ω—è–≤ scAuth/scDb.");
  }

  async function requireJudgeOrAdmin(user){
    if(!user) return false;
    if(user.uid === ADMIN_UID) return true;

    const snap = await db.collection("users").doc(user.uid).get();
    const role = (snap.exists ? (snap.data()||{}).role : "") || "";
    return role === "judge" || role === "admin";
  }

  function readBind(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      return raw ? JSON.parse(raw) : null;
    }catch{
      return null;
    }
  }

  function writeBind(data){
    try{
      localStorage.setItem(LS_KEY, JSON.stringify(data));
      return true;
    }catch{
      return false;
    }
  }

  function clearBind(){
    try{ localStorage.removeItem(LS_KEY); }catch{}
  }

  function currentParams(){
    const p = new URLSearchParams(location.search);
    const zone   = norm((p.get("zone")||"").toUpperCase());
    const compId = norm(p.get("compId")||"");
    const stageId= norm(p.get("stageId")||"");
    const token  = norm(p.get("t")||"");
    return { zone, compId, stageId, token };
  }

  function buildUrlFromBind(b){
    const p = new URLSearchParams();
    p.set("zone", b.zone);
    p.set("compId", b.compId);
    if (b.stageId) p.set("stageId", b.stageId);
    p.set("t", b.token);
    return location.origin + location.pathname + "?" + p.toString();
  }

  function renderState(){
    const bind = readBind();
    if (!bind){
      zoneTitle.textContent = "–ó–æ–Ω–∞ ‚Äî";
      statusEl.textContent = "‚ùó –ù–µ–º–∞ –ø—Ä–∏–≤‚Äô—è–∑–∫–∏. –í—ñ–¥–∫—Ä–∏–π QR/–ª—ñ–Ω–∫ –≤—ñ–¥ –∞–¥–º—ñ–Ω–∞ –æ–¥–∏–Ω —Ä–∞–∑ ‚Äî —ñ –∑–æ–Ω–∞ –∑–±–µ—Ä–µ–∂–µ—Ç—å—Å—è.";
      bindInfo.textContent = "‚Äî";
      return;
    }
    zoneTitle.textContent = `–ó–æ–Ω–∞ ${bind.zone}`;
    statusEl.textContent = "‚úÖ –ü—Ä–∏–≤‚Äô—è–∑–∫–∞ –∑–æ–Ω–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–∞ –Ω–∞ —Ü—å–æ–º—É —Ç–µ–ª–µ—Ñ–æ–Ω—ñ.";
    bindInfo.textContent = `zone=${bind.zone} | compId=${bind.compId} | stageId=${bind.stageId || "‚Äî"} | token=${bind.token}`;
  }

  async function boot(){
    // 0) –ü—ñ–¥–Ω—ñ–º–∞—î–º–æ Firebase
    try{
      await waitFirebase();
      auth = window.scAuth;
      db = window.scDb;
    }catch(e){
      statusEl.textContent = "Firebase –Ω–µ –∑–∞–ø—É—Å—Ç–∏–≤—Å—è ‚ùå";
      setMsg(e.message || "Firebase init error", false);
      return;
    }

    // 1) –Ø–∫—â–æ –ø—Ä–∏–π—à–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –∑ QR/–ª—ñ–Ω–∫–∞ ‚Äî –∑–±–µ—Ä—ñ–≥–∞—î–º–æ —è–∫ –ø—Ä–∏–≤‚Äô—è–∑–∫—É
    const p = currentParams();
    if (p.zone && p.compId && p.token){
      const ok = writeBind({
        zone: p.zone,
        compId: p.compId,
        stageId: p.stageId || "",
        token: p.token,
        savedAt: Date.now()
      });
      if (ok){
        setMsg("‚úÖ –ó–æ–Ω–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–∞. –¢–µ–ø–µ—Ä –º–æ–∂–Ω–∞ –ø—Ä–æ—Å—Ç–æ –≤—ñ–¥–∫—Ä–∏–≤–∞—Ç–∏ —Ü—é —Å—Ç–æ—Ä—ñ–Ω–∫—É ‚Äî –≤–æ–Ω–∞ –ø–∞–º‚Äô—è—Ç–∞—î.", true);
        history.replaceState({}, "", location.pathname); // —á–∏—Å—Ç–∏–π URL
      }else{
        setMsg("‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ (–±—Ä–∞—É–∑–µ—Ä –±–ª–æ–∫—É—î —Å—Ö–æ–≤–∏—â–µ).", false);
      }
    }

    // 2) Auth + —Ä–æ–ª—å
    auth.onAuthStateChanged(async (user)=>{
      if(!user){
        authPill.textContent = "auth: ‚ùå (–Ω–µ —É–≤—ñ–π—à–æ–≤)";
        statusEl.textContent = "–ü–æ—Ç—Ä—ñ–±–µ–Ω –≤—Ö—ñ–¥ —Å—É–¥–¥—ñ/–∞–¥–º—ñ–Ω–∞ (auth.html)";
        setMsg("–£–≤—ñ–π–¥–∏ –ø—ñ–¥ —Å—É–¥–¥–µ—é –∞–±–æ –∞–¥–º—ñ–Ω–æ–º.", false);
        renderState();
        return;
      }

      authPill.textContent = "auth: ‚úÖ " + (user.email || user.uid);

      try{
        const ok = await requireJudgeOrAdmin(user);
        if(!ok){
          statusEl.textContent = "–ù–µ–º–∞ –¥–æ—Å—Ç—É–ø—É ‚ùå";
          setMsg("–¶–µ–π –∞–∫–∞—É–Ω—Ç –Ω–µ —Å—É–¥–¥—è —ñ –Ω–µ –∞–¥–º—ñ–Ω.", false);
          renderState();
          return;
        }

        statusEl.textContent = "‚úÖ –î–æ—Å—Ç—É–ø —Å—É–¥–¥—ñ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ.";
        setMsg("", true);
        renderState();
      }catch(err){
        console.error(err);
        statusEl.textContent = "–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø—É ‚ùå";
        setMsg("–ü–µ—Ä–µ–≤—ñ—Ä roles/users –∞–±–æ –ø—Ä–∞–≤–∏–ª–∞ Firestore.", false);
        renderState();
      }
    });

    // 3) –ö–Ω–æ–ø–∫–∏
    btnOpen.onclick = ()=>{
      const bind = readBind();
      if (!bind) return setMsg("–ù–µ–º–∞ –ø—Ä–∏–≤‚Äô—è–∑–∫–∏. –°–ø–æ—á–∞—Ç–∫—É –≤—ñ–¥–∫—Ä–∏–π QR/–ª—ñ–Ω–∫ –≤—ñ–¥ –∞–¥–º—ñ–Ω–∞.", false);

      // –ü–æ–∫–∏ —Ü–µ ‚Äú–≤—ñ–¥–∫—Ä–∏—Ç–∏ –º–æ—é –∑–æ–Ω—É‚Äù (–Ω–∞—Å—Ç—É–ø–Ω–∏–π –∫—Ä–æ–∫ ‚Äî —Ä–µ–∞–ª—å–Ω–∏–π –µ–∫—Ä–∞–Ω weighings)
      const url = buildUrlFromBind(bind);
      setMsg("‚úÖ –í—ñ–¥–∫—Ä–∏–≤–∞—é —Ç–≤–æ—é –∑–æ–Ω—É‚Ä¶", true);
      location.href = url;
    };

    btnReset.onclick = ()=>{
      if (!confirm("–°–∫–∏–Ω—É—Ç–∏ –ø—Ä–∏–≤‚Äô—è–∑–∫—É –∑–æ–Ω–∏ –Ω–∞ —Ü—å–æ–º—É —Ç–µ–ª–µ—Ñ–æ–Ω—ñ?")) return;
      clearBind();
      renderState();
      setMsg("‚úÖ –ü—Ä–∏–≤‚Äô—è–∑–∫—É —Å–∫–∏–Ω—É—Ç–æ. –¢–µ–ø–µ—Ä —Ç—Ä–µ–±–∞ –∑–Ω–æ–≤ 1 —Ä–∞–∑ –∑–∞–π—Ç–∏ –ø–æ QR/–ª—ñ–Ω–∫—É.", true);
    };

    btnSaveHint.onclick = ()=>{
      setMsg("üìå Chrome: ‚ãÆ ‚Üí ‚Äú–î–æ–¥–∞—Ç–∏ –Ω–∞ –≥–æ–ª–æ–≤–Ω–∏–π –µ–∫—Ä–∞–Ω‚Äù. –¢–æ–¥—ñ –∑–æ–Ω–∞ –≤—ñ–¥–∫—Ä–∏–≤–∞—î—Ç—å—Å—è –æ–¥–Ω–∏–º —Ç–∞–ø–æ–º.", true);
    };
  }

  boot();

})();
</script>

</body>
</html>
