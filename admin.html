<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>STOLAR CARP • Адмінка</title>

  <link rel="stylesheet" href="assets/css/main.css">

  <style>
    body{ background: radial-gradient(circle at top,#111827 0,#020617 55%); }
    .admin-wrap{ max-width:980px; margin:0 auto; padding:22px 0 70px; }

    .admin-top{
      padding:14px 16px; border-radius:18px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.35);
      box-shadow:0 18px 40px rgba(0,0,0,.6);
    }
    .muted{ color:#9ca3af; }
    .admin-hidden{ display:none; }

    .admin-card{
      margin-top:14px;
      padding:16px;
      border-radius:18px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.35);
      box-shadow:0 18px 40px rgba(0,0,0,.6);
    }

    .stack{ display:flex; flex-direction:column; gap:10px; }
    .stack .btn{ width:100%; justify-content:center; padding:12px 14px; border-radius:14px; }

    .mini-form{
      margin-top:12px;
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    .mini-form input, .mini-form select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,.35);
      background:rgba(2,6,23,.55);
      color:#e5e7eb;
      outline:none;
    }
    .mini-form input::placeholder{ color:#6b7280; }

    .hr{ height:1px; background:rgba(148,163,184,.18); margin:12px 0; border-radius:99px; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .row > *{ flex:1; min-width:220px; }

    .pill{
      display:inline-flex; gap:8px; align-items:center;
      border:1px solid rgba(148,163,184,.35);
      padding:6px 10px; border-radius:999px;
      background:rgba(2,6,23,.35);
      font-size:.82rem;
      color:#e5e7eb;
    }

    .stage-box{
      border:1px solid rgba(148,163,184,.25);
      border-radius:14px;
      padding:12px;
      background:rgba(2,6,23,.25);
      margin-top:10px;
    }

    .stage-title{
      font-weight:700;
      letter-spacing:.06em;
      text-transform:uppercase;
      font-size:.9rem;
      margin-bottom:8px;
    }

    .stage-grid{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }

    .hint{ font-size:.82rem; color:#9ca3af; margin-top:6px; }
    .ok{ color:#22c55e; }
    .err{ color:#ef4444; }
  </style>
</head>

<body>

<header class="header">
  <div class="container header__row">
    <a class="logo" href="index.html">
      <span class="logo__mark">SC</span>
      <span class="logo__text">STOLAR CARP</span>
    </a>
    <nav class="nav">
      <a href="/index.html" class="nav__link">Головна</a>
      <a href="/live.html" class="nav__link">Live</a>
      <a href="/rating.html" class="nav__link">Рейтинг</a>
      <a href="/cabinet.html" class="nav__link">Мій кабінет</a>
    </nav>
  </div>
</header>

<main class="main">
  <section class="section container admin-wrap">

    <div class="admin-top">
      <div class="title-gradient" style="font-size:1.2rem; font-weight:800;">Адмінка STOLAR CARP</div>
      <div class="muted" id="adminStatus">Запуск…</div>
      <div class="hint" id="adminHint"></div>
    </div>

    <!-- LOGIN -->
    <div id="adminLogin" class="admin-card admin-hidden">
      <h2 class="section-title" style="margin:0 0 10px;">Вхід адміністратора</h2>
      <div class="muted">Увійди email/паролем адмін-акаунта. Реєстрації тут немає.</div>

      <div class="row" style="margin-top:12px;">
        <input id="admEmail" type="email" placeholder="Email">
        <input id="admPass" type="password" placeholder="Пароль">
        <button class="btn btn--accent" id="btnAdminLogin">Увійти</button>
      </div>

      <div class="muted" id="adminLoginMsg" style="margin-top:10px;"></div>
    </div>

    <!-- APP -->
    <div id="adminApp" class="admin-hidden">

      <!-- QUICK NAV -->
      <div class="admin-card">
        <h2 class="section-title" style="margin:0 0 8px;">Швидкі переходи</h2>
        <div class="muted">Тут не блокуємо нічого по логіці — це лише сторінки адмінки.</div>
        <div class="hr"></div>
        <div class="stack">
          <button class="btn btn--primary" id="btnOpenCreate">1) Створити змагання</button>
          <button class="btn btn--accent"  id="btnOpenActive">2) Зробити активним</button>

          <a class="btn btn--primary" href="admin-registrations.html">3) Реєстрація команд</a>
          <a class="btn btn--accent"  href="admin-draw.html">4) Жеребкування</a>
          <a class="btn btn--danger"  href="admin-weigh.html">5) Зважування (судді/адмін)</a>
        </div>

        <div class="hint">AUTO реєстрація працює по датах (12:00). MANUAL — зробимо окремо в наступному кроці.</div>
      </div>

      <!-- CREATE COMPETITION -->
      <div class="admin-card admin-hidden" id="modCreate">
        <h2 class="section-title" style="margin:0 0 8px;">Створити змагання</h2>
        <div class="muted">Пише в <b>competitions</b> і підколекцію <b>competitions/{id}/stages</b>.</div>

        <div class="mini-form" style="margin-top:12px;">
          <select id="inpType">
            <option value="season">Тип: СЕЗОН (з етапами + фінал опційно)</option>
            <option value="single">Тип: ОДНОРАЗОВЕ змагання</option>
          </select>

          <input id="inpYear" placeholder="Рік (наприклад: 2026)" inputmode="numeric">

          <input id="inpBrand" placeholder="Бренд/серія (STOLAR CARP)" disabled>

          <input id="inpName" placeholder="Назва змагання (наприклад: Season STOLAR CARP 2026 / Осінній Короп)">

          <select id="inpStagesCount">
            <option value="2">К-сть етапів у сезоні: 2</option>
            <option value="3" selected>К-сть етапів у сезоні: 3</option>
            <option value="4">К-сть етапів у сезоні: 4</option>
            <option value="5">К-сть етапів у сезоні: 5</option>
            <option value="6">К-сть етапів у сезоні: 6</option>
            <option value="7">К-сть етапів у сезоні: 7</option>
            <option value="8">К-сть етапів у сезоні: 8</option>
          </select>

          <select id="inpHasFinal">
            <option value="yes" selected>Фінал: ТАК</option>
            <option value="no">Фінал: НІ</option>
          </select>
        </div>

        <div class="hr"></div>

        <div class="muted">
          Реєстрація по даті (час автоматично = <b>12:00</b> Київ).
          Для сезону — задаємо окремо для кожного етапу (+ для фіналу, якщо ТАК).
        </div>

        <div id="stagesWrap"></div>

        <div class="stack" style="margin-top:12px;">
          <button class="btn btn--accent" id="btnDoCreate">Зберегти змагання</button>
        </div>

        <div class="muted" id="createMsg" style="margin-top:10px;"></div>
      </div>

      <!-- SET ACTIVE -->
      <div class="admin-card admin-hidden" id="modActive">
        <h2 class="section-title" style="margin:0 0 8px;">Зробити змагання активним</h2>
        <div class="muted">Оновлює <b>settings/app</b>: activeCompetitionId (+ базові поля).</div>

        <div class="mini-form" style="margin-top:12px;">
          <select id="selCompetition"></select>
          <button class="btn btn--accent" id="btnSetActive">Зробити активним</button>
        </div>

        <div class="muted" id="activeMsg" style="margin-top:10px;"></div>
      </div>

    </div>

  </section>
</main>

<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<!-- Єдиний init -->
<script src="assets/js/firebase-init.js"></script>

<script>
  const ADMIN_UID = "5Dt6fN64c3aWACYV1WacxV2BHDl2";
  const BRAND_DEFAULT = "STOLAR CARP";

  const $ = (id)=>document.getElementById(id);
  const show = (el)=>el && el.classList.remove("admin-hidden");
  const hide = (el)=>el && el.classList.add("admin-hidden");

  const setStatus = (t)=>{ const e=$("adminStatus"); if(e) e.textContent=t; };
  const setHint = (t)=>{ const e=$("adminHint"); if(e) e.textContent=t||""; };

  const modCreate = $("modCreate");
  const modActive = $("modActive");

  function openModule(name){
    hide(modCreate); hide(modActive);
    if(name==="create") show(modCreate);
    if(name==="active") show(modActive);
  }

  function slugify(s){
    return String(s||"")
      .trim().toLowerCase()
      .replace(/['"]/g,"")
      .replace(/[^a-z0-9\u0400-\u04FF]+/gi,"-")
      .replace(/^-+|-+$/g,"")
      .slice(0,60) || "event";
  }

  // дата YYYY-MM-DD -> Date(локально) з часом 12:00
  function date12(dateStr){
    const v = (dateStr||"").trim();
    if(!v) return null;
    const m = v.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(!m) return null;
    const Y=+m[1], Mo=+m[2]-1, D=+m[3];
    return new Date(Y,Mo,D,12,0,0,0);
  }
  function toTS(d){
    return d ? window.firebase.firestore.Timestamp.fromDate(d) : null;
  }

  async function waitForFirebase(){
    for(let i=0;i<200;i++){
      if(window.scAuth && window.scDb) return;
      await new Promise(r=>setTimeout(r,80));
    }
    throw new Error("Firebase не ініціалізувався. Перевір шлях assets/js/firebase-init.js і консоль.");
  }

  function buildStagesUI(){
    const type = $("inpType").value;
    const count = parseInt($("inpStagesCount").value,10) || 3;
    const hasFinal = $("inpHasFinal").value === "yes";
    const wrap = $("stagesWrap");
    wrap.innerHTML = "";

    // single — тільки одна пара дат (open/close)
    if(type === "single"){
      wrap.innerHTML = `
        <div class="stage-box">
          <div class="stage-title">Реєстрація на змагання</div>
          <div class="stage-grid">
            <input id="singleOpen" placeholder="Відкриття (YYYY-MM-DD)">
            <input id="singleClose" placeholder="Закриття (YYYY-MM-DD)">
          </div>
          <div class="hint">Час проставиться автоматично 12:00.</div>
        </div>
      `;
      return;
    }

    // season — етапи 1..N
    for(let i=1;i<=count;i++){
      const sid = `stage-${i}`;
      wrap.insertAdjacentHTML("beforeend", `
        <div class="stage-box">
          <div class="stage-title">Етап ${i} • Реєстрація</div>
          <div class="stage-grid">
            <input id="${sid}-open"  placeholder="Відкриття (YYYY-MM-DD)">
            <input id="${sid}-close" placeholder="Закриття (YYYY-MM-DD)">
          </div>
          <div class="hint">Час проставиться автоматично 12:00.</div>
        </div>
      `);
    }

    if(hasFinal){
      wrap.insertAdjacentHTML("beforeend", `
        <div class="stage-box">
          <div class="stage-title">Фінал • Реєстрація</div>
          <div class="stage-grid">
            <input id="final-open"  placeholder="Відкриття (YYYY-MM-DD)">
            <input id="final-close" placeholder="Закриття (YYYY-MM-DD)">
          </div>
          <div class="hint">Час проставиться автоматично 12:00.</div>
        </div>
      `);
    }
  }

  async function init(){
    setHint("Перевіряю Firebase…");
    await waitForFirebase();

    const auth = window.scAuth;
    const db   = window.scDb;

    setHint("");

    const loginBox = $("adminLogin");
    const appBox   = $("adminApp");
    const btnLogin = $("btnAdminLogin");
    const msg      = $("adminLoginMsg");

    function showLogin(text){
      hide(appBox); show(loginBox);
      if(msg) msg.textContent = text || "";
    }
    function showApp(){
      hide(loginBox); show(appBox);
    }

    $("btnOpenCreate").onclick = ()=>openModule("create");
    $("btnOpenActive").onclick = async ()=>{ openModule("active"); await loadCompetitions(); };

    if(btnLogin){
      btnLogin.onclick = async () => {
        const email = $("admEmail").value.trim();
        const pass  = $("admPass").value.trim();
        if(!email || !pass){ msg.textContent = "Введи email і пароль"; return; }
        msg.textContent = "Вхід…";
        try{ await auth.signInWithEmailAndPassword(email, pass); }
        catch(e){ msg.textContent = e?.message || "Помилка входу"; }
      };
    }

    // defaults
    $("inpBrand").value = BRAND_DEFAULT;

    $("inpType").addEventListener("change", ()=>{
      const isSeason = $("inpType").value === "season";
      $("inpStagesCount").disabled = !isSeason;
      $("inpHasFinal").disabled = !isSeason;
      buildStagesUI();
    });

    $("inpStagesCount").addEventListener("change", buildStagesUI);
    $("inpHasFinal").addEventListener("change", buildStagesUI);

    buildStagesUI();

    auth.onAuthStateChanged(async (user) => {
      if(!user){
        setStatus("Потрібен вхід (адмін)");
        showLogin("Увійди як адміністратор");
        return;
      }
      if(user.uid !== ADMIN_UID){
        setStatus("Доступ заборонено ❌");
        showLogin("Цей акаунт не має доступу");
        return;
      }

      setStatus("Адмін-доступ дозволено ✅");
      showApp();
      openModule("create");
      await loadCompetitions();
    });

    // SAVE
    $("btnDoCreate").onclick = async ()=>{
      const type = $("inpType").value; // season|single
      const year = $("inpYear").value.trim();
      const brand = BRAND_DEFAULT; // авто
      const name = $("inpName").value.trim();

      if(!/^\d{4}$/.test(year)){
        $("createMsg").innerHTML = `<span class="err">Вкажи рік (4 цифри), наприклад 2026.</span>`;
        return;
      }
      if(!name){
        $("createMsg").innerHTML = `<span class="err">Вкажи назву змагання.</span>`;
        return;
      }

      $("createMsg").textContent = "Збереження…";

      try{
        let competitionId = "";
        let stagesCount = 0;
        let hasFinal = false;

        if(type === "season"){
          stagesCount = parseInt($("inpStagesCount").value,10) || 3;
          hasFinal = $("inpHasFinal").value === "yes";
          competitionId = `season-${year}`;
        }else{
          competitionId = `event-${year}-${slugify(name)}`;
        }

        // сформувати stages
        const stages = [];
        const stagesToWrite = [];

        if(type === "single"){
          const openD = date12($("singleOpen")?.value);
          const closeD = date12($("singleClose")?.value);
          stages.push({
            stageId: "main",
            name: "Основний старт",
            regOpenDate: ($("singleOpen")?.value || "").trim() || null,
            regCloseDate: ($("singleClose")?.value || "").trim() || null,
            regOpenAt: openD ? toTS(openD) : null,
            regCloseAt: closeD ? toTS(closeD) : null
          });
        }else{
          for(let i=1;i<=stagesCount;i++){
            const sid = `stage-${i}`;
            const openStr  = ($(`${sid}-open`)?.value || "").trim();
            const closeStr = ($(`${sid}-close`)?.value || "").trim();
            const openD = date12(openStr);
            const closeD = date12(closeStr);
            stages.push({
              stageId: sid,
              name: `Етап ${i}`,
              regOpenDate: openStr || null,
              regCloseDate: closeStr || null,
              regOpenAt: openD ? toTS(openD) : null,
              regCloseAt: closeD ? toTS(closeD) : null
            });
          }
          if(hasFinal){
            const openStr  = ($("final-open")?.value || "").trim();
            const closeStr = ($("final-close")?.value || "").trim();
            const openD = date12(openStr);
            const closeD = date12(closeStr);
            stages.push({
              stageId: "final",
              name: "Фінал",
              isFinal: true,
              regOpenDate: openStr || null,
              regCloseDate: closeStr || null,
              regOpenAt: openD ? toTS(openD) : null,
              regCloseAt: closeD ? toTS(closeD) : null
            });
          }
        }

        // головний док
        const compRef = db.collection("competitions").doc(competitionId);
        await compRef.set({
          competitionId,
          type,                 // season|single
          brand,                // STOLAR CARP
          year: Number(year),
          name,
          stagesCount: type==="season" ? stagesCount : 1,
          hasFinal: type==="season" ? !!hasFinal : false,
          createdAt: window.firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: window.firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });

        // stages subcollection
        for(const st of stages){
          const stageRef = compRef.collection("stages").doc(st.stageId);
          await stageRef.set({
            ...st,
            competitionId,
            type,
            updatedAt: window.firebase.firestore.FieldValue.serverTimestamp(),
            createdAt: window.firebase.firestore.FieldValue.serverTimestamp()
          }, { merge:true });
        }

        $("createMsg").innerHTML = `<span class="ok">✅ Збережено: ${competitionId}</span>`;
        await loadCompetitions(competitionId);
      }catch(e){
        console.error(e);
        $("createMsg").innerHTML = `<span class="err">❌ Помилка: ${e?.message || e}</span>`;
      }
    };

    // SET ACTIVE
    $("btnSetActive").onclick = async ()=>{
      const v = $("selCompetition").value || "";
      if(!v){
        $("activeMsg").innerHTML = `<span class="err">Нема вибраного змагання.</span>`;
        return;
      }
      $("activeMsg").textContent = "Оновлення settings/app…";
      try{
        const doc = await db.collection("competitions").doc(v).get();
        if(!doc.exists){
          $("activeMsg").innerHTML = `<span class="err">Не знайдено competition: ${v}</span>`;
          return;
        }
        const d = doc.data() || {};
        await db.collection("settings").doc("app").set({
          activeCompetitionId: v,
          activeType: d.type || null,
          activeYear: d.year || null,
          activeName: d.name || null,
          activeBrand: d.brand || BRAND_DEFAULT,
          updatedAt: window.firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });

        $("activeMsg").innerHTML = `<span class="ok">✅ Активне змагання: ${v}</span>`;
        await loadCompetitions(v);
      }catch(e){
        console.error(e);
        $("activeMsg").innerHTML = `<span class="err">❌ Помилка: ${e?.message || e}</span>`;
      }
    };

    async function loadCompetitions(selectId){
      const sel = $("selCompetition");
      if(!sel) return;

      sel.innerHTML = `<option value="">Завантаження…</option>`;
      $("activeMsg").textContent = "";

      const snap = await db.collection("competitions").get();
      if(snap.empty){
        sel.innerHTML = `<option value="">Нема змагань (спочатку створи).</option>`;
        return;
      }

      // хто активний
      let activeId = null;
      try{
        const s = await db.collection("settings").doc("app").get();
        if(s.exists) activeId = (s.data()||{}).activeCompetitionId || null;
      }catch(_){}

      const items = snap.docs.map(doc=>{
        const d = doc.data() || {};
        const id = doc.id;
        const label = `${id} • ${d.name || ""} • ${d.type || ""}`;
        return { id, label, year: d.year||0, type: d.type||"", name: d.name||"" };
      });

      items.sort((a,b)=>{
        if(b.year !== a.year) return b.year - a.year;
        return (a.label||"").localeCompare(b.label||"", "uk");
      });

      sel.innerHTML = items.map(x=>{
        const chosen = selectId ? (x.id===selectId) : (x.id===activeId);
        const mark = (x.id===activeId) ? "✅ " : "";
        return `<option value="${x.id}" ${chosen ? "selected":""}>${mark}${x.label}</option>`;
      }).join("");
    }
  }

  init().catch(err=>{
    console.error(err);
    setStatus("Помилка запуску ❌");
    setHint(err?.message || String(err));
    // показати логін на всяк випадок
    show($("adminLogin"));
  });
</script>

</body>
</html>
