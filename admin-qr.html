<script>
(function(){
  "use strict";

  // ====== CONFIG ======
  const ADMIN_UID = "5Dt6fN64c3aWACYV1WacxV2BHDl2";
  const MAX_WAIT_MS = 15000;

  const $ = (id)=>document.getElementById(id);

  // UI
  const msgEl     = $("msg");
  const authPill  = $("authPill");
  const subTitle  = $("subTitle");
  const tbody     = $("tbody");
  const countEl   = $("count");
  const totalsEl  = $("totals");

  const qInp       = $("q");
  const roleFilter = $("roleFilter");
  const limitSel   = $("limitSel");

  const btnLoad  = $("btnLoad");
  const btnClear = $("btnClear");

  // Firebase
  let auth = null;
  let db   = null;

  // State
  let activeUids = new Set();
  let usersCache = [];           // loaded users (limit)
  let isLoading  = false;        // lock load
  const rowLocks = new Set();    // lock per UID on save/delete

  // ====== helpers ======
  function setMsg(t, ok=true){
    if(!msgEl) return;
    msgEl.textContent = t || "";
    msgEl.className = "muted " + (t ? (ok ? "ok":"err") : "");
  }

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function norm(v){ return String(v ?? "").trim(); }

  function nowHHMM(){
    const d=new Date();
    return String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0");
  }

  function safeNumber(v, def){
    const n = Number(v);
    return Number.isFinite(n) ? n : def;
  }

  async function waitFirebase(){
    const t0 = Date.now();
    while(Date.now()-t0 < MAX_WAIT_MS){
      if(window.scAuth && window.scDb && window.firebase) return;
      await new Promise(r=>setTimeout(r,120));
    }
    throw new Error("Firebase init не підняв scAuth/scDb (перевір assets/js/firebase-init.js).");
  }

  async function requireAdmin(user){
    if(!user) return false;
    if(user.uid === ADMIN_UID) return true;

    try{
      const snap = await db.collection("users").doc(user.uid).get();
      const role = (snap.exists ? (snap.data()||{}).role : "") || "";
      return role === "admin";
    }catch(e){
      console.warn("requireAdmin error:", e);
      return false;
    }
  }

  // Обережний підрахунок (може бути важко, але ти просив totals)
  async function getTotalCountFallback(colName){
    let n = 0;
    const snap = await db.collection(colName).get();
    snap.forEach(()=>n++);
    return n;
  }

  async function loadActiveUidsFromRegistrations(limit = 5000){
    const set = new Set();
    try{
      let snap;
      try{
        snap = await db.collection("registrations").orderBy("createdAt","desc").limit(limit).get();
      }catch{
        snap = await db.collection("registrations").limit(limit).get();
      }
      snap.forEach(doc=>{
        const d = doc.data() || {};
        if (d.uid) set.add(String(d.uid));
      });
    }catch(err){
      console.warn("Не вдалося завантажити registrations:", err);
    }
    return set;
  }

  // ====== render ======
  function rowHtml(u){
    const uid      = esc(u.uid);
    const fullName = esc(u.fullName || "");
    const email    = esc(u.email || "");
    const phone    = esc(u.phone || "");
    const city     = esc(u.city || "");
    const role     = esc(u.role || "user");
    const teamId   = esc(u.teamId || "");

    const isActive = activeUids.has(u.uid);

    return `
      <tr data-uid="${uid}" class="${isActive ? "isActive" : ""}">
        <td>${isActive ? `<span class="activeDot"></span>` : ""}${uid}</td>
        <td><input class="mini" data-k="fullName" value="${fullName}" placeholder="Імʼя" /></td>
        <td><input class="mini" data-k="email" value="${email}" placeholder="Email" /></td>
        <td><input class="mini" data-k="phone" value="${phone}" placeholder="Телефон" /></td>
        <td><input class="mini" data-k="city" value="${city}" placeholder="Місто" /></td>
        <td>
          <select class="mini" data-k="role">
            <option value="user"  ${role==="user" ?"selected":""}>user</option>
            <option value="judge" ${role==="judge"?"selected":""}>judge</option>
            <option value="admin" ${role==="admin"?"selected":""}>admin</option>
          </select>
        </td>
        <td><input class="mini" data-k="teamId" value="${teamId}" placeholder="teamId" /></td>
        <td>
          <div class="btnRow" style="margin:0;">
            <button class="btn btn--accent" data-save type="button">Зберегти</button>
            <button class="btn btn--danger" data-del type="button">Видалити</button>
          </div>
        </td>
      </tr>
    `;
  }

  function collectRow(tr){
    const get = (k)=> tr.querySelector(`[data-k="${k}"]`)?.value ?? "";
    const role = norm(get("role")) || "user";
    return {
      fullName: norm(get("fullName")),
      email:    norm(get("email")),
      phone:    norm(get("phone")),
      city:     norm(get("city")),
      role,
      teamId:   norm(get("teamId")),
      updatedAt: window.firebase.firestore.FieldValue.serverTimestamp()
    };
  }

  function applyFiltersAndRender(){
    const q  = norm(qInp?.value || "").toLowerCase();
    const rf = norm(roleFilter?.value || "");

    const filtered = usersCache.filter(u=>{
      if(rf && (u.role||"user") !== rf) return false;
      if(!q) return true;
      const hay = `${u.uid} ${u.fullName} ${u.email} ${u.phone} ${u.city} ${u.role} ${u.teamId}`.toLowerCase();
      return hay.includes(q);
    });

    countEl.textContent = `Показано: ${filtered.length} (завантажено: ${usersCache.length})`;

    if(!filtered.length){
      tbody.innerHTML = `<tr><td colspan="8" class="muted">Нічого не знайдено.</td></tr>`;
      return;
    }

    tbody.innerHTML = filtered.map(rowHtml).join("");
  }

  // ====== data ops ======
  async function loadUsers(){
    if(isLoading) return;
    isLoading = true;

    const limit = safeNumber(limitSel?.value || 100, 100);

    tbody.innerHTML = `<tr><td colspan="8" class="muted">Завантаження…</td></tr>`;
    setMsg("Завантажую users…", true);

    try{
      // 1) активні uid (є участь)
      activeUids = await loadActiveUidsFromRegistrations(5000);

      // 2) totals (не валимо сторінку якщо важко)
      let totalUsers = "—";
      let totalRegs  = "—";
      try { totalUsers = await getTotalCountFallback("users"); } catch(e){ console.warn("count users fail", e); }
      try { totalRegs  = await getTotalCountFallback("registrations"); } catch(e){ console.warn("count regs fail", e); }

      // 3) users list
      let snap;
      try{
        snap = await db.collection("users").orderBy("createdAt","desc").limit(limit).get();
      }catch{
        snap = await db.collection("users").limit(limit).get();
      }

      const items = [];
      snap.forEach(doc=>{
        const d = doc.data()||{};
        items.push({
          uid: doc.id,
          fullName: d.fullName || "",
          email:    d.email || "",
          phone:    d.phone || "",
          city:     d.city || "",
          role:     d.role || "user",
          teamId:   d.teamId || ""
        });
      });

      usersCache = items;

      const activeLoaded = items.filter(x => activeUids.has(x.uid)).length;

      totalsEl.textContent =
        `Всього зареєстровано (users): ${totalUsers} • ` +
        `Активних (є участь): ${activeLoaded} • ` +
        `Всього участей (registrations): ${totalRegs}`;

      applyFiltersAndRender();
      setMsg(`Готово ✅ (${nowHHMM()})`, true);

    }catch(err){
      console.error(err);
      tbody.innerHTML = `<tr><td colspan="8" class="muted">Помилка завантаження.</td></tr>`;
      setMsg("❌ " + (err?.message || err), false);
    }finally{
      isLoading = false;
    }
  }

  async function saveUser(uid, data){
    await db.collection("users").doc(uid).set(data, { merge:true });
  }

  async function deleteUser(uid){
    await db.collection("users").doc(uid).delete();
  }

  function setRowButtonsDisabled(tr, disabled){
    tr.querySelectorAll("button").forEach(b=> b.disabled = !!disabled);
    tr.style.opacity = disabled ? ".75" : "";
    tr.style.pointerEvents = disabled ? "none" : "";
  }

  // ====== events ======
  function bindUI(){
    btnLoad.onclick = loadUsers;

    btnClear.onclick = ()=>{
      qInp.value = "";
      roleFilter.value = "";
      applyFiltersAndRender(); // не треба знову тягнути з Firestore
      setMsg("Очищено ✅", true);
      setTimeout(()=>setMsg("", true), 700);
    };

    roleFilter.onchange = applyFiltersAndRender;
    qInp.addEventListener("input", ()=>{
      // швидкий фільтр без Firestore
      applyFiltersAndRender();
    });
    limitSel.onchange = loadUsers;

    // Save/Delete delegated
    document.addEventListener("click", async (e)=>{
      const tr = e.target.closest("tr[data-uid]");
      if(!tr) return;

      const uid = tr.getAttribute("data-uid");
      const btnSave = e.target.closest("[data-save]");
      const btnDel  = e.target.closest("[data-del]");
      if(!btnSave && !btnDel) return;

      // анти-спам на рядок
      if(rowLocks.has(uid)) return;
      rowLocks.add(uid);
      setRowButtonsDisabled(tr, true);

      try{
        if(btnSave){
          const data = collectRow(tr);
          await saveUser(uid, data);

          // оновити кеш локально (щоб не робити reload)
          const i = usersCache.findIndex(x=>x.uid===uid);
          if(i>=0){
            usersCache[i] = { ...usersCache[i], ...data, updatedAt: undefined };
          }

          setMsg("Збережено ✅", true);
          setTimeout(()=>setMsg("", true), 900);
        }

        if(btnDel){
          const ok = confirm(
            `Видалити користувача з Firestore?\n\nUID: ${uid}\n\n` +
            `(Auth email/пароль з браузера НЕ видаляється)`
          );
          if(ok){
            await deleteUser(uid);

            // прибрати з кешу + з UI
            usersCache = usersCache.filter(x=>x.uid!==uid);
            tr.remove();
            applyFiltersAndRender();

            setMsg("Видалено ✅", true);
            setTimeout(()=>setMsg("", true), 900);
          }
        }
      }catch(err){
        console.error(err);
        setMsg("❌ Помилка (Rules/доступ/мережа).", false);
      }finally{
        rowLocks.delete(uid);
        setRowButtonsDisabled(tr, false);
      }
    });
  }

  // ====== boot ======
  async function boot(){
    try{
      await waitFirebase();
      auth = window.scAuth;
      db   = window.scDb;
    }catch(e){
      subTitle.textContent = "Firebase не запустився ❌";
      setMsg(e.message || "Firebase init error", false);
      return;
    }

    bindUI();

    auth.onAuthStateChanged(async (user)=>{
      if(!user){
        authPill.textContent = "auth: ❌ (не увійшов)";
        subTitle.textContent = "Потрібен вхід адміна";
        setMsg("Увійди як адмін (auth.html).", false);
        return;
      }

      authPill.textContent = "auth: ✅ " + (user.email || user.uid);

      const ok = await requireAdmin(user);
      if(!ok){
        subTitle.textContent = "Нема доступу ❌";
        setMsg("Цей акаунт не адмін.", false);
        return;
      }

      subTitle.textContent = "Тут можна редагувати/видаляти users у Firestore.";
      setMsg("", true);
      await loadUsers();
    });
  }

  boot();

})();
</script>
