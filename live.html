<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Live ‚Äî STOLAR CARP</title>
  <link rel="stylesheet" href="assets/css/main.css">
  <script defer src="assets/js/config.js"></script>
  <style>
    :root{
      --line: rgba(255,255,255,.10);
      --row: #16171c;
      --ok: #16a34a; --warn:#f59e0b; --err:#ef4444;
      --grad: linear-gradient(90deg,#f6c34c 0%, #cc6a2b 35%, #7a0f2b 100%);
    }
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:10px}
    .input{background:#111215;border:1px solid var(--line);color:#fff;border-radius:10px;padding:10px 12px;outline:none;min-width:260px}
    .btn, .btn-sm{
      padding:10px 14px;border-radius:10px;background:#1b1c20;border:1px solid var(--line);
      color:#fff;text-decoration:none;font-weight:600;cursor:pointer
    }
    .btn:hover,.btn-sm:hover{filter:brightness(1.08)}
    .btn-sm{padding:8px 12px}
    .seg{display:flex;gap:6px;background:#101114;border:1px solid var(--line);border-radius:12px;padding:4px}
    .seg button{background:transparent;border:0;color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer}
    .seg button.active{background:#1b1c20}
    .state{display:inline-flex;align-items:center;gap:8px}
    .dot{width:8px;height:8px;border-radius:999px;background:var(--warn)}
    .dot.ok{background:var(--ok)} .dot.err{background:var(--err)}
    .hint{opacity:.75}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:900px){ .grid-2{grid-template-columns:1fr} }
    .card{background:#14151a;border:1px solid var(--line);border-radius:16px;overflow:hidden;padding:16px}
    .card.live-wrap{padding:0}
    .title-gradient{background:var(--grad);-webkit-background-clip:text;background-clip:text;color:transparent}
    .section h2{margin:0 0 12px}
    .subhead{margin:16px 0 8px;font-weight:800}
    .zone-title{margin:22px 0 8px;font-weight:900;font-size:20px}
    .zone-title span{display:inline-block;padding:2px 10px;border-radius:999px;border:1px solid var(--line)}
    .pending{border:1px dashed var(--line)}
    /* tables */
    table.live{width:100%;border-collapse:separate;border-spacing:0}
    table.live thead th{position:sticky;top:0;background:#15161a;padding:12px;text-align:left;border-bottom:1px solid var(--line);user-select:none}
    table.live tbody td{background:#16171c;padding:10px 12px;border-bottom:1px solid var(--line);vertical-align:middle}
    table.live tbody tr:hover td{background:#1a1b21}
    .num{text-align:right;white-space:nowrap}
    .lead-row td{background:#182216}
    .foot td{background:#101114;font-weight:700;border-top:2px solid var(--line)}
    .pill{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px}
    .paid{background:#0e2b1b;border-color:#124d2e;color:#9ff0bf}
    .notpaid{opacity:.6}
    .mini{font-size:.95rem}
    .textarea{width:100%}
    .muted{opacity:.8}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media (max-width:900px){ .grid-3{grid-template-columns:1fr} }
    .kpi{background:#111215;border:1px solid var(--line);border-radius:14px;padding:14px}
    .kpi h4{margin:0 0 8px;font-size:14px;opacity:.85}
    .kpi b{font-size:22px}
  </style>
</head>
<body>
<header class="header">
  <div class="container header__row">
    <a class="logo" href="index.html">
      <span class="logo__mark">SC</span><span class="logo__text">STOLAR CARP</span>
    </a>
    <nav class="nav" id="nav">
      <a href="index.html" class="nav__link">–ì–æ–ª–æ–≤–Ω–∞</a>
      <a href="rules.html" class="nav__link">–†–µ–≥–ª–∞–º–µ–Ω—Ç</a>
      <a href="register.html" class="nav__link">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</a>
      <a href="live.html" class="nav__link nav__link--active">Live</a>
      <a href="rating.html" class="nav__link">–†–µ–π—Ç–∏–Ω–≥</a>
      <a href="lakes.html" class="nav__link">–í–æ–¥–æ–π–º–∏</a>
      <a href="sponsors.html" class="nav__link">–°–ø–æ–Ω—Å–æ—Ä–∏</a>
      <a href="events/turnir-2026.html" class="nav__link">–¢—É—Ä–Ω—ñ—Ä 2026</a>
    </nav>
    <button class="burger" id="burger"><span></span><span></span><span></span></button>
  </div>
</header>

<main class="main">
<section class="container section">
  <h2 class="title-gradient">Live-–ø—Ä–æ—Ç–æ–∫–æ–ª</h2>

  <!-- –í–µ—Ä—Ö–Ω—è –ø–∞–Ω–µ–ª—å –∫–µ—Ä—É–≤–∞–Ω–Ω—è -->
  <div class="toolbar">
    <div class="seg" id="zoneSeg">
      <button data-zone="ALL" class="active">–£—Å—ñ</button>
      <button data-zone="A">–ó–æ–Ω–∞ A</button>
      <button data-zone="B">–ó–æ–Ω–∞ B</button>
      <button data-zone="C">–ó–æ–Ω–∞ C</button>
    </div>
    <button id="exportCsv" class="btn-sm">–ï–∫—Å–ø–æ—Ä—Ç CSV</button>
    <span class="mini state"><span id="statusDot" class="dot"></span><span id="statusText">–ì–æ—Ç–æ–≤–æ –¥–æ —Ä–æ–±–æ—Ç–∏</span></span>
  </div>

  <div class="grid-2">
    <div class="card">
      <h3>–®–≤–∏–¥–∫–∞ –≤—Å—Ç–∞–≤–∫–∞</h3>
      <p class="form__hint">–í—Å—Ç–∞–≤ —ñ–∑ Google Sheets (—Ä–æ–∑–¥—ñ–ª—å–Ω–∏–∫–∏: <b>;</b>, <b>,</b> –∞–±–æ <b>—Ç–∞–±</b> ¬∑ –¥–µ—Å—è—Ç–∫–æ–≤—ñ: <b>,</b> –∞–±–æ <b>.</b>)</p>
      <textarea id="csv-paste" class="textarea" rows="6" placeholder="–ö–æ–º–∞–Ω–¥–∞;–ó–æ–Ω–∞;–°–µ–∫—Ç–æ—Ä;–ö-—Å—Ç—å;–í–∞–≥–∞;Big;BigD1;BigD2;PaidD1;PaidD2;PaidOverall"></textarea>
      <div class="cta-row" style="margin-top:8px">
        <button class="btn btn--primary" id="render-csv">–ü–æ–±—É–¥—É–≤–∞—Ç–∏ —Ç–∞–±–ª–∏—Ü—é</button>
        <button class="btn btn--ghost" id="clear">–û—á–∏—Å—Ç–∏—Ç–∏</button>
      </div>
    </div>

    <div class="card">
      <h3>–ê–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∑ –ø–æ—Å–∏–ª–∞–Ω–Ω—è</h3>
      <div class="toolbar" style="margin:0 0 6px">
        <input id="csv-url" class="input" placeholder="https://docs.google.com/.../export?format=csv">
        <button class="btn btn--ghost" id="fetch-csv">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–∞—Ä–∞–∑</button>
        <label class="mini"><input type="checkbox" id="auto-refresh"> –ê–≤—Ç–æ 60—Å</label>
      </div>
      <p class="form__hint">–ü—ñ–¥—ñ–π–¥—É—Ç—å ‚ÄúPublish to web ‚Üí CSV/TSV‚Äù –∞–±–æ Apps Script, —â–æ –≤—ñ–¥–¥–∞—î CSV/TSV. URL —ñ –∞–≤—Ç–æ–ø—É–ª –∑–∞–ø–∞–º‚Äô—è—Ç–æ–≤—É—é—Ç—å—Å—è.</p>
    </div>
  </div>

  <!-- –ë–ª–æ–∫ 1: –û—á—ñ–∫—É—é—Ç—å –∂–µ—Ä–µ–±–∫—É–≤–∞–Ω–Ω—è -->
  <div class="card pending" style="margin-top:18px">
    <h3 class="subhead">–ó–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω—ñ –∫–æ–º–∞–Ω–¥–∏ ‚Äî <span class="muted">–æ—á—ñ–∫—É—é—Ç—å –∂–µ—Ä–µ–±–∫—É–≤–∞–Ω–Ω—è</span></h3>
    <table class="live" id="tbl-pending">
      <thead>
        <tr>
          <th>–ö–æ–º–∞–Ω–¥–∞</th>
          <th>–°—Ç–∞—Ç—É—Å</th>
        </tr>
      </thead>
      <tbody id="pending-body"><tr><td colspan="2" class="muted">–ü–æ—Ä–æ–∂–Ω—å–æ</td></tr></tbody>
    </table>
  </div>

  <!-- –ë–ª–æ–∫ 2: –ó–æ–Ω–∏ A/B/C -->
  <div class="card live-wrap" style="margin-top:18px">
    <div style="padding:16px 16px 0"><div class="zone-title">–ó–æ–Ω–∞ <span>A</span></div></div>
    <table class="live">
      <thead>
        <tr>
          <th>–ö–æ–º–∞–Ω–¥–∞</th>
          <th class="num">–ö-—Å—Ç—å</th>
          <th class="num">–í–∞–≥–∞, –∫–≥</th>
          <th class="num">Big, –∫–≥</th>
          <th class="num">üí∞ –¢–æ—Ç–∞–ª</th>
          <th class="num">–ú—ñ—Å—Ü–µ</th>
        </tr>
      </thead>
      <tbody id="zoneA-body"></tbody>
      <tbody class="foot"><tr><td>–†–∞–∑–æ–º</td><td class="num" id="zoneA-cnt">0</td><td class="num" id="zoneA-kg">0.000</td><td class="num" id="zoneA-big">0.000</td><td></td><td></td></tr></tbody>
    </table>

    <div style="padding:16px 16px 0"><div class="zone-title">–ó–æ–Ω–∞ <span>B</span></div></div>
    <table class="live">
      <thead>
        <tr>
          <th>–ö–æ–º–∞–Ω–¥–∞</th>
          <th class="num">–ö-—Å—Ç—å</th>
          <th class="num">–í–∞–≥–∞, –∫–≥</th>
          <th class="num">Big, –∫–≥</th>
          <th class="num">üí∞ –¢–æ—Ç–∞–ª</th>
          <th class="num">–ú—ñ—Å—Ü–µ</th>
        </tr>
      </thead>
      <tbody id="zoneB-body"></tbody>
      <tbody class="foot"><tr><td>–†–∞–∑–æ–º</td><td class="num" id="zoneB-cnt">0</td><td class="num" id="zoneB-kg">0.000</td><td class="num" id="zoneB-big">0.000</td><td></td><td></td></tr></tbody>
    </table>

    <div style="padding:16px 16px 0"><div class="zone-title">–ó–æ–Ω–∞ <span>C</span></div></div>
    <table class="live">
      <thead>
        <tr>
          <th>–ö–æ–º–∞–Ω–¥–∞</th>
          <th class="num">–ö-—Å—Ç—å</th>
          <th class="num">–í–∞–≥–∞, –∫–≥</th>
          <th class="num">Big, –∫–≥</th>
          <th class="num">üí∞ –¢–æ—Ç–∞–ª</th>
          <th class="num">–ú—ñ—Å—Ü–µ</th>
        </tr>
      </thead>
      <tbody id="zoneC-body"></tbody>
      <tbody class="foot"><tr><td>–†–∞–∑–æ–º</td><td class="num" id="zoneC-cnt">0</td><td class="num" id="zoneC-kg">0.000</td><td class="num" id="zoneC-big">0.000</td><td></td><td></td></tr></tbody>
    </table>
  </div>

  <!-- –ë–ª–æ–∫ 3: –§—ñ–Ω–∞–Ω—Å–æ–≤–∏–π —Ç–æ—Ç–∞–ª -->
  <div class="card" style="margin-top:18px">
    <h3 class="subhead">–§—ñ–Ω–∞–Ω—Å–æ–≤–∏–π —Ç–æ—Ç–∞–ª</h3>
    <div class="grid-3">
      <div class="kpi">
        <h4>–ë—ñ–≥ 1 –¥–æ–±–∏ (–∑–≤–∞–∂. 1‚Äì2)</h4>
        <div><b id="totD1Team">‚Äî</b></div>
        <div class="muted">–í–∞–≥–∞: <b id="totD1Val">0.000</b> –∫–≥</div>
      </div>
      <div class="kpi">
        <h4>–ë—ñ–≥ 2 –¥–æ–±–∏ (–∑–≤–∞–∂. 3‚Äì4)</h4>
        <div><b id="totD2Team">‚Äî</b></div>
        <div class="muted">–í–∞–≥–∞: <b id="totD2Val">0.000</b> –∫–≥</div>
      </div>
      <div class="kpi">
        <h4>–ë—ñ–≥ –∑–º–∞–≥–∞–Ω—å</h4>
        <div><b id="totOverallTeam">‚Äî</b></div>
        <div class="muted">–í–∞–≥–∞: <b id="totOverallVal">0.000</b> –∫–≥</div>
      </div>
    </div>
    <p class="form__hint" style="margin-top:10px">
      –£ —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –±–µ—Ä—É—Ç—å—Å—è –ª–∏—à–µ –∫–æ–º–∞–Ω–¥–∏, –¥–µ <code>PaidD1 / PaidD2 / PaidOverall = 1</code>.
      –î–ª—è ‚Äú–ë—ñ–≥ 1 –¥–æ–±–∏‚Äù –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –∫–æ–ª–æ–Ω–∫–∞ <code>BigD1</code> (–Ω–∞–π–±—ñ–ª—å—à–∞ —Ä–∏–±–∞ –∑–∞ –∑–≤–∞–∂—É–≤–∞–Ω–Ω—è 1‚Äì2), –¥–ª—è ‚Äú–ë—ñ–≥ 2 –¥–æ–±–∏‚Äù ‚Äî <code>BigD2</code>.
    </p>
  </div>
</section>
</main>

<footer class="footer">
  <div class="container footer__row">
    <div>¬© 2025 STOLAR CARP ¬∑ –õ—å–≤—ñ–≤</div>
    <div class="footer__links">
      <a href="https://invite.viber.com/?g=8R04gUEhdVSnX6sr_DxGGGqAXTus0Ygh">Viber</a>
      <a href="https://youtube.com/@dk-stolarcarp?si=H-BUK2msCiKXdcA9">YouTube</a>
    </div>
  </div>
</footer>

<script>
/* ====== –£–¢–ò–õ–Ü–¢–ò ====== */
const toNum = v => {
  if (v == null) return 0;
  const s = String(v).trim().replace(/\s+/g,'').replace(',', '.');
  const x = parseFloat(s);
  return Number.isFinite(x) ? x : 0;
};
const kg = v => toNum(v).toFixed(3);
const yes = v => /^(1|y|yes|true|—Ç–∞–∫|ok)$/i.test(String(v||'').trim());

/* ====== –ü–ê–†–°–ï–† –∑ –∞–¥–∞–ø—Ç–∏–≤–Ω–∏–º–∏ —Ö–µ–¥–µ—Ä–∞–º–∏ ====== */
function parseCSV(text){
  const lines = String(text||'').replace(/\r/g,'').split('\n').filter(l=>l.trim().length);
  if (!lines.length) return [];
  const sniff = (line) => line.includes('\t') ? '\t' : (line.includes(';') ? ';' : ',');
  const sep = sniff(lines[0]);
  const rows = lines.map(l => l.split(sep).map(s => s.trim().replace(/^"(.*)"$/,'$1')));
  return rows;
}

function headerIndexMap(headerRow){
  const map = {};
  headerRow.forEach((h,i)=>{
    const k = String(h||'').toLowerCase().replace(/\s+/g,'').replace(/[,._-]/g,'');
    map[k] = i;
  });
  // –æ—á—ñ–∫—É–≤–∞–Ω—ñ –∫–ª—é—á—ñ -> –º–æ–∂–ª–∏–≤—ñ –≤–∞—Ä—ñ–∞–Ω—Ç–∏ –Ω–∞–∑–≤
  const want = {
    team: ['–∫–æ–º–∞–Ω–¥–∞','team'],
    zone: ['–∑–æ–Ω–∞','zone'],
    sector: ['—Å–µ–∫—Ç–æ—Ä','sector'],
    cnt: ['–∫—Å—Ç—å','–∫-—Å—Ç—å','–∫—ñ–ª—å–∫—ñ—Å—Ç—å','count','qty'],
    weight: ['–≤–∞–≥–∞','–≤–∞–≥–∞–∫–≥','weight','weightkg'],
    big: ['big','bigfish','bigkg','bigfish–∫–≥','–±—ñ–≥','–±—ñ–≥—Ñ—ñ—à'],
    bigd1: ['bigd1','bigday1','–±—ñ–≥–¥1'],
    bigd2: ['bigd2','bigday2','–±—ñ–≥–¥2'],
    paidd1: ['paidd1','paidday1','–æ–ø–ª–∞—Ç–∞–¥1'],
    paidd2: ['paidd2','paidday2','–æ–ø–ª–∞—Ç–∞–¥2'],
    paidoverall: ['paidoverall','paido','paidbig','–æ–ø–ª–∞—Ç–∞–±—ñ–≥','–æ–ø–ª–∞–±—ñ–≥','–æ–ø–ª–∞—Ç–∞–∑–º–∞–≥–∞–Ω—å']
  };
  const idx = {};
  for (const key in want){
    const match = want[key].find(alias => map.hasOwnProperty(alias));
    idx[key] = match ? map[match] : -1;
  }
  return idx;
}

function normalize(rows){
  if (!rows.length) return [];
  let header = rows[0].map(x=>String(x||'').toLowerCase());
  let data = rows;
  // —è–∫—â–æ –ø–µ—Ä—à–∏–π —Å—Ç–æ–≤–ø—á–∏–∫ –≤–∏–≥–ª—è–¥–∞—î —è–∫ "–∫–æ–º–∞–Ω–¥–∞" ‚Äî —Ü–µ —Ö–µ–¥–µ—Ä
  if (/–∫–æ–º–∞–Ω–¥–∞|team/i.test(rows[0][0]||'')) data = rows.slice(1);
  const idx = headerIndexMap(rows[0]);
  return data.map(r => ({
    team:   r[idx.team] ?? '',
    zone:   (r[idx.zone] ?? '').toString().trim().toUpperCase(),
    sector: r[idx.sector] ?? '',
    cnt:    toNum(r[idx.cnt]),
    weight: toNum(r[idx.weight]),
    big:    toNum(r[idx.big]),
    bigd1:  toNum(r[idx.bigd1]),
    bigd2:  toNum(r[idx.bigd2]),
    paidd1: yes(r[idx.paidd1]),
    paidd2: yes(r[idx.paidd2]),
    paido:  yes(r[idx.paidoverall]),
  })).filter(x => x.team);
}

/* ====== –°–¢–ê–ù ====== */
let items = [];
let zoneFilter = 'ALL';
let timer = null;

/* ====== –ï–õ–ï–ú–ï–ù–¢–ò ====== */
const txtArea = document.getElementById('csv-paste');
const renderBtn = document.getElementById('render-csv');
const clearBtn  = document.getElementById('clear');

const fetchBtn = document.getElementById('fetch-csv');
const urlInput = document.getElementById('csv-url');
const autoChk  = document.getElementById('auto-refresh');

const statusDot  = document.getElementById('statusDot');
const statusText = document.getElementById('statusText');

const pendingBody = document.getElementById('pending-body');

const zoneBodies = {
  A: document.getElementById('zoneA-body'),
  B: document.getElementById('zoneB-body'),
  C: document.getElementById('zoneC-body'),
};
const zoneFoot = {
  A: { cnt: document.getElementById('zoneA-cnt'), kg: document.getElementById('zoneA-kg'), big: document.getElementById('zoneA-big') },
  B: { cnt: document.getElementById('zoneB-cnt'), kg: document.getElementById('zoneB-kg'), big: document.getElementById('zoneB-big') },
  C: { cnt: document.getElementById('zoneC-cnt'), kg: document.getElementById('zoneC-kg'), big: document.getElementById('zoneC-big') },
};

const totD1Team = document.getElementById('totD1Team');
const totD1Val  = document.getElementById('totD1Val');
const totD2Team = document.getElementById('totD2Team');
const totD2Val  = document.getElementById('totD2Val');
const totOTeam  = document.getElementById('totOverallTeam');
const totOVal   = document.getElementById('totOverallVal');

/* ====== –†–ï–ù–î–ï–† ====== */
function render(){
  // 1) –û—á—ñ–∫—É—é—Ç—å –∂–µ—Ä–µ–±–∫—É–≤–∞–Ω–Ω—è (–Ω–µ–º–∞ –∑–æ–Ω–∏ –∞–±–æ —Å–µ–∫—Ç–æ—Ä–∞)
  const pending = items.filter(x => !x.zone || !x.sector);
  pendingBody.innerHTML = pending.length
    ? pending.map(x => `<tr><td>${x.team}</td><td class="muted">–û—á—ñ–∫—É—î –∂–µ—Ä–µ–±–∫—É–≤–∞–Ω–Ω—è</td></tr>`).join('')
    : `<tr><td colspan="2" class="muted">–ü–æ—Ä–æ–∂–Ω—å–æ</td></tr>`;

  // 2) –ó–æ–Ω–∏: –±–µ—Ä–µ–º–æ –ª–∏—à–µ –∑ –≤–∞–ª—ñ–¥–Ω–æ—é –∑–æ–Ω–æ—é (A/B/C)
  const zones = {A:[],B:[],C:[]};
  items.forEach(x=>{
    const z = (x.zone||'').toUpperCase();
    if (['A','B','C'].includes(z)) zones[z].push(x);
  });

  // –ø–æ –∫–æ–∂–Ω—ñ–π –∑–æ–Ω—ñ: —Å–æ—Ä—Ç—É—î–º–æ –∑–∞ –≤–∞–≥–æ—é (desc), –ø—Ä–∏–∑–Ω–∞—á–∞—î–º–æ –º—ñ—Å—Ü–µ
  for (const z of ['A','B','C']){
    const arr = zones[z]
      .filter(x => (zoneFilter==='ALL' ? true : x.zone===zoneFilter))
      .slice()
      .sort((a,b)=> b.weight - a.weight);
    // –º—ñ—Å—Ü–µ (1..n) –∑–∞ total weight; –ø—Ä–∏ —Ä—ñ–≤–Ω–æ—Å—Ç—ñ ‚Äî –æ–¥–Ω–∞–∫–æ–≤–µ –º—ñ—Å—Ü–µ
    let place = 0, lastW = null, lastPlace = 0;
    const rows = arr.map((x,i)=>{
      if (lastW===null || x.weight !== lastW){ place = i+1; lastPlace = place; lastW = x.weight; }
      const paid = (x.paidd1||x.paidd2||x.paido);
      return {
        html: `<tr class="${i===0?'lead-row':''}">
          <td>${x.team}${x.sector?` <span class="muted">(${x.sector})</span>`:''}</td>
          <td class="num">${x.cnt||0}</td>
          <td class="num">${kg(x.weight)}</td>
          <td class="num">${kg(x.big)}</td>
          <td class="num">${paid ? '<span class="pill paid">—Ç–∞–∫</span>' : '<span class="pill notpaid">‚Äî</span>'}</td>
          <td class="num"><b>${lastPlace}</b></td>
        </tr>`,
        cnt: x.cnt||0, w: x.weight||0, big: x.big||0
      };
    });
    zoneBodies[z].innerHTML = rows.map(r=>r.html).join('') || `<tr><td colspan="6" class="muted">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –∑–æ–Ω–∏ ${z}</td></tr>`;
    // –ø—ñ–¥—Å—É–º–∫–∏
    const totalCnt = rows.reduce((s,r)=>s+r.cnt,0);
    const totalW   = rows.reduce((s,r)=>s+r.w,0);
    const maxBig   = rows.reduce((m,r)=>Math.max(m,r.big),0);
    zoneFoot[z].cnt.textContent = totalCnt;
    zoneFoot[z].kg.textContent  = kg(totalW);
    zoneFoot[z].big.textContent = kg(maxBig);
  }

  // 3) –§—ñ–Ω–∞–Ω—Å–æ–≤–∏–π —Ç–æ—Ç–∞–ª
  const d1 = items.filter(x => x.paidd1).sort((a,b)=> b.bigd1 - a.bigd1)[0];
  const d2 = items.filter(x => x.paidd2).sort((a,b)=> b.bigd2 - a.bigd2)[0];
  const ov = items.filter(x => x.paido).sort((a,b)=> b.big - a.big)[0]; // ‚Äú–±—ñ–≥ –∑–º–∞–≥–∞–Ω—å‚Äù = –∑–∞–≥–∞–ª—å–Ω–∏–π Big

  totD1Team.textContent = d1 ? d1.team : '‚Äî';
  totD1Val.textContent  = kg(d1 ? d1.bigd1 : 0);
  totD2Team.textContent = d2 ? d2.team : '‚Äî';
  totD2Val.textContent  = kg(d2 ? d2.bigd2 : 0);
  totOTeam.textContent  = ov ? ov.team : '‚Äî';
  totOVal.textContent   = kg(ov ? ov.big : 0);
}

/* ====== –î–ñ–ï–†–ï–õ–ê –î–ê–ù–ò–• ====== */
function buildFromTextarea(){
  const rows = parseCSV(txtArea.value);
  items = normalize(rows);
  render();
  statusDot.classList.add('ok'); statusDot.classList.remove('err');
  statusText.textContent = '–û–Ω–æ–≤–ª–µ–Ω–æ –∑ –±—É—Ñ–µ—Ä–∞';
}

async function fetchAndRender(){
  const url = urlInput.value.trim();
  if (!url) return;
  try{
    statusDot.classList.remove('ok','err');
    statusText.textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶';
    const res = await fetch(url, { cache:'no-store' });
    if(!res.ok) throw new Error('HTTP '+res.status);
    const text = await res.text();
    const rows = parseCSV(text);
    items = normalize(rows);
    render();
    statusDot.classList.add('ok');
    statusText.textContent = '–û–Ω–æ–≤–ª–µ–Ω–æ: ' + new Date().toLocaleTimeString('uk-UA');
    localStorage.setItem('live_url', url);
  }catch(e){
    statusDot.classList.add('err');
    statusText.textContent = '–ü–æ–º–∏–ª–∫–∞: ' + e.message;
  }
}

/* ====== –ï–ö–°–ü–û–†–¢ ====== */
function exportCSV(){
  const header = ['–ö–æ–º–∞–Ω–¥–∞','–ó–æ–Ω–∞','–°–µ–∫—Ç–æ—Ä','–ö-—Å—Ç—å','–í–∞–≥–∞','Big','BigD1','BigD2','PaidD1','PaidD2','PaidOverall'];
  const rows = items.map(x => [
    x.team, x.zone, x.sector, x.cnt||0, kg(x.weight), kg(x.big), kg(x.bigd1), kg(x.bigd2),
    x.paidd1?1:0, x.paidd2?1:0, x.paido?1:0
  ]);
  const csv = [header, ...rows].map(r => r.map(c => {
    const s = String(c);
    return /[;,]/.test(s) ? `"${s}"` : s;
  }).join(';')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'stolarcarp-live.csv';
  a.click();
  URL.revokeObjectURL(a.href);
}

/* ====== –ü–û–î–Ü–á ====== */
document.getElementById('exportCsv').addEventListener('click', exportCSV);
document.getElementById('render-csv').addEventListener('click', buildFromTextarea);
document.getElementById('clear').addEventListener('click', ()=>{
  txtArea.value=''; items=[]; render(); statusText.textContent='–û—á–∏—â–µ–Ω–æ';
});
document.getElementById('fetch-csv').addEventListener('click', fetchAndRender);

const zoneSeg = document.getElementById('zoneSeg');
zoneSeg.addEventListener('click', e=>{
  if (e.target.tagName!=='BUTTON') return;
  zoneFilter = e.target.dataset.zone;
  zoneSeg.querySelectorAll('button').forEach(b=>b.classList.toggle('active', b===e.target));
  render();
});

const autoChk = document.getElementById('auto-refresh');
let timer = null;
autoChk.addEventListener('change', ()=>{
  localStorage.setItem('live_auto', autoChk.checked ? '1' : '0');
  if (autoChk.checked){
    fetchAndRender();
    timer = setInterval(fetchAndRender, 60000);
  } else if (timer){ clearInterval(timer); timer = null; }
});

/* ====== INIT ====== */
(function init(){
  const savedUrl = localStorage.getItem('live_url');
  if (savedUrl) urlInput.value = savedUrl;
  const savedAuto = localStorage.getItem('live_auto')==='1';
  autoChk.checked = savedAuto;
  if (savedUrl && savedAuto){ fetchAndRender(); timer = setInterval(fetchAndRender, 60000); }
})();
</script>
</body>
</html>
