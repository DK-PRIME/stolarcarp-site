<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>STOLAR CARP ‚Ä¢ –ê–¥–º—ñ–Ω–∫–∞</title>

  <link rel="stylesheet" href="assets/css/main.css">
  <script defer src="assets/js/config.js"></script>

  <style>
    body{ background: radial-gradient(circle at top,#111827 0,#020617 55%); }
    .admin-wrap{ max-width:1100px; margin:0 auto; padding:32px 0 70px; }
    .admin-top{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px; border-radius:18px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.35);
      box-shadow:0 18px 40px rgba(0,0,0,.6);
    }
    .admin-badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 12px; border-radius:999px;
      font-size:.85rem; color:#e5e7eb;
      border:1px solid rgba(148,163,184,.35);
      background:rgba(0,0,0,.35);
    }
    .admin-grid{
      margin-top:18px;
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    @media(min-width:900px){
      .admin-grid{ grid-template-columns: 1.2fr .8fr; }
    }
    .admin-card{
      padding:16px;
      border-radius:18px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.35);
      box-shadow:0 18px 40px rgba(0,0,0,.6);
    }
    .admin-card h2{ margin:0 0 10px; }
    .muted{ color:#9ca3af; }
    .admin-list{ display:flex; flex-direction:column; gap:10px; margin-top:12px; }
    .item{
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.25);
      background:rgba(2,6,23,.55);
    }
    .item-top{ display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap;}
    .pill{
      display:inline-flex; align-items:center;
      padding:4px 10px; border-radius:999px;
      font-size:.78rem;
      border:1px solid rgba(148,163,184,.35);
      color:#e5e7eb;
      background:rgba(0,0,0,.35);
    }
    .pill.ok{ border-color:rgba(34,197,94,.6); }
    .pill.warn{ border-color:rgba(250,204,21,.65); }
    .pill.bad{ border-color:rgba(239,68,68,.65); }
    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .row .btn{ padding:10px 14px; border-radius:12px; }
    .admin-hidden{ display:none; }
  </style>
</head>

<body>

<header class="header">
  <div class="container header__row">
    <a class="logo" href="index.html">
      <span class="logo__mark">SC</span>
      <span class="logo__text">STOLAR CARP</span>
    </a>
    <nav class="nav">
      <a href="/index.html" class="nav__link">–ì–æ–ª–æ–≤–Ω–∞</a>
      <a href="/live.html" class="nav__link">Live</a>
      <a href="/rating.html" class="nav__link">–†–µ–π—Ç–∏–Ω–≥</a>
      <a href="/cabinet.html" class="nav__link">–ú—ñ–π –∫–∞–±—ñ–Ω–µ—Ç</a>
    </nav>
  </div>
</header>

<main class="main">
  <section class="section container admin-wrap">

    <div class="admin-top">
      <div>
        <div class="title-gradient" style="font-size:1.2rem; font-weight:800;">–ê–¥–º—ñ–Ω–∫–∞ STOLAR CARP</div>
        <div class="muted" id="adminStatus">–ü–µ—Ä–µ–≤—ñ—Ä—è—é –¥–æ—Å—Ç—É–ø‚Ä¶</div>
      </div>
      <div class="admin-badge" id="adminBadge">üîí admin</div>
    </div>

    <div id="adminApp" class="admin-hidden">

      <!-- –ü–∞–Ω–µ–ª—å –∫–Ω–æ–ø–æ–∫ -->
      <div class="admin-card" style="margin-top:14px;">
        <h2 class="section-title" style="margin:0 0 10px;">–ö–µ—Ä—É–≤–∞–Ω–Ω—è</h2>
        <div class="row">
          <button class="btn btn--primary" id="btnCreateContest">1. –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–º–∞–≥–∞–Ω–Ω—è</button>
          <button class="btn btn--accent"  id="btnToggleContest">2. –í—ñ–¥–∫—Ä–∏—Ç–∏ / –∑–∞–∫—Ä–∏—Ç–∏</button>
          <button class="btn btn--primary" id="btnRegistrations">3. –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –∫–æ–º–∞–Ω–¥</button>
          <button class="btn btn--accent"  id="btnDraw">4. –ñ–µ—Ä–µ–±–∫—É–≤–∞–Ω–Ω—è</button>
          <button class="btn btn--danger"  id="btnWeigh">5. –ó–≤–∞–∂—É–≤–∞–Ω–Ω—è</button>
          <button class="btn btn--primary" id="btnUsers">6. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ —Å–∞–π—Ç—É</button>
        </div>
        <div class="muted" style="margin-top:10px;" id="adminHint">–û–±–µ—Ä–∏ –º–æ–¥—É–ª—å –∑–≤–µ—Ä—Ö—É.</div>
      </div>

      <div class="admin-grid">

        <!-- –õ–Ü–í–û: –ó–∞—è–≤–∫–∏ -->
        <div class="admin-card">
          <h2 class="section-title" style="margin:0 0 10px;">–ó–∞—è–≤–∫–∏ –Ω–∞ —É—á–∞—Å—Ç—å</h2>
          <div class="muted">–¢—É—Ç –ø–æ–∫–∞–∑—É—é—Ç—å—Å—è –∑–∞—è–≤–∫–∏ (registrations). –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –æ–ø–ª–∞—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω–µ —Ç—ñ–ª—å–∫–∏ –∞–¥–º—ñ–Ω—É.</div>

          <div class="row">
            <button class="btn btn--primary" id="btnLoadRegs">–û–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫</button>
          </div>

          <div class="admin-list" id="regsList"></div>
        </div>

        <!-- –ü–†–ê–í–û: –ó–∞–≥–ª—É—à–∫–∏ –º–æ–¥—É–ª—ñ–≤ -->
        <div style="display:flex; flex-direction:column; gap:14px;">
          <div class="admin-card">
            <h2 class="section-title" style="margin:0 0 10px;">–ñ–µ—Ä–µ–±–∫—É–≤–∞–Ω–Ω—è</h2>
            <div class="muted">–ú–æ–¥—É–ª—å –∂–µ—Ä–µ–±—É: –∑–æ–Ω–∞/—Å–µ–∫—Ç–æ—Ä –¥–ª—è –∫–æ–º–∞–Ω–¥–∏ (–ø—ñ–¥–∫–ª—é—á–∏–º–æ –Ω–∞—Å—Ç—É–ø–Ω–∏–º –∫—Ä–æ–∫–æ–º).</div>
            <div class="row">
              <button class="btn btn--accent" id="btnOpenDraw">–í—ñ–¥–∫—Ä–∏—Ç–∏ –º–æ–¥—É–ª—å –∂–µ—Ä–µ–±—É</button>
            </div>
          </div>

          <div class="admin-card">
            <h2 class="section-title" style="margin:0 0 10px;">–ó–≤–∞–∂—É–≤–∞–Ω–Ω—è</h2>
            <div class="muted">–ú–æ–¥—É–ª—å –∑–≤–∞–∂—É–≤–∞–Ω—å (1‚Äì4) —ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –∑–æ–Ω A/B/C (–ø—ñ–¥–∫–ª—é—á–∏–º–æ –Ω–∞—Å—Ç—É–ø–Ω–∏–º –∫—Ä–æ–∫–æ–º).</div>
            <div class="row">
              <button class="btn btn--danger" id="btnOpenWeigh">–í—ñ–¥–∫—Ä–∏—Ç–∏ –º–æ–¥—É–ª—å –∑–≤–∞–∂—É–≤–∞–Ω—å</button>
            </div>
          </div>
        </div>

      </div>
    </div>

  </section>
</main>

<script>
  // –ü–æ–∫–∞–∑—É—î–º–æ –±—É–¥—å-—è–∫—ñ JS –ø–æ–º–∏–ª–∫–∏ –ø—Ä—è–º–æ –Ω–∞ –µ–∫—Ä–∞–Ω—ñ
  window.addEventListener("error", (e) => {
    const el = document.getElementById("adminStatus");
    if (el) el.textContent = "–ü–æ–º–∏–ª–∫–∞ JS: " + (e.message || "unknown");
  });

  function setStatus(t){
    const el = document.getElementById("adminStatus");
    if (el) el.textContent = t;
  }

  function $id(id){ return document.getElementById(id); }
  function esc(s){ return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  async function waitForFirebase(){
    setStatus("Firebase: —à—É–∫–∞—é scAuth/scDb‚Ä¶");
    for (let i=0;i<120;i++){
      if (window.scAuth && window.scDb) {
        setStatus("Firebase: scAuth/scDb –∑–Ω–∞–π–¥–µ–Ω–æ ‚úÖ");
        return;
      }
      await new Promise(r => setTimeout(r, 100));
    }
    throw new Error("–ù–µ –∑‚Äô—è–≤–∏–ª–∏—Å—å scAuth/scDb (–ø–µ—Ä–µ–≤—ñ—Ä config.js —ñ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è firebase sdk)");
  }

  async function requireAdmin(){
    await waitForFirebase();

    const auth = window.scAuth;
    const db   = window.scDb;

    setStatus("Auth: —á–µ–∫–∞—é onAuthStateChanged‚Ä¶");

    const user = await new Promise(resolve => {
      const unsub = auth.onAuthStateChanged(u => {
        unsub();
        resolve(u);
      });
    });

    if (!user) {
      setStatus("Auth: —Ç–∏ –Ω–µ –∑–∞–ª–æ–≥—ñ–Ω–µ–Ω–∏–π ‚Üí –∫–∏–¥–∞—é –Ω–∞ /auth.html");
      location.href = "/auth.html";
      return;
    }

    setStatus("Auth: user OK ‚úÖ (uid: " + user.uid.slice(0,6) + "‚Ä¶)");

    setStatus("Role: —á–∏—Ç–∞—é users/" + user.uid.slice(0,6) + "‚Ä¶");

    const me = await db.collection("users").doc(user.uid).get();
    if (!me.exists) {
      setStatus("Role: –Ω–µ–º–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ users/{uid} (–ø—Ä–æ—Ñ—ñ–ª—å –Ω–µ —Å—Ç–≤–æ—Ä–∏–≤—Å—è) ‚ùå");
      location.href = "/";
      return;
    }

    const role = me.data().role || "user";
    setStatus("Role: " + role);

    if (role !== "admin") {
      setStatus("–î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ ‚ùå (role=" + role + ")");
      location.href = "/";
      return;
    }

    // ‚úÖ –î–û–°–¢–£–ü –î–û–ó–í–û–õ–ï–ù–û
    setStatus("–î–æ—Å—Ç—É–ø –¥–æ–∑–≤–æ–ª–µ–Ω–æ ‚úÖ");
    $id("adminApp").classList.remove("admin-hidden");

    // –ö–Ω–æ–ø–∫–∏ –∫–µ—Ä—É–≤–∞–Ω–Ω—è (—è–∫—â–æ –≤–æ–Ω–∏ —î –≤ HTML)
    const bind = (id, fn) => { const b = $id(id); if (b) b.addEventListener("click", fn); };

    bind("btnCreateContest", () => { $id("adminHint").textContent = "–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–º–∞–≥–∞–Ω–Ω—è ‚Äî –Ω–∞—Å—Ç—É–ø–Ω–∏–π –∫—Ä–æ–∫"; alert("–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–º–∞–≥–∞–Ω–Ω—è ‚Äî –Ω–∞—Å—Ç—É–ø–Ω–∏–π –∫—Ä–æ–∫"); });
    bind("btnToggleContest", () => { $id("adminHint").textContent = "–í—ñ–¥–∫—Ä–∏—Ç–∏/–∑–∞–∫—Ä–∏—Ç–∏ ‚Äî –Ω–∞—Å—Ç—É–ø–Ω–∏–π –∫—Ä–æ–∫"; alert("–í—ñ–¥–∫—Ä–∏—Ç–∏ / –∑–∞–∫—Ä–∏—Ç–∏ ‚Äî –Ω–∞—Å—Ç—É–ø–Ω–∏–π –∫—Ä–æ–∫"); });
    bind("btnRegistrations", () => { $id("adminHint").textContent = "–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –∫–æ–º–∞–Ω–¥ ‚Äî –ø–æ–∫–∞–∑—É—é –∑–∞—è–≤–∫–∏"; loadRegistrations(); });
    bind("btnDraw", () => { $id("adminHint").textContent = "–ñ–µ—Ä–µ–±–∫—É–≤–∞–Ω–Ω—è ‚Äî –Ω–∞—Å—Ç—É–ø–Ω–∏–π –∫—Ä–æ–∫"; alert("–ñ–µ—Ä–µ–±–∫—É–≤–∞–Ω–Ω—è ‚Äî –Ω–∞—Å—Ç—É–ø–Ω–∏–π –∫—Ä–æ–∫"); });
    bind("btnWeigh", () => { $id("adminHint").textContent = "–ó–≤–∞–∂—É–≤–∞–Ω–Ω—è ‚Äî –Ω–∞—Å—Ç—É–ø–Ω–∏–π –∫—Ä–æ–∫"; alert("–ó–≤–∞–∂—É–≤–∞–Ω–Ω—è ‚Äî –Ω–∞—Å—Ç—É–ø–Ω–∏–π –∫—Ä–æ–∫"); });
    bind("btnUsers", () => { $id("adminHint").textContent = "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ ‚Äî –Ω–∞—Å—Ç—É–ø–Ω–∏–π –∫—Ä–æ–∫"; alert("–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ ‚Äî –Ω–∞—Å—Ç—É–ø–Ω–∏–π –∫—Ä–æ–∫"); });

    bind("btnLoadRegs", () => loadRegistrations());
    bind("btnOpenDraw", () => alert("–ú–æ–¥—É–ª—å –∂–µ—Ä–µ–±–∫—É–≤–∞–Ω–Ω—è: –Ω–∞—Å—Ç—É–ø–Ω–∏–π –∫—Ä–æ–∫"));
    bind("btnOpenWeigh", () => alert("–ú–æ–¥—É–ª—å –∑–≤–∞–∂—É–≤–∞–Ω—å: –Ω–∞—Å—Ç—É–ø–Ω–∏–π –∫—Ä–æ–∫"));

    // –ê–≤—Ç–æ–ø–æ–∫–∞–∑ –∑–∞—è–≤–æ–∫ (—è–∫—â–æ –∫–æ–ª–µ–∫—Ü—ñ—è —î)
    loadRegistrations().catch(()=>{});
  }

  async function loadRegistrations(){
    const db = window.scDb;
    const box = $id("regsList");
    if (!box) return;

    box.innerHTML = '<div class="muted">–ó–∞–≤–∞–Ω—Ç–∞–∂—É—é‚Ä¶</div>';

    const snap = await db.collection("registrations")
      .orderBy("createdAt", "desc")
      .limit(25)
      .get();

    if (snap.empty){
      box.innerHTML = '<div class="muted">–ó–∞—è–≤–æ–∫ –ø–æ–∫–∏ –Ω–µ–º–∞—î.</div>';
      return;
    }

    const items = [];
    snap.forEach(doc => {
      const d = doc.data() || {};
      const teamName = d.teamName || d.team || d.name || "–ö–æ–º–∞–Ω–¥–∞";
      const stageId = d.stageId || d.stage || "‚Äî";
      const pay = d.paymentStatus || d.payStatus || "pending";
      const pillClass = pay === "paid" ? "ok" : (pay === "rejected" ? "bad" : "warn");

      items.push(`
        <div class="item">
          <div class="item-top">
            <div><b>${esc(teamName)}</b> <span class="muted">‚Ä¢ stage: ${esc(stageId)}</span></div>
            <span class="pill ${pillClass}">${esc(pay)}</span>
          </div>
          <div class="muted" style="margin-top:6px;">id: ${esc(doc.id)}</div>
        </div>
      `);
    });

    box.innerHTML = items.join("");
  }

  // —Å—Ç–∞—Ä—Ç
  requireAdmin().catch(err => {
    console.error(err);
    setStatus("–ü–æ–º–∏–ª–∫–∞: " + err.message);
  });
</script>

</body>
</html>
