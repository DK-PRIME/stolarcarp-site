<script>
(function(){
  "use strict";

  // =========================
  // STOLAR CARP ‚Ä¢ –°—É–¥–¥—è ‚Ä¢ –ó–≤–∞–∂—É–≤–∞–Ω–Ω—è (LIVE-—Å—É–º—ñ—Å–Ω–∏–π)
  // ‚úÖ bind —Ç—ñ–ª—å–∫–∏ –ø–æ ZONE (A/B/C)
  // ‚úÖ compId/stageId –±–µ—Ä—É—Ç—å—Å—è –∑ settings/app (activeCompetitionId/activeStageId/activeKey)
  // ‚úÖ –∫–æ–º–∞–Ω–¥–∏ –¥–ª—è –∑–æ–Ω–∏ ‚Äî –∑ registrations (confirmed) + drawZone/drawSector
  // ‚úÖ weighings –ø–∏—à–µ–º–æ —Ç–∞–∫, —è–∫ —á–∏—Ç–∞—î LIVE: compId, stageId, weighNo, teamId, weights:[...]
  // =========================

  const LS_KEY = "sc_judge_bind_v2"; // –Ω–æ–≤–∏–π –∫–ª—é—á, —â–æ–± –Ω–µ —Ç—è–≥–Ω—É—Ç–∏ —Å—Ç–∞—Ä—ñ bind –∑ compId/stageId
  const ADMIN_UID = "5Dt6fN64c3aWACYV1WacxV2BHDl2";
  const DEFAULT_MAX_W = 4;

  // UI
  const zoneTitle = document.getElementById("zoneTitle");
  const statusEl  = document.getElementById("status");
  const bindInfo  = document.getElementById("bindInfo");
  const msgEl     = document.getElementById("msg");
  const authPill  = document.getElementById("authPill");

  const btnOpen   = document.getElementById("btnOpen");
  const btnReset  = document.getElementById("btnReset");
  const btnSaveHint = document.getElementById("btnSaveHint");

  const weighCard = document.getElementById("weighCard");
  const wMsgEl = document.getElementById("wMsg");
  const curWEl = document.getElementById("curW");
  const teamsCountEl = document.getElementById("teamsCount");
  const teamsBox = document.getElementById("teamsBox");
  const netBadge = document.getElementById("netBadge");

  const wBtns = [
    { n:1, el: document.getElementById("w1") },
    { n:2, el: document.getElementById("w2") },
    { n:3, el: document.getElementById("w3") },
    { n:4, el: document.getElementById("w4") },
  ];

  // Firebase
  let db = null;
  let me = null;

  // ACTIVE (–∑ settings/app)
  let compId   = "";
  let stageId  = "";
  let activeKey = ""; // –∑–∞–∑–≤–∏—á–∞–π compId||stageId
  let stageLabel = ""; // –ø—Ä–æ—Å—Ç–æ –¥–ª—è bindInfo

  // bind
  let zone = ""; // A/B/C

  // weighing state
  let maxW = DEFAULT_MAX_W;
  let currentW = 1;
  let viewW = 1;

  // cache: { [teamId]: { [wNo]: weighingDoc|null } }
  const weighCache = Object.create(null);

  // -------------------------
  // helpers
  // -------------------------
  function setMsg(t, ok=true){
    msgEl.textContent = t || "";
    msgEl.className = "muted " + (t ? (ok ? "ok":"err") : "");
  }
  function setWMsg(t, ok=true){
    wMsgEl.textContent = t || "";
    wMsgEl.className = "muted " + (t ? (ok ? "ok":"err") : "");
  }
  function norm(v){ return String(v ?? "").trim(); }
  function esc(s){ return String(s ?? "").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

  async function waitFirebase(){
    for(let i=0;i<140;i++){
      if(window.scDb && window.scAuth && window.firebase) return;
      await new Promise(r=>setTimeout(r,100));
    }
    throw new Error("Firebase init –Ω–µ –ø—ñ–¥–Ω—è–≤ scAuth/scDb.");
  }

  async function requireJudgeOrAdmin(user){
    if(!user) return false;
    if(user.uid === ADMIN_UID) return true;
    const snap = await db.collection("users").doc(user.uid).get();
    const role = (snap.exists ? (snap.data()||{}).role : "") || "";
    return role === "judge" || role === "admin";
  }

  // -------------------------
  // bind (—Ç—ñ–ª—å–∫–∏ ZONE)
  // -------------------------
  function readBind(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      return raw ? JSON.parse(raw) : null;
    }catch{ return null; }
  }
  function writeBind(data){
    try{ localStorage.setItem(LS_KEY, JSON.stringify(data)); return true; }
    catch{ return false; }
  }
  function clearBind(){
    try{ localStorage.removeItem(LS_KEY); }catch{}
  }

  function currentParams(){
    const p = new URLSearchParams(location.search);
    const z = norm((p.get("zone")||"").toUpperCase());
    return { zone:z };
  }

  function makeActiveKey(compId, stageId){
    const c = norm(compId);
    const s = norm(stageId);
    if(!c) return "";
    return `${c}||${s || "stage-1"}`;
  }

  function renderBindState(){
    const bind = readBind();
    if (!bind || !bind.zone){
      zoneTitle.textContent = "–ó–æ–Ω–∞ ‚Äî";
      statusEl.textContent = "‚ùó –ù–µ–º–∞ –ø—Ä–∏–≤‚Äô—è–∑–∫–∏. –í—ñ–¥–∫—Ä–∏–π QR/–ª—ñ–Ω–∫ –≤—ñ–¥ –∞–¥–º—ñ–Ω–∞ –æ–¥–∏–Ω —Ä–∞–∑ (weigh_judge.html?zone=A).";
      bindInfo.textContent = "‚Äî";
      return;
    }

    zoneTitle.textContent = `–ó–æ–Ω–∞ ${bind.zone}`;

    const c = compId ? compId : "‚Äî";
    const s = stageId ? stageId : "‚Äî";
    const ak = activeKey ? activeKey : "‚Äî";

    statusEl.textContent = "‚úÖ –ü—Ä–∏–≤‚Äô—è–∑–∫–∞ –∑–æ–Ω–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–∞ –Ω–∞ —Ü—å–æ–º—É —Ç–µ–ª–µ—Ñ–æ–Ω—ñ.";
    bindInfo.textContent = `zone=${bind.zone} | active compId=${c} | active stageId=${s} | activeKey=${ak}${stageLabel ? " | " + stageLabel : ""}`;
  }

  // -------------------------
  // settings/app (–∞–∫—Ç–∏–≤–Ω–∏–π –µ—Ç–∞–ø)
  // -------------------------
  function readActiveFromApp(app){
    const comp =
      app?.activeCompetitionId ||
      app?.activeCompetition ||
      app?.competitionId ||
      "";

    const stage =
      app?.activeStageId ||
      app?.stageId ||
      "";

    compId  = String(comp || "").trim();
    stageId = String(stage || "").trim();

    // —è–∫—â–æ —É –≤–∞—Å –¥–ª—è –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–∏—Ö —Ç–µ–∂ stage-1 ‚Äî —Ü–µ –æ–∫.
    if(!stageId) stageId = "stage-1";

    // activeKey –≤—ñ–¥ –∂–µ—Ä–µ–±–∫—É–≤–∞–Ω–Ω—è (–ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç)
    const ak = String(app?.activeKey || "").trim();
    activeKey = ak || makeActiveKey(compId, stageId);

    // —á–∏—Å—Ç–æ –¥–ª—è —ñ–Ω—Ñ–æ
    stageLabel = "";
    if (app?.activeKey) stageLabel = `settings/app.activeKey=${app.activeKey}`;
  }

  let unsubApp = null;

  function startAppSub(){
    if(unsubApp) unsubApp();

    unsubApp = db.collection("settings").doc("app").onSnapshot(async (snap)=>{
      const app = snap.exists ? (snap.data()||{}) : {};
      readActiveFromApp(app);

      renderBindState();

      // —è–∫—â–æ –≤–∂–µ –≤—ñ–¥–∫—Ä–∏—Ç–∞ –∑–æ–Ω–∞ ‚Äî –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ –ø—Ä–∏ –∑–º—ñ–Ω—ñ –µ—Ç–∞–ø—É
      const bind = readBind();
      if(bind?.zone && weighCard.style.display !== "none"){
        zone = String(bind.zone).toUpperCase();
        try{
          const s = await getOrCreateWeighingSettings();
          maxW = Number(s.data.maxW || DEFAULT_MAX_W);
          currentW = getCurrentWForZone(s.data);
          if(viewW > currentW) viewW = currentW;
          updateWButtons();

          const teams = await loadTeamsForZone();
          await renderTeams(teams);
          setWMsg(`–ê–∫—Ç–∏–≤–Ω–∏–π –µ—Ç–∞–ø –æ–Ω–æ–≤–ª–µ–Ω–æ ‚Üí ${compId} / ${stageId}.`, true);
        }catch(err){
          setWMsg("–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –µ—Ç–∞–ø—É: " + (err?.message || err), false);
        }
      }
    }, (err)=>{
      console.error(err);
      statusEl.textContent = "‚ùå –ü–æ–º–∏–ª–∫–∞ —á–∏—Ç–∞–Ω–Ω—è settings/app.";
    });
  }

  // -------------------------
  // weighing settings per activeKey
  // -------------------------
  function settingsDocIdByActiveKey(activeKey){
    return `weighing_${String(activeKey||"").trim()}`;
  }

  async function getOrCreateWeighingSettings(){
    if(!activeKey) throw new Error("–ù–µ–º–∞ activeKey (settings/app).");
    const ref = db.collection("settings").doc(settingsDocIdByActiveKey(activeKey));
    const snap = await ref.get();
    if(snap.exists) return { ref, data:(snap.data()||{}) };

    const init = {
      activeKey,
      compId,
      stageId,
      maxW: DEFAULT_MAX_W,
      current: { A:1, B:1, C:1 },
      updatedAt: window.firebase.firestore.FieldValue.serverTimestamp()
    };
    await ref.set(init, { merge:true });
    return { ref, data:init };
  }

  function getCurrentWForZone(settingsData){
    const cur = settingsData.current || {};
    const w = Number(cur[zone] || 1);
    const mW = Number(settingsData.maxW || DEFAULT_MAX_W);
    return Math.min(Math.max(w,1), mW);
  }

  async function setCurrentWForZone(nextW){
    const ref = db.collection("settings").doc(settingsDocIdByActiveKey(activeKey));
    await db.runTransaction(async (tx)=>{
      const snap = await tx.get(ref);
      const d = snap.data() || {};
      const mW = Number(d.maxW || DEFAULT_MAX_W);
      const cur = Object.assign({A:1,B:1,C:1}, d.current || {});
      const safe = Math.min(Math.max(Number(nextW||1),1), mW);
      cur[zone] = safe;
      tx.set(ref, {
        current: cur,
        updatedAt: window.firebase.firestore.FieldValue.serverTimestamp()
      }, { merge:true });
    });
  }

  function updateWButtons(){
    curWEl.textContent = `W${currentW}`;
    wBtns.forEach(b=>{
      b.el.classList.toggle("isActive", b.n === viewW);
      b.el.disabled = (b.n > currentW);
    });
  }

  // -------------------------
  // Teams for zone (SOURCE OF TRUTH: registrations)
  // -------------------------
  async function loadTeamsForZone(){
    if(!compId || !stageId) throw new Error("–ù–µ–º–∞ compId/stageId –∑ settings/app.");

    const qs = await db.collection("registrations")
      .where("competitionId","==",compId)
      .where("stageId","==",stageId)
      .where("status","==","confirmed")
      .get();

    const rows = [];
    qs.forEach(doc=>{
      const d = doc.data() || {};
      const z = String(d.drawZone || (d.drawKey ? String(d.drawKey)[0] : "") || "").toUpperCase();
      if(z !== String(zone||"").toUpperCase()) return;

      const sector = Number(d.drawSector || (d.drawKey ? parseInt(String(d.drawKey).slice(1),10) : 0) || 0);
      const teamId = String(d.teamId || "");
      const teamName = String(d.teamName || d.team || "‚Äî");

      if(!teamId) return;
      rows.push({ teamId, teamName, sector });
    });

    rows.sort((a,b)=> (a.sector||0)-(b.sector||0) || (a.teamName||"").localeCompare(b.teamName||"", "uk"));
    return rows;
  }

  // -------------------------
  // Weighings (LIVE compatible)
  // -------------------------
  function weighingDocId(teamId, wNo){
    return `${compId}||${stageId}||W${Number(wNo)}||${String(teamId)}`;
  }

  async function loadWeighing(teamId, wNo){
    const id = weighingDocId(teamId, wNo);
    const snap = await db.collection("weighings").doc(id).get();
    return snap.exists ? (snap.data()||null) : null;
  }

  function toNum(val){
    const s = String(val ?? "").trim().replace(",", ".");
    if(!s) return NaN;
    return Number(s);
  }

  function clampWeight(x){
    if(!Number.isFinite(x)) return NaN;
    x = Math.max(0, Math.min(x, 999.99));
    return Math.round(x * 100) / 100;
  }

  function computeFromFishWeights(fishWeights){
    const arr = (Array.isArray(fishWeights) ? fishWeights : [])
      .map(toNum)
      .map(clampWeight)
      .filter(n => Number.isFinite(n) && n > 0);

    const fishCount = arr.length;
    const totalWeightKg = Math.round(arr.reduce((a,b)=>a+b,0) * 100) / 100;
    const bigFishKg = fishCount ? Math.max(...arr) : 0;
    return { fishWeights: arr, fishCount, totalWeightKg, bigFishKg };
  }

  async function saveWeighing(team, wNo, fishWeights){
    const id = weighingDocId(team.teamId, wNo);
    const ts = window.firebase.firestore.FieldValue.serverTimestamp();

    const calc = computeFromFishWeights(fishWeights);

    await db.collection("weighings").doc(id).set({
      // ‚úÖ LIVE —á–∏—Ç–∞—î —Å–∞–º–µ —Ü–µ:
      compId,
      stageId,
      weighNo: Number(wNo),
      teamId: team.teamId,
      weights: calc.fishWeights,

      // –¥–æ–¥–∞—Ç–∫–æ–≤–µ (–Ω–µ –∑–∞–≤–∞–∂–∞—î LIVE)
      zone,
      sector: Number(team.sector || 0),
      teamName: team.teamName || "",
      status: "submitted",
      updatedAt: ts,
      updatedBy: me.uid
    }, { merge:true });

    weighCache[team.teamId] = weighCache[team.teamId] || {};
    weighCache[team.teamId][wNo] = { weights: calc.fishWeights, status:"submitted" };
  }

  async function maybeAdvanceAuto(teams){
    if(currentW >= maxW) return false;
    if(!teams.length) return false;

    // —Ä–∞—Ö—É—î–º–æ –∑–¥–∞–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏ –¥–ª—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ W –≤ –∑–æ–Ω—ñ (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –ø–æ–ª—è zone/status)
    const wsnap = await db.collection("weighings")
      .where("compId","==",compId)
      .where("stageId","==",stageId)
      .where("weighNo","==",Number(currentW))
      .where("zone","==",zone)
      .where("status","==","submitted")
      .get();

    const got = new Set();
    wsnap.forEach(doc=>{
      const d = doc.data() || {};
      if(d.teamId) got.add(String(d.teamId));
    });

    for(const t of teams){
      if(!got.has(String(t.teamId))) return false;
    }

    await setCurrentWForZone(currentW + 1);
    return true;
  }

  function fmtW(count, kg){
    const c = Number.isFinite(count) ? count : 0;
    const w = Number.isFinite(kg) ? kg : 0;
    return `${c}/${w.toFixed(2)}`;
  }

  function renderTeamRow(team, wNo, weighing){
    const weightsArr = (weighing && Array.isArray(weighing.weights)) ? weighing.weights : [];
    const calc = computeFromFishWeights(weightsArr);

    const safeWeights = (weightsArr.length ? weightsArr : [""])
      .map(v => (v === "" ? "" : String(Number(v).toFixed(2))));

    const submitted = (weighing && weighing.status === "submitted") || (weighing && Array.isArray(weighing.weights));
    const status = submitted ? "‚úÖ –∑–¥–∞–Ω–æ" : "‚Äî –Ω–µ –∑–¥–∞–Ω–æ";
    const sum = fmtW(calc.fishCount, calc.totalWeightKg);

    return `
      <div class="teamRow" data-team="${esc(team.teamId)}">
        <div class="teamHead">
          <div>
            <div class="teamTitle">${esc(team.teamName)}</div>
            <div class="teamMeta">–°–µ–∫—Ç–æ—Ä: <b>${esc(team.sector)}</b> ‚Ä¢ W${wNo} ‚Ä¢ <span class="muted">${status}</span></div>
          </div>
          <div class="pill">–†–∞–∑–æ–º: <b>${esc(sum)}</b> ‚Ä¢ Big: <b>${esc((calc.bigFishKg||0).toFixed(2))}</b></div>
        </div>

        <div class="fishGrid">
          <div class="fishTile">
            ${safeWeights.map((v,idx)=>`
              <div class="fishTile" style="margin-bottom:8px;">
                <input class="inp fishInp" inputmode="decimal" placeholder="–í–∞–≥–∞ —Ä–∏–±–∏ (–∫–≥), –Ω–∞–ø—Ä. 12.34"
                  value="${esc(v)}" data-fish="${idx}">
                <button class="fishDel" type="button" data-del="${idx}" ${safeWeights.length<=1 ? "disabled":""}>√ó</button>
              </div>
            `).join("")}
          </div>

          <div class="muted">
            <div>–ü–æ—Ä–∞–¥–∞: –º–æ–∂–Ω–∞ –ø–∏—Å–∞—Ç–∏ <b>12.34</b> –∞–±–æ <b>12,34</b></div>
            <div>–ú–∞–∫—Å —Ü–∏—Ñ—Ä–∏: <b>999.99</b></div>
          </div>

          <button class="fishAdd" type="button" title="–î–æ–¥–∞—Ç–∏ —Ä–∏–±—É" data-add>+</button>
        </div>

        <div class="sumRow">
          <div class="muted">–ê–≤—Ç–æ: üêü <b>${esc(String(calc.fishCount))}</b> ‚Ä¢ –∫–≥ <b>${esc(calc.totalWeightKg.toFixed(2))}</b> ‚Ä¢ Big <b>${esc((calc.bigFishKg||0).toFixed(2))}</b></div>
          <div class="teamBtns">
            <button class="btn btn--ghost" type="button" data-reload>–û–Ω–æ–≤–∏—Ç–∏</button>
            <button class="btn btn--primary" type="button" data-save>–ó–±–µ—Ä–µ–≥—Ç–∏ W${wNo}</button>
          </div>
        </div>

        <div class="muted" data-hint style="margin-top:8px;"></div>
      </div>
    `;
  }

  async function ensureWeighingCached(teamId, wNo){
    weighCache[teamId] = weighCache[teamId] || {};
    if(weighCache[teamId].hasOwnProperty(wNo)) return weighCache[teamId][wNo];
    const d = await loadWeighing(teamId, wNo);
    weighCache[teamId][wNo] = d;
    return d;
  }

  function reindexFish(row){
    const blocks = row.querySelectorAll(".fishGrid .fishTile .fishTile");
    blocks.forEach((b,i)=>{
      const inp = b.querySelector("input[data-fish]");
      const del = b.querySelector("button[data-del]");
      if(inp) inp.setAttribute("data-fish", String(i));
      if(del) del.setAttribute("data-del", String(i));
    });

    const dels = row.querySelectorAll("button.fishDel");
    if(dels.length === 1){
      dels[0].disabled = true;
    }else{
      dels.forEach(x => x.disabled = false);
    }
  }

  async function renderTeams(teams){
    teamsCountEl.textContent = `–ö–æ–º–∞–Ω–¥ —É –∑–æ–Ω—ñ: ${teams.length}`;

    if(!teams.length){
      teamsBox.innerHTML = `<div class="muted">–ù–µ–º–∞ –∫–æ–º–∞–Ω–¥ —É –∑–æ–Ω—ñ ${esc(zone)}. –ü–µ—Ä–µ–≤—ñ—Ä –∂–µ—Ä–µ–±–∫—É–≤–∞–Ω–Ω—è (drawZone/drawSector) —É confirmed registrations.</div>`;
      return;
    }

    // –ø—ñ–¥–≤–∞–Ω—Ç–∞–∂–∏–º–æ weighings –¥–ª—è viewW
    const rows = [];
    for(const t of teams){
      const w = await ensureWeighingCached(t.teamId, viewW);
      rows.push(renderTeamRow(t, viewW, w));
    }
    teamsBox.innerHTML = rows.join("");

    teamsBox.querySelectorAll(".teamRow").forEach(row=>{
      const teamId = row.getAttribute("data-team");
      const hintEl = row.querySelector('[data-hint]');

      function readFishInputs(){
        const vals = [];
        row.querySelectorAll("input[data-fish]").forEach(inp=>{
          vals.push(inp.value);
        });
        return vals;
      }

      row.querySelector("[data-add]")?.addEventListener("click", ()=>{
        const tile = row.querySelector(".fishGrid .fishTile");
        const curInputs = tile.querySelectorAll("input[data-fish]").length;
        const wrap = document.createElement("div");
        wrap.className = "fishTile";
        wrap.style.marginBottom = "8px";
        wrap.innerHTML = `
          <input class="inp fishInp" inputmode="decimal" placeholder="–í–∞–≥–∞ —Ä–∏–±–∏ (–∫–≥), –Ω–∞–ø—Ä. 12.34"
            value="" data-fish="${curInputs}">
          <button class="fishDel" type="button" data-del="${curInputs}">√ó</button>
        `;
        tile.appendChild(wrap);
        reindexFish(row);
        hintEl.textContent = "";
      });

      row.addEventListener("click", (e)=>{
        const del = e.target?.getAttribute && e.target.getAttribute("data-del");
        if(del !== null && del !== undefined){
          const container = e.target.closest(".fishTile");
          if(container){
            container.remove();
            reindexFish(row);
            hintEl.textContent = "";
          }
        }
      });

      row.querySelector("[data-reload]")?.addEventListener("click", async ()=>{
        try{
          weighCache[teamId] = weighCache[teamId] || {};
          weighCache[teamId][viewW] = await loadWeighing(teamId, viewW);

          const teams2 = await loadTeamsForZone();
          await renderTeams(teams2);
        }catch(err){
          hintEl.textContent = "–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: " + (err?.message || err);
          hintEl.className = "muted err";
        }
      });

      row.querySelector("[data-save]")?.addEventListener("click", async ()=>{
        try{
          hintEl.textContent = "–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è‚Ä¶";
          hintEl.className = "muted";

          const teams2 = await loadTeamsForZone();
          const team = teams2.find(x => String(x.teamId) === String(teamId));
          if(!team) throw new Error("–ù–µ –∑–Ω–∞–π—à–æ–≤ teamId —É confirmed registrations —Ü—ñ—î—ó –∑–æ–Ω–∏.");

          const raw = readFishInputs();
          const calc = computeFromFishWeights(raw);

          await saveWeighing(team, viewW, raw);

          hintEl.textContent = `‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–æ: ${fmtW(calc.fishCount, calc.totalWeightKg)} ‚Ä¢ Big ${calc.bigFishKg.toFixed(2)}`;
          hintEl.className = "muted ok";

          // –∞–≤—Ç–æ-–ø—Ä–æ–≥—Ä–µ—Å W
          const advanced = await maybeAdvanceAuto(teams2);
          if(advanced){
            const s = await getOrCreateWeighingSettings();
            maxW = Number(s.data.maxW || DEFAULT_MAX_W);
            currentW = getCurrentWForZone(s.data);
            if(viewW > currentW) viewW = currentW;
            updateWButtons();
            setWMsg(`–ê–≤—Ç–æ: –≤—Å—ñ –∫–æ–º–∞–Ω–¥–∏ –∑–¥–∞–Ω—ñ ‚Üí –ø–µ—Ä–µ–∫–ª—é—á–∏–≤ –Ω–∞ W${currentW}`, true);
          }

          await renderTeams(teams2);
        }catch(err){
          hintEl.textContent = "‚ùå –ü–æ–º–∏–ª–∫–∞: " + (err?.message || err);
          hintEl.className = "muted err";
        }
      });
    });
  }

  // -------------------------
  // Open zone (bind only zone)
  // -------------------------
  async function openZoneFlow(){
    // 1) –∑ URL –±–µ—Ä–µ–º–æ zone —ñ –∑–±–µ—Ä—ñ–≥–∞—î–º–æ
    const p = currentParams();
    let bind = readBind();

    if(p.zone){
      bind = { zone: p.zone };
      writeBind(bind);
    }

    if(!bind || !bind.zone){
      setMsg("–ù–µ–º–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤. –í—ñ–¥–∫—Ä–∏–π –ª—ñ–Ω–∫/QR –∑ zone (weigh_judge.html?zone=A).", false);
      return;
    }

    zone = String(bind.zone).toUpperCase();
    if(!["A","B","C"].includes(zone)){
      setMsg("–ù–µ–≤—ñ—Ä–Ω–∞ –∑–æ–Ω–∞. –ú–∞—î –±—É—Ç–∏ A / B / C.", false);
      return;
    }

    // 2) –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è —â–æ —î –∞–∫—Ç–∏–≤–Ω–∏–π –µ—Ç–∞–ø
    if(!compId || !stageId || !activeKey){
      setMsg("–ù–µ–º–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –µ—Ç–∞–ø—É (settings/app). –°–ø–æ—á–∞—Ç–∫—É –∞–¥–º—ñ–Ω –º–∞—î –ø—Ä–æ–≤–µ—Å—Ç–∏ –∂–µ—Ä–µ–±–∫—É–≤–∞–Ω–Ω—è –∞–±–æ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ activeKey.", false);
      return;
    }

    zoneTitle.textContent = `–ó–æ–Ω–∞ ${zone}`;
    statusEl.textContent = "üîÑ –í—ñ–¥–∫—Ä–∏–≤–∞—é –∑–æ–Ω—É‚Ä¶";

    renderBindState();

    // 3) settings –∑–≤–∞–∂—É–≤–∞–Ω—å
    const s = await getOrCreateWeighingSettings();
    maxW = Number(s.data.maxW || DEFAULT_MAX_W);
    currentW = getCurrentWForZone(s.data);
    viewW = Math.min(viewW, currentW);
    updateWButtons();

    // 4) –∫–æ–º–∞–Ω–¥–∏ –∑ registrations
    const teams = await loadTeamsForZone();
    statusEl.textContent = teams.length ? "‚úÖ –ó–æ–Ω–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∞." : "‚ö†Ô∏è –ó–æ–Ω–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∞, –∞–ª–µ –∫–æ–º–∞–Ω–¥ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ (–ø–µ—Ä–µ–≤—ñ—Ä confirmed + drawZone/drawSector).";
    weighCard.style.display = "block";

    // realtime badge (–ø—Ä–æ—Å—Ç–æ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä)
    if(netBadge) netBadge.style.display = "inline-flex";

    await renderTeams(teams);
    setWMsg(`–ü–µ—Ä–µ–≥–ª—è–¥: W${viewW}. –ü–æ—Ç–æ—á–Ω–µ: W${currentW}.`, true);
  }

  // -------------------------
  // INIT
  // -------------------------
  (async function init(){
    try{
      renderBindState();
      await waitFirebase();

      db = window.scDb;
      const auth = window.scAuth;

      auth.onAuthStateChanged(async (user)=>{
        if(!user){
          authPill.textContent = "auth: ‚ùå —É–≤—ñ–π–¥–∏ (—Å—É–¥–¥—è)";
          statusEl.textContent = "–ü–æ—Ç—Ä—ñ–±–µ–Ω –≤—Ö—ñ–¥ —Å—É–¥–¥—ñ/–∞–¥–º—ñ–Ω–∞.";
          weighCard.style.display = "none";
          return;
        }

        me = user;
        authPill.textContent = "auth: ‚úÖ " + (user.email || user.uid);

        const ok = await requireJudgeOrAdmin(user);
        if(!ok){
          statusEl.textContent = "‚õî –ù–µ–º–∞ –¥–æ—Å—Ç—É–ø—É. –ü–æ—Ç—Ä—ñ–±–Ω–∞ —Ä–æ–ª—å judge/admin —É users/{uid}.";
          weighCard.style.display = "none";
          return;
        }

        statusEl.textContent = "‚úÖ –î–æ—Å—Ç—É–ø —Å—É–¥–¥—ñ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ.";
        setMsg("–ì–æ—Ç–æ–≤–æ. –ù–∞—Ç–∏—Å–Ω–∏ ¬´–í—ñ–¥–∫—Ä–∏—Ç–∏ –º–æ—é –∑–æ–Ω—É¬ª –∞–±–æ –∑–∞–π–¥–∏ —á–µ—Ä–µ–∑ QR (‚Ä¶?zone=A).", true);

        // –ü—ñ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∞–∫—Ç–∏–≤–Ω–∏–π –µ—Ç–∞–ø
        startAppSub();
      });

      btnOpen.addEventListener("click", async ()=>{
        try{
          setMsg("–í—ñ–¥–∫—Ä–∏–≤–∞—é‚Ä¶", true);
          await openZoneFlow();
          renderBindState();
          setMsg("–ó–æ–Ω–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∞.", true);
        }catch(err){
          setMsg("–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è: " + (err?.message || err), false);
        }
      });

      btnReset.addEventListener("click", ()=>{
        clearBind();
        renderBindState();
        weighCard.style.display = "none";
        setMsg("–ü—Ä–∏–≤‚Äô—è–∑–∫—É —Å–∫–∏–Ω—É—Ç–æ.", true);
      });

      btnSaveHint.addEventListener("click", ()=>{
        alert("–ù–∞ Android/Chrome: –º–µ–Ω—é ‚ãÆ ‚Üí ¬´–î–æ–¥–∞—Ç–∏ –Ω–∞ –≥–æ–ª–æ–≤–Ω–∏–π –µ–∫—Ä–∞–Ω¬ª. –ù–∞ iPhone/Safari: Share ‚Üí Add to Home Screen.");
      });

      // –∫–Ω–æ–ø–∫–∏ W
      wBtns.forEach(b=>{
        b.el.addEventListener("click", async ()=>{
          if(b.n > currentW) return;
          viewW = b.n;
          updateWButtons();
          try{
            const teams = await loadTeamsForZone();
            await renderTeams(teams);
            setWMsg(`–ü–µ—Ä–µ–≥–ª—è–¥: W${viewW}`, true);
          }catch(err){
            setWMsg("–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è: " + (err?.message || err), false);
          }
        });
      });

      // —è–∫—â–æ —î zone –≤ URL ‚Äî –æ–¥—Ä–∞–∑—É –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ
      const p = currentParams();
      if(p.zone){
        writeBind({ zone: p.zone });
      }

      // —è–∫—â–æ –≤–∂–µ —î bind ‚Äî –º–æ–∂–Ω–∞ –æ–¥—Ä–∞–∑—É –≤—ñ–¥–∫—Ä–∏—Ç–∏ (–∫–æ–ª–∏ –ø—ñ–¥—Ç—è–≥–Ω–µ—Ç—å—Å—è settings/app)
      // (–Ω–µ —Ñ–æ—Ä—Å—É—î–º–æ —Ç—É—Ç ‚Äî –±–æ compId/stageId –º–æ–∂—É—Ç—å –ø—Ä–∏–π—Ç–∏ —á–µ—Ä–µ–∑ snapshot –∑–∞ –º–∏—Ç—å)
    }catch(err){
      statusEl.textContent = "‚ùå –ü–æ–º–∏–ª–∫–∞ init: " + (err?.message || err);
    }
  })();

})();
</script>
