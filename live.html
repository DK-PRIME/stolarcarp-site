<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live ‚Äî STOLAR CARP</title>
  <link rel="stylesheet" href="assets/css/main.css" />
  <script defer src="assets/js/config.js"></script>
  <style>
    :root{
      --line: rgba(255,255,255,.10);
      --row: #16171c;
      --ok:#16a34a; --warn:#f59e0b; --err:#ef4444;
      --grad: linear-gradient(90deg,#f6c34c 0%, #cc6a2b 35%, #7a0f2b 100%);
    }
    .title-gradient{background:var(--grad);-webkit-background-clip:text;background-clip:text;color:transparent}
    .card{background:#14151a;border:1px solid var(--line);border-radius:16px;padding:16px}
    .card.live{padding:0;overflow:hidden}
    .subhead{margin:0 0 8px;font-weight:800}
    .muted{opacity:.8}
    .zone-title{margin:22px 16px 8px;font-weight:900;font-size:20px}
    .zone-title span{display:inline-block;padding:2px 10px;border-radius:999px;border:1px solid var(--line)}
    .pending{border:1px dashed var(--line)}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:900px){ .grid-2{grid-template-columns:1fr} }
    table.live{width:100%;border-collapse:separate;border-spacing:0}
    table.live thead th{position:sticky;top:0;background:#15161a;padding:12px;text-align:left;border-bottom:1px solid var(--line)}
    table.live tbody td{background:#16171c;padding:10px 12px;border-bottom:1px solid var(--line)}
    table.live tbody tr:hover td{background:#1a1b21}
    .foot td{background:#101114;font-weight:700;border-top:2px solid var(--line)}
    .num{text-align:right;white-space:nowrap}
    .lead-row td{background:#182216}
    .pill{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px}
    .paid{background:#0e2b1b;border-color:#124d2e;color:#9ff0bf}
    .notpaid{opacity:.6}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:10px 0 0}
    @media (max-width:900px){ .kpis{grid-template-columns:1fr} }
    .kpi{background:#111215;border:1px solid var(--line);border-radius:14px;padding:14px}
    .kpi h4{margin:0 0 6px;font-size:14px;opacity:.85}
    .kpi .val{font-weight:900;font-size:20px}
    .winner{border-left:3px solid #f6c34c}
    .toolbar{display:flex;gap:10px;align-items:center;margin-bottom:10px}
    .state{display:inline-flex;align-items:center;gap:8px}
    .dot{width:8px;height:8px;border-radius:999px;background:var(--warn)}
    .dot.ok{background:var(--ok)} .dot.err{background:var(--err)}
  </style>
</head>
<body>
<header class="header">
  <div class="container header__row">
    <a class="logo" href="index.html">
      <span class="logo__mark">SC</span><span class="logo__text">STOLAR CARP</span>
    </a>
    <nav class="nav" id="nav">
      <a href="index.html" class="nav__link">–ì–æ–ª–æ–≤–Ω–∞</a>
      <a href="rules.html" class="nav__link">–†–µ–≥–ª–∞–º–µ–Ω—Ç</a>
      <a href="register.html" class="nav__link">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</a>
      <a href="live.html" class="nav__link nav__link--active">Live</a>
      <a href="rating.html" class="nav__link">–†–µ–π—Ç–∏–Ω–≥</a>
      <a href="lakes.html" class="nav__link">–í–æ–¥–æ–π–º–∏</a>
      <a href="sponsors.html" class="nav__link">–°–ø–æ–Ω—Å–æ—Ä–∏</a>
      <a href="events/turnir-2026.html" class="nav__link">–¢—É—Ä–Ω—ñ—Ä 2026</a>
    </nav>
    <button class="burger" id="burger"><span></span><span></span><span></span></button>
  </div>
</header>

<main class="main">
<section class="container section">
  <div class="toolbar">
    <h2 class="title-gradient" style="margin:0;">Live-–ø—Ä–æ—Ç–æ–∫–æ–ª</h2>
    <span class="state" style="margin-left:auto;"><span id="statusDot" class="dot"></span><span id="statusText">–û–Ω–æ–≤–ª–µ–Ω–Ω—è...</span></span>
  </div>

  <!-- –ë–ª–æ–∫ 1: –û—á—ñ–∫—É—é—Ç—å –∂–µ—Ä–µ–±–∫—É–≤–∞–Ω–Ω—è -->
  <div class="card pending">
    <h3 class="subhead">–ó–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω—ñ –∫–æ–º–∞–Ω–¥–∏ ‚Äî <span class="muted">–æ—á—ñ–∫—É—é—Ç—å –∂–µ—Ä–µ–±–∫—É–≤–∞–Ω–Ω—è</span></h3>
    <table class="live">
      <thead>
        <tr><th>–ö–æ–º–∞–Ω–¥–∞</th><th>–°—Ç–∞—Ç—É—Å</th></tr>
      </thead>
      <tbody id="pendingBody"><tr><td colspan="2" class="muted">–ü–æ—Ä–æ–∂–Ω—å–æ</td></tr></tbody>
    </table>
  </div>

  <!-- –ë–ª–æ–∫ 2: –ó–æ–Ω–∏ -->
  <div class="card live" style="margin-top:16px">
    <div class="zone-title">–ó–æ–Ω–∞ <span>A</span></div>
    <table class="live">
      <thead>
        <tr>
          <th>–ö–æ–º–∞–Ω–¥–∞</th>
          <th class="num">–ö-—Å—Ç—å</th>
          <th class="num">–í–∞–≥–∞, –∫–≥</th>
          <th class="num">Big, –∫–≥</th>
          <th class="num">üí∞ –¢–æ—Ç–∞–ª</th>
          <th class="num">–ú—ñ—Å—Ü–µ</th>
        </tr>
      </thead>
      <tbody id="zoneA"></tbody>
      <tbody class="foot"><tr><td>–†–∞–∑–æ–º</td><td class="num" id="zoneA_cnt">0</td><td class="num" id="zoneA_kg">0.000</td><td class="num" id="zoneA_big">0.000</td><td></td><td></td></tr></tbody>
    </table>

    <div class="zone-title">–ó–æ–Ω–∞ <span>B</span></div>
    <table class="live">
      <thead>
        <tr>
          <th>–ö–æ–º–∞–Ω–¥–∞</th>
          <th class="num">–ö-—Å—Ç—å</th>
          <th class="num">–í–∞–≥–∞, –∫–≥</th>
          <th class="num">Big, –∫–≥</th>
          <th class="num">üí∞ –¢–æ—Ç–∞–ª</th>
          <th class="num">–ú—ñ—Å—Ü–µ</th>
        </tr>
      </thead>
      <tbody id="zoneB"></tbody>
      <tbody class="foot"><tr><td>–†–∞–∑–æ–º</td><td class="num" id="zoneB_cnt">0</td><td class="num" id="zoneB_kg">0.000</td><td class="num" id="zoneB_big">0.000</td><td></td><td></td></tr></tbody>
    </table>

    <div class="zone-title">–ó–æ–Ω–∞ <span>C</span></div>
    <table class="live">
      <thead>
        <tr>
          <th>–ö–æ–º–∞–Ω–¥–∞</th>
          <th class="num">–ö-—Å—Ç—å</th>
          <th class="num">–í–∞–≥–∞, –∫–≥</th>
          <th class="num">Big, –∫–≥</th>
          <th class="num">üí∞ –¢–æ—Ç–∞–ª</th>
          <th class="num">–ú—ñ—Å—Ü–µ</th>
        </tr>
      </thead>
      <tbody id="zoneC"></tbody>
      <tbody class="foot"><tr><td>–†–∞–∑–æ–º</td><td class="num" id="zoneC_cnt">0</td><td class="num" id="zoneC_kg">0.000</td><td class="num" id="zoneC_big">0.000</td><td></td><td></td></tr></tbody>
    </table>
  </div>

  <!-- –ë–ª–æ–∫ 3: –§—ñ–Ω–∞–Ω—Å–æ–≤–∏–π —Ç–æ—Ç–∞–ª (–ø—Ä–æ–∑–æ—Ä–∏–π —Å–ø–∏—Å–æ–∫) -->
  <div class="card" style="margin-top:16px">
    <h3 class="subhead">–§—ñ–Ω–∞–Ω—Å–æ–≤–∏–π —Ç–æ—Ç–∞–ª (–ª–∏—à–µ –æ–ø–ª–∞—á–µ–Ω—ñ)</h3>

    <div class="kpis">
      <div class="kpi" id="kpiD1"><h4>–ë—ñ–≥ 1 –¥–æ–±–∏</h4><div class="val" id="kpiD1Team">‚Äî</div><div class="muted">–í–∞–≥–∞: <b id="kpiD1Val">0.000</b> –∫–≥</div></div>
      <div class="kpi" id="kpiD2"><h4>–ë—ñ–≥ 2 –¥–æ–±–∏</h4><div class="val" id="kpiD2Team">‚Äî</div><div class="muted">–í–∞–≥–∞: <b id="kpiD2Val">0.000</b> –∫–≥</div></div>
      <div class="kpi" id="kpiAll"><h4>–ë—ñ–≥ –∑–º–∞–≥–∞–Ω—å</h4><div class="val" id="kpiAllTeam">‚Äî</div><div class="muted">–í–∞–≥–∞: <b id="kpiAllVal">0.000</b> –∫–≥</div></div>
    </div>

    <table class="live" style="margin-top:14px">
      <thead>
        <tr>
          <th>–ö–æ–º–∞–Ω–¥–∞</th>
          <th class="num">BigD1</th>
          <th class="num">BigD2</th>
          <th class="num">Big</th>
          <th class="num">D1</th>
          <th class="num">D2</th>
          <th class="num">Overall</th>
        </tr>
      </thead>
      <tbody id="totalsBody"><tr><td colspan="7" class="muted">–ù–µ–º–∞—î –æ–ø–ª–∞—á–µ–Ω–∏—Ö —É—á–∞—Å–Ω–∏–∫—ñ–≤</td></tr></tbody>
    </table>
  </div>
</section>
</main>

<footer class="footer">
  <div class="container footer__row">
    <div>¬© 2025 STOLAR CARP ¬∑ –õ—å–≤—ñ–≤</div>
    <div class="footer__links">
      <a href="https://invite.viber.com/?g=8R04gUEhdVSnX6sr_DxGGGqAXTus0Ygh" rel="noopener">Viber</a>
      <a href="https://youtube.com/@dk-stolarcarp" rel="noopener">YouTube</a>
    </div>
  </div>
</footer>

<script>
/* ===== –£—Ç–∏–ª—ñ—Ç–∏ ===== */
const CSV_URL = 'assets/data/live.csv';
const REFRESH_MS = 60000;
const toNum = v => {
  if (v == null) return 0;
  const s = String(v).trim().replace(/\s+/g,'').replace(',', '.');
  const x = parseFloat(s);
  return Number.isFinite(x) ? x : 0;
};
const kg = v => toNum(v).toFixed(3);
const yes = v => /^(1|y|yes|true|—Ç–∞–∫|ok)$/i.test(String(v||'').trim());

/* ===== –ü–∞—Ä—Å–µ—Ä CSV –∑ –∞–≤—Ç–æ-–≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è–º —Ä–æ–∑–¥—ñ–ª—å–Ω–∏–∫–∞ + –º–∞–ø–ø–µ—Ä –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤ ===== */
function parseCSV(text){
  const lines = String(text||'').replace(/\r/g,'').split('\n').filter(l=>l.trim().length);
  if (!lines.length) return [];
  const sniff = (line) => line.includes('\t') ? '\t' : (line.includes(';') ? ';' : ',');
  const sep = sniff(lines[0]);
  return lines.map(l => l.split(sep).map(s => s.trim().replace(/^"(.*)"$/,'$1')));
}
function headerIndexMap(headerRow){
  const map = {};
  headerRow.forEach((h,i)=>{
    const k = String(h||'').toLowerCase().replace(/\s+/g,'').replace(/[,._-]/g,'');
    map[k] = i;
  });
  const want = {
    team: ['–∫–æ–º–∞–Ω–¥–∞','team'],
    zone: ['–∑–æ–Ω–∞','zone'],
    sector: ['—Å–µ–∫—Ç–æ—Ä','sector'],
    cnt: ['–∫—Å—Ç—å','–∫-—Å—Ç—å','–∫—ñ–ª—å–∫—ñ—Å—Ç—å','count','qty'],
    weight: ['–≤–∞–≥–∞','–≤–∞–≥–∞–∫–≥','weight','weightkg'],
    big: ['big','bigfish','bigkg','bigfish–∫–≥','–±—ñ–≥','–±—ñ–≥—Ñ—ñ—à'],
    bigd1: ['bigd1','bigday1','–±—ñ–≥–¥1'],
    bigd2: ['bigd2','bigday2','–±—ñ–≥–¥2'],
    paidd1: ['paidd1','paidday1','–æ–ø–ª–∞—Ç–∞–¥1'],
    paidd2: ['paidd2','paidday2','–æ–ø–ª–∞—Ç–∞–¥2'],
    paidoverall: ['paidoverall','paido','paidbig','–æ–ø–ª–∞—Ç–∞–±—ñ–≥','–æ–ø–ª–∞–±—ñ–≥','–æ–ø–ª–∞—Ç–∞–∑–º–∞–≥–∞–Ω—å']
  };
  const idx = {};
  for (const key in want){
    const alias = want[key].find(a => map.hasOwnProperty(a));
    idx[key] = alias ? map[alias] : -1;
  }
  return idx;
}
function normalize(rows){
  if (!rows.length) return [];
  const hasHeader = /–∫–æ–º–∞–Ω–¥–∞|team/i.test(rows[0][0]||'');
  const header = hasHeader ? rows[0] : ['–ö–æ–º–∞–Ω–¥–∞','–ó–æ–Ω–∞','–°–µ–∫—Ç–æ—Ä','–ö-—Å—Ç—å','–í–∞–≥–∞','Big','BigD1','BigD2','PaidD1','PaidD2','PaidOverall'];
  const idx = headerIndexMap(header);
  const data = hasHeader ? rows.slice(1) : rows;
  return data.map(r => ({
    team:   r[idx.team] ?? '',
    zone:   (r[idx.zone] ?? '').toString().trim().toUpperCase(),
    sector: r[idx.sector] ?? '',
    cnt:    toNum(r[idx.cnt]),
    weight: toNum(r[idx.weight]),
    big:    toNum(r[idx.big]),
    bigd1:  toNum(r[idx.bigd1]),
    bigd2:  toNum(r[idx.bigd2]),
    paidd1: yes(r[idx.paidd1]),
    paidd2: yes(r[idx.paidd2]),
    paido:  yes(r[idx.paidoverall]),
  })).filter(x => x.team);
}

/* ===== –†–µ–Ω–¥–µ—Ä ===== */
const $ = sel => document.querySelector(sel);
const pendingBody = $('#pendingBody');
const zoneBodies = { A: $('#zoneA'), B: $('#zoneB'), C: $('#zoneC') };
const zoneFoot = {
  A: { cnt: $('#zoneA_cnt'), kg: $('#zoneA_kg'), big: $('#zoneA_big') },
  B: { cnt: $('#zoneB_cnt'), kg: $('#zoneB_kg'), big: $('#zoneB_big') },
  C: { cnt: $('#zoneC_cnt'), kg: $('#zoneC_kg'), big: $('#zoneC_big') }
};
const kpi = {
  d1Team: $('#kpiD1Team'), d1Val: $('#kpiD1Val'),
  d2Team: $('#kpiD2Team'), d2Val: $('#kpiD2Val'),
  allTeam: $('#kpiAllTeam'), allVal: $('#kpiAllVal')
};
const totalsBody = $('#totalsBody');
const statusDot = $('#statusDot');
const statusText = $('#statusText');

function renderAll(items){
  // 1) Pending (–Ω–µ–º–∞ –∑–æ–Ω–∏ –∞–±–æ —Å–µ–∫—Ç–æ—Ä–∞)
  const pending = items.filter(x => !x.zone || !x.sector);
  pendingBody.innerHTML = pending.length
    ? pending.map(x => `<tr><td>${x.team}</td><td class="muted">–û—á—ñ–∫—É—î –∂–µ—Ä–µ–±–∫—É–≤–∞–Ω–Ω—è</td></tr>`).join('')
    : `<tr><td colspan="2" class="muted">–ü–æ—Ä–æ–∂–Ω—å–æ</td></tr>`;

  // 2) –ó–æ–Ω–∏
  const zones = {A:[],B:[],C:[]};
  items.forEach(x => { if (['A','B','C'].includes(x.zone)) zones[x.zone].push(x); });
  for (const z of ['A','B','C']){
    const arr = zones[z].slice().sort((a,b)=> b.weight - a.weight);
    let lastW=null, place=0, lastPlace=0;
    const rows = arr.map((x,i)=>{
      if (lastW===null || x.weight !== lastW){ place = i+1; lastPlace = place; lastW = x.weight; }
      const paid = (x.paidd1||x.paidd2||x.paido);
      return {
        html: `<tr class="${i===0?'lead-row':''}">
          <td>${x.team}${x.sector?` <span class="muted">(${x.sector})</span>`:''}</td>
          <td class="num">${x.cnt||0}</td>
          <td class="num">${kg(x.weight)}</td>
          <td class="num">${kg(x.big)}</td>
          <td class="num">${paid ? '<span class="pill paid">—Ç–∞–∫</span>' : '<span class="pill notpaid">‚Äî</span>'}</td>
          <td class="num"><b>${lastPlace}</b></td>
        </tr>`,
        cnt:x.cnt||0, w:x.weight||0, big:x.big||0
      };
    });
    zoneBodies[z].innerHTML = rows.map(r=>r.html).join('') || `<tr><td colspan="6" class="muted">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –∑–æ–Ω–∏ ${z}</td></tr>`;
    zoneFoot[z].cnt.textContent = rows.reduce((s,r)=>s+r.cnt,0);
    zoneFoot[z].kg.textContent  = kg(rows.reduce((s,r)=>s+r.w,0));
    zoneFoot[z].big.textContent = kg(rows.reduce((m,r)=>Math.max(m,r.big),0));
  }

  // 3) –§—ñ–Ω–∞–Ω—Å–æ–≤–∏–π —Ç–æ—Ç–∞–ª
  const paidAny = items.filter(x => x.paidd1 || x.paidd2 || x.paido);
  if (!paidAny.length){
    totalsBody.innerHTML = `<tr><td colspan="7" class="muted">–ù–µ–º–∞—î –æ–ø–ª–∞—á–µ–Ω–∏—Ö —É—á–∞—Å–Ω–∏–∫—ñ–≤</td></tr>`;
    kpi.d1Team.textContent = '‚Äî'; kpi.d1Val.textContent = '0.000';
    kpi.d2Team.textContent = '‚Äî'; kpi.d2Val.textContent = '0.000';
    kpi.allTeam.textContent= '‚Äî'; kpi.allVal.textContent= '0.000';
  } else {
    // winners
    const winD1 = paidAny.filter(x=>x.paidd1).sort((a,b)=> b.bigd1 - a.bigd1)[0];
    const winD2 = paidAny.filter(x=>x.paidd2).sort((a,b)=> b.bigd2 - a.bigd2)[0];
    const winAll= paidAny.filter(x=>x.paido ).sort((a,b)=> b.big   - a.big  )[0];

    kpi.d1Team.textContent = winD1 ? winD1.team : '‚Äî';
    kpi.d1Val.textContent  = kg(winD1 ? winD1.bigd1 : 0);
    kpi.d2Team.textContent = winD2 ? winD2.team : '‚Äî';
    kpi.d2Val.textContent  = kg(winD2 ? winD2.bigd2 : 0);
    kpi.allTeam.textContent= winAll? winAll.team : '‚Äî';
    kpi.allVal.textContent = kg(winAll? winAll.big  : 0);

    totalsBody.innerHTML = paidAny
      .sort((a,b)=> (b.paido-b.paido) || (b.paidd2-b.paidd2) || (b.paidd1-b.paidd1) || (b.big - a.big))
      .map(x=>{
        const rowClass =
          (winAll && x.team===winAll.team) ? 'winner' :
          (winD2 && x.team===winD2.team) ? 'winner' :
          (winD1 && x.team===winD1.team) ? 'winner' : '';
        return `<tr class="${rowClass}">
          <td>${x.team}</td>
          <td class="num">${kg(x.bigd1)}</td>
          <td class="num">${kg(x.bigd2)}</td>
          <td class="num">${kg(x.big)}</td>
          <td class="num">${x.paidd1?'<span class="pill paid">—Ç–∞–∫</span>':'‚Äî'}</td>
          <td class="num">${x.paidd2?'<span class="pill paid">—Ç–∞–∫</span>':'‚Äî'}</td>
          <td class="num">${x.paido ?'<span class="pill paid">—Ç–∞–∫</span>':'‚Äî'}</td>
        </tr>`;
      }).join('');
  }
}

/* ===== –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è + –∞–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è ===== */
async function loadAndRender(){
  try{
    statusDot.classList.remove('ok','err');
    statusText.textContent = '–û–Ω–æ–≤–ª–µ–Ω–Ω—è...';
    const res = await fetch(CSV_URL, {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const text = await res.text();
    const rows = parseCSV(text);
    const items = normalize(rows);
    renderAll(items);
    statusDot.classList.add('ok');
    statusText.textContent = '–û–Ω–æ–≤–ª–µ–Ω–æ: ' + new Date().toLocaleTimeString('uk-UA');
  }catch(err){
    statusDot.classList.add('err');
    statusText.textContent = '–ü–æ–º–∏–ª–∫–∞: ' + err.message;
  }
}
loadAndRender();
setInterval(loadAndRender, REFRESH_MS);
</script>
</body>
</html>
