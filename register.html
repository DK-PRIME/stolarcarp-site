<!-- –°–ö–†–ò–ü–¢ –†–ï–Ñ–°–¢–†–ê–¶–Ü–á -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  // ‚úÖ –Ñ–î–ò–ù–ê –ø—Ä–∞–≤–∫–∞: –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞–∑–≤–∞–Ω–∞ –∑–º—ñ–Ω–Ω–∞ –∑ –≤–µ–±-–∞–¥—Ä–µ—Å–æ—é
  const API_URL = "https://script.google.com/macros/s/AKfycbzavsHNwfQQ_5P3ciP19G7vOJjRdo3jr1GgHEi1oSDXNY5QT0ek4wwXubygTtEQoqFM/exec";

  const form = document.getElementById('regForm');
  const qty = document.getElementById('food_qty');
  const qtyField = document.getElementById('foodQtyField');
  const phoneInput = document.getElementById('phone_rest');
  const phoneHidden = document.getElementById('phone');
  const copyCardBtn = document.getElementById('copyCard');
  const msg = document.getElementById('msg');
  const eventOptionsContainer = document.getElementById('eventOptions');
  const submitBtn = document.getElementById('submitBtn');
  const spinner = document.getElementById('spinner');
  const fpInput = document.getElementById('fp');

  if (!form) return;

  // === Fingerprint ===
  (function makeFingerprint(){
    if (!fpInput) return;
    try {
      const src = [
        navigator.userAgent,
        navigator.language,
        (screen && (screen.width + 'x' + screen.height)) || '',
        (Intl && Intl.DateTimeFormat().resolvedOptions().timeZone) || ''
      ].join('|');

      let h = 2166136261;
      for (let i = 0; i < src.length; i++) {
        h ^= src.charCodeAt(i);
        h = (h * 16777619) >>> 0;
      }
      fpInput.value = 'fp_' + h.toString(16);
    } catch (err) {
      console.warn('Fingerprint error:', err);
    }
  })();

  // === Helpers ===
  const toggleLoading = (isLoading) => {
    if (submitBtn) {
      submitBtn.disabled = isLoading;
      submitBtn.textContent = isLoading ? '–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è...' : '–ü–æ–¥–∞—Ç–∏ –∑–∞—è–≤–∫—É';
    }
    if (spinner) {
      spinner.classList.toggle('spinner--on', isLoading);
    }
  };

  const prefillEvent = () => {
    if (!eventOptionsContainer) return;
    const params = new URLSearchParams(location.search);
    const p = params.get('stage') || params.get('event');
    if (!p) return;
    const radios = eventOptionsContainer.querySelectorAll('input[name="event"]');
    const found = Array.from(radios).find(r => (r.value || '').toLowerCase().includes(p.toLowerCase()));
    if (found) found.checked = true;
  };

  // === –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—ñ–¥–∫—Ä–∏—Ç–∏—Ö –µ—Ç–∞–ø—ñ–≤ ===
  const loadEvents = async () => {
    if (!eventOptionsContainer) return;
    eventOptionsContainer.innerHTML =
      '<p id="loading-events" class="form__hint">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∞–∫—Ç—É–∞–ª—å–Ω–∏—Ö –µ—Ç–∞–ø—ñ–≤...</p>';
    toggleLoading(true);

    try {
      const response = await fetch(API_URL);
      const data = await response.json();

      if (!Array.isArray(data) || data.length === 0) {
        eventOptionsContainer.innerHTML =
          '<p class="form-msg err" style="display:block;">‚ùå –ù–µ–º–∞—î –≤—ñ–¥–∫—Ä–∏—Ç–∏—Ö –µ—Ç–∞–ø—ñ–≤ –∞–±–æ –Ω–µ –≤–¥–∞–ª–æ—Å—è —ó—Ö –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏.</p>';
        return;
      }

      let html = '';
      data.forEach(eventValue => {
        const val = String(eventValue || '').trim();
        if (!val) return;
        const icon = val.toLowerCase().includes('—Ñ—ñ–Ω–∞–ª') ? 'ü•á' : 'üèÜ';
        html += `
          <label class="event-item">
            <input type="radio" name="event" value="${val}" required>
            <span>${icon} ${val}</span>
          </label>
        `;
      });

      eventOptionsContainer.innerHTML =
        html || '<p class="form-msg err" style="display:block;">‚ùå –ù–µ–º–∞—î –∞–∫—Ç—É–∞–ª—å–Ω–∏—Ö –µ—Ç–∞–ø—ñ–≤ –¥–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó.</p>';
      prefillEvent();

    } catch (error) {
      console.error('–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –µ—Ç–∞–ø—ñ–≤:', error);
      eventOptionsContainer.innerHTML =
        '<p class="form-msg err" style="display:block;">‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –¥–∞–Ω–∏—Ö. –û–Ω–æ–≤—ñ—Ç—å —Å—Ç–æ—Ä—ñ–Ω–∫—É –∞–±–æ —Å–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.</p>';
    } finally {
      toggleLoading(false);
    }
  };

  loadEvents();

  // === –õ–æ–≥—ñ–∫–∞ —Ö–∞—Ä—á—É–≤–∞–Ω–Ω—è ===
  const foodRadios = form.querySelectorAll('input[name="food"]');
  const toggleFood = () => {
    const need = form.food && form.food.value === '–¢–∞–∫';
    if (qty) {
      qty.disabled = !need;
      qty.required = need;
      if (!need) qty.value = '';
    }
    if (qtyField) {
      qtyField.classList.toggle('field--disabled', !need);
    }
  };

  foodRadios.forEach(r => r.addEventListener('change', toggleFood));
  toggleFood();

  // === –¢–µ–ª–µ—Ñ–æ–Ω ===
  if (phoneInput && phoneHidden) {
    phoneInput.addEventListener('input', () => {
      const clean = (phoneInput.value || '').replace(/\D/g, '').slice(0, 9);
      phoneInput.value = clean;
      phoneHidden.value = clean ? ('+380' + clean) : '';
    });
  }

  // === –ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è –∫–∞—Ä—Ç–∫–∏ ===
  if (copyCardBtn) {
    copyCardBtn.addEventListener('click', async () => {
      try {
        const cardEl = document.getElementById('cardNum');
        const num = (cardEl?.textContent || '').replace(/\s+/g, '').trim() || '4874070050688793';
        await navigator.clipboard.writeText(num);
        const old = copyCardBtn.textContent;
        copyCardBtn.textContent = '‚úÖ –°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ';
        setTimeout(() => copyCardBtn.textContent = old, 1500);
      } catch (err) {
        alert('–°–∫–æ–ø—ñ—é–π—Ç–µ –≤—Ä—É—á–Ω—É: 4874070050688793');
      }
    });
  }

  // === –°–∞–±–º—ñ—Ç ===
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (msg) {
      msg.className = 'form-msg';
      msg.textContent = '';
    }

    if (!form.checkValidity()) {
      if (msg) {
        msg.className = 'form-msg err';
        msg.textContent = '–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –æ–±–æ–≤ º—è–∑–∫–æ–≤—ñ –ø–æ–ª—è.';
      }
      form.reportValidity?.();
      return;
    }

    if (phoneHidden && !/^\+380\d{9}$/.test(phoneHidden.value || '')) {
      if (msg) {
        msg.className = 'form-msg err';
        msg.textContent = '–ù–µ–≤—ñ—Ä–Ω–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É. –ü–æ—Ç—Ä—ñ–±–Ω–æ 9 —Ü–∏—Ñ—Ä –ø—ñ—Å–ª—è +380.';
      }
      return;
    }

    toggleLoading(true);

    try {
      const formData = new FormData(form);

      const response = await fetch(API_URL, {
        method: 'POST',
        body: formData
      });

      const result = await response.json();

      if (result && result.success) {
        const selectedStage = formData.get('event') || '–æ–±—Ä–∞–Ω–∏–π –µ—Ç–∞–ø';

        if (msg) {
          msg.className = 'form-msg ok';
          msg.innerHTML = `
            ‚úÖ –ó–∞—è–≤–∫—É –Ω–∞ <b>${selectedStage}</b> –ø—Ä–∏–π–Ω—è—Ç–æ! –û–ø–ª–∞—Ç—ñ—Ç—å, –±—É–¥—å –ª–∞—Å–∫–∞, <b>3500 ‚Ç¥</b> —Ç–∞ –≤–∫–∞–∂—ñ—Ç—å <b>–Ω–∞–∑–≤—É –∫–æ–º–∞–Ω–¥–∏</b> —É –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ –¥–æ –ø–ª–∞—Ç–µ–∂—É.<br><br>
            <span style="color:#f97373;font-weight:600;">
              ‚ö†Ô∏è –Ø–∫—â–æ –æ–ø–ª–∞—Ç–∞ –Ω–µ –±—É–¥–µ –∑–¥—ñ–π—Å–Ω–µ–Ω–∞ –ø—Ä–æ—Ç—è–≥–æ–º <b>24 –≥–æ–¥–∏–Ω</b> –ø—ñ—Å–ª—è –ø–æ–¥–∞–Ω–Ω—è –∑–∞—è–≤–∫–∏ ‚Äî –≤–æ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ <b>–∞–Ω—É–ª—é—î—Ç—å—Å—è</b>.
            </span>
          `;
        }

        form.reset();
        if (phoneHidden) phoneHidden.value = '';
        toggleFood();

      } else {
        console.error('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏:', result);
        if (msg) {
          msg.className = 'form-msg err';
          msg.textContent =
            `‚ùå –ü–æ–º–∏–ª–∫–∞: ${result?.error || '–ù–µ –≤–¥–∞–ª–æ—Å—è –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –¥–∞–Ω—ñ. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.'}`;
        }
      }
    } catch (error) {
      console.error('Fetch error:', error);
      if (msg) {
        msg.className = 'form-msg err';
        msg.textContent =
          '‚ùå –ü–æ–º–∏–ª–∫–∞ –∑‚Äô—î–¥–Ω–∞–Ω–Ω—è —ñ–∑ —Å–µ—Ä–≤–µ—Ä–æ–º. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç –∞–±–æ —Å–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.';
      }
    } finally {
      toggleLoading(false);
    }
  });
});
</script>
