<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>–ú—ñ–≥—Ä–∞—Ü—ñ—è teamId ¬∑ STOLAR CARP</title>
  
  <style>
    body {
      background: #020617;
      color: #e5e7eb;
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    h1 {
      background: linear-gradient(90deg, #facc15 0%, #f97316 100%);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    button {
      background: linear-gradient(135deg, #facc15, #f97316);
      color: #111827;
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      font-size: 1rem;
    }
    button:hover {
      filter: brightness(1.1);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #log {
      margin-top: 20px;
      padding: 15px;
      background: #0f172a;
      border-radius: 12px;
      border: 1px solid #1f2937;
      max-height: 60vh;
      overflow-y: auto;
    }
    .success { color: #22c55e; }
    .warning { color: #f97316; }
    .error { color: #ef4444; }
    .info { color: #94a3b8; }
    .stats {
      margin-top: 20px;
      padding: 15px;
      background: #1f2937;
      border-radius: 12px;
    }
  </style>
</head>
<body>

  <h1>üîß –ú—ñ–≥—Ä–∞—Ü—ñ—è teamId –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</h1>
  <p>–¶–µ–π —Å–∫—Ä–∏–ø—Ç –æ–Ω–æ–≤–∏—Ç—å –ø–æ–ª–µ <code>teamId</code> –¥–ª—è –≤—Å—ñ—Ö –∫–∞–ø—ñ—Ç–∞–Ω—ñ–≤ –∫–æ–º–∞–Ω–¥.</p>
  
  <button id="startBtn" onclick="startMigration()">–ó–∞–ø—É—Å—Ç–∏—Ç–∏ –º—ñ–≥—Ä–∞—Ü—ñ—é</button>
  
  <div id="log"></div>

  <!-- ‚úÖ –í–°–Ü 4 Firebase SDK (–æ–±–æ–≤'—è–∑–∫–æ–≤–æ –≤ —Ü—å–æ–º—É –ø–æ—Ä—è–¥–∫—É) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

  <!-- ‚úÖ –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ó–ê–í–ñ–î–ò –æ—Å—Ç–∞–Ω–Ω—å–æ—é -->
  <script src="assets/js/firebase-init.js"></script>

  <script>
    async function startMigration() {
      const btn = document.getElementById('startBtn');
      const log = document.getElementById('log');
      
      btn.disabled = true;
      log.innerHTML = '<p class="info">–ü–æ—á–∏–Ω–∞—î–º–æ –º—ñ–≥—Ä–∞—Ü—ñ—é...</p>';
      
      try {
        // –ß–µ–∫–∞—î–º–æ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
        await window.scReady;
        const db = window.scDb;
        
        if (!db) {
          throw new Error('Firebase Firestore –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ');
        }
        
        // 1. –û—Ç—Ä–∏–º—É—î–º–æ –≤—Å—ñ –∫–æ–º–∞–Ω–¥–∏
        log.innerHTML += '<p class="info">–ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥...</p>';
        
        const teamsSnap = await db.collection("teams").get();
        const teamsMap = new Map(); // ownerUid -> teamInfo
        
        teamsSnap.forEach(doc => {
          const data = doc.data();
          if (data.ownerUid) {
            teamsMap.set(data.ownerUid, {
              teamId: doc.id,
              teamName: data.name || '–ë–µ–∑ –Ω–∞–∑–≤–∏',
              joinCode: data.joinCode
            });
          }
        });
        
        log.innerHTML += `<p class="success">‚úì –ó–Ω–∞–π–¥–µ–Ω–æ –∫–æ–º–∞–Ω–¥: ${teamsMap.size}</p>`;
        
        if (teamsMap.size === 0) {
          log.innerHTML += '<p class="warning">‚ö† –ö–æ–º–∞–Ω–¥ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –ü–µ—Ä–µ–≤—ñ—Ä –∫–æ–ª–µ–∫—Ü—ñ—é teams.</p>';
          return;
        }
        
        // 2. –û–Ω–æ–≤–ª—é—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
        let updated = 0;
        let skipped = 0;
        let errors = 0;
        
        for (const [ownerUid, teamInfo] of teamsMap) {
          try {
            const userRef = db.collection("users").doc(ownerUid);
            const userSnap = await userRef.get();
            
            if (!userSnap.exists) {
              log.innerHTML += `<p class="warning">‚ö† –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á ${ownerUid.substring(0, 8)}... –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∏–π (–∫–æ–º–∞–Ω–¥–∞: ${teamInfo.teamName})</p>`;
              skipped++;
              continue;
            }
            
            const userData = userSnap.data();
            
            // –Ø–∫—â–æ teamId –≤–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ
            if (userData.teamId === teamInfo.teamId) {
              log.innerHTML += `<p class="info">‚úì ${userData.fullName || ownerUid.substring(0, 8)}... –≤–∂–µ –º–∞—î –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π teamId</p>`;
              skipped++;
              continue;
            }
            
            // –û–Ω–æ–≤–ª—é—î–º–æ teamId
            await userRef.update({
              teamId: teamInfo.teamId,
              role: 'captain',
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            log.innerHTML += `<p class="success">‚úì –û–Ω–æ–≤–ª–µ–Ω–æ: ${userData.fullName || ownerUid.substring(0, 8)}... ‚Üí ${teamInfo.teamId.substring(0, 8)}... (${teamInfo.teamName})</p>`;
            updated++;
            
          } catch (err) {
            log.innerHTML += `<p class="error">‚úó –ü–æ–º–∏–ª–∫–∞ –¥–ª—è ${ownerUid.substring(0, 8)}...: ${err.message}</p>`;
            errors++;
          }
        }
        
        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        log.innerHTML += `
          <div class="stats">
            <h3>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –º—ñ–≥—Ä–∞—Ü—ñ—ó</h3>
            <p class="success">–û–Ω–æ–≤–ª–µ–Ω–æ: ${updated}</p>
            <p class="info">–ü—Ä–æ–ø—É—â–µ–Ω–æ (–≤–∂–µ –æ–∫): ${skipped}</p>
            <p class="error">–ü–æ–º–∏–ª–æ–∫: ${errors}</p>
          </div>
          <p class="success"><strong>‚úÖ –ú—ñ–≥—Ä–∞—Ü—ñ—é –∑–∞–≤–µ—Ä—à–µ–Ω–æ!</strong></p>
          <p class="info">–¢–µ–ø–µ—Ä popup —Å–∫–ª–∞–¥—É –∫–æ–º–∞–Ω–¥–∏ –º–∞—î –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –∫–æ—Ä–µ–∫—Ç–Ω–æ.</p>
        `;
        
      } catch (err) {
        log.innerHTML += `<p class="error">–ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞: ${err.message}</p>`;
        console.error(err);
      } finally {
        btn.disabled = false;
      }
    }
  </script>

</body>
</html>
