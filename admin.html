<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>STOLAR CARP • Адмінка</title>

  <link rel="stylesheet" href="assets/css/main.css" />

  <style>
    body{ background: radial-gradient(circle at top,#111827 0,#020617 55%); }
    .admin-wrap{ max-width:980px; margin:0 auto; padding:22px 0 70px; }
    .admin-top{
      padding:14px 16px; border-radius:18px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.35);
      box-shadow:0 18px 40px rgba(0,0,0,.6);
    }
    .muted{ color:#9ca3af; }
    .admin-hidden{ display:none; }

    .admin-card{
      margin-top:14px;
      padding:16px;
      border-radius:18px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.35);
      box-shadow:0 18px 40px rgba(0,0,0,.6);
    }

    .stack{ display:flex; flex-direction:column; gap:10px; }
    .stack .btn{ width:100%; justify-content:center; padding:12px 14px; border-radius:14px; }

    .mini-form{
      margin-top:12px;
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    .mini-form input, .mini-form select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,.35);
      background:rgba(2,6,23,.55);
      color:#e5e7eb;
      outline:none;
    }
    .mini-form input::placeholder{ color:#6b7280; }

    .hr{ height:1px; background:rgba(148,163,184,.18); margin:12px 0; border-radius:99px; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .row input{ flex:1; min-width:220px; }

    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width:720px){ .grid-2{ grid-template-columns:1fr; } }

    .stage-box{
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.28);
      background:rgba(2,6,23,.35);
    }
    .stage-head{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom:10px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:4px 10px; border-radius:999px;
      border:1px solid rgba(148,163,184,.35);
      background:rgba(15,23,42,.65);
      color:#e5e7eb;
      font-size:.82rem;
      white-space:nowrap;
    }
    .msg{ margin-top:10px; }
    .msg.ok{ color:#22c55e; }
    .msg.err{ color:#ef4444; }
  </style>
</head>

<body>

<header class="header">
  <div class="container header__row">
    <a class="logo" href="index.html">
      <span class="logo__mark">SC</span>
      <span class="logo__text">STOLAR CARP</span>
    </a>
    <nav class="nav">
      <a href="/index.html" class="nav__link">Головна</a>
      <a href="/live.html" class="nav__link">Live</a>
      <a href="/rating.html" class="nav__link">Рейтинг</a>
      <a href="/cabinet.html" class="nav__link">Мій кабінет</a>
    </nav>
  </div>
</header>

<main class="main">
  <section class="section container admin-wrap">

    <div class="admin-top">
      <div class="title-gradient" style="font-size:1.2rem; font-weight:800;">Адмінка STOLAR CARP</div>
      <div class="muted" id="adminStatus">Запуск…</div>
    </div>

    <!-- LOGIN -->
    <div id="adminLogin" class="admin-card admin-hidden">
      <h2 class="section-title" style="margin:0 0 10px;">Вхід адміністратора</h2>
      <div class="muted">Увійди email/паролем адмін-акаунта.</div>

      <div class="row">
        <input id="admEmail" type="email" placeholder="Email" />
        <input id="admPass" type="password" placeholder="Пароль" />
        <button class="btn btn--accent" id="btnAdminLogin">Увійти</button>
      </div>

      <div class="muted" id="adminLoginMsg" style="margin-top:10px;"></div>
    </div>

    <!-- APP -->
    <div id="adminApp" class="admin-hidden">

      <div class="admin-card">
        <div class="stack">
          <button class="btn btn--primary" id="btnOpenCreate">1) Створити змагання</button>
          <button class="btn btn--accent"  id="btnOpenReg">2) Відкрити / закрити реєстрацію</button>

          <a class="btn btn--primary" href="admin-registrations.html">3) Реєстрація команд</a>
          <a class="btn btn--accent"  href="admin-draw.html">4) Жеребкування</a>
          <a class="btn btn--danger"  href="admin-weigh.html">5) Зважування (судді/адмін)</a>
        </div>
      </div>

      <!-- 1) CREATE COMPETITION -->
      <div class="admin-card admin-hidden" id="modCreate">
        <h2 class="section-title" style="margin:0 0 8px;">Створити змагання</h2>

        <div class="mini-form">
          <select id="inpType">
            <option value="season">Тип: СЕЗОН (з етапами + фінал опційно)</option>
            <option value="oneoff">Тип: ОДНОРАЗОВЕ змагання</option>
          </select>

          <input id="inpYear" placeholder="Рік (наприклад: 2026)" inputmode="numeric" />

          <!-- бренд/серія авто -->
          <input id="inpName" placeholder="Назва змагання (наприклад: Осінній Короп / STALKER / Таблиця трьох)" />

          <select id="inpStagesCount" class="only-season">
            <option value="2">К-сть етапів у сезоні: 2</option>
            <option value="3" selected>К-сть етапів у сезоні: 3</option>
            <option value="4">К-сть етапів у сезоні: 4</option>
            <option value="5">К-сть етапів у сезоні: 5</option>
            <option value="6">К-сть етапів у сезоні: 6</option>
            <option value="7">К-сть етапів у сезоні: 7</option>
            <option value="8">К-сть етапів у сезоні: 8</option>
          </select>

          <select id="inpHasFinal" class="only-season">
            <option value="yes" selected>Фінал: ТАК</option>
            <option value="no">Фінал: НІ</option>
          </select>

          <div class="hr"></div>

          <div class="muted" style="margin-top:0;">
            Дати реєстрації (календар). Час фіксовано: <b>12:00 Київ</b>.
          </div>

          <div id="stageDatesWrap"></div>

          <select id="inpRegMode">
            <option value="auto" selected>Режим реєстрації: AUTO (по даті)</option>
            <option value="manual">Режим реєстрації: MANUAL (вручну)</option>
          </select>
        </div>

        <div class="stack" style="margin-top:12px;">
          <button class="btn btn--accent" id="btnDoCreate">Зберегти змагання</button>
          <button class="btn btn--primary" id="btnSetActive">Зробити активним</button>
        </div>

        <div id="createMsg" class="msg muted"></div>
      </div>

      <!-- 2) REGISTRATION DATES (calendar) -->
      <div class="admin-card admin-hidden" id="modReg">
        <h2 class="section-title" style="margin:0 0 8px;">Відкрити / закрити реєстрацію</h2>

        <div class="mini-form">
          <select id="selStage"></select>

          <div class="stage-box">
            <div class="stage-head">
              <div class="pill" id="regPill">—</div>
              <div class="pill">12:00 Київ</div>
            </div>

            <div class="grid-2">
              <div>
                <div class="muted" style="margin-bottom:6px;">Відкриття (дата)</div>
                <input type="date" id="regOpenDate" />
              </div>
              <div>
                <div class="muted" style="margin-bottom:6px;">Закриття (дата)</div>
                <input type="date" id="regCloseDate" />
              </div>
            </div>

            <div class="stack" style="margin-top:12px;">
              <button class="btn btn--accent" id="btnSaveRegDates">Зберегти дати</button>
              <button class="btn btn--primary" id="btnManualOpen">MANUAL: Відкрити</button>
              <button class="btn btn--danger" id="btnManualClose">MANUAL: Закрити</button>
            </div>

            <div id="regMsg" class="msg muted"></div>
          </div>
        </div>
      </div>

    </div>
  </section>
</main>

<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<!-- Єдиний init -->
<script src="assets/js/firebase-init.js"></script>

<script>
  // твій UID адміна
  const ADMIN_UID = "5Dt6fN64c3aWACYV1WacxV2BHDl2";

  const BRAND = "STOLAR CARP";
  const KYIV_TZ = "Europe/Kyiv";

  const $ = (id)=>document.getElementById(id);
  const show = (el)=>el && el.classList.remove("admin-hidden");
  const hide = (el)=>el && el.classList.add("admin-hidden");
  const setStatus = (t)=>{ const e=$("adminStatus"); if(e) e.textContent=t; };

  const modCreate = $("modCreate");
  const modReg    = $("modReg");

  function openModule(name){
    hide(modCreate); hide(modReg);
    if(name==="create") show(modCreate);
    if(name==="reg") show(modReg);
  }

  function msg(el, text, type){
    if(!el) return;
    el.classList.remove("ok","err","muted");
    if(type) el.classList.add(type);
    else el.classList.add("muted");
    el.textContent = text || "";
  }

  function toSlug(s){
    return String(s||"")
      .toLowerCase()
      .trim()
      .replace(/['"]/g,"")
      .replace(/[^a-z0-9а-яіїєґ]+/gi,"-")
      .replace(/-+/g,"-")
      .replace(/^-|-$/g,"");
  }

  // ===== Kyiv 12:00 helper (Timestamp) =====
  // беремо дату YYYY-MM-DD і робимо Timestamp на 12:00 Київ незалежно від девайсу
  function getKyivOffsetMinutes(yyyy, mm, dd, hh=12, mi=0){
    // пробуємо витягнути GMT+/- з Intl (працює у сучасних браузерах)
    const dt = new Date(Date.UTC(yyyy, mm-1, dd, hh, mi, 0));
    const fmt = new Intl.DateTimeFormat("en-US", { timeZone: KYIV_TZ, timeZoneName: "shortOffset", hour: "2-digit" });
    const parts = fmt.formatToParts(dt);
    const tz = (parts.find(p=>p.type==="timeZoneName")||{}).value || "";
    // tz типу "GMT+2" або "GMT+3"
    const m = tz.match(/GMT([+-]\d{1,2})(?::(\d{2}))?/i);
    if(!m) return 0;
    const h = parseInt(m[1],10);
    const mins = m[2] ? parseInt(m[2],10) : 0;
    return h*60 + (h>=0 ? mins : -mins);
  }

  function kyivNoonTimestamp(dateStr){
    if(!dateStr) return null;
    const m = String(dateStr).match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(!m) return null;
    const Y = parseInt(m[1],10);
    const Mo = parseInt(m[2],10);
    const D = parseInt(m[3],10);
    const offMin = getKyivOffsetMinutes(Y, Mo, D, 12, 0);
    // Київ = UTC + offMin, тому UTC час = Kyiv - offset
    const utcMs = Date.UTC(Y, Mo-1, D, 12, 0, 0) - offMin*60000;
    return window.firebase.firestore.Timestamp.fromDate(new Date(utcMs));
  }

  async function waitForFirebase(){
    for(let i=0;i<120;i++){
      if(window.scAuth && window.scDb) return;
      await new Promise(r=>setTimeout(r,100));
    }
    throw new Error("Firebase НЕ ініціалізований (scAuth / scDb)");
  }

  function renderStageDateInputs(){
    const type = $("inpType").value;
    const year = $("inpYear").value.trim();
    const wrap = $("stageDatesWrap");
    if(!wrap) return;

    // hide/show season-only
    document.querySelectorAll(".only-season").forEach(el=>{
      el.style.display = (type==="season") ? "" : "none";
    });

    wrap.innerHTML = "";

    if(type==="oneoff"){
      wrap.innerHTML = `
        <div class="stage-box">
          <div class="stage-head">
            <div class="pill"><b>Змагання</b></div>
          </div>
          <div class="grid-2">
            <div>
              <div class="muted" style="margin-bottom:6px;">Відкриття (дата)</div>
              <input type="date" id="date_open_main" />
            </div>
            <div>
              <div class="muted" style="margin-bottom:6px;">Закриття (дата)</div>
              <input type="date" id="date_close_main" />
            </div>
          </div>
        </div>
      `;
      return;
    }

    const n = parseInt($("inpStagesCount").value,10) || 3;
    const hasFinal = $("inpHasFinal").value === "yes";

    const boxes = [];
    for(let i=1;i<=n;i++){
      boxes.push(`
        <div class="stage-box">
          <div class="stage-head">
            <div class="pill"><b>Етап ${i}</b></div>
          </div>
          <div class="grid-2">
            <div>
              <div class="muted" style="margin-bottom:6px;">Відкриття (дата)</div>
              <input type="date" id="date_open_stage_${i}" />
            </div>
            <div>
              <div class="muted" style="margin-bottom:6px;">Закриття (дата)</div>
              <input type="date" id="date_close_stage_${i}" />
            </div>
          </div>
        </div>
      `);
    }

    if(hasFinal){
      boxes.push(`
        <div class="stage-box">
          <div class="stage-head">
            <div class="pill"><b>Фінал</b></div>
          </div>
          <div class="grid-2">
            <div>
              <div class="muted" style="margin-bottom:6px;">Відкриття (дата)</div>
              <input type="date" id="date_open_final" />
            </div>
            <div>
              <div class="muted" style="margin-bottom:6px;">Закриття (дата)</div>
              <input type="date" id="date_close_final" />
            </div>
          </div>
        </div>
      `);
    }

    wrap.innerHTML = boxes.join("");
  }

  async function init(){
    await waitForFirebase();

    const auth = window.scAuth;
    const db   = window.scDb;

    const loginBox = $("adminLogin");
    const appBox   = $("adminApp");
    const btnLogin = $("btnAdminLogin");
    const loginMsg = $("adminLoginMsg");

    function showLogin(text){
      hide(appBox);
      show(loginBox);
      loginMsg.textContent = text || "";
    }
    function showApp(){
      hide(loginBox);
      show(appBox);
    }

    $("btnOpenCreate").onclick = ()=>{
      openModule("create");
      renderStageDateInputs();
    };

    $("btnOpenReg").onclick = async ()=>{
      openModule("reg");
      await loadStagesList();
    };

    // live updates for create module
    $("inpType").addEventListener("change", renderStageDateInputs);
    $("inpStagesCount").addEventListener("change", renderStageDateInputs);
    $("inpHasFinal").addEventListener("change", renderStageDateInputs);

    if(btnLogin){
      btnLogin.onclick = async () => {
        const email = $("admEmail").value.trim();
        const pass  = $("admPass").value.trim();
        if(!email || !pass){ loginMsg.textContent = "Введи email і пароль"; return; }
        loginMsg.textContent = "Вхід…";
        try{ await auth.signInWithEmailAndPassword(email, pass); }
        catch(e){ loginMsg.textContent = e?.message || "Помилка входу"; }
      };
    }

    auth.onAuthStateChanged(async (user) => {
      if(!user){
        setStatus("Потрібен вхід (адмін)");
        showLogin("Увійди як адміністратор");
        return;
      }

      if(user.uid !== ADMIN_UID){
        setStatus("Доступ заборонено ❌");
        showLogin("Цей акаунт не має доступу");
        return;
      }

      setStatus("Адмін-доступ дозволено ✅");
      showApp();
      openModule("create");
      renderStageDateInputs();
      await loadStagesList();
    });

    // ===== CREATE SAVE =====
    $("btnDoCreate").onclick = async ()=>{
      const type = $("inpType").value;
      const year = $("inpYear").value.trim();
      const customName = $("inpName").value.trim();
      const regMode = $("inpRegMode").value;

      const createMsgEl = $("createMsg");

      if(!/^\d{4}$/.test(year)){
        msg(createMsgEl, "Вкажи рік у форматі YYYY (наприклад 2026).", "err");
        return;
      }

      if(type==="oneoff" && !customName){
        msg(createMsgEl, "Для одноразового змагання введи назву (Осінній Короп / STALKER / ...).", "err");
        return;
      }

      let competitionId = "";
      let title = "";
      let stagesCount = 0;
      let hasFinal = false;

      if(type==="season"){
        stagesCount = parseInt($("inpStagesCount").value,10) || 3;
        hasFinal = $("inpHasFinal").value === "yes";
        competitionId = `season-${year}`;
        title = `Season ${BRAND} ${year}`;
      }else{
        competitionId = `event-${year}-${toSlug(customName) || "event"}`;
        title = customName;
      }

      msg(createMsgEl, "Збереження…");

      try{
        // competitions/{id}
        await db.collection("competitions").doc(competitionId).set({
          competitionId,
          type,                 // season | oneoff
          brand: BRAND,         // авто
          year: Number(year),
          title,
          stagesCount: type==="season" ? stagesCount : 1,
          hasFinal: type==="season" ? hasFinal : false,
          regMode,              // auto | manual
          updatedAt: window.firebase.firestore.FieldValue.serverTimestamp(),
          createdAt: window.firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });

        // stages (для season)
        if(type==="season"){
          for(let i=1;i<=stagesCount;i++){
            const openDate = (document.getElementById(`date_open_stage_${i}`)||{}).value || "";
            const closeDate = (document.getElementById(`date_close_stage_${i}`)||{}).value || "";

            await db.collection("competitions").doc(competitionId)
              .collection("stages").doc(`stage-${i}`)
              .set({
                competitionId,
                stageId: `stage-${i}`,
                order: i,
                title: `Етап ${i}`,
                regMode,
                regOpenDate: openDate || null,
                regCloseDate: closeDate || null,
                regOpenAt: kyivNoonTimestamp(openDate),
                regCloseAt: kyivNoonTimestamp(closeDate),
                manualOpen: false,
                updatedAt: window.firebase.firestore.FieldValue.serverTimestamp(),
                createdAt: window.firebase.firestore.FieldValue.serverTimestamp()
              }, { merge:true });
          }

          if(hasFinal){
            const openDate = (document.getElementById(`date_open_final`)||{}).value || "";
            const closeDate = (document.getElementById(`date_close_final`)||{}).value || "";

            await db.collection("competitions").doc(competitionId)
              .collection("stages").doc(`final`)
              .set({
                competitionId,
                stageId: "final",
                order: stagesCount + 1,
                title: `Фінал`,
                regMode,
                regOpenDate: openDate || null,
                regCloseDate: closeDate || null,
                regOpenAt: kyivNoonTimestamp(openDate),
                regCloseAt: kyivNoonTimestamp(closeDate),
                manualOpen: false,
                updatedAt: window.firebase.firestore.FieldValue.serverTimestamp(),
                createdAt: window.firebase.firestore.FieldValue.serverTimestamp()
              }, { merge:true });
          }
        }else{
          // oneoff stage doc = main
          const openDate = (document.getElementById(`date_open_main`)||{}).value || "";
          const closeDate = (document.getElementById(`date_close_main`)||{}).value || "";

          await db.collection("competitions").doc(competitionId)
            .collection("stages").doc(`main`)
            .set({
              competitionId,
              stageId: "main",
              order: 1,
              title,
              regMode,
              regOpenDate: openDate || null,
              regCloseDate: closeDate || null,
              regOpenAt: kyivNoonTimestamp(openDate),
              regCloseAt: kyivNoonTimestamp(closeDate),
              manualOpen: false,
              updatedAt: window.firebase.firestore.FieldValue.serverTimestamp(),
              createdAt: window.firebase.firestore.FieldValue.serverTimestamp()
            }, { merge:true });
        }

        msg(createMsgEl, `✅ Збережено: ${competitionId}`, "ok");
        await loadStagesList(true);
      }catch(e){
        console.error(e);
        msg(createMsgEl, "❌ Помилка: " + (e.message || e), "
