<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Live — STOLAR CARP</title>
  <link rel="stylesheet" href="assets/css/main.css">
  <script defer src="assets/js/config.js"></script>
  <style>
    :root{
      --line: rgba(255,255,255,.08);
      --row: #16171c;
      --ok: #16a34a; --warn:#f59e0b; --err:#ef4444;
    }
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:10px}
    .input{background:#111215;border:1px solid var(--line);color:#fff;border-radius:10px;padding:10px 12px;outline:none;min-width:260px}
    .btn, .btn-sm{
      padding:10px 14px;border-radius:10px;background:#1b1c20;border:1px solid var(--line);
      color:#fff;text-decoration:none;font-weight:600;cursor:pointer
    }
    .btn:hover,.btn-sm:hover{filter:brightness(1.08)}
    .btn-sm{padding:8px 12px}
    .seg{display:flex;gap:6px;background:#101114;border:1px solid var(--line);border-radius:12px;padding:4px}
    .seg button{background:transparent;border:0;color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer}
    .seg button.active{background:#1b1c20}
    .state{display:inline-flex;align-items:center;gap:8px}
    .dot{width:8px;height:8px;border-radius:999px;background:var(--warn)}
    .dot.ok{background:var(--ok)} .dot.err{background:var(--err)}
    .hint{opacity:.75}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:900px){ .grid-2{grid-template-columns:1fr} }
    .card.live-wrap{background:#14151a;border:1px solid var(--line);border-radius:16px;overflow:hidden}
    table.live{width:100%;border-collapse:separate;border-spacing:0}
    table.live thead th{position:sticky;top:0;background:#15161a;padding:12px;text-align:left;border-bottom:1px solid var(--line);user-select:none}
    table.live thead th.sort{cursor:pointer}
    table.live thead th .arrow{opacity:.5;margin-left:6px}
    table.live tbody td{background:var(--row);padding:10px 12px;border-bottom:1px solid var(--line);vertical-align:middle}
    table.live tbody tr:hover td{background:#1a1b21}
    .num{text-align:right;white-space:nowrap}
    .zone-chip{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid var(--line);font-weight:600}
    .lead-row td{background:#182216}
    tfoot td{background:#101114;font-weight:700;border-top:2px solid var(--line)}
    .mini{font-size:.95rem}
    .textarea{width:100%}
  </style>
</head>
<body>
<header class="header">
  <div class="container header__row">
    <a class="logo" href="index.html">
      <span class="logo__mark">SC</span><span class="logo__text">STOLAR CARP</span>
    </a>
    <nav class="nav" id="nav">
      <a href="index.html" class="nav__link">Головна</a>
      <a href="rules.html" class="nav__link">Регламент</a>
      <a href="register.html" class="nav__link">Реєстрація</a>
      <a href="live.html" class="nav__link">Live</a>
      <a href="rating.html" class="nav__link">Рейтинг</a>
      <a href="lakes.html" class="nav__link">Водойми</a>
      <a href="sponsors.html" class="nav__link">Спонсори</a>
      <a href="events/turnir-2026.html" class="nav__link">Турнір 2026</a>
    </nav>
    <button class="burger" id="burger"><span></span><span></span><span></span></button>
  </div>
</header>

<main class="main">
<section class="container section">
  <h2 class="title-gradient">Live-протокол</h2>

  <!-- Верхня панель керування -->
  <div class="toolbar">
    <div class="seg" id="zoneSeg">
      <button data-zone="ALL" class="active">Усі</button>
      <button data-zone="A">Зона A</button>
      <button data-zone="B">Зона B</button>
      <button data-zone="C">Зона C</button>
    </div>
    <button id="exportCsv" class="btn-sm">Експорт CSV</button>
    <span class="mini state"><span id="statusDot" class="dot"></span><span id="statusText">Очікування…</span></span>
  </div>

  <div class="grid-2">
    <div class="card">
      <h3>Швидка вставка</h3>
      <p class="form__hint">Встав “значення” із Google Sheets. Допустимі роздільники: <b>;</b>, <b>,</b> або <b>таб</b>. Десяткові: кома або крапка.</p>
      <textarea id="csv-paste" class="textarea" rows="6" placeholder="Команда;Зона;Сектор;К-сть;Вага, кг;Середня, кг;Big Fish, кг"></textarea>
      <div class="cta-row" style="margin-top:8px">
        <button class="btn btn--primary" id="render-csv">Побудувати таблицю</button>
        <button class="btn btn--ghost" id="clear">Очистити</button>
      </div>
    </div>

    <div class="card">
      <h3>Автооновлення з посилання</h3>
      <div class="toolbar" style="margin:0 0 6px">
        <input id="csv-url" class="input" placeholder="https://docs.google.com/.../export?format=csv">
        <button class="btn btn--ghost" id="fetch-csv">Завантажити зараз</button>
        <label class="mini"><input type="checkbox" id="auto-refresh"> Авто 60с</label>
      </div>
      <p class="form__hint">Підійдуть «Publish to web → CSV/TSV» або Apps Script, що віддає CSV/TSV. URL і автопул запам’ятовуються.</p>
    </div>
  </div>

  <div class="card live-wrap" style="margin-top:16px">
    <table class="live">
      <thead>
        <tr>
          <th>Команда</th>
          <th>Зона</th>
          <th>Сектор</th>
          <th class="num sort" data-sort="cnt">К-сть <span class="arrow">↕</span></th>
          <th class="num sort" data-sort="weight">Вага, кг <span class="arrow">↕</span></th>
          <th class="num sort" data-sort="avg">Середня, кг <span class="arrow">↕</span></th>
          <th class="num sort" data-sort="big">Big Fish, кг <span class="arrow">↕</span></th>
        </tr>
      </thead>
      <tbody id="live-body"></tbody>
      <tfoot>
        <tr>
          <td colspan="3">Разом</td>
          <td class="num" id="tCount">0</td>
          <td class="num" id="tWeight">0.000</td>
          <td class="num" id="tAvg">0.000</td>
          <td class="num" id="tBig">0.000</td>
        </tr>
      </tfoot>
    </table>
  </div>

  <p class="form__hint">Порада: порядок колонок — Команда · Зона · Сектор · Кількість · Вага · Середня · Big Fish.</p>
</section>
</main>

<footer class="footer">
  <div class="container footer__row">
    <div>© 2025 STOLAR CARP · Львів</div>
    <div class="footer__links">
      <a href="https://invite.viber.com/?g=8R04gUEhdVSnX6sr_DxGGGqAXTus0Ygh">Viber</a>
      <a href="https://youtube.com/@dk-stolarcarp?si=H-BUK2msCiKXdcA9">YouTube</a>
    </div>
  </div>
</footer>

<script>
/* ===== Утиліти ===== */
const toNum = v => {
  if (v == null) return 0;
  // приймаємо "1,25" або "1.25"
  const s = String(v).trim().replace(/\s+/g,'').replace(',', '.');
  const x = parseFloat(s);
  return Number.isFinite(x) ? x : 0;
};
const kg = v => toNum(v).toFixed(3);

/* ===== CSV/TSV парсер ===== */
function parseCSV(text){
  const out = [];
  const lines = text.replace(/\r/g,'').split('\n').filter(l=>l.trim().length);
  for (const line of lines){
    const sep = line.includes('\t') ? '\t' : (line.includes(';') ? ';' : ',');
    const cols = line.split(sep).map(s => s.trim().replace(/^"(.*)"$/,'$1'));
    out.push(cols);
  }
  // якщо перший рядок схожий на заголовок — прибираємо
  if (out.length && /команда/i.test(out[0][0]||'')) out.shift();
  return out;
}

/* ===== Стан + дані ===== */
let rawRows = [];       // сирі масиви масивів
let items = [];         // нормалізовані об'єкти
let zoneFilter = 'ALL';
let sortKey = 'weight';
let sortDir = -1;       // -1: спадання, 1: зростання
let timer = null;

/* ===== Елементи DOM ===== */
const bodyEl = document.getElementById('live-body');
const tCount = document.getElementById('tCount');
const tWeight = document.getElementById('tWeight');
const tAvg = document.getElementById('tAvg');
const tBig = document.getElementById('tBig');

const txtArea = document.getElementById('csv-paste');
const renderBtn = document.getElementById('render-csv');
const clearBtn  = document.getElementById('clear');

const fetchBtn = document.getElementById('fetch-csv');
const urlInput = document.getElementById('csv-url');
const autoChk  = document.getElementById('auto-refresh');

const statusDot  = document.getElementById('statusDot');
const statusText = document.getElementById('statusText');
const zoneSeg    = document.getElementById('zoneSeg');

/* ===== Рендер ===== */
function normalize(rows){
  return rows.map(r => ({
    team:   r[0] ?? '',
    zone:   (r[1] ?? '').toString().trim().toUpperCase(),
    sector: r[2] ?? '',
    cnt:    toNum(r[3]),
    weight: toNum(r[4]),
    avg:    toNum(r[5]),
    big:    toNum(r[6]),
  })).filter(x => x.team);
}

function render(){
  // фільтр по зоні
  let arr = items.filter(x => zoneFilter==='ALL' ? true : x.zone === zoneFilter);

  // сортування: всередині зони — за ключем; між зонами — A,B,C
  const zoneOrder = {A:1,B:2,C:3};
  arr.sort((a,b)=>{
    const z = (zoneOrder[a.zone]||9) - (zoneOrder[b.zone]||9);
    if (z !== 0) return z;
    const A = a[sortKey], B = b[sortKey];
    return (A === B ? 0 : (A > B ? 1 : -1)) * sortDir;
  });

  // лідери зон
  const leadByZone = {};
  for (const it of arr){
    if (!leadByZone[it.zone]) leadByZone[it.zone] = it.team;
  }

  // рядки
  bodyEl.innerHTML = arr.map(it => `
    <tr class="${leadByZone[it.zone]===it.team ? 'lead-row' : ''}">
      <td>${it.team}</td>
      <td><span class="zone-chip">${it.zone || '-'}</span></td>
      <td>${it.sector || '-'}</td>
      <td class="num">${it.cnt || 0}</td>
      <td class="num">${kg(it.weight)}</td>
      <td class="num">${kg(it.avg)}</td>
      <td class="num">${kg(it.big)}</td>
    </tr>
  `).join('');

  // підсумки (по відфільтрованих)
  const totalCnt = arr.reduce((s,x)=>s + (x.cnt||0), 0);
  const totalW   = arr.reduce((s,x)=>s + (x.weight||0), 0);
  const maxBig   = arr.reduce((m,x)=>Math.max(m, x.big||0), 0);
  const avgW     = arr.length ? totalW / arr.length : 0;

  tCount.textContent  = totalCnt;
  tWeight.textContent = kg(totalW);
  tAvg.textContent    = kg(avgW);
  tBig.textContent    = kg(maxBig);
}

/* ===== Джерела даних ===== */
function buildFromTextarea(){
  rawRows = parseCSV(txtArea.value);
  items = normalize(rawRows);
  render();
  statusDot.classList.add('ok');
  statusText.textContent = 'Оновлено з буфера';
}

async function fetchAndRender(){
  const url = urlInput.value.trim();
  if (!url) return;
  try{
    statusDot.classList.remove('ok','err');
    statusText.textContent = 'Завантаження…';
    const res = await fetch(url, { cache:'no-store' });
    const text = await res.text();
    rawRows = parseCSV(text);
    items = normalize(rawRows);
    render();
    statusDot.classList.add('ok');
    statusText.textContent = 'Оновлено: ' + new Date().toLocaleTimeString('uk-UA');
    // пам'ять
    localStorage.setItem('live_url', url);
  }catch(e){
    statusDot.classList.add('err');
    statusText.textContent = 'Помилка: ' + e.message;
  }
}

/* ===== Експорт CSV ===== */
function exportCSV(){
  const header = ['Команда','Зона','Сектор','К-сть','Вага, кг','Середня, кг','Big Fish, кг'];
  // беремо поточні відфільтровані/відсортовані дані
  const zoneOrder = {A:1,B:2,C:3};
  let arr = items.filter(x => zoneFilter==='ALL' ? true : x.zone === zoneFilter);
  arr.sort((a,b)=>{
    const z = (zoneOrder[a.zone]||9) - (zoneOrder[b.zone]||9);
    if (z !== 0) return z;
    const A = a[sortKey], B = b[sortKey];
    return (A === B ? 0 : (A > B ? 1 : -1)) * sortDir;
  });
  const rows = arr.map(x => [
    x.team, x.zone, x.sector, x.cnt, x.weight.toFixed(3), x.avg.toFixed(3), x.big.toFixed(3)
  ]);
  const csv = [header, ...rows].map(r => r.map(c => String(c).includes(';') ? `"${c}"` : c).join(';')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'stolarcarp-live.csv';
  a.click();
  URL.revokeObjectURL(a.href);
}

/* ===== Події ===== */
document.querySelectorAll('th.sort').forEach(th=>{
  th.addEventListener('click', ()=>{
    const key = th.dataset.sort;
    if (sortKey === key) sortDir *= -1; else { sortKey = key; sortDir = -1; }
    document.querySelectorAll('th.sort .arrow').forEach(a=>a.textContent='↕');
    th.querySelector('.arrow').textContent = sortDir===1?'↑':'↓';
    render();
  });
});

zoneSeg.addEventListener('click', (e)=>{
  if (e.target.tagName !== 'BUTTON') return;
  zoneFilter = e.target.dataset.zone;
  zoneSeg.querySelectorAll('button').forEach(b=>b.classList.toggle('active', b===e.target));
  render();
});

renderBtn.addEventListener('click', buildFromTextarea);
clearBtn.addEventListener('click', ()=>{
  txtArea.value = '';
  rawRows = []; items = [];
  render();
  statusText.textContent = 'Очищено';
});

fetchBtn.addEventListener('click', fetchAndRender);
autoChk.addEventListener('change', ()=>{
  localStorage.setItem('live_auto', autoChk.checked ? '1' : '0');
  if (autoChk.checked){
    fetchAndRender();
    timer = setInterval(fetchAndRender, 60000);
  } else {
    clearInterval(timer);
  }
});
document.getElementById('exportCsv').addEventListener('click', exportCSV);

/* ===== Ініціалізація ===== */
(function init(){
  // підхоплюємо збережені налаштування
  const savedUrl = localStorage.getItem('live_url');
  if (savedUrl) urlInput.value = savedUrl;
  const savedAuto = localStorage.getItem('live_auto') === '1';
  autoChk.checked = savedAuto;
  if (savedUrl && savedAuto){
    fetchAndRender();
    timer = setInterval(fetchAndRender, 60000);
  } else {
    statusText.textContent = 'Готово до роботи';
  }
})();
</script>
</body>
</html>
