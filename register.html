<script>
// === 1. Fingerprint (–ó–∞–ª–∏—à–∞—î–º–æ —è–∫ IIFE –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è) ===
(function(){
  const src=[navigator.userAgent,navigator.language,screen.width+'x'+screen.height,Intl.DateTimeFormat().resolvedOptions().timeZone].join('|');
  let h=2166136261;
  for(let i=0;i<src.length;i++){
    h^=src.charCodeAt(i);
    h=(h*16777619)>>>0;
  }
  document.getElementById('fp').value='fp_'+h.toString(16);
})();

// === 2. –û—Å–Ω–æ–≤–Ω–∞ –ª–æ–≥—ñ–∫–∞ (–í–∏–∫–æ–Ω—É—î—Ç—å—Å—è –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è DOM) ===
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('regForm');
  const qty = document.getElementById('food_qty');
  const qtyField = document.getElementById('foodQtyField');
  const phoneInput = document.getElementById('phone_rest');
  const phoneHidden = document.getElementById('phone');
  const copyCardBtn = document.getElementById('copyCard');
  const msg = document.getElementById('msg');
  const eventOptionsContainer = document.getElementById('eventOptions');
  const foodRadios = form.querySelectorAll('input[name="food"]');
  const submitBtn = document.getElementById('submitBtn');
  const spinner = document.getElementById('spinner');

  // !!! –í–ê–® –ê–ö–¢–£–ê–õ–¨–ù–ò–ô –¢–ê –ü–ï–†–ï–í–Ü–†–ï–ù–ò–ô API URL !!!
  const apiUrl = 'https://script.google.com/macros/s/AKfycbwmL_waJIehJG1N3PfDtpO9QLUS-DWEgEUjpMNzP6ioAs-0ObnOki8WQtAMzjeHrLKg/exec'; 

  // –î–æ–ø–æ–º—ñ–∂–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –∫–µ—Ä—É–≤–∞–Ω–Ω—è —Å—Ç–∞–Ω–æ–º –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
  const toggleLoading = (isLoading) => {
      submitBtn.disabled = isLoading;
      spinner.classList.toggle('spinner--visible', isLoading);
      submitBtn.textContent = isLoading ? '–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è...' : '–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –∑–∞—è–≤–∫—É';
  };
  
  // --- 2.1. –õ–æ–≥—ñ–∫–∞ –¥–ª—è –∞–≤—Ç–æ–ø—Ä–µ—Ñ—ñ–ª—É (–≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –µ—Ç–∞–ø—ñ–≤) ---
  const prefillEvent = () => {
    const p = new URLSearchParams(location.search).get('event');
    if(!p) return;
    const eventRadios = eventOptionsContainer.querySelectorAll('input[name="event"]');
    const found = [...eventRadios].find(r => r.value.toLowerCase().includes(p.toLowerCase()));
    if(found){ found.checked = true; }
  };

  // --- 2.2. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –µ—Ç–∞–ø—ñ–≤ –∑ API ---
  const loadEvents = async () => {
    eventOptionsContainer.innerHTML = '<p id="loading-events">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∞–∫—Ç—É–∞–ª—å–Ω–∏—Ö –µ—Ç–∞–ø—ñ–≤...</p>';
    toggleLoading(true);

    try {
      // –ó–∞–ø–∏—Ç –∑ –¥–µ—Ñ–æ–ª—Ç–Ω–∏–º action=stages
      const response = await fetch(apiUrl); 
      const data = await response.json(); 

      if (!Array.isArray(data) || data.length === 0) {
        eventOptionsContainer.innerHTML = '<p class="form-msg err">‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ –µ—Ç–∞–ø—ñ–≤ –∞–±–æ —Å–ø–∏—Å–æ–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ `–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è` —É —Ç–∞–±–ª–∏—Ü—ñ.</p>';
        return;
      }

      let eventHtml = '';
      data.forEach(eventValue => {
        const icon = eventValue.toLowerCase().includes('—Ñ—ñ–Ω–∞–ª') ? 'ü•á' : 'üèÜ';
        
        eventHtml += `
          <label class="event-item">
            <input type="radio" name="event" value="${eventValue}" required>
            <span>${icon} ${eventValue}</span>
          </label>
        `;
      });

      eventOptionsContainer.innerHTML = eventHtml;
      prefillEvent();
      
    } catch (error) {
      console.error('–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –µ—Ç–∞–ø—ñ–≤:', error);
      eventOptionsContainer.innerHTML = '<p class="form-msg err">‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö. –°–ø—Ä–æ–±—É–π—Ç–µ –æ–Ω–æ–≤–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É.</p>';
    } finally {
        toggleLoading(false);
    }
  };

  // --- 2.3. –í–∏–∫–ª–∏–∫ —Ñ—É–Ω–∫—Ü—ñ—ó –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ ---
  loadEvents();

  // --- 2.4. –õ–æ–≥—ñ–∫–∞ —Ö–∞—Ä—á—É–≤–∞–Ω–Ω—è ---
  const toggleFood = () => {
    const need = form.food?.value === '–¢–∞–∫';
    qty.disabled = !need;
    qty.required = need;
    qtyField.classList.toggle('field--disabled', !need);
    if (!need) {
      qty.value = '';
    }
  };

  foodRadios.forEach(r => r.addEventListener('change', toggleFood));
  toggleFood(); // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Å—Ç–∞–Ω—É

  // --- 2.5. –¢–µ–ª–µ—Ñ–æ–Ω ---
  phoneInput.addEventListener('input', () => {
    const clean = (phoneInput.value || '').replace(/\D/g, '').slice(0, 9);
    phoneInput.value = clean;
    // –ù–∞–≤—ñ—Ç—å —è–∫—â–æ –¥–æ–≤–∂–∏–Ω–∞ –Ω–µ 9, –∑–±–µ—Ä—ñ–≥–∞—î–º–æ —Ç–µ, —â–æ —î, —â–æ–± —Å–µ—Ä–≤–µ—Ä –º—ñ–≥ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏
    phoneHidden.value = '+380' + clean; 
  });

  // --- 2.6. –ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è –∫–∞—Ä—Ç–∫–∏ ---
  copyCardBtn.addEventListener('click', async () => {
    try {
      const card = document.getElementById('cardNum').textContent.replace(/\s+/g, '').trim();
      await navigator.clipboard.writeText(card);
      const old = copyCardBtn.textContent;
      copyCardBtn.textContent = '‚úÖ –°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ';
      setTimeout(() => copyCardBtn.textContent = old, 1500);
    } catch (err) {
      alert('–°–∫–æ–ø—ñ—é–π—Ç–µ –≤—Ä—É—á–Ω—É: 4874070050688793');
    }
  });

  // --- 2.7. –°–∞–±–º—ñ—Ç —Ñ–æ—Ä–º–∏ (–û–ù–û–í–õ–ï–ù–û: –¢–µ–ø–µ—Ä –∑ POST-–∑–∞–ø–∏—Ç–æ–º) ---
  form.addEventListener('submit', async e => {
    e.preventDefault();
    msg.className = 'form-msg';
    msg.textContent = ''; 
    
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤–∞–ª—ñ–¥–Ω–æ—Å—Ç—ñ —Ñ–æ—Ä–º–∏
    if (!form.checkValidity()){
        msg.className = 'form-msg err';
        msg.textContent = '–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –æ–±–æ–≤ º—è–∑–∫–æ–≤—ñ –ø–æ–ª—è.';
        form.reportValidity?.();
        return;
    }

    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç—É —Ç–µ–ª–µ—Ñ–æ–Ω—É
    if (!/^\+380\d{9}$/.test(phoneHidden.value)) {
      msg.className = 'form-msg err';
      msg.textContent = '–ù–µ–≤—ñ—Ä–Ω–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É. –ü–æ—Ç—Ä—ñ–±–Ω–æ 9 —Ü–∏—Ñ—Ä –ø—ñ—Å–ª—è +380.';
      return;
    }
    
    toggleLoading(true);

    try {
        const formData = new FormData(form);
        
        const response = await fetch(apiUrl, {
            method: 'POST',
            body: formData,
        });

        // GAS –∑–∞–≤–∂–¥–∏ –ø–æ–≤–µ—Ä—Ç–∞—î JSON
        const result = await response.json(); 

        if (result.success) {
            const selectedEvent = formData.get('event');
            
            msg.className = 'form-msg ok';
            msg.innerHTML = `
              ‚úÖ –ó–∞—è–≤–∫—É –Ω–∞ <b>${selectedEvent}</b> –ø—Ä–∏–π–Ω—è—Ç–æ! –û–ø–ª–∞—Ç—ñ—Ç—å, –±—É–¥—å –ª–∞—Å–∫–∞, <b>1500 ‚Ç¥</b> —Ç–∞ –≤–∫–∞–∂—ñ—Ç—å <b>–Ω–∞–∑–≤—É –∫–æ–º–∞–Ω–¥–∏</b> —É –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ –¥–æ –ø–ª–∞—Ç–µ–∂—É.<br><br>
              <span style="color:#f87171;font-weight:600;">
                ‚ö†Ô∏è –Ø–∫—â–æ –æ–ø–ª–∞—Ç–∞ –Ω–µ –±—É–¥–µ –∑–¥—ñ–π—Å–Ω–µ–Ω–∞ –ø—Ä–æ—Ç—è–≥–æ–º <b>24 –≥–æ–¥–∏–Ω</b> –ø—ñ—Å–ª—è –ø–æ–¥–∞–Ω–Ω—è –∑–∞—è–≤–∫–∏ ‚Äî –≤–æ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ <b>–∞–Ω—É–ª—é—î—Ç—å—Å—è</b>.
              </span>
            `;

            form.reset(); 
            toggleFood();
        } else {
            console.error('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏:', result.error || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞');
            msg.className = 'form-msg err';
            msg.textContent = `‚ùå –ü–æ–º–∏–ª–∫–∞: ${result.error || '–ù–µ –≤–¥–∞–ª–æ—Å—è –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –¥–∞–Ω—ñ.'}`;
        }
    } catch (error) {
        console.error('Fetch Error:', error);
        msg.className = 'form-msg err';
        msg.textContent = '‚ùå –ü–æ–º–∏–ª–∫–∞ –∑‚Äô—î–¥–Ω–∞–Ω–Ω—è —ñ–∑ —Å–µ—Ä–≤–µ—Ä–æ–º. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –∞–±–æ —Å–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.';
    } finally {
        toggleLoading(false);
    }
  });
});
</script>
