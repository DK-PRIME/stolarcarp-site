<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>STOLAR CARP • Зважування (адмін)</title>

  <link rel="stylesheet" href="assets/css/main.css">

  <style>
    body{ background: radial-gradient(circle at top,#111827 0,#020617 55%); }
    .admin-wrap{ max-width:1100px; margin:0 auto; padding:22px 0 70px; }

    /* header fix */
    .header .header__row{ align-items:center; }
    .header .logo{ display:flex; align-items:center; gap:10px; min-height:56px; padding:8px 0; }
    .header .logo__mark{ width:42px; height:42px; display:flex; align-items:center; justify-content:center; line-height:1; overflow:visible; padding:0; }
    .header .logo__text{ line-height:1.1; }
    .header, .header .container{ overflow:visible; }

    .admin-top{
      padding:14px 16px; border-radius:18px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.35);
      box-shadow:0 18px 40px rgba(0,0,0,.6);
    }
    .admin-card{
      margin-top:14px;
      padding:16px;
      border-radius:18px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.35);
      box-shadow:0 18px 40px rgba(0,0,0,.6);
    }
    .muted{ color:#9ca3af; }
    .ok{ color:#22c55e; }
    .err{ color:#ef4444; }

    .mini-form{
      margin-top:12px;
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    .mini-form input, .mini-form select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,.35);
      background:rgba(2,6,23,.55);
      color:#e5e7eb;
      outline:none;
    }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width:640px){ .grid2{ grid-template-columns:1fr; } }

    /* ---------- TABLE UI ---------- */
    .zoneBlock{
      margin-top:14px;
      padding:14px;
      border-radius:18px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.35);
      box-shadow:0 18px 40px rgba(0,0,0,.6);
    }
    .zoneTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight:900;
      margin-bottom:10px;
    }

    .tableWrap{ overflow:auto; border-radius:14px; border:1px solid rgba(148,163,184,.25); }
    table.scTable{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width:760px;
      background:rgba(2,6,23,.35);
    }
    .scTable th, .scTable td{
      padding:10px 10px;
      border-bottom:1px solid rgba(148,163,184,.16);
      vertical-align:middle;
      color:#e5e7eb;
    }
    .scTable th{
      position:sticky;
      top:0;
      background:rgba(2,6,23,.85);
      backdrop-filter: blur(6px);
      z-index:2;
      font-size:.85rem;
      letter-spacing:.04em;
      text-transform:uppercase;
      color:#cbd5e1;
    }
    .scTable tr:last-child td{ border-bottom:none; }
    .colSector{ width:90px; white-space:nowrap; }
    .colTeam{ min-width:220px; }
    .colSum{ width:140px; white-space:nowrap; font-weight:900; }

    .weightsCell{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .wInp{
      width:120px;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,.35);
      background:rgba(2,6,23,.55);
      color:#e5e7eb;
      outline:none;
    }
    .wInp:focus{
      border-color:var(--accent);
      box-shadow:0 0 10px rgba(246,195,76,.25);
    }

    .miniBtn{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,.25);
      background:rgba(2,6,23,.45);
      color:#e5e7eb;
      font-weight:900;
      cursor:pointer;
    }
    .miniBtn--add{
      background:linear-gradient(135deg,var(--accent),var(--accent-2));
      color:#000;
      border-color:transparent;
    }
    .miniBtn--save{
      background:rgba(34,197,94,.18);
      border-color:rgba(34,197,94,.35);
    }
    .miniBtn--clear{
      background:rgba(239,68,68,.16);
      border-color:rgba(239,68,68,.35);
    }
    .rowActions{
      display:flex;
      gap:8px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .hintSmall{ color:#9ca3af; font-size:.85rem; margin-top:8px; }

    /* QR block (UI only; logic can be added later) */
    .badge{
      font-size:.72rem;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.25);
      background:rgba(2,6,23,.45);
      color:#e5e7eb;
      white-space:nowrap;
    }
  </style>
</head>

<body>

<header class="header">
  <div class="container header__row">
    <a class="logo" href="index.html">
      <span class="logo__mark">SC</span>
      <span class="logo__text">STOLAR CARP</span>
    </a>
    <nav class="nav">
      <a href="/live.html" class="nav__link">Live</a>
      <a href="/rating.html" class="nav__link">Рейтинг</a>
      <a href="/auth.html" class="nav__link">Акаунт</a>
    </nav>
  </div>
</header>

<main class="main">
  <section class="section container admin-wrap">

    <div class="admin-top">
      <div class="title-gradient" style="font-size:1.2rem; font-weight:900;">Зважування (адмін)</div>
      <div class="muted">Таблиці по зонах A/B/C. У рядку команди: ваги + кнопка “+” додає нову клітинку.</div>
      <div class="muted" id="adminStatus" style="margin-top:6px;">Запуск…</div>
    </div>

    <!-- CONTROL -->
    <div class="admin-card">
      <div style="font-weight:900; margin-bottom:8px;">Змагання / етап</div>

      <div class="mini-form">
        <select id="stageSelect">
          <option value="">— Завантаження… —</option>
        </select>

        <div>
          <div class="muted" style="font-size:.9rem; margin-bottom:6px;">Номер зважування</div>
          <select id="weighNo">
            <option value="1" selected>Зважування №1</option>
            <option value="2">Зважування №2</option>
            <option value="3">Зважування №3</option>
            <option value="4">Зважування №4</option>
          </select>
        </div>

        <div class="grid2">
          <button class="btn btn--accent" id="btnLoadData" type="button">Завантажити дані</button>
          <button class="btn btn--primary" id="btnRefreshList" type="button">Оновити список</button>
        </div>

        <div id="weighMsg" class="muted" style="margin-top:10px;"></div>
        <div id="weighDebug" class="muted" style="margin-top:6px; white-space:pre-wrap;"></div>
      </div>
    </div>

    <!-- TABLES -->
    <div id="tablesWrap" style="margin-top:12px;"></div>

    <!-- QR (тільки UI заглушка; логіку доробимо наступним кроком) -->
    <div class="admin-card">
      <div style="font-weight:900; margin-bottom:8px;">QR для суддів (A/B/C)</div>
      <div class="muted">
        Це блок наступного кроку: будемо генерувати token + QR на <b>weigh_judge.html</b> для зон A/B/C.
      </div>
      <div class="hintSmall">Зараз зосереджено на таблицях і внесенні риби.</div>
    </div>

  </section>
</main>

<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<!-- init -->
<script src="assets/js/firebase-init.js"></script>

<script>
(function(){
  "use strict";

  const auth = window.scAuth;
  const db   = window.scDb;

  const $ = (id)=>document.getElementById(id);

  const stageSelect = $("stageSelect");
  const weighNoSel  = $("weighNo");
  const btnLoad     = $("btnLoadData");
  const btnRefresh  = $("btnRefreshList");

  const msgEl  = $("weighMsg");
  const dbgEl  = $("weighDebug");
  const wrapEl = $("tablesWrap");
  const statusTop = $("adminStatus");

  const esc = (s)=>String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  const setTop = (t)=>{ if(statusTop) statusTop.textContent = t || ""; };

  const setMsg = (t, ok=true)=>{
    if(!msgEl) return;
    msgEl.textContent = t||"";
    msgEl.className = "muted " + (t ? (ok ? "ok" : "err") : "");
  };
  const setDbg = (t)=>{ if(dbgEl) dbgEl.textContent = t||""; };

  function norm(v){ return String(v??"").trim(); }

  function parseStageValue(v){
    const [compId, stageIdRaw] = String(v||"").split("||");
    return { compId: norm(compId), stageId: norm(stageIdRaw) || "" };
  }

  async function requireAdmin(user){
    const snap = await db.collection("users").doc(user.uid).get();
    const role = (snap.exists ? (snap.data()||{}).role : "") || "";
    return role === "admin";
  }

  async function waitFirebase(){
    for(let i=0;i<140;i++){
      if(window.scAuth && window.scDb && window.firebase) return;
      await new Promise(r=>setTimeout(r,100));
    }
    throw new Error("Firebase init не підняв scAuth/scDb.");
  }

  // ---- Список етапів ----
  async function loadStagesToSelect(){
    stageSelect.innerHTML = `<option value="">Завантаження…</option>`;

    const items = [];
    const snap = await db.collection("competitions").get();

    snap.forEach(docSnap=>{
      const c = docSnap.data()||{};
      const compId = docSnap.id;

      const brand = c.brand || "STOLAR CARP";
      const compTitle = c.name || c.title || compId;

      const eventsArr = Array.isArray(c.events) ? c.events : null;
      if (eventsArr && eventsArr.length) {
        eventsArr.forEach((ev, idx)=>{
          const key = String(ev.key || `stage-${idx+1}`);
          const stageTitle = ev.title || ev.name || ev.label || `Етап ${idx+1}`;
          items.push({ value:`${compId}||${key}`, label:`${brand} · ${compTitle} — ${stageTitle}` });
        });
      } else {
        items.push({ value:`${compId}||stage-1`, label:`${brand} · ${compTitle} — Етап 1` });
      }
    });

    items.sort((a,b)=>a.label.localeCompare(b.label,"uk"));

    stageSelect.innerHTML =
      `<option value="">— Оберіть —</option>` +
      items.map(x=>`<option value="${esc(x.value)}">${esc(x.label)}</option>`).join("");
  }

  // ---- Команди беремо з registrations (бо там точно є drawZone/drawSector) ----
  async function loadTeamsFromRegistrations(compId, stageId){
    const zones = { A:[], B:[], C:[] };

    const q = await db.collection("registrations")
      .where("competitionId", "==", compId)
      .where("stageId", "==", stageId)
      .where("status", "==", "confirmed")
      .get();

    q.forEach(doc=>{
      const r = doc.data() || {};
      const zone = String(r.drawZone || "").toUpperCase().trim(); // A/B/C
      const sector = r.drawSector || r.drawKey || "";
      const name = r.teamName || r.team || "Команда";
      const teamId = r.teamId || "";
      if(!zone || !zones[zone]) return;
      zones[zone].push({ zone, sector, name, teamId, regId: doc.id });
    });

    const sortSector = (a,b)=>String(a.sector||"").localeCompare(String(b.sector||""),"uk",{numeric:true});
    zones.A.sort(sortSector); zones.B.sort(sortSector); zones.C.sort(sortSector);

    return zones;
  }

  // ---- Local weights ----
  function keyLocal(compId, stageId, weighNo, zone, teamId){
    return `sc_w_${compId}_${stageId}_w${weighNo}_${zone}_${teamId||"noid"}`;
  }
  function loadLocal(compId, stageId, weighNo, zone, teamId){
    try{ return JSON.parse(localStorage.getItem(keyLocal(compId, stageId, weighNo, zone, teamId)) || "[]"); }
    catch{ return []; }
  }
  function saveLocal(compId, stageId, weighNo, zone, teamId, arr){
    try{ localStorage.setItem(keyLocal(compId, stageId, weighNo, zone, teamId), JSON.stringify(arr||[])); }catch{}
  }

  function sumWeights(arr){
    return (arr||[]).reduce((s,v)=>s + (Number(v)||0), 0);
  }

  // ---- Save Firestore (weighings) ----
  async function saveWeighing(compId, stageId, weighNo, zone, teamId, teamName, sector, weights){
    const id = `${compId}_${stageId}_w${weighNo}_${zone}_${(teamId||"noid")}`;
    await db.collection("weighings").doc(id).set({
      compId, stageId,
      weighNo: Number(weighNo),
      zone,
      teamId: teamId || "",
      teamName: teamName || "",
      sector: sector || "",
      weights: weights || [],
      totalWeight: sumWeights(weights),
      updatedAt: window.firebase.firestore.FieldValue.serverTimestamp()
    }, { merge:true });
  }

  // ---- Render ----
  function renderZone(zone, list, compId, stageId, weighNo){
    const rows = list.map((t, idx)=>{
      const sector = t.sector || (idx+1);
      const teamId = t.teamId || "";
      const teamName = t.name || "Команда";

      const arr = loadLocal(compId, stageId, weighNo, zone, teamId);
      const arrForInputs = (arr.length ? arr : [""]);

      const inputs = arrForInputs.map(v =>
        `<input class="wInp" value="${esc(v)}" placeholder="4.560" inputmode="decimal">`
      ).join("");

      return `
        <tr data-row data-zone="${esc(zone)}" data-team="${esc(teamId)}" data-name="${esc(teamName)}" data-sector="${esc(sector)}">
          <td class="colSector">${esc(sector)}</td>
          <td class="colTeam"><b>${esc(teamName)}</b></td>

          <td>
            <div class="weightsCell" data-cell>
              ${inputs}
              <button class="miniBtn miniBtn--add" type="button" data-add>+</button>
            </div>
            <div class="hintSmall" data-hint></div>
          </td>

          <td class="colSum" data-sum>${sumWeights(arr).toFixed(3)} кг</td>

          <td>
            <div class="rowActions">
              <button class="miniBtn miniBtn--save" type="button" data-save>Зберегти</button>
              <button class="miniBtn miniBtn--clear" type="button" data-clear>Очистити</button>
            </div>
            <div class="hintSmall" data-status></div>
          </td>
        </tr>
      `;
    }).join("");

    return `
      <div class="zoneBlock">
        <div class="zoneTitle">
          <div>Зона ${esc(zone)}</div>
          <div class="badge">Команд: ${list.length}</div>
        </div>
        <div class="tableWrap">
          <table class="scTable">
            <thead>
              <tr>
                <th class="colSector">Сектор</th>
                <th class="colTeam">Команда</th>
                <th>Риба (ваги, кг) +</th>
                <th class="colSum">Сума</th>
                <th>Дії</th>
              </tr>
            </thead>
            <tbody>
              ${rows || `<tr><td colspan="5" class="muted">Нема команд у зоні ${esc(zone)}</td></tr>`}
            </tbody>
          </table>
        </div>
        <div class="hintSmall">Ввів вагу → “+” додає нову клітинку → “Зберегти” пише в Firestore.</div>
      </div>
    `;
  }

  function readRowWeights(row){
    const arr = [];
    row.querySelectorAll("input.wInp").forEach(inp=>{
      const raw = String(inp.value||"").trim().replace(",",".");
      if(!raw) return;
      const v = Number(raw);
      if(v>0) arr.push(v);
    });
    return arr;
  }

  function attachRowHandlers(compId, stageId, weighNo){
    wrapEl.querySelectorAll("[data-row]").forEach(row=>{
      const zone = row.getAttribute("data-zone");
      const teamId = row.getAttribute("data-team") || "";
      const teamName = row.getAttribute("data-name") || "";
      const sector = row.getAttribute("data-sector") || "";

      const cell = row.querySelector("[data-cell]");
      const btnAdd = row.querySelector("[data-add]");
      const btnSave = row.querySelector("[data-save]");
      const btnClear = row.querySelector("[data-clear]");
      const sumEl = row.querySelector("[data-sum]");
      const stEl = row.querySelector("[data-status]");

      const recalc = ()=>{
        const arr = readRowWeights(row);
        sumEl.textContent = sumWeights(arr).toFixed(3) + " кг";
        saveLocal(compId, stageId, weighNo, zone, teamId, arr);
      };

      row.addEventListener("input", (e)=>{
        if(e.target && e.target.classList.contains("wInp")) recalc();
      });

      btnAdd.onclick = ()=>{
        const inp = document.createElement("input");
        inp.className = "wInp";
        inp.placeholder = "4.560";
        inp.setAttribute("inputmode","decimal");
        cell.insertBefore(inp, btnAdd);
        inp.focus();
        if(stEl) stEl.textContent = "";
      };

      btnClear.onclick = ()=>{
        const inputs = cell.querySelectorAll("input.wInp");
        inputs.forEach((x,i)=>{
          if(i===0) x.value = "";
          else x.remove();
        });
        recalc();
        if(stEl) stEl.textContent = "Очищено";
      };

      btnSave.onclick = async ()=>{
        const arr = readRowWeights(row);
        if(stEl){ stEl.textContent = "Зберігаю…"; }
        try{
          await saveWeighing(compId, stageId, weighNo, zone, teamId, teamName, sector, arr);
          if(stEl){ stEl.textContent = "Збережено ✅"; }
        }catch(e){
          if(stEl){ stEl.textContent = "Помилка ❌"; }
          setDbg((dbgEl?.textContent||"") + "\nSAVE ERROR:\n" + (e?.message||String(e)));
        }
      };

      recalc();
    });
  }

  async function loadAndRender(){
    const { compId, stageId } = parseStageValue(stageSelect.value);
    const weighNo = norm(weighNoSel?.value || "1");

    if(!compId || !stageId){
      setMsg("Обери змагання/етап.", false);
      return;
    }

    setMsg("Завантажую команди…", true);
    setDbg("");

    const zones = await loadTeamsFromRegistrations(compId, stageId);

    const a = zones.A || [], b = zones.B || [], c = zones.C || [];
    if(!a.length && !b.length && !c.length){
      setMsg("Нема підтверджених команд (перевір registrations: competitionId + stageId + status=confirmed + drawZone/drawSector).", false);
      wrapEl.innerHTML = "";
      return;
    }

    wrapEl.innerHTML =
      renderZone("A", a, compId, stageId, weighNo) +
      renderZone("B", b, compId, stageId, weighNo) +
      renderZone("C", c, compId, stageId, weighNo);

    attachRowHandlers(compId, stageId, weighNo);
    setMsg("✅ Таблиці згенеровані.", true);
  }

  async function init(){
    try{
      await waitFirebase();
    }catch(e){
      setTop("Firebase не запустився ❌");
      setMsg("Firebase init не підняв scAuth/scDb.", false);
      setDbg(e?.message || String(e));
      return;
    }

    setTop("Перевіряю доступ…");

    auth.onAuthStateChanged(async (user)=>{
      if(!user){
        setTop("Потрібен вхід");
        setMsg("Увійди як адмін.", false);
        return;
      }

      const ok = await requireAdmin(user);
      if(!ok){
        setTop("Доступ заборонено ❌");
        setMsg("Цей акаунт не адмін.", false);
        return;
      }

      setTop("Адмін-доступ ✅");
      await loadStagesToSelect();
      setMsg("Обери етап → натисни “Завантажити дані”.", true);

      if(btnLoad) btnLoad.onclick = loadAndRender;

      if(btnRefresh) btnRefresh.onclick = async ()=>{
        setMsg("Оновлюю список…", true);
        await loadStagesToSelect();
        setMsg("Оновлено ✅", true);
      };

      if(weighNoSel){
        weighNoSel.addEventListener("change", ()=>{
          if(stageSelect.value) loadAndRender();
        });
      }
    });
  }

  window.addEventListener("error", (e)=>{
    setTop("Помилка JS ❌");
    setMsg("Сталася помилка JS. Дивись debug.", false);
    setDbg(e?.message || "error");
  });
  window.addEventListener("unhandledrejection", (e)=>{
    setTop("Помилка Promise ❌");
    setMsg("Promise error. Дивись debug.", false);
    setDbg(e?.reason?.message || String(e?.reason || "Promise error"));
  });

  init();
})();
</script>

</body>
</html>
