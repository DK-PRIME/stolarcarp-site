<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>STOLAR CARP ‚Ä¢ –ê–¥–º—ñ–Ω–∫–∞</title>

  <link rel="stylesheet" href="assets/css/main.css">

  <style>
    body{ background: radial-gradient(circle at top,#111827 0,#020617 55%); }
    .admin-wrap{ max-width:1100px; margin:0 auto; padding:32px 0 70px; }
    .admin-top{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px; border-radius:18px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.35);
      box-shadow:0 18px 40px rgba(0,0,0,.6);
    }
    .admin-badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 12px; border-radius:999px;
      font-size:.85rem; color:#e5e7eb;
      border:1px solid rgba(148,163,184,.35);
      background:rgba(0,0,0,.35);
      white-space:nowrap;
    }
    .muted{ color:#9ca3af; }
    .admin-hidden{ display:none; }

    .admin-card{
      margin-top:14px;
      padding:16px;
      border-radius:18px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.35);
      box-shadow:0 18px 40px rgba(0,0,0,.6);
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .row .btn{ padding:10px 14px; border-radius:12px; }

    .admin-grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    @media(min-width:900px){
      .admin-grid{ grid-template-columns: 1.2fr .8fr; }
    }

    .admin-list{ display:flex; flex-direction:column; gap:10px; margin-top:12px; }
    .item{
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.25);
      background:rgba(2,6,23,.55);
    }
    .item-top{ display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap; }
    .pill{
      display:inline-flex; align-items:center;
      padding:4px 10px; border-radius:999px;
      font-size:.78rem;
      border:1px solid rgba(148,163,184,.35);
      color:#e5e7eb;
      background:rgba(0,0,0,.35);
    }
    .pill.ok{ border-color:rgba(34,197,94,.6); }
    .pill.warn{ border-color:rgba(250,204,21,.65); }
    .pill.bad{ border-color:rgba(239,68,68,.65); }

    .mini-form{
      margin-top:12px;
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    .mini-form input, .mini-form select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,.35);
      background:rgba(2,6,23,.55);
      color:#e5e7eb;
      outline:none;
    }
    .mini-form input::placeholder{ color:#6b7280; }
  </style>
</head>

<body>

<header class="header">
  <div class="container header__row">
    <a class="logo" href="index.html">
      <span class="logo__mark">SC</span>
      <span class="logo__text">STOLAR CARP</span>
    </a>
    <nav class="nav">
      <a href="/index.html" class="nav__link">–ì–æ–ª–æ–≤–Ω–∞</a>
      <a href="/live.html" class="nav__link">Live</a>
      <a href="/rating.html" class="nav__link">–†–µ–π—Ç–∏–Ω–≥</a>
      <a href="/cabinet.html" class="nav__link">–ú—ñ–π –∫–∞–±—ñ–Ω–µ—Ç</a>
    </nav>
  </div>
</header>

<main class="main">
  <section class="section container admin-wrap">

    <div class="admin-top">
      <div>
        <div class="title-gradient" style="font-size:1.2rem; font-weight:800;">–ê–¥–º—ñ–Ω–∫–∞ STOLAR CARP</div>
        <div class="muted" id="adminStatus">–ó–∞–ø—É—Å–∫‚Ä¶</div>
      </div>
      <div class="admin-badge" id="adminBadge">üîí admin</div>
    </div>

    <div id="adminApp" class="admin-hidden">

      <!-- –ü–∞–Ω–µ–ª—å –∫–Ω–æ–ø–æ–∫ -->
      <div class="admin-card">
        <h2 class="section-title" style="margin:0 0 10px;">–ö–µ—Ä—É–≤–∞–Ω–Ω—è</h2>
        <div class="row">
          <button class="btn btn--primary" id="btnCreateContest">1. –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–º–∞–≥–∞–Ω–Ω—è</button>
          <button class="btn btn--accent"  id="btnToggleContest">2. –í—ñ–¥–∫—Ä–∏—Ç–∏ / –∑–∞–∫—Ä–∏—Ç–∏</button>
          <button class="btn btn--primary" id="btnRegistrations">3. –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –∫–æ–º–∞–Ω–¥</button>
          <button class="btn btn--accent"  id="btnDraw">4. –ñ–µ—Ä–µ–±–∫—É–≤–∞–Ω–Ω—è</button>
          <button class="btn btn--danger"  id="btnWeigh">5. –ó–≤–∞–∂—É–≤–∞–Ω–Ω—è</button>
          <button class="btn btn--primary" id="btnUsers">6. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ —Å–∞–π—Ç—É</button>
          <button class="btn btn--primary" id="btnLogout">–í–∏–π—Ç–∏</button>
        </div>
        <div class="muted" style="margin-top:10px;" id="adminHint">–û–±–µ—Ä–∏ –º–æ–¥—É–ª—å –∑–≤–µ—Ä—Ö—É.</div>
      </div>

      <!-- –ú–û–î–£–õ–Ü -->
      <div class="admin-grid">

        <!-- –õ–Ü–í–û: –ó–∞—è–≤–∫–∏ -->
        <div class="admin-card" id="modRegistrations">
          <h2 class="section-title" style="margin:0 0 10px;">–ó–∞—è–≤–∫–∏ –Ω–∞ —É—á–∞—Å—Ç—å</h2>
          <div class="muted">–ö–æ–ª–µ–∫—Ü—ñ—è: <b>registrations</b>. –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –æ–ø–ª–∞—Ç–∏ ‚Äî —Ç—ñ–ª—å–∫–∏ —Ç–∏ (UID –∞–¥–º—ñ–Ω–∞).</div>
          <div class="row">
            <button class="btn btn--primary" id="btnLoadRegs">–û–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫</button>
          </div>
          <div class="admin-list" id="regsList"></div>
        </div>

        <!-- –ü–†–ê–í–û: –ú–æ–¥—É–ª—ñ -->
        <div style="display:flex; flex-direction:column; gap:14px;">

          <!-- –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–º–∞–≥–∞–Ω–Ω—è -->
          <div class="admin-card admin-hidden" id="modCreate">
            <h2 class="section-title" style="margin:0 0 10px;">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–º–∞–≥–∞–Ω–Ω—è (–∫–∞—Ä–∫–∞—Å)</h2>
            <div class="muted">–ó–∞–ø–∏—Å—É—î–º–æ –≤: <b>seasons</b> —ñ (–æ–ø—Ü—ñ–π–Ω–æ) <b>seasons/{seasonId}/stages</b>, –∞ —Ç–∞–∫–æ–∂ <b>settings/app</b>.</div>

            <div class="mini-form">
              <input id="inpSeasonId" placeholder="seasonId (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: season-2026)" />
              <input id="inpSeasonName" placeholder="–ù–∞–∑–≤–∞ —Å–µ–∑–æ–Ω—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: STOLAR CARP 2026)" />
              <input id="inpStageId" placeholder="stageId (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: stage-1)" />
              <input id="inpStageName" placeholder="–ù–∞–∑–≤–∞ –µ—Ç–∞–ø—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: –ï—Ç–∞–ø 1)" />
              <select id="inpRegOpen">
                <option value="true">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è: –í–Ü–î–ö–†–ò–¢–ê</option>
                <option value="false">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è: –ó–ê–ö–†–ò–¢–ê</option>
              </select>
            </div>

            <div class="row">
              <button class="btn btn--accent" id="btnDoCreate">–°—Ç–≤–æ—Ä–∏—Ç–∏ / –û–Ω–æ–≤–∏—Ç–∏</button>
            </div>

            <div class="muted" id="createMsg" style="margin-top:10px;"></div>
          </div>

          <!-- –í—ñ–¥–∫—Ä–∏—Ç–∏/–ó–∞–∫—Ä–∏—Ç–∏ -->
          <div class="admin-card admin-hidden" id="modToggle">
            <h2 class="section-title" style="margin:0 0 10px;">–í—ñ–¥–∫—Ä–∏—Ç–∏ / –ó–∞–∫—Ä–∏—Ç–∏ –∑–º–∞–≥–∞–Ω–Ω—è</h2>
            <div class="muted">–î–æ–∫—É–º–µ–Ω—Ç: <b>settings/app</b> –ø–æ–ª–µ <b>registrationOpen</b>.</div>
            <div class="row">
              <button class="btn btn--accent" id="btnOpenReg">–í—ñ–¥–∫—Ä–∏—Ç–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é</button>
              <button class="btn btn--danger" id="btnCloseReg">–ó–∞–∫—Ä–∏—Ç–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é</button>
            </div>
            <div class="muted" id="toggleMsg" style="margin-top:10px;"></div>
          </div>

          <!-- –ñ–µ—Ä–µ–± -->
          <div class="admin-card admin-hidden" id="modDraw">
            <h2 class="section-title" style="margin:0 0 10px;">–ñ–µ—Ä–µ–±–∫—É–≤–∞–Ω–Ω—è</h2>
            <div class="muted">–ù–∞—Å—Ç—É–ø–Ω–∏–º –∫—Ä–æ–∫–æ–º –ø—ñ–¥–∫–ª—é—á–∏–º–æ: –∑–æ–Ω–∞/—Å–µ–∫—Ç–æ—Ä + –∫–æ–Ω—Ç—Ä–æ–ª—å –¥—É–±–ª—ñ–≤.</div>
            <div class="row">
              <button class="btn btn--accent" id="btnOpenDraw">–í—ñ–¥–∫—Ä–∏—Ç–∏ –º–æ–¥—É–ª—å –∂–µ—Ä–µ–±—É</button>
            </div>
          </div>

          <!-- –ó–≤–∞–∂—É–≤–∞–Ω–Ω—è -->
          <div class="admin-card admin-hidden" id="modWeigh">
            <h2 class="section-title" style="margin:0 0 10px;">–ó–≤–∞–∂—É–≤–∞–Ω–Ω—è</h2>
            <div class="muted">–ù–∞—Å—Ç—É–ø–Ω–∏–º –∫—Ä–æ–∫–æ–º: 1‚Äì4 –∑–≤–∞–∂—É–≤–∞–Ω–Ω—è, big fish, –∑–æ–Ω–∞ A/B/C.</div>
            <div class="row">
              <button class="btn btn--danger" id="btnOpenWeigh">–í—ñ–¥–∫—Ä–∏—Ç–∏ –º–æ–¥—É–ª—å –∑–≤–∞–∂—É–≤–∞–Ω—å</button>
            </div>
          </div>

          <!-- –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ -->
          <div class="admin-card admin-hidden" id="modUsers">
            <h2 class="section-title" style="margin:0 0 10px;">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ —Å–∞–π—Ç—É</h2>
            <div class="muted">–ö–æ–ª–µ–∫—Ü—ñ—è: <b>users</b> (–ø–æ–∫–∞–∑—É—î–º–æ –æ—Å—Ç–∞–Ω–Ω—ñ—Ö 50).</div>
            <div class="row">
              <button class="btn btn--primary" id="btnLoadUsers">–û–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫</button>
            </div>
            <div class="admin-list" id="usersList"></div>
          </div>

        </div>

      </div>
    </div>

  </section>
</main>

<!-- Firebase compat SDK (—â–æ–± —Ç–æ—á–Ω–æ –Ω–µ –±—É–ª–æ "SDK –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–≤—Å—è") -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
  // ====== –í–®–ò–¢–ò–ô –ê–î–ú–Ü–ù ======
  const ADMIN_UID = "5Dt6fN64c3aWACYV1WacxV2BHDl2";

  // –¢–≤—ñ–π Firebase config (—è–∫ —Ç–∏ –¥–∞–≤)
  const firebaseConfig = {
    apiKey: "AIzaSyBU7BSwGl0laDvHGhrvu14nJWpabsjSoNo",
    authDomain: "stolar-carp.firebaseapp.com",
    projectId: "stolar-carp",
    storageBucket: "stolar-carp.firebasestorage.app",
    messagingSenderId: "1019636788370",
    appId: "1:1019636788370:web:af1c1ecadb683df212ca4b",
    measurementId: "G-VWC07QNS7P"
  };

  // ===== helpers =====
  function $id(id){ return document.getElementById(id); }
  function setStatus(t){ const el=$id("adminStatus"); if(el) el.textContent=t; }
  function setHint(t){ const el=$id("adminHint"); if(el) el.textContent=t; }
  function esc(s){ return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  function showOnly(moduleId){
    const mods = ["modRegistrations","modCreate","modToggle","modDraw","modWeigh","modUsers"];
    mods.forEach(id => { const el=$id(id); if(el) el.classList.add("admin-hidden"); });
    const target = $id(moduleId);
    if(target) target.classList.remove("admin-hidden");
  }

  // ===== init firebase =====
  try{
    firebase.initializeApp(firebaseConfig);
  }catch(e){
    // —è–∫—â–æ –≤–∂–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ
  }
  const auth = firebase.auth();
  const db = firebase.firestore();

  // ===== access gate (–¢–û–õ–¨–ö–ò UID) =====
  setStatus("Auth: –ø–µ—Ä–µ–≤—ñ—Ä—è—é —Å–µ—Å—ñ—é‚Ä¶");
  auth.onAuthStateChanged(async (user) => {
    if(!user){
      setStatus("–¢–∏ –Ω–µ —É–≤—ñ–π—à–æ–≤ —è–∫ –∞–¥–º—ñ–Ω ‚Üí –ø–µ—Ä–µ–∫–∏–¥–∞—é –Ω–∞ /auth.html");
      location.href = "/auth.html";
      return;
    }

    if(user.uid !== ADMIN_UID){
      setStatus("–î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ ‚ùå (—Ü–µ –Ω–µ UID –∞–¥–º—ñ–Ω–∞)");
      // –º–æ–∂–Ω–∞ –∫–∏–Ω—É—Ç–∏ –Ω–∞ –≥–æ–ª–æ–≤–Ω—É
      setTimeout(()=> location.href="/", 600);
      return;
    }

    // ‚úÖ OK
    setStatus("–î–æ—Å—Ç—É–ø –¥–æ–∑–≤–æ–ª–µ–Ω–æ ‚úÖ (admin UID)");
    $id("adminApp").classList.remove("admin-hidden");

    // –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
    showOnly("modRegistrations");
    setHint("–ú–æ–¥—É–ª—å: –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –∫–æ–º–∞–Ω–¥ (–∑–∞—è–≤–∫–∏).");

    // bind buttons
    const bind = (id, fn) => { const b=$id(id); if(b) b.addEventListener("click", fn); };

    bind("btnLogout", async () => { await auth.signOut(); location.href="/"; });

    bind("btnCreateContest", () => { showOnly("modCreate"); setHint("–ú–æ–¥—É–ª—å: –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–º–∞–≥–∞–Ω–Ω—è."); });
    bind("btnToggleContest", () => { showOnly("modToggle"); setHint("–ú–æ–¥—É–ª—å: –í—ñ–¥–∫—Ä–∏—Ç–∏/–ó–∞–∫—Ä–∏—Ç–∏."); });
    bind("btnRegistrations", () => { showOnly("modRegistrations"); setHint("–ú–æ–¥—É–ª—å: –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –∫–æ–º–∞–Ω–¥ (–∑–∞—è–≤–∫–∏)."); loadRegistrations(); });
    bind("btnDraw", () => { showOnly("modDraw"); setHint("–ú–æ–¥—É–ª—å: –ñ–µ—Ä–µ–±–∫—É–≤–∞–Ω–Ω—è."); });
    bind("btnWeigh", () => { showOnly("modWeigh"); setHint("–ú–æ–¥—É–ª—å: –ó–≤–∞–∂—É–≤–∞–Ω–Ω—è."); });
    bind("btnUsers", () => { showOnly("modUsers"); setHint("–ú–æ–¥—É–ª—å: –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ —Å–∞–π—Ç—É."); });

    bind("btnLoadRegs", () => loadRegistrations());
    bind("btnLoadUsers", () => loadUsers());

    bind("btnOpenDraw", () => alert("–ñ–µ—Ä–µ–±–∫—É–≤–∞–Ω–Ω—è ‚Äî –ø—ñ–¥–∫–ª—é—á–∞—é –Ω–∞—Å—Ç—É–ø–Ω–∏–º –∫—Ä–æ–∫–æ–º (–∑–æ–Ω–∞/—Å–µ–∫—Ç–æ—Ä + –∫–æ–Ω—Ç—Ä–æ–ª—å –¥—É–±–ª—ñ–≤)."));
    bind("btnOpenWeigh", () => alert("–ó–≤–∞–∂—É–≤–∞–Ω–Ω—è ‚Äî –ø—ñ–¥–∫–ª—é—á–∞—é –Ω–∞—Å—Ç—É–ø–Ω–∏–º –∫—Ä–æ–∫–æ–º (1‚Äì4, big fish, –∑–æ–Ω–∏)."));

    // create contest
    bind("btnDoCreate", () => createContest());

    // toggle reg open/close
    bind("btnOpenReg", () => setRegistrationOpen(true));
    bind("btnCloseReg", () => setRegistrationOpen(false));

    // –∞–≤—Ç–æ–ø—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
    loadRegistrations().catch(()=>{});
  });

  // ====== MODULE: registrations ======
  async function loadRegistrations(){
    const box = $id("regsList");
    if(!box) return;
    box.innerHTML = '<div class="muted">–ó–∞–≤–∞–Ω—Ç–∞–∂—É—é‚Ä¶</div>';

    // —è–∫—â–æ createdAt —ñ–Ω–∫–æ–ª–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ–π ‚Äî Firestore –≤–ø–∞–¥–µ.
    // –¢–æ–º—É —Ä–æ–±–∏–º–æ "–º‚Äô—è–∫—à–µ": –ø—Ä–æ–±—É—î–º–æ –∑ orderBy, —è–∫—â–æ –ø–æ–º–∏–ª–∫–∞ ‚Äî –±–µ–∑ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è.
    let snap;
    try{
      snap = await db.collection("registrations").orderBy("createdAt","desc").limit(25).get();
    }catch(e){
      snap = await db.collection("registrations").limit(25).get();
    }

    if(snap.empty){
      box.innerHTML = '<div class="muted">–ó–∞—è–≤–æ–∫ –ø–æ–∫–∏ –Ω–µ–º–∞—î.</div>';
      return;
    }

    const items = [];
    snap.forEach(doc => {
      const d = doc.data() || {};
      const teamName = d.teamName || d.team || d.name || "–ö–æ–º–∞–Ω–¥–∞";
      const stageId = d.stageId || d.stage || "‚Äî";
      const pay = d.paymentStatus || d.payStatus || "pending";
      const pillClass = pay === "paid" ? "ok" : (pay === "rejected" ? "bad" : "warn");

      items.push(`
        <div class="item">
          <div class="item-top">
            <div><b>${esc(teamName)}</b> <span class="muted">‚Ä¢ stage: ${esc(stageId)}</span></div>
            <span class="pill ${pillClass}">${esc(pay)}</span>
          </div>
          <div class="muted" style="margin-top:6px;">id: ${esc(doc.id)}</div>
          <div class="row">
            <button class="btn btn--accent" onclick="approveReg('${esc(doc.id)}')">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –æ–ø–ª–∞—Ç—É</button>
            <button class="btn btn--danger" onclick="rejectReg('${esc(doc.id)}')">–í—ñ–¥—Ö–∏–ª–∏—Ç–∏</button>
          </div>
        </div>
      `);
    });

    box.innerHTML = items.join("");
  }

  window.approveReg = async function(regId){
    await db.collection("registrations").doc(regId).update({
      paymentStatus: "paid",
      approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
      approvedBy: ADMIN_UID
    });
    loadRegistrations();
  };

  window.rejectReg = async function(regId){
    await db.collection("registrations").doc(regId).update({
      paymentStatus: "rejected",
      rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
      rejectedBy: ADMIN_UID
    });
    loadRegistrations();
  };

  // ====== MODULE: users ======
  async function loadUsers(){
    const box = $id("usersList");
    if(!box) return;
    box.innerHTML = '<div class="muted">–ó–∞–≤–∞–Ω—Ç–∞–∂—É—é‚Ä¶</div>';

    let snap;
    try{
      snap = await db.collection("users").orderBy("createdAt","desc").limit(50).get();
    }catch(e){
      snap = await db.collection("users").limit(50).get();
    }

    if(snap.empty){
      box.innerHTML = '<div class="muted">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –ø–æ–∫–∏ –Ω–µ–º–∞—î.</div>';
      return;
    }

    const items = [];
    snap.forEach(doc => {
      const d = doc.data() || {};
      items.push(`
        <div class="item">
          <div class="item-top">
            <div><b>${esc(d.fullName || d.name || "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á")}</b> <span class="muted">‚Ä¢ ${esc(d.email || "‚Äî")}</span></div>
            <span class="pill ${doc.id===ADMIN_UID ? "ok":"warn"}">${doc.id===ADMIN_UID ? "admin(uid)" : esc(d.role || "user")}</span>
          </div>
          <div class="muted" style="margin-top:6px;">uid: ${esc(doc.id)} ${d.teamId ? " ‚Ä¢ teamId: " + esc(d.teamId) : ""}</div>
        </div>
      `);
    });

    box.innerHTML = items.join("");
  }

  // ====== MODULE: create contest ======
  async function createContest(){
    const seasonId = ($id("inpSeasonId").value || "").trim();
    const seasonName = ($id("inpSeasonName").value || "").trim();
    const stageId = ($id("inpStageId").value || "").trim();
    const stageName = ($id("inpStageName").value || "").trim();
    const regOpen = ($id("inpRegOpen").value === "true");

    const msg = $id("createMsg");
    if(!seasonId || !seasonName){
      msg.textContent = "‚ùå –ó–∞–ø–æ–≤–Ω–∏ seasonId —ñ –Ω–∞–∑–≤—É —Å–µ–∑–æ–Ω—É.";
      return;
    }

    msg.textContent = "‚è≥ –ü–∏—à—É –≤ Firestore‚Ä¶";

    // seasons/{seasonId}
    await db.collection("seasons").doc(seasonId).set({
      name: seasonName,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge:true });

    // seasons/{seasonId}/stages/{stageId} (—è–∫—â–æ –≤–∫–∞–∑–∞–Ω–æ)
    if(stageId && stageName){
      await db.collection("seasons").doc(seasonId)
        .collection("stages").doc(stageId)
        .set({
          name: stageName,
          seasonId,
          registrationOpen: regOpen,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
    }

    // settings/app
    await db.collection("settings").doc("app").set({
      activeSeasonId: seasonId,
      activeStageId: stageId || null,
      registrationOpen: regOpen,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge:true });

    msg.textContent = "‚úÖ –ì–æ—Ç–æ–≤–æ. –ê–∫—Ç–∏–≤–Ω–∏–π —Å–µ–∑–æ–Ω/–µ—Ç–∞–ø –∑–±–µ—Ä–µ–∂–µ–Ω–æ –≤ settings/app.";
  }

  // ====== MODULE: open/close ======
  async function setRegistrationOpen(open){
    const el = $id("toggleMsg");
    el.textContent = "‚è≥ –û–Ω–æ–≤–ª—é—é settings/app‚Ä¶";
    await db.collection("settings").doc("app").set({
      registrationOpen: !!open,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge:true });
    el.textContent = open ? "‚úÖ –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—é –í–Ü–î–ö–†–ò–¢–û" : "‚úÖ –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—é –ó–ê–ö–†–ò–¢–û";
  }
</script>

</body>
  </html>
