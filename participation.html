<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#020617">
  <meta name="msapplication-navbutton-color" content="#020617">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <title>STOLAR CARP ‚Ä¢ –£—á–∞—Å–Ω–∏–∫–∏ –∑–º–∞–≥–∞–Ω–Ω—è</title>

  <link rel="stylesheet" href="assets/css/main.css">

  <style>
    /* –±–∞–∑–∞ */
    body{ background:#020617; }
    .wrap{ max-width:980px; margin:0 auto; padding:18px 12px 80px; }

    /* header */
    .header{
      position:sticky; top:0; z-index:20;
      backdrop-filter: blur(10px);
      background: rgba(2,6,23,.65);
      border-bottom: 1px solid rgba(148,163,184,.12);
      padding:10px 12px;
    }
    .headerInner{ max-width:980px; margin:0 auto; display:flex; align-items:center; }

    .btnBack{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:14px;
      text-decoration:none;
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(15,23,42,.55);
    }

    /* –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
    .pageTitle{
      margin:18px 0 8px;
      text-align:center;
      font-weight:950;
      letter-spacing:.6px;
      line-height:1.15;
      font-size:1.9rem;
      background:linear-gradient(90deg,#facc15 0%, #7f1d1d 100%);
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
      -webkit-text-fill-color:transparent;
    }
    .pageSub{
      text-align:center;
      color:#94a3b8;
      font-weight:800;
      margin-bottom:14px;
    }

    /* —Å–ø–∏—Å–æ–∫ */
    .list{
      margin-top:8px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .row{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 4px;
      border-bottom:1px solid rgba(148,163,184,.16);
      cursor:pointer;
      transition:background .2s;
      border-radius:8px;
    }
    .row:hover{
      background:rgba(250,204,21,.05);
    }

    .lamp{
      width:10px; height:10px; border-radius:999px;
      flex:0 0 10px;
      box-shadow: 0 0 0 3px rgba(255,255,255,.03);
    }
    .lamp--green{ background:#22c55e; }
    .lamp--red{ background:#ef4444; }

    .idx{
      width:32px;
      text-align:right;
      color:#94a3b8;
      font-weight:900;
      flex:0 0 32px;
    }

    .name{
      flex:1;
      min-width:0;
      color:#e5e7eb;
      font-weight:900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .status{
      flex:0 0 auto;
      font-weight:900;
      white-space:nowrap;
      color:#94a3b8;
    }
    .status--paid{ color:#22c55e; }
    .status--unpaid{ color:#ef4444; }

    .mutedCenter{
      text-align:center;
      color:#94a3b8;
      font-weight:800;
      margin-top:14px;
    }
    .dividerLabel{
      margin-top:14px;
      color:#94a3b8;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:.08em;
      font-size:.85rem;
    }

    /* === POPUP –°–ö–õ–ê–î–£ –ö–û–ú–ê–ù–î–ò === */
    #teamPopup{
      display:none;
      position:fixed;
      left:0;
      top:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.9);
      backdrop-filter:blur(6px);
      z-index:9999;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    #teamPopupContent{
      background:#0f172a;
      border-radius:18px;
      border:1px solid #1f2937;
      max-width:500px;
      width:100%;
      max-height:80vh;
      overflow-y:auto;
      box-shadow:0 25px 50px rgba(0,0,0,.8);
    }
    #teamPopupHeader{
      padding:16px;
      border-bottom:1px solid #1f2937;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    #teamPopupTitle{
      font-size:1.1rem;
      font-weight:800;
      color:#facc15;
    }
    #teamPopupClose{
      background:none;
      border:none;
      color:#94a3b8;
      font-size:1.5rem;
      cursor:pointer;
      padding:0;
      width:32px;
      height:32px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:8px;
      transition:all .2s;
    }
    #teamPopupClose:hover{
      background:#1f2937;
      color:#e5e7eb;
    }
    #teamPopupBody{
      padding:16px;
    }
    .team-member{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 0;
      border-bottom:1px solid #1f2937;
    }
    .team-member:last-child{
      border-bottom:none;
    }
    .member-avatar{
      width:50px;
      height:50px;
      border-radius:50%;
      overflow:hidden;
      border:2px solid #facc15;
      flex-shrink:0;
    }
    .member-avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .member-avatar-placeholder{
      width:100%;
      height:100%;
      background:#1f2937;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:20px;
    }
    .member-info{
      flex:1;
    }
    .member-name{
      font-weight:800;
      color:#e5e7eb;
      margin-bottom:2px;
    }
    .member-role{
      font-size:.8rem;
      color:#94a3b8;
    }
    .team-loading{
      text-align:center;
      color:#94a3b8;
      padding:20px;
    }
    /* === –ö–Ü–ù–ï–¶–¨ POPUP === */
  </style>
</head>

<body>
  <header class="header">
    <div class="headerInner">
      <a href="cabinet.html" class="btnBack">‚Üê –ù–∞–∑–∞–¥</a>
    </div>
  </header>

  <main class="wrap">
    <h1 id="pageTitle" class="pageTitle">–ó–º–∞–≥–∞–Ω–Ω—è</h1>
    <div id="pageSub" class="pageSub"></div>

    <div id="teamsList" class="list"></div>
    <div id="msg" class="mutedCenter"></div>
  </main>

  // === POPUP –°–ö–õ–ê–î–£ –ö–û–ú–ê–ù–î–ò ===
async function openTeamPopup(teamName, teamId) {
  const popup = $("teamPopup");
  const title = $("teamPopupTitle");
  const body = $("teamPopupBody");

  if (!popup || !title || !body) return;

  title.textContent = teamName || "–ö–æ–º–∞–Ω–¥–∞";
  body.innerHTML = '<div class="team-loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–∫–ª–∞–¥—É‚Ä¶</div>';
  popup.style.display = "flex";

  try {
    const db = window.scDb;

    // 1. –î–∞–Ω—ñ –∫–æ–º–∞–Ω–¥–∏
    const teamSnap = await db.collection("teams").doc(teamId).get();
    if (!teamSnap.exists) {
      body.innerHTML = '<div class="team-loading">–ö–æ–º–∞–Ω–¥—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>';
      return;
    }

    const team = teamSnap.data();
    const ownerUid = team.ownerUid || null;

    let members = [];
    const used = new Set();

    // 2. –û—Å–Ω–æ–≤–Ω–∏–π –ø–æ—à—É–∫ ‚Äî –≤—Å—ñ user –∑ —Ü—ñ—î—é –∫–æ–º–∞–Ω–¥–æ—é
    try {
      const usersSnap = await db.collection("users")
        .where("teamId", "==", teamId)
        .get();

      usersSnap.forEach(doc => {
        const d = doc.data();
        members.push({
          id: doc.id,
          fullName: d.fullName || d.displayName || d.email || "–£—á–∞—Å–Ω–∏–∫",
          role: d.role || "member",
          avatarUrl: d.avatarUrl || d.photoURL || null
        });
        used.add(doc.id);
      });
    } catch (err) {
      console.error("–ü–æ–º–∏–ª–∫–∞ –ø–æ—à—É–∫—É users.teamId:", err);
    }

    // 3. –Ø–∫—â–æ –∫–∞–ø—ñ—Ç–∞–Ω–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ —Å–µ—Ä–µ–¥ members ‚Üí –¥–æ–¥–∞—î–º–æ –æ–∫—Ä–µ–º–æ
    if (ownerUid && !used.has(ownerUid)) {
      const cSnap = await db.collection("users").doc(ownerUid).get();
      if (cSnap.exists) {
        const c = cSnap.data();
        members.push({
          id: ownerUid,
          fullName: c.fullName || c.displayName || c.email || "–ö–∞–ø—ñ—Ç–∞–Ω",
          role: "captain",
          avatarUrl: c.avatarUrl || c.photoURL || null
        });
        used.add(ownerUid);
      }
    }

    // 4. –Ø–∫—â–æ –≤–∑–∞–≥–∞–ª—ñ –Ω—ñ–∫–æ–≥–æ –Ω–µ–º–∞—î ‚Üí fallback
    if (members.length === 0) {
      body.innerHTML = '<div class="team-loading">–°–∫–ª–∞–¥ –∫–æ–º–∞–Ω–¥–∏ –ø–æ—Ä–æ–∂–Ω—ñ–π</div>';
      return;
    }

    // 5. –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è: –∫–∞–ø—ñ—Ç–∞–Ω –∑–≤–µ—Ä—Ö—É
    members.sort((a, b) => {
      const aCap = a.role === "captain" || a.id === ownerUid;
      const bCap = b.role === "captain" || b.id === ownerUid;
      if (aCap && !bCap) return -1;
      if (bCap && !aCap) return 1;
      return (a.fullName || "").localeCompare(b.fullName || "");
    });

    // 6. –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
    body.innerHTML = members.map(m => {
      const avatarHtml = m.avatarUrl
        ? `<div class="member-avatar"><img src="${esc(m.avatarUrl)}" alt=""></div>`
        : `<div class="member-avatar"><div class="member-avatar-placeholder">üë§</div></div>`;

      return `
        <div class="team-member">
          ${avatarHtml}
          <div class="member-info">
            <div class="member-name">${esc(m.fullName)}</div>
            <div class="member-role">${m.role === "captain" ? "‚≠ê –ö–∞–ø—ñ—Ç–∞–Ω" : "–£—á–∞—Å–Ω–∏–∫"}</div>
          </div>
        </div>
      `;
    }).join('');

  } catch (err) {
    console.error("üí• –ü–æ–º–∏–ª–∫–∞ –≤ openTeamPopup:", err);
    body.innerHTML = `<div class="team-loading">–ü–æ–º–∏–ª–∫–∞: ${esc(err.message)}</div>`;
  }
}

  <!-- Firebase compat CDN -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script src="assets/js/firebase-init.js"></script>
  <script src="assets/js/participation.js"></script>
</body>
</html>
