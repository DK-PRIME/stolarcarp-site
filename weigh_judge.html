<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>STOLAR CARP ‚Ä¢ –°—É–¥–¥—è ‚Ä¢ –ó–≤–∞–∂—É–≤–∞–Ω–Ω—è</title>

  <link rel="stylesheet" href="assets/css/main.css" />

  <style>
    body{ background:#020617; }
    .wrap{ max-width:980px; margin:0 auto; padding:20px 0 80px; }
    .card{
      background:rgba(15,23,42,.92);
      border:1px solid rgba(148,163,184,.30);
      border-radius:16px;
      padding:16px;
      margin-bottom:12px;
    }
    .muted{ color:#9ca3af; }
    .ok{ color:#8fe39a; }
    .err{ color:#ff6c6c; }
    .big{ font-size:1.35rem; font-weight:900; }
    .kv{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:.9rem; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(148,163,184,.25);
      background:rgba(2,6,23,.35);
      color:#e5e7eb; font-size:.82rem; white-space:nowrap;
    }

    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .rowTop{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap:wrap; }

    .wbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
      margin-top:12px;
      padding:10px;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(2,6,23,.25);
      border-radius:14px;
    }
    .wBtns{ display:flex; gap:8px; flex-wrap:wrap; }
    .wbtn{
      border:1px solid rgba(148,163,184,.25);
      background:rgba(2,6,23,.25);
      color:#e5e7eb;
      border-radius:999px;
      padding:8px 12px;
      font-weight:900;
      font-size:.9rem;
      cursor:pointer;
      user-select:none;
    }
    .wbtn.isActive{
      border-color: rgba(246,195,76,.55);
      box-shadow: 0 0 0 3px rgba(246,195,76,.14);
      background: rgba(246,195,76,.10);
      color:#fff;
    }
    .wbtn:disabled{
      opacity:.45;
      cursor:not-allowed;
    }
    .wstat{ text-align:right; }
    .wstat .big2{ font-size:1.1rem; font-weight:900; }

    .callItem{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(2,6,23,.22);
      border-radius:12px;
      padding:10px;
      margin-top:8px;
    }
    .callLine{ font-size:1.0rem; }
    .callActions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }

    .teams{
      display:grid;
      gap:10px;
      margin-top:10px;
    }
    .teamRow{
      border:1px solid rgba(148,163,184,.22);
      background:rgba(2,6,23,.22);
      border-radius:14px;
      padding:12px;
    }
    .teamHead{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .teamTitle{
      font-weight:900;
      font-size:1.05rem;
      line-height:1.2;
    }
    .teamMeta{ color:#9ca3af; font-size:.9rem; }

    .inp{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(2,6,23,.55);
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,.28);
      outline:none;
      font-weight:800;
    }
    .inp:focus{
      border-color:var(--accent);
      box-shadow:0 0 10px rgba(246,195,76,.25);
    }

    .teamBtns{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
      justify-content:flex-end;
    }

    .miniBadge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border-radius:999px;
      padding:6px 10px;
      border:1px solid rgba(148,163,184,.20);
      background:rgba(2,6,23,.20);
      color:#e5e7eb;
      font-size:.82rem;
      white-space:nowrap;
    }
    .dot{
      width:8px;height:8px;border-radius:999px;
      background:rgba(34,197,94,.95);
      box-shadow:0 0 0 3px rgba(34,197,94,.12);
      display:inline-block;
    }

    /* ==== Fish tiles (–≤–Ω–µ—Å–µ–Ω–Ω—è –∫–æ–∂–Ω–æ—ó —Ä–∏–±–∏ –æ–∫—Ä–µ–º–æ) ==== */
    .fishGrid{
      display:grid;
      grid-template-columns: 1fr 1fr auto;
      gap:10px;
      align-items:center;
    }
    @media (max-width:720px){
      .fishGrid{ grid-template-columns: 1fr auto; }
    }
    .fishTile{ position:relative; }
    .fishInp{ padding-right:44px; }
    .fishDel{
      position:absolute;
      right:10px;
      top:50%;
      transform:translateY(-50%);
      width:30px;height:30px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.25);
      background:rgba(2,6,23,.35);
      color:#e5e7eb;
      font-weight:900;
      cursor:pointer;
    }
    .fishDel:disabled{ opacity:.45; cursor:not-allowed; }
    .fishAdd{
      width:44px;height:44px;
      border-radius:14px;
      border:1px solid rgba(246,195,76,.35);
      background:rgba(246,195,76,.18);
      color:#fff;
      font-weight:900;
      font-size:20px;
      cursor:pointer;
    }
    .fishAdd:disabled{ opacity:.45; cursor:not-allowed; }
  </style>
</head>

<body>
<header class="header">
  <div class="container header__row">
    <a class="logo" href="index.html">
      <span class="logo__mark">SC</span>
      <span class="logo__text">STOLAR CARP</span>
    </a>
    <div class="pill" id="authPill">auth: ‚Ä¶</div>
  </div>
</header>

<main class="main">
  <section class="section container wrap">

    <div class="card">
      <div class="rowTop">
        <div>
          <div class="big" id="zoneTitle">–ó–æ–Ω–∞ ‚Äî</div>
          <div class="muted" id="status">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</div>
        </div>
        <div class="miniBadge" id="netBadge" style="display:none;"><span class="dot"></span> realtime</div>
      </div>

      <div class="muted" style="margin-top:10px;">
        <div><b>–ü—Ä–∏–≤‚Äô—è–∑–∫–∞ –ø—Ä–∏—Å—Ç—Ä–æ—é:</b></div>
        <div class="kv" id="bindInfo">‚Äî</div>
      </div>

      <div class="btnRow">
        <button class="btn btn--primary" id="btnOpen">–í—ñ–¥–∫—Ä–∏—Ç–∏ –º–æ—é –∑–æ–Ω—É</button>
        <button class="btn btn--ghost" id="btnSaveHint">–Ø–∫ –∑–±–µ—Ä–µ–≥—Ç–∏ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω</button>
        <button class="btn btn--danger" id="btnReset">–°–∫–∏–Ω—É—Ç–∏ –ø—Ä–∏–≤‚Äô—è–∑–∫—É</button>
      </div>

      <div class="muted" id="msg" style="margin-top:10px;"></div>
    </div>

    <div class="card" id="weighCard" style="display:none;">
      <div class="rowTop">
        <div>
          <div style="font-weight:900;font-size:1.1rem;">–ó–≤–∞–∂—É–≤–∞–Ω–Ω—è</div>
          <div class="muted" id="wHelp">–ü–æ—Ç–æ—á–Ω–µ W –ø–µ—Ä–µ–º–∏–∫–∞—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ, –∫–æ–ª–∏ –≤—Å—ñ –∫–æ–º–∞–Ω–¥–∏ —Ç–≤–æ—î—ó –∑–æ–Ω–∏ –∑–¥–∞–Ω—ñ.</div>
        </div>
        <div class="muted" id="teamsCount">‚Äî</div>
      </div>

      <div class="wbar">
        <div class="wBtns">
          <button class="wbtn" id="w1">W1</button>
          <button class="wbtn" id="w2">W2</button>
          <button class="wbtn" id="w3">W3</button>
          <button class="wbtn" id="w4">W4</button>
        </div>
        <div class="wstat">
          <div class="muted">–ü–æ—Ç–æ—á–Ω–µ</div>
          <div class="big2" id="curW">W‚Äî</div>
        </div>
      </div>

      <div class="muted" id="wMsg" style="margin-top:10px;"></div>

      <div style="margin-top:12px; font-weight:900;">–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –º–æ—î—ó –∑–æ–Ω–∏</div>
      <div class="muted" id="callsCount" style="margin-top:6px;">‚Äî</div>
      <div id="callsList"></div>
      <div class="muted" id="callsEmpty" style="margin-top:8px;">‚Äî</div>

      <div style="margin-top:14px; font-weight:900;">–ö–æ–º–∞–Ω–¥–∏ –º–æ—î—ó –∑–æ–Ω–∏</div>
      <div class="muted" id="teamsHint" style="margin-top:6px;">–°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è: —Å–µ–∫—Ç–æ—Ä ‚Üí —á–∞—Å.</div>

      <div class="teams" id="teamsBox"></div>
    </div>

  </section>
</main>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="assets/js/firebase-init.js"></script>

<script>
(function(){
  "use strict";

  const LS_KEY = "sc_judge_bind_v1";
  const ADMIN_UID = "5Dt6fN64c3aWACYV1WacxV2BHDl2";
  const DEFAULT_MAX_W = 4;

  const zoneTitle = document.getElementById("zoneTitle");
  const statusEl  = document.getElementById("status");
  const bindInfo  = document.getElementById("bindInfo");
  const msgEl     = document.getElementById("msg");
  const authPill  = document.getElementById("authPill");

  const btnOpen   = document.getElementById("btnOpen");
  const btnReset  = document.getElementById("btnReset");
  const btnSaveHint = document.getElementById("btnSaveHint");

  const weighCard = document.getElementById("weighCard");
  const wMsgEl = document.getElementById("wMsg");
  const curWEl = document.getElementById("curW");
  const teamsCountEl = document.getElementById("teamsCount");
  const teamsBox = document.getElementById("teamsBox");

  const callsCountEl = document.getElementById("callsCount");
  const callsListEl  = document.getElementById("callsList");
  const callsEmptyEl = document.getElementById("callsEmpty");
  const netBadge = document.getElementById("netBadge");

  const wBtns = [
    { n:1, el: document.getElementById("w1") },
    { n:2, el: document.getElementById("w2") },
    { n:3, el: document.getElementById("w3") },
    { n:4, el: document.getElementById("w4") },
  ];

  let auth = null;
  let db = null;
  let me = null;

  let stageId  = "";
  let compId   = "";
  let zone     = "";
  let token    = "";

  let activeKey = "";

  let maxW = DEFAULT_MAX_W;
  let currentW = 1;
  let viewW = 1;

  let unsubCalls = null;
  let lastOpenIds = new Set();

  function setMsg(t, ok=true){
    msgEl.textContent = t || "";
    msgEl.className = "muted " + (t ? (ok ? "ok":"err") : "");
  }
  function setWMsg(t, ok=true){
    wMsgEl.textContent = t || "";
    wMsgEl.className = "muted " + (t ? (ok ? "ok":"err") : "");
  }
  function norm(v){ return String(v ?? "").trim(); }
  function esc(s){ return String(s ?? "").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

  async function waitFirebase(){
    for(let i=0;i<140;i++){
      if(window.scAuth && window.scDb && window.firebase) return;
      await new Promise(r=>setTimeout(r,100));
    }
    throw new Error("Firebase init –Ω–µ –ø—ñ–¥–Ω—è–≤ scAuth/scDb.");
  }

  async function requireJudgeOrAdmin(user){
    if(!user) return false;
    if(user.uid === ADMIN_UID) return true;
    const snap = await db.collection("users").doc(user.uid).get();
    const role = (snap.exists ? (snap.data()||{}).role : "") || "";
    return role === "judge" || role === "admin";
  }

  function readBind(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      return raw ? JSON.parse(raw) : null;
    }catch{ return null; }
  }
  function writeBind(data){
    try{ localStorage.setItem(LS_KEY, JSON.stringify(data)); return true; }
    catch{ return false; }
  }
  function clearBind(){
    try{ localStorage.removeItem(LS_KEY); }catch{}
  }

  function currentParams(){
    const p = new URLSearchParams(location.search);
    const z   = norm((p.get("zone")||"").toUpperCase());
    const cId = norm(p.get("compId")||"");
    const sId = norm(p.get("stageId")||""); // –º–æ–∂–µ –±—É—Ç–∏ –ø—É—Å—Ç–∏–π => main
    const t   = norm(p.get("t")||"");
    return { zone:z, compId:cId, stageId:sId, token:t };
  }

  function buildUrlFromBind(b){
    const p = new URLSearchParams();
    p.set("zone", b.zone);
    p.set("compId", b.compId);
    if (b.stageId) p.set("stageId", b.stageId);
    p.set("t", b.token);
    return location.origin + location.pathname + "?" + p.toString();
  }

  function makeActiveKey(compId, stageId){
    return `${String(compId||"").trim()}||${String(stageId||"").trim() || "main"}`;
  }

  function renderBindState(){
    const bind = readBind();
    if (!bind){
      zoneTitle.textContent = "–ó–æ–Ω–∞ ‚Äî";
      statusEl.textContent = "‚ùó –ù–µ–º–∞ –ø—Ä–∏–≤‚Äô—è–∑–∫–∏. –í—ñ–¥–∫—Ä–∏–π QR/–ª—ñ–Ω–∫ –≤—ñ–¥ –∞–¥–º—ñ–Ω–∞ –æ–¥–∏–Ω —Ä–∞–∑ ‚Äî —ñ –∑–æ–Ω–∞ –∑–±–µ—Ä–µ–∂–µ—Ç—å—Å—è.";
      bindInfo.textContent = "‚Äî";
      return;
    }
    const ak = makeActiveKey(bind.compId, bind.stageId);
    zoneTitle.textContent = `–ó–æ–Ω–∞ ${bind.zone}`;
    statusEl.textContent = "‚úÖ –ü—Ä–∏–≤‚Äô—è–∑–∫–∞ –∑–æ–Ω–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–∞ –Ω–∞ —Ü—å–æ–º—É —Ç–µ–ª–µ—Ñ–æ–Ω—ñ.";
    bindInfo.textContent = `zone=${bind.zone} | compId=${bind.compId} | stageId=${bind.stageId || "main"} | activeKey=${ak}`;
  }

  function settingsDocIdByActiveKey(activeKey){
    return `weighing_${activeKey}`;
  }

  async function getOrCreateWeighingSettings(){
    const ref = db.collection("settings").doc(settingsDocIdByActiveKey(activeKey));
    const snap = await ref.get();
    if(snap.exists) return { ref, data:(snap.data()||{}) };

    const init = {
      activeKey,
      compId,
      stageId: stageId || "main",
      maxW: DEFAULT_MAX_W,
      current: { A:1, B:1, C:1 },
      updatedAt: window.firebase.firestore.FieldValue.serverTimestamp()
    };
    await ref.set(init, { merge:true });
    return { ref, data:init };
  }

  function getCurrentWForZone(settingsData){
    const cur = settingsData.current || {};
    const w = Number(cur[zone] || 1);
    return Math.min(Math.max(w,1), Number(settingsData.maxW || DEFAULT_MAX_W));
  }

  async function setCurrentWForZone(nextW){
    const ref = db.collection("settings").doc(settingsDocIdByActiveKey(activeKey));
    await db.runTransaction(async (tx)=>{
      const snap = await tx.get(ref);
      const d = snap.data() || {};
      const mW = Number(d.maxW || DEFAULT_MAX_W);
      const cur = Object.assign({A:1,B:1,C:1}, d.current || {});
      const safe = Math.min(Math.max(Number(nextW||1),1), mW);
      cur[zone] = safe;
      tx.set(ref, {
        current: cur,
        updatedAt: window.firebase.firestore.FieldValue.serverTimestamp()
      }, { merge:true });
    });
  }

  function updateWButtons(){
    curWEl.textContent = `W${currentW}`;
    wBtns.forEach(b=>{
      b.el.classList.toggle("isActive", b.n === viewW);
      b.el.disabled = (b.n > currentW);
    });
  }

  async function loadTeamsForZone(){
    const srSnap = await db.collection("stageResults").doc(activeKey).get();
    const sr = srSnap.exists ? (srSnap.data()||{}) : {};
    const teams = Array.isArray(sr.teams) ? sr.teams : [];

    const arr = teams
      .filter(t => String(t.drawZone||"").toUpperCase() === String(zone||"").toUpperCase())
      .map(t => ({
        teamId: String(t.regId || t.teamId || ""),
        teamName: String(t.teamName || ""),
        sector: Number(t.drawSector || 0)
      }))
      .filter(x => x.teamId);

    arr.sort((a,b)=> (a.sector||0)-(b.sector||0) || (a.teamName||"").localeCompare(b.teamName||"", "uk"));
    return arr;
  }

  function weighingDocId(teamId, wNo){
    return `${activeKey}_${zone}_${teamId}_W${wNo}`;
  }

  async function loadWeighing(teamId, wNo){
    const id = weighingDocId(teamId, wNo);
    const snap = await db.collection("weighings").doc(id).get();
    return snap.exists ? (snap.data()||null) : null;
  }

  async function saveWeighing(team, wNo, values){
    const id = weighingDocId(team.teamId, wNo);
    const ts = window.firebase.firestore.FieldValue.serverTimestamp();

    await db.collection("weighings").doc(id).set({
      activeKey,
      compId,
      stageId: stageId || "main",

      zone,
      sector: Number(team.sector || 0),

      wNo: Number(wNo),
      teamId: team.teamId,
      teamName: team.teamName || "",

      // ‚úÖ –≤–∞–≥–∏ –∫–æ–∂–Ω–æ—ó —Ä–∏–±–∏
      fishWeights: Array.isArray(values.fishWeights) ? values.fishWeights : [],

      // ‚úÖ –∞–≤—Ç–æ–ø–æ–ª—è (—Ä–∞—Ö—É—é—Ç—å—Å—è –∑ fishWeights)
      fishCount: Number(values.fishCount || 0),
      totalWeightKg: Number(values.totalWeightKg || 0),
      bigFishKg: Number(values.bigFishKg || 0),

      status: "submitted",

      judgeUid: me.uid,
      judgeEmail: me.email || "",

      updatedAt: ts,
      createdAt: ts
    }, { merge: true });
  }

  async function maybeAdvanceAuto(teams){
    if(currentW >= maxW) return false;
    if(!teams.length) return false;

    const wsnap = await db.collection("weighings")
      .where("activeKey","==",activeKey)
      .where("zone","==",zone)
      .where("wNo","==",Number(currentW))
      .where("status","==","submitted")
      .get();

    const got = new Set();
    wsnap.forEach(doc=>{
      const d = doc.data() || {};
      if(d.teamId) got.add(String(d.teamId));
    });

    for(const t of teams){
      if(!got.has(String(t.teamId))) return false;
    }

    await setCurrentWForZone(currentW + 1);
    return true;
  }

  function reasonLabel(code){
    return ({
      "AMUR_2": "2 –∞–º—É—Ä–∏",
      "FISH_10PLUS": "–†–∏–±–∞ 10+",
      "BAGS_10": "10 –º—ñ—à–∫—ñ–≤",
      "SICK_FISH": "–ü–æ–≥–∞–Ω–∏–π —Å—Ç–∞–Ω —Ä–∏–±–∏",
      "OTHER_TEAM_VIOLATION": "–ü–æ—Ä—É—à–µ–Ω–Ω—è —ñ–Ω—à–æ—ó –∫–æ–º–∞–Ω–¥–∏"
    })[code] || code || "‚Äî";
  }

  function playPing(){
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.frequency.value = 880;
      g.gain.value = 0.04;
      o.start();
      setTimeout(()=>{ o.stop(); ctx.close(); }, 120);
    }catch(e){}
    try{ if(navigator.vibrate) navigator.vibrate([120, 80, 120]); }catch(e){}
  }

  function renderCallItem(id, d){
    const z = esc(String(d.zone||"").toUpperCase());
    const s = (d.sector!==undefined && d.sector!==null) ? String(d.sector) : "‚Äî";
    const team = esc(d.teamName || d.teamId || "‚Äî");
    const reason = esc(reasonLabel(d.reason));
    const line = `<span class="callLine"><b>${z}${s}</b> | <b>${team}</b> | <b>${reason}</b></span>`;

    return `
      <div class="callItem">
        <div>${line}</div>
        <div class="callActions">
          <button class="btn btn--primary" data-ack="${id}">–û—Ç—Ä–∏–º–∞–≤</button>
          <button class="btn btn--ghost" data-warn="${id}" data-kind="verbal">–£—Å–Ω–µ</button>
          <button class="btn btn--accent" data-warn="${id}" data-kind="yellow">–ñ–æ–≤—Ç–∞</button>
          <button class="btn btn--danger" data-warn="${id}" data-kind="red">–ß–µ—Ä–≤–æ–Ω–∞</button>
        </div>
      </div>
    `;
  }

  async function createPenaltyFromCall(callId, callData, kind){
    await db.collection("penalties").add({
      activeKey,
      compType: "series",

      compId,
      stageId: stageId || "main",

      zone: String(callData.zone||zone),
      sector: Number(callData.sector||0),
      teamId: String(callData.teamId||""),
      teamName: String(callData.teamName||""),

      kind: String(kind||"verbal"),
      reason: String(callData.reason||""),

      judgeUid: me.uid,
      createdAt: window.firebase.firestore.FieldValue.serverTimestamp()
    });

    await db.collection("calls").doc(callId).set({
      status: "done",
      judgeUid: me.uid,
      doneAt: window.firebase.firestore.FieldValue.serverTimestamp()
    }, { merge:true });
  }

  function setupCallsRealtime(){
    if(unsubCalls) try{ unsubCalls(); }catch(e){}
    lastOpenIds = new Set();

    const q = db.collection("calls")
      .where("activeKey","==",activeKey)
      .where("zone","==",zone)
      .where("status","==","open");

    netBadge.style.display = "inline-flex";

    unsubCalls = q.onSnapshot((snap)=>{
      const items = [];
      snap.forEach(doc=> items.push({ id: doc.id, d: doc.data()||{} }));

      items.sort((a,b)=>{
        const sa = Number(a.d.sector||0), sb = Number(b.d.sector||0);
        if(sa!==sb) return sa-sb;
        const ta = (a.d.createdAt && a.d.createdAt.toMillis) ? a.d.createdAt.toMillis() : 0;
        const tb = (b.d.createdAt && b.d.createdAt.toMillis) ? b.d.createdAt.toMillis() : 0;
        return ta-tb;
      });

      callsCountEl.textContent = `–ù–æ–≤–∏—Ö: ${items.length}`;
      if(!items.length){
        callsListEl.innerHTML = "";
        callsEmptyEl.textContent = "–ù–µ–º–∞ –≤–∏–∫–ª–∏–∫—ñ–≤.";
      }else{
        callsEmptyEl.textContent = "";
        callsListEl.innerHTML = items.map(x=>renderCallItem(x.id, x.d)).join("");
      }

      const cur = new Set(items.map(x=>x.id));
      let newOnes = 0;
      for(const id of cur){
        if(!lastOpenIds.has(id)) newOnes++;
      }
      if(newOnes>0) playPing();
      lastOpenIds = cur;
    }, async (err)=>{
      console.error(err);
      callsEmptyEl.textContent = "–ü–æ–º–∏–ª–∫–∞ realtime (Rules/—ñ–Ω–¥–µ–∫—Å–∏). –ü–æ–∫–∞–∑—É—é –±–µ–∑ realtime‚Ä¶";
      await loadCallsOnceFallback();
    });
  }

  async function loadCallsOnceFallback(){
    try{
      const snap = await db.collection("calls")
        .where("activeKey","==",activeKey)
        .where("zone","==",zone)
        .where("status","==","open")
        .get();

      const items = [];
      snap.forEach(doc=> items.push({ id: doc.id, d: doc.data()||{} }));

      items.sort((a,b)=>{
        const sa = Number(a.d.sector||0), sb = Number(b.d.sector||0);
        if(sa!==sb) return sa-sb;
        const ta = (a.d.createdAt && a.d.createdAt.toMillis) ? a.d.createdAt.toMillis() : 0;
        const tb = (b.d.createdAt && b.d.createdAt.toMillis) ? b.d.createdAt.toMillis() : 0;
        return ta-tb;
      });

      callsCountEl.textContent = `–ù–æ–≤–∏—Ö: ${items.length}`;
      if(!items.length){
        callsListEl.innerHTML = "";
        callsEmptyEl.textContent = "–ù–µ–º–∞ –≤–∏–∫–ª–∏–∫—ñ–≤.";
      }else{
        callsEmptyEl.textContent = "";
        callsListEl.innerHTML = items.map(x=>renderCallItem(x.id, x.d)).join("");
      }
    }catch(err){
      console.error(err);
      callsEmptyEl.textContent = "–ù–µ–º–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –≤–∏–∫–ª–∏–∫—ñ–≤ (Rules/—ñ–Ω–¥–µ–∫—Å–∏).";
    }
  }

  function teamRowHtml(team, data, readOnly){
    const id = esc(team.teamId);
    const name = esc(team.teamName || "–ö–æ–º–∞–Ω–¥–∞");
    const sec = team.sector ? `–°–µ–∫—Ç–æ—Ä ${team.sector}` : "–°–µ–∫—Ç–æ—Ä ‚Äî";
    const dis = readOnly ? "disabled" : "";

    const fish = Array.isArray(data?.fishWeights) ? data.fishWeights : [];

    const fishCount = Number(data?.fishCount || 0);
    const totalWeightKg = Number(data?.totalWeightKg || 0);
    const bigFishKg = Number(data?.bigFishKg || 0);

    const tiles = (fish.length ? fish : [""]).map((w)=>`
      <div class="fishTile">
        <input class="inp fishInp" inputmode="decimal" type="number" min="0" step="0.001"
          data-fish value="${(Number(w)>0 ? String(w) : "")}" placeholder="–Ω–∞–ø—Ä. 4.560" ${dis}/>
        <button class="fishDel" type="button" data-del ${dis} title="–í–∏–¥–∞–ª–∏—Ç–∏">√ó</button>
      </div>
    `).join("");

    return `
      <div class="teamRow" data-team="${id}">
        <div class="teamHead">
          <div>
            <div class="teamTitle">${zone}${team.sector || ""} ‚Ä¢ ${name}</div>
            <div class="teamMeta">${sec} ‚Ä¢ ${readOnly ? "–ø–µ—Ä–µ–≥–ª—è–¥" : "–≤–Ω–µ—Å–µ–Ω–Ω—è"}</div>
          </div>
          <div class="muted">W${viewW}</div>
        </div>

        <div class="muted" style="margin:0 0 8px;">
          –í–ø–∏—à–∏ –≤–∞–≥—É –∫–æ–∂–Ω–æ—ó —Ä–∏–±–∏ –æ–∫—Ä–µ–º–æ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ 4.560)
        </div>

        <div class="fishGrid" data-fishbox>
          ${tiles}
          <button class="fishAdd" type="button" data-add ${dis} title="–î–æ–¥–∞—Ç–∏ —Ä–∏–±—É">+</button>
        </div>

        <div class="muted" style="margin-top:10px;">
          <span class="pill" data-totals>
            –†–∏–±: <b>${fishCount}</b> ‚Ä¢ –°—É–º–∞ W: <b>${totalWeightKg.toFixed(3)}</b> ‚Ä¢ Big: <b>${bigFishKg.toFixed(3)}</b>
          </span>
        </div>

        <div class="teamBtns">
          <button class="btn btn--accent" data-save ${readOnly ? "disabled" : ""}>–ó–±–µ—Ä–µ–≥—Ç–∏</button>
        </div>
      </div>
    `;
  }

  function readRowValues(row){
    const inputs = Array.from(row.querySelectorAll("[data-fish]"));
    const fishWeights = inputs
      .map(i => Number(String(i.value || "").replace(",", ".")))
      .filter(v => isFinite(v) && v > 0);

    const fishCount = fishWeights.length;
    const totalWeightKg = fishWeights.reduce((a,b)=>a+b, 0);
    const bigFishKg = fishWeights.length ? Math.max(...fishWeights) : 0;

    return {
      fishWeights,
      fishCount,
      totalWeightKg: +totalWeightKg.toFixed(3),
      bigFishKg: +bigFishKg.toFixed(3),
    };
  }

  function updateHint(row, v){
    const t = row.querySelector("[data-totals]");
    if(t){
      t.innerHTML = `–†–∏–±: <b>${v.fishCount}</b> ‚Ä¢ –°—É–º–∞ W: <b>${v.totalWeightKg.toFixed(3)}</b> ‚Ä¢ Big: <b>${v.bigFishKg.toFixed(3)}</b>`;
    }
  }

  async function renderTeams(){
    setWMsg("–ó–∞–≤–∞–Ω—Ç–∞–∂—É—é –∫–æ–º–∞–Ω–¥–∏‚Ä¶", true);
    teamsBox.innerHTML = "";
    const teams = await loadTeamsForZone();
    teamsCountEl.textContent = `–ö–æ–º–∞–Ω–¥: ${teams.length}`;

    if(!teams.length){
      teamsBox.innerHTML = `<div class="muted">–ù–µ–º–∞ –∫–æ–º–∞–Ω–¥ —É –∑–æ–Ω—ñ. –ü–µ—Ä–µ–≤—ñ—Ä –∂–µ—Ä–µ–±–∫—É–≤–∞–Ω–Ω—è/–¥–∞–Ω—ñ stageResults.</div>`;
      setWMsg("‚ùó –ù–µ–º–∞ —Å–ø–∏—Å–∫—É –∫–æ–º–∞–Ω–¥ –¥–ª—è —Ü—ñ—î—ó –∑–æ–Ω–∏.", false);
      return;
    }

    const rows = [];
    for(const t of teams){
      const wd = await loadWeighing(t.teamId, viewW);
      const readOnly = (viewW < currentW);
      rows.push(teamRowHtml(t, wd, readOnly));
    }
    teamsBox.innerHTML = rows.join("");
    setWMsg(`–ì–æ—Ç–æ–≤–æ ‚úÖ –ü–æ—Ç–æ—á–Ω–µ: W${currentW} ‚Ä¢ –ü–µ—Ä–µ–≥–ª—è–¥: W${viewW}`, true);
  }

  wBtns.forEach(b=>{
    b.el.onclick = async ()=>{
      viewW = b.n;
      updateWButtons();
      await renderTeams();
    };
  });

  document.addEventListener("input", (e)=>{
    const inp = e.target.closest("[data-fish]");
    if(!inp) return;
    const row = inp.closest(".teamRow");
    if(!row) return;
    const v = readRowValues(row);
    updateHint(row, v);
  });

  document.addEventListener("click", async (e)=>{
    const addBtn = e.target.closest("[data-add]");
    if(addBtn){
      const row = addBtn.closest(".teamRow");
      if(!row) return;
      addBtn.insertAdjacentHTML("beforebegin", `
        <div class="fishTile">
          <input class="inp fishInp" inputmode="decimal" type="number" min="0" step="0.001"
            data-fish value="" placeholder="–Ω–∞–ø—Ä. 4.560"/>
          <button class="fishDel" type="button" data-del title="–í–∏–¥–∞–ª–∏—Ç–∏">√ó</button>
        </div>
      `);
      const v = readRowValues(row);
      updateHint(row, v);
      return;
    }

    const delBtn = e.target.closest("[data-del]");
    if(delBtn){
      const row = delBtn.closest(".teamRow");
      if(!row) return;
      const tile = delBtn.closest(".fishTile");
      if(tile) tile.remove();

      // —è–∫—â–æ –Ω–µ –ª–∏—à–∏–ª–æ—Å—å –∂–æ–¥–Ω–æ–≥–æ –ø–æ–ª—è ‚Äî –ª–∏—à–∞—î–º–æ –æ–¥–Ω–µ
      const box = row.querySelector("[data-fishbox]");
      if(box && box.querySelectorAll("[data-fish]").length === 0){
        const add = box.querySelector("[data-add]");
        if(add){
          add.insertAdjacentHTML("beforebegin", `
            <div class="fishTile">
              <input class="inp fishInp" inputmode="decimal" type="number" min="0" step="0.001"
                data-fish value="" placeholder="–Ω–∞–ø—Ä. 4.560"/>
              <button class="fishDel" type="button" data-del title="–í–∏–¥–∞–ª–∏—Ç–∏">√ó</button>
            </div>
          `);
        }
      }

      const v = readRowValues(row);
      updateHint(row, v);
      return;
    }

    const saveBtn = e.target.closest("[data-save]");
    if(saveBtn){
      const row = saveBtn.closest(".teamRow");
      if(!row) return;

      if(viewW !== currentW){
        return alert("–ó–±–µ—Ä—ñ–≥–∞—Ç–∏ –º–æ–∂–Ω–∞ —Ç—ñ–ª—å–∫–∏ —É –ø–æ—Ç–æ—á–Ω–µ –∑–≤–∞–∂—É–≤–∞–Ω–Ω—è.");
      }

      const teamId = row.getAttribute("data-team");
      const teams = await loadTeamsForZone();
      const team = teams.find(x=>String(x.teamId)===String(teamId));
      if(!team) return alert("–ù–µ –∑–Ω–∞–π—à–æ–≤ –∫–æ–º–∞–Ω–¥—É.");

      const v = readRowValues(row);
      updateHint(row, v);

      const ok = confirm(
        `–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è?\n\n`+
        `${zone}${team.sector||""} ‚Ä¢ ${team.teamName}\n`+
        `W${currentW}\n`+
        `–†–∏–±: ${v.fishCount}\n`+
        `–°—É–º–∞: ${v.totalWeightKg.toFixed(3)} –∫–≥\n`+
        `Big: ${v.bigFishKg.toFixed(3)} –∫–≥`
      );
      if(!ok) return;

      try{
        setWMsg("–ó–±–µ—Ä—ñ–≥–∞—é‚Ä¶", true);
        await saveWeighing(team, currentW, v);
        setWMsg("–ó–±–µ—Ä–µ–∂–µ–Ω–æ ‚úÖ", true);

        const advanced = await maybeAdvanceAuto(teams);
        if(advanced){
          const { data } = await getOrCreateWeighingSettings();
          maxW = Number(data.maxW || DEFAULT_MAX_W);
          currentW = getCurrentWForZone(data);
          viewW = currentW;
          updateWButtons();
          setWMsg(`‚úÖ –£—Å—ñ –∫–æ–º–∞–Ω–¥–∏ –∑–¥–∞–Ω—ñ. –ê–≤—Ç–æ-–ø–µ—Ä–µ—Ö—ñ–¥ –Ω–∞ W${currentW}.`, true);
        }

        await renderTeams();
      }catch(err){
        console.error(err);
        setWMsg("–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è ‚ùå", false);
      }
      return;
    }

    const ack = e.target.closest("[data-ack]");
    if(ack){
      const id = ack.getAttribute("data-ack");
      if(!id) return;
      try{
        await db.collection("calls").doc(id).set({
          status: "accepted",
          judgeUid: me.uid,
          acceptedAt: window.firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
      }catch(err){
        console.error(err);
        alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—Ä–∏–π–Ω—è—Ç–∏ –≤–∏–∫–ª–∏–∫");
      }
      return;
    }

    const warn = e.target.closest("[data-warn]");
    if(warn){
      const id = warn.getAttribute("data-warn");
      const kind = warn.getAttribute("data-kind");
      if(!id || !kind) return;
      if(!confirm(`–ó–∞–ø–∏—Å–∞—Ç–∏ "${kind}" —ñ –∑–∞–∫—Ä–∏—Ç–∏ –≤–∏–∫–ª–∏–∫?`)) return;

      try{
        const snap = await db.collection("calls").doc(id).get();
        const d = snap.exists ? (snap.data()||{}) : {};
        await createPenaltyFromCall(id, d, kind);
      }catch(err){
        console.error(err);
        alert("–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø–∏—Å—É –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è/–∫–∞—Ä—Ç–∫–∏");
      }
      return;
    }
  });

  async function boot(){
    try{
      await waitFirebase();
      auth = window.scAuth;
      db = window.scDb;
    }catch(e){
      statusEl.textContent = "Firebase –Ω–µ –∑–∞–ø—É—Å—Ç–∏–≤—Å—è ‚ùå";
      setMsg(e.message || "Firebase init error", false);
      return;
    }

    const p = currentParams();
    if (p.zone && p.compId && p.token){
      const ok = writeBind({
        zone: p.zone,
        compId: p.compId,
        stageId: p.stageId || "",
        token: p.token,
        savedAt: Date.now()
      });
      if (ok){
        setMsg("‚úÖ –ó–æ–Ω–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–∞. –¢–µ–ø–µ—Ä –º–æ–∂–Ω–∞ –ø—Ä–æ—Å—Ç–æ –≤—ñ–¥–∫—Ä–∏–≤–∞—Ç–∏ —Ü—é —Å—Ç–æ—Ä—ñ–Ω–∫—É ‚Äî –≤–æ–Ω–∞ –ø–∞–º‚Äô—è—Ç–∞—î.", true);
        history.replaceState({}, "", location.pathname);
      }else{
        setMsg("‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ (–±—Ä–∞—É–∑–µ—Ä –±–ª–æ–∫—É—î —Å—Ö–æ–≤–∏—â–µ).", false);
      }
    }

    renderBindState();

    btnOpen.onclick = ()=>{
      const bind = readBind();
      if (!bind) return setMsg("–ù–µ–º–∞ –ø—Ä–∏–≤‚Äô—è–∑–∫–∏. –°–ø–æ—á–∞—Ç–∫—É –≤—ñ–¥–∫—Ä–∏–π QR/–ª—ñ–Ω–∫ –≤—ñ–¥ –∞–¥–º—ñ–Ω–∞.", false);
      const url = buildUrlFromBind(bind);
      setMsg("‚úÖ –í—ñ–¥–∫—Ä–∏–≤–∞—é —Ç–≤–æ—é –∑–æ–Ω—É‚Ä¶", true);
      location.href = url;
    };
    btnReset.onclick = ()=>{
      if (!confirm("–°–∫–∏–Ω—É—Ç–∏ –ø—Ä–∏–≤‚Äô—è–∑–∫—É –∑–æ–Ω–∏ –Ω–∞ —Ü—å–æ–º—É —Ç–µ–ª–µ—Ñ–æ–Ω—ñ?")) return;
      clearBind();
      renderBindState();
      setMsg("‚úÖ –ü—Ä–∏–≤‚Äô—è–∑–∫—É —Å–∫–∏–Ω—É—Ç–æ. –¢–µ–ø–µ—Ä —Ç—Ä–µ–±–∞ –∑–Ω–æ–≤ 1 —Ä–∞–∑ –∑–∞–π—Ç–∏ –ø–æ QR/–ª—ñ–Ω–∫—É.", true);
    };
    btnSaveHint.onclick = ()=>{
      setMsg("üìå Chrome: ‚ãÆ ‚Üí ‚Äú–î–æ–¥–∞—Ç–∏ –Ω–∞ –≥–æ–ª–æ–≤–Ω–∏–π –µ–∫—Ä–∞–Ω‚Äù. –¢–æ–¥—ñ –∑–æ–Ω–∞ –≤—ñ–¥–∫—Ä–∏–≤–∞—î—Ç—å—Å—è –æ–¥–Ω–∏–º —Ç–∞–ø–æ–º.", true);
    };

    auth.onAuthStateChanged(async (user)=>{
      if(!user){
        authPill.textContent = "auth: ‚ùå (–Ω–µ —É–≤—ñ–π—à–æ–≤)";
        statusEl.textContent = "–ü–æ—Ç—Ä—ñ–±–µ–Ω –≤—Ö—ñ–¥ —Å—É–¥–¥—ñ/–∞–¥–º—ñ–Ω–∞ (auth.html)";
        setMsg("–£–≤—ñ–π–¥–∏ –ø—ñ–¥ —Å—É–¥–¥–µ—é –∞–±–æ –∞–¥–º—ñ–Ω–æ–º.", false);
        weighCard.style.display = "none";
        return;
      }

      authPill.textContent = "auth: ‚úÖ " + (user.email || user.uid);

      try{
        const ok = await requireJudgeOrAdmin(user);
        if(!ok){
          statusEl.textContent = "–ù–µ–º–∞ –¥–æ—Å—Ç—É–ø—É ‚ùå";
          setMsg("–¶–µ–π –∞–∫–∞—É–Ω—Ç –Ω–µ —Å—É–¥–¥—è —ñ –Ω–µ –∞–¥–º—ñ–Ω.", false);
          weighCard.style.display = "none";
          return;
        }

        me = user;

        const bind = readBind();
        if(!bind){
          statusEl.textContent = "–ù–µ–º–∞ –ø—Ä–∏–≤‚Äô—è–∑–∫–∏ ‚ùó";
          setMsg("–í—ñ–¥–∫—Ä–∏–π QR/–ª—ñ–Ω–∫ –≤—ñ–¥ –∞–¥–º—ñ–Ω–∞ (1 —Ä–∞–∑).", false);
          weighCard.style.display = "none";
          return;
        }

        zone = String(bind.zone||"").toUpperCase();
        compId = String(bind.compId||"");
        stageId = String(bind.stageId||""); // –º–æ–∂–µ –±—É—Ç–∏ –ø—É—Å—Ç–∏–π
        token = String(bind.token||"");

        if(!zone || !compId){
          statusEl.textContent = "–ù–µ–ø–æ–≤–Ω–∞ –ø—Ä–∏–≤‚Äô—è–∑–∫–∞ ‚ùó";
          setMsg("–ü–µ—Ä–µ–≤—ñ—Ä QR: zone + compId –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤—ñ.", false);
          weighCard.style.display = "none";
          return;
        }

        activeKey = makeActiveKey(compId, stageId);

        zoneTitle.textContent = `–ó–æ–Ω–∞ ${zone}`;
        statusEl.textContent = "‚úÖ –°—É–¥–¥—è –≤ –∑–æ–Ω—ñ –∞–∫—Ç–∏–≤–Ω–∏–π.";
        setMsg("", true);

        const { data } = await getOrCreateWeighingSettings();
        maxW = Number(data.maxW || DEFAULT_MAX_W);
        currentW = getCurrentWForZone(data);
        viewW = currentW;

        weighCard.style.display = "block";
        updateWButtons();

        setupCallsRealtime();
        await loadCallsOnceFallback();
        await renderTeams();

      }catch(err){
        console.error(err);
        statusEl.textContent = "–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø—É ‚ùå";
        setMsg("–ü–µ—Ä–µ–≤—ñ—Ä users.role / rules Firestore.", false);
        weighCard.style.display = "none";
      }
    });
  }

  boot();
})();
</script>

</body>
</html>
